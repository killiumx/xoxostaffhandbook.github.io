<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Prop Farm Pro ‚Äî Economic Calendar + AI</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f8fafc;--card:#fff;--card2:#f1f5f9;--border:#e2e8f0;--border2:#cbd5e1;
  --t1:#0f172a;--t2:#64748b;--t3:#94a3b8;
  --red:#ef4444;--amber:#f59e0b;--green:#10b981;--blue:#3b82f6;--cyan:#06b6d4;
  --red-d:rgba(239,68,68,.08);--amber-d:rgba(245,158,11,.08);--green-d:rgba(16,185,129,.08);
  --sh:0 1px 3px rgba(0,0,0,.1);--sh2:0 10px 25px rgba(0,0,0,.1);
  --g1:#667eea;--g2:#764ba2;
  --ai1:#ff6b35;--ai2:#f7931e;
}
html{scroll-behavior:smooth}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;-webkit-font-smoothing:antialiased}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes rowPulse{0%,100%{background:transparent}50%{background:rgba(59,130,246,.06)}}
@keyframes glowPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(239,68,68,.2)}}

/* NAV */
.nav{background:var(--card);border-bottom:1px solid var(--border);padding:.875rem 2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:500;gap:1rem;box-shadow:0 1px 3px rgba(0,0,0,.07)}
.logo{font-size:1.125rem;font-weight:800;white-space:nowrap;display:flex;align-items:center;gap:.375rem;background:linear-gradient(135deg,var(--g1),var(--g2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo em{-webkit-text-fill-color:var(--t1);font-style:normal}
.logo-accent{color:var(--ai1)}
.nav-r{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.live-pill{display:flex;align-items:center;gap:.375rem;font-size:.75rem;font-weight:700;color:var(--green);font-family:'JetBrains Mono',monospace}
.ldot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite}
.ai-pill{display:flex;align-items:center;gap:.375rem;padding:.25rem .75rem;border-radius:20px;font-size:.6875rem;font-weight:700;cursor:pointer;border:1px solid;transition:all .2s}
.ai-pill.checking{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.08);color:var(--amber)}
.ai-pill.ok{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.08);color:var(--green)}
.ai-pill.err{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:var(--red)}
.ai-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.ai-pill.checking .ai-dot{background:var(--amber);animation:blink 1s infinite}
.ai-pill.ok .ai-dot{background:var(--green);animation:blink 2s infinite}
.ai-pill.err .ai-dot{background:var(--red)}
.back-btn{font-size:.8125rem;font-weight:600;color:var(--t2);text-decoration:none;padding:.375rem .875rem;border:1px solid var(--border);border-radius:8px;transition:all .2s}
.back-btn:hover{color:var(--t1);border-color:var(--blue)}

/* SESSION HERO */
.session-hero{background:linear-gradient(135deg,var(--g1),var(--g2));border-bottom:1px solid var(--border);padding:2rem 2rem 1.5rem;color:#fff}
.session-inner{max-width:1600px;margin:0 auto;display:grid;grid-template-columns:1fr auto;gap:2rem;align-items:center}
.session-left h1{font-size:clamp(1.25rem,2.5vw,1.75rem);font-weight:800;margin-bottom:.25rem;line-height:1.2}
.session-left h1 span{opacity:.9}
.session-left p{font-size:.875rem;opacity:.88;line-height:1.6;max-width:600px;margin-bottom:.875rem}
.session-tags{display:flex;gap:.4rem;flex-wrap:wrap}
.stag{font-size:.6875rem;font-weight:600;padding:.2rem .75rem;border-radius:20px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.15)}
.stag.on{background:rgba(16,185,129,.3);border-color:rgba(16,185,129,.5)}
.stag.off{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2)}
.stag.hot{background:rgba(239,68,68,.35);border-color:rgba(239,68,68,.5)}
.stag.warn{background:rgba(245,158,11,.3);border-color:rgba(245,158,11,.5)}

/* COUNTDOWN */
.countdown-block{text-align:center;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:1.25rem 1.75rem;min-width:260px;flex-shrink:0;color:#fff}
.cd-label{font-size:.6875rem;font-weight:700;opacity:.88;margin-bottom:.5rem}
.cd-time{font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;letter-spacing:.04em;line-height:1}
.cd-sub{margin-top:.5rem;display:flex;flex-direction:column;gap:.2rem}
.cd-ny{font-size:.6875rem;font-family:'JetBrains Mono',monospace;font-weight:600;opacity:.9}
.cd-london{font-size:.5625rem;font-family:'JetBrains Mono',monospace;opacity:.7}
.cd-status{font-size:.625rem;font-weight:700;padding:.2rem .75rem;border-radius:20px;margin-top:.625rem;display:inline-block;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.15)}

/* RISK BAR */
.risk-bar{background:var(--card);border-bottom:1px solid var(--border);padding:.75rem 2rem;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.risk-inner{max-width:1600px;margin:0 auto;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.risk-label{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);white-space:nowrap}
.risk-stat{display:flex;align-items:center;gap:.5rem;padding:.3rem .875rem;border-radius:8px;border:1px solid}
.risk-stat.r{border-color:rgba(239,68,68,.3);background:var(--red-d)}.risk-stat.r .rsn{color:var(--red)}
.risk-stat.a{border-color:rgba(245,158,11,.3);background:var(--amber-d)}.risk-stat.a .rsn{color:var(--amber)}
.risk-stat.g{border-color:rgba(16,185,129,.25);background:var(--green-d)}.risk-stat.g .rsn{color:var(--green)}
.risk-stat.b{border-color:var(--border);background:rgba(59,130,246,.05)}.risk-stat.b .rsn{color:var(--blue)}
.rsn{font-family:'JetBrains Mono',monospace;font-size:1.125rem;font-weight:800;line-height:1}
.rsl{font-size:.5625rem;font-weight:700;color:var(--t2)}
.risk-verdict{margin-left:auto;display:flex;align-items:center;gap:.5rem;padding:.375rem 1rem;border-radius:8px;font-size:.8125rem;font-weight:700;border:1px solid;white-space:nowrap}
.risk-verdict.danger{background:var(--red-d);border-color:rgba(239,68,68,.3);color:var(--red)}
.risk-verdict.caution{background:var(--amber-d);border-color:rgba(245,158,11,.3);color:var(--amber)}
.risk-verdict.clear{background:var(--green-d);border-color:rgba(16,185,129,.25);color:var(--green)}

/* MODE BAR */
.mode-bar{background:var(--card);border-bottom:1px solid var(--border);padding:.625rem 2rem}
.mode-inner{max-width:1600px;margin:0 auto;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.mode-lbl{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);white-space:nowrap}
.mode-toggle{display:flex;background:var(--bg);border:1px solid var(--border);border-radius:9px;overflow:hidden}
.mode-btn{padding:.275rem 1.125rem;font-size:.75rem;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--t2);font-family:'Inter',sans-serif;transition:all .2s;white-space:nowrap}
.mode-btn.active.normal{background:var(--blue);color:#fff}
.mode-btn.active.auto{background:var(--ai1);color:#fff}
.mode-info{font-size:.75rem;color:var(--t2)}
.size-area{margin-left:auto;display:flex;align-items:center;gap:.625rem;flex-wrap:wrap}
.sz-lbl{font-size:.6875rem;font-weight:700;color:var(--t2);white-space:nowrap}
.sz-pills{display:flex;gap:.3rem;flex-wrap:wrap}
.sz-pill{padding:.2rem .625rem;border-radius:6px;font-size:.6875rem;font-weight:700;font-family:'JetBrains Mono',monospace;border:1px solid var(--border);color:var(--t2);cursor:pointer;transition:all .15s;white-space:nowrap}
.sz-pill:hover{border-color:var(--blue);color:var(--blue)}
.sz-pill.active{border-color:var(--blue);color:var(--blue);background:rgba(59,130,246,.08)}

/* CLOCK STRIP */
.clock-strip{background:var(--card);border-bottom:1px solid var(--border);padding:.5rem 2rem}
.clock-inner{max-width:1600px;margin:0 auto;display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap}
.ck-lbl{font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--t3)}
.ck-zones{display:flex;gap:.75rem;flex-wrap:wrap}
.ck-zone{display:flex;align-items:center;gap:.3rem;padding:.2rem .5rem;border-radius:6px;border:1px solid transparent;transition:all .2s}
.ck-zone.open{background:rgba(16,185,129,.07);border-color:rgba(16,185,129,.2)}
.ck-flag{font-size:.8125rem}
.ck-time{font-family:'JetBrains Mono',monospace;font-size:.875rem;font-weight:700;line-height:1.1;color:var(--t1)}
.ck-zone.open .ck-time{color:var(--green)}
.ck-name{font-size:.5rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);display:flex;align-items:center;gap:2px}
.ck-name{font-size:.4rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--t3);display:flex;align-items:center;gap:2px}
.sdot{width:4px;height:4px;border-radius:50%;background:var(--t3);flex-shrink:0}
.sdot.open{background:var(--green);animation:blink 2s infinite}

/* WRAP */
.wrap{max-width:1600px;margin:0 auto;padding:1.5rem 2rem 3rem}

/* TABS */
.tabs{display:flex;gap:.375rem;margin-bottom:1.5rem;flex-wrap:wrap;padding-bottom:.25rem}
.tab{padding:.5rem 1.125rem;border-radius:10px;font-size:.8125rem;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--t2);transition:all .15s;white-space:nowrap}
.tab:hover{border-color:var(--blue);color:var(--blue)}
.tab.active{background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border-color:transparent;box-shadow:0 4px 12px rgba(102,126,234,.3)}
.tab.red-tab{border-color:rgba(239,68,68,.2);color:var(--red)}.tab.red-tab.active{background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 12px rgba(239,68,68,.3)}
.tab.ai{border-color:rgba(255,107,53,.2);color:var(--ai1)}.tab.ai.active{background:linear-gradient(135deg,var(--ai1),var(--ai2));box-shadow:0 4px 12px rgba(255,107,53,.3)}
.panel{display:none}.panel.active{display:block}

/* FOREX FACTORY TABLE */
.ff-box{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:1.5rem;box-shadow:var(--sh)}
.ff-head{padding:.875rem 1.25rem;border-bottom:1px solid var(--border);background:var(--card2);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
.ff-title{font-size:.9375rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.ff-meta{font-size:.75rem;color:var(--t2);margin-top:2px}
.ff-filters{display:flex;gap:.3rem;flex-wrap:wrap;align-items:center}
.ff-filt{padding:.2rem .7rem;border-radius:6px;font-size:.5rem;font-weight:700;letter-spacing:.07em;border:1px solid var(--border2);color:var(--t3);cursor:pointer;transition:all .15s;text-transform:uppercase}
.ff-filt:hover{color:var(--t1)}
.ff-filt.f-all.on{border-color:var(--blue);color:var(--blue);background:rgba(59,130,246,.08)}
.ff-filt.f-H.on{border-color:rgba(255,61,61,.5);color:var(--red);background:var(--red-d)}
.ff-filt.f-M.on{border-color:rgba(255,176,32,.5);color:var(--amber);background:var(--amber-d)}
.ff-filt.f-L.on{border-color:rgba(0,223,122,.4);color:var(--green);background:var(--green-d)}

.tbl-wrap{overflow-x:auto}
table.ff-tbl{width:100%;border-collapse:collapse;min-width:760px}
table.ff-tbl th{padding:.5rem 1rem;font-size:.5625rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:var(--t3);background:var(--bg);text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
table.ff-tbl td{padding:.625rem 1rem;border-bottom:1px solid var(--border);vertical-align:middle;font-size:.8125rem}
table.ff-tbl tr:last-child td{border-bottom:none}
table.ff-tbl tr:hover td{background:var(--bg)}
table.ff-tbl tr.is-H{background:rgba(239,68,68,.04)}
table.ff-tbl tr.is-M{background:rgba(245,158,11,.03)}
table.ff-tbl tr.NEXT td{background:rgba(59,130,246,.06);animation:rowPulse 2s infinite}
table.ff-tbl tr.PASSED td{opacity:.4}

.imp-badge{display:inline-flex;align-items:center;gap:.3rem;font-size:.5rem;font-weight:700;padding:.125rem .5rem;border-radius:20px;text-transform:uppercase;letter-spacing:.06em;white-space:nowrap}
.imp-badge.H{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.25)}
.imp-badge.M{background:rgba(245,158,11,.1);color:var(--amber);border:1px solid rgba(245,158,11,.25)}
.imp-badge.L{background:rgba(16,185,129,.1);color:var(--green);border:1px solid rgba(16,185,129,.2)}
.imp-dot{width:7px;height:7px;border-radius:50%;display:inline-block;flex-shrink:0}
.imp-dot.H{background:var(--red)}.imp-dot.M{background:var(--amber)}.imp-dot.L{background:var(--green)}

.t-cell{font-family:'JetBrains Mono',monospace;font-size:.75rem;font-weight:700;white-space:nowrap;line-height:1.4;color:var(--t1)}
.t-cell .ny{color:var(--blue);font-size:.5625rem}
.t-cell .lon{color:var(--t3);font-size:.5rem}
.ev-name{font-weight:600;font-size:.8125rem;line-height:1.3;color:var(--t1)}
.ev-cur{font-size:.5rem;font-weight:700;padding:.1rem .4rem;border-radius:4px;background:rgba(59,130,246,.1);color:var(--blue);font-family:'JetBrains Mono',monospace;margin-left:.3rem}
.next-tag{font-size:.5rem;font-weight:700;padding:.1rem .4rem;border-radius:4px;background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.25);margin-left:.3rem;animation:blink 1.5s infinite}
.pass-tag{font-size:.45rem;color:var(--t3);margin-left:.3rem}
.num-cell{font-family:'JetBrains Mono',monospace;font-size:.8125rem;font-weight:700;color:var(--t1)}
.num-cell.beat{color:var(--green)}.num-cell.miss{color:var(--red)}.num-cell.inline{color:var(--amber)}
.forecast-cell,.prev-cell{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--t2)}
.ft-cell{display:flex;gap:.2rem;flex-wrap:wrap}
.ft{font-size:.5rem;font-weight:700;font-family:'JetBrains Mono',monospace;padding:.125rem .4rem;border-radius:3px;background:rgba(59,130,246,.1);color:var(--blue);white-space:nowrap}
.ft.hot{background:rgba(239,68,68,.1);color:var(--red)}
.act-cell{font-size:.575rem;font-weight:700;white-space:nowrap}
.act-cell.avoid{color:var(--red)}.act-cell.caution{color:var(--amber)}.act-cell.ok{color:var(--green)}

/* AI SCAN */
.ai-scan-box{background:linear-gradient(135deg,rgba(255,107,53,.05),rgba(247,147,30,.03));border:1px solid rgba(255,107,53,.2);border-radius:14px;padding:1.5rem;margin-bottom:1.5rem}
.ai-scan-box::before{content:'';display:none}
.ai-scan-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.875rem;flex-wrap:wrap;gap:.625rem}
.ai-scan-title{font-size:.9375rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.ai-scan-body{font-size:.875rem;color:var(--t2);line-height:1.8;white-space:pre-wrap}
.ai-scan-body strong,.ai-scan-body b{color:var(--t1)}
.ai-loading{display:flex;align-items:center;gap:.75rem;font-size:.875rem;color:var(--t2)}
.ai-spin{width:18px;height:18px;border:2px solid rgba(255,107,53,.2);border-top-color:var(--ai1);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}

/* AUTO MODE */
.auto-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.375rem}
.auto-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.125rem;position:relative;overflow:hidden;box-shadow:var(--sh)}
.auto-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.auto-card.r::before{background:var(--red)}.auto-card.a::before{background:var(--amber)}.auto-card.g::before{background:var(--green)}.auto-card.b::before{background:var(--cyan)}
.ac-label{font-size:.625rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);margin-bottom:.5rem}
.ac-val{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:800;line-height:1;margin-bottom:.2rem}
.ac-sub{font-size:.6875rem;color:var(--t2);line-height:1.4}
.auto-card.r .ac-val{color:var(--red)}.auto-card.a .ac-val{color:var(--amber)}.auto-card.g .ac-val{color:var(--green)}.auto-card.b .ac-val{color:var(--cyan)}

/* SIZE CALC */
.size-calc{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.25rem;margin-bottom:1.5rem;box-shadow:var(--sh)}
.sc-title{font-size:.9375rem;font-weight:700;margin-bottom:.875rem;display:flex;align-items:center;gap:.5rem}
.sc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.625rem}
.sc-row{background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:.75rem;text-align:center}
.sc-label{font-size:.5625rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--t3);margin-bottom:.3rem}
.sc-val{font-family:'JetBrains Mono',monospace;font-size:1.375rem;font-weight:800;line-height:1}
.sc-hint{font-size:.5625rem;color:var(--t2);margin-top:.25rem;line-height:1.4}
.sc-row.r .sc-val{color:var(--red)}.sc-row.a .sc-val{color:var(--amber)}.sc-row.g .sc-val{color:var(--green)}.sc-row.b .sc-val{color:var(--cyan)}

/* TV WIDGET */
.tv-wrap{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:1.5rem;box-shadow:var(--sh)}
.tv-head{padding:.875rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
.tv-title{font-size:.9375rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.tv-badge{font-size:.5rem;font-weight:700;padding:.125rem .5rem;border-radius:4px;background:rgba(59,130,246,.1);color:var(--blue);letter-spacing:.06em;text-transform:uppercase}
.tradingview-widget-container{height:680px}

/* CHAT */
.chat-wrap{display:grid;grid-template-columns:1fr 310px;gap:1.25rem;align-items:start}
@media(max-width:900px){.chat-wrap{grid-template-columns:1fr}}
.chat-box{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;height:580px;box-shadow:var(--sh)}
.chat-head{padding:.875rem 1.25rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,var(--ai1),var(--ai2));color:#fff;display:flex;align-items:center;gap:.75rem}
.chat-head-txt{font-weight:700;font-size:.9375rem}
.chat-head-sub{font-size:.6875rem;opacity:.88}
.chat-msgs{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.875rem}
.chat-msgs::-webkit-scrollbar{width:3px}
.chat-msgs::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.msg{max-width:88%;display:flex;flex-direction:column;gap:.175rem;animation:fadeUp .2s ease}
.msg.user{align-self:flex-end;align-items:flex-end}
.msg.ai-m{align-self:flex-start;align-items:flex-start}
.msg-bub{padding:.5625rem .75rem;border-radius:10px;font-size:.8125rem;line-height:1.6}
.msg.user .msg-bub{background:linear-gradient(135deg,var(--g1),var(--g2));color:#fff;border-radius:12px 12px 2px 12px}
.msg.ai-m .msg-bub{background:var(--bg);border:1px solid var(--border);color:var(--t1);border-radius:12px 12px 12px 2px;white-space:pre-wrap}
.msg-time{font-size:.4375rem;color:var(--t3);font-family:'JetBrains Mono',monospace}
.chat-in-row{padding:.625rem .875rem;border-top:1px solid var(--border);display:flex;gap:.5rem;align-items:flex-end;background:var(--card2)}
.chat-in{flex:1;padding:.625rem .875rem;border:1px solid var(--border);border-radius:10px;font-family:'Inter',sans-serif;font-size:.8125rem;resize:none;min-height:40px;max-height:100px;outline:none;background:var(--bg);color:var(--t1);line-height:1.5;transition:border-color .2s}
.chat-in:focus{border-color:var(--ai1)}
.chat-send{padding:.625rem 1rem;background:linear-gradient(135deg,var(--ai1),var(--ai2));color:#fff;border:none;border-radius:10px;font-size:.8125rem;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;transition:all .2s;white-space:nowrap}
.chat-send:hover{transform:translateY(-1px)}
.chat-send:disabled{opacity:.35;cursor:not-allowed;transform:none}
.quick-qs{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1.125rem}
.qqs-title{font-weight:800;font-size:.8125rem;margin-bottom:.75rem;letter-spacing:-.01em;display:flex;align-items:center;gap:.375rem}
.qq{display:block;width:100%;text-align:left;padding:.625rem .875rem;border:1px solid var(--border);border-radius:10px;background:var(--bg);font-size:.75rem;font-weight:600;color:var(--t1);cursor:pointer;font-family:'Inter',sans-serif;margin-bottom:.5rem;transition:all .2s;line-height:1.4}
.qq:hover{border-color:var(--ai1);color:var(--ai1);background:rgba(255,107,53,.04)}
.qq:last-child{margin-bottom:0}

/* BRIEFING */
.briefing-card{background:var(--card);border:1px solid rgba(255,107,53,.2);border-radius:14px;overflow:hidden;margin-bottom:1.5rem;box-shadow:var(--sh)}
.briefing-head{padding:.875rem 1.5rem;border-bottom:1px solid var(--border);background:linear-gradient(135deg,rgba(255,107,53,.06),rgba(247,147,30,.04));display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
.briefing-title{font-size:1rem;font-weight:700;display:flex;align-items:center;gap:.5rem}
.briefing-body{padding:1.5rem;font-size:.875rem;color:var(--t2);line-height:1.8;white-space:pre-wrap}
.briefing-body strong,.briefing-body b{color:var(--t1)}
.bload{display:flex;align-items:center;gap:.625rem;font-size:.8125rem;color:var(--t2);padding:1.375rem}
.bspin{width:16px;height:16px;border:2px solid rgba(255,176,32,.15);border-top-color:var(--amber);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0}

/* SHARED */
.btn{display:inline-flex;align-items:center;gap:.375rem;padding:.5rem 1.125rem;border-radius:9px;font-size:.8125rem;font-weight:600;cursor:pointer;border:none;font-family:'Inter',sans-serif;transition:all .2s;text-decoration:none;white-space:nowrap}
.btn-ghost{background:var(--card);color:var(--t1);border:1px solid var(--border)}.btn-ghost:hover{border-color:var(--blue);color:var(--blue)}
.btn-acc{background:linear-gradient(135deg,var(--ai1),var(--ai2));color:#fff}.btn-acc:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(255,107,53,.35)}
.btn-blue{background:rgba(59,130,246,.1);color:var(--blue);border:1px solid rgba(59,130,246,.2)}.btn-blue:hover{background:rgba(59,130,246,.18)}
.btn-red{background:var(--red-d);color:var(--red);border:1px solid rgba(255,61,61,.25)}.btn-red:hover{background:rgba(255,61,61,.14)}

.red-rule{background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.2);border-radius:12px;padding:.875rem 1.25rem;margin-bottom:1.5rem;display:flex;gap:.75rem;font-size:.875rem;line-height:1.6;align-items:flex-start}
.red-rule strong{color:var(--red)}.red-rule p{color:var(--t2)}
.tip-box{background:rgba(16,185,129,.06);border:1px solid rgba(16,185,129,.2);border-radius:12px;padding:.875rem 1.25rem;margin-bottom:1.5rem;display:flex;gap:.75rem;font-size:.875rem;align-items:flex-start;line-height:1.6}
.tip-box strong{color:var(--green)}.tip-box p{color:var(--t2)}
.sdiv{display:flex;align-items:center;gap:.875rem;margin-bottom:1rem}
.sdiv h3{font-size:.8125rem;font-weight:800;white-space:nowrap;letter-spacing:-.01em}
.sdiv-line{flex:1;height:1px;background:var(--border)}
.sdiv-count{font-size:.5625rem;color:var(--t3);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--g1);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto .75rem}
.loading-box{text-align:center;padding:3rem 1rem;color:var(--t2);font-size:.875rem}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem;margin-bottom:1.5rem}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.125rem;box-shadow:var(--sh)}
.cc-title{font-weight:700;font-size:.875rem;margin-bottom:.125rem}
.cc-sub{font-size:.5625rem;color:var(--t2);margin-bottom:.875rem}
.cc-wrap{position:relative;height:180px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem;margin-bottom:1.5rem}
.ibox{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.125rem;box-shadow:var(--sh)}
.ibox.red-b{border-left:3px solid var(--red)}.ibox.amber-b{border-left:3px solid var(--amber)}.ibox.green-b{border-left:3px solid var(--green)}.ibox.blue-b{border-left:3px solid var(--blue)}
.ibox-title{font-weight:700;font-size:.875rem;margin-bottom:.625rem;display:flex;align-items:center;gap:.375rem}
.ilist li{font-size:.75rem;color:var(--t2);padding:.25rem 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem;list-style:none;line-height:1.5}
.ilist li:last-child{border-bottom:none}
.idot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.ilist strong{color:var(--t1)}
.cheat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:1rem;margin-bottom:1.5rem}
.ccard{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:var(--sh)}
.ccard-head{padding:.75rem 1rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.5rem;background:var(--bg)}
.ccard-head.red-h{border-left:3px solid var(--red)}.ccard-head.amber-h{border-left:3px solid var(--amber)}
.cname{font-weight:700;font-size:.875rem}
.cfreq{font-size:.45rem;font-weight:700;margin-left:auto;color:var(--t3);font-family:'JetBrains Mono',monospace;letter-spacing:.07em}
.ccsched{font-size:.5rem;color:var(--t3);margin-top:1px}
.ctable{width:100%;border-collapse:collapse}
.ctable th{padding:.4rem .875rem;font-size:.5rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--t3);background:var(--card2);text-align:left;border-bottom:1px solid var(--border)}
.ctable td{padding:.5rem .75rem;font-size:.75rem;border-bottom:1px solid rgba(26,34,54,.8);vertical-align:top;line-height:1.4}
.ctable tr:last-child td{border-bottom:none}
.ctable tr:hover td{background:rgba(255,255,255,.018)}
.scenario{font-weight:700;font-size:.6875rem}.up{color:var(--green)}.down{color:var(--red)}.mixed{color:var(--amber)}
.ftag{display:inline-block;font-size:.45rem;font-weight:700;font-family:'JetBrains Mono',monospace;padding:.05rem .3rem;border-radius:3px;background:rgba(77,166,255,.1);color:var(--blue);margin:1px}
.ftag.down{background:rgba(255,61,61,.1);color:var(--red)}.ftag.up{background:rgba(0,223,122,.08);color:var(--green)}
.qrtable-wrap{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:1.5rem;box-shadow:var(--sh)}
.qrhead{padding:.75rem 1.25rem;background:var(--bg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.qrtitle{font-weight:800;font-size:.875rem;letter-spacing:-.01em}
table.qr{width:100%;border-collapse:collapse}
table.qr th{padding:.4rem .875rem;font-size:.45rem;font-weight:700;text-transform:uppercase;letter-spacing:.09em;color:var(--t3);background:var(--bg);text-align:left;border-bottom:1px solid var(--border);white-space:nowrap}
table.qr td{padding:.5625rem .875rem;font-size:.8125rem;border-bottom:1px solid rgba(26,34,54,.8);vertical-align:middle}
table.qr tr:last-child td{border-bottom:none}
table.qr tr:hover td{background:rgba(255,255,255,.018)}
.ipill{display:inline-block;padding:.1rem .45rem;border-radius:20px;font-size:.45rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em}
.ipill.H{background:var(--red-d);color:var(--red)}.ipill.M{background:var(--amber-d);color:var(--amber)}.ipill.L{background:var(--green-d);color:var(--green)}
.futs{display:flex;gap:.2rem;flex-wrap:wrap}
.src-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem;margin-bottom:1.5rem}
.src-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;transition:all .2s}
.src-card:hover{border-color:var(--border);transform:translateY(-2px);box-shadow:var(--sh2)}
.src-head{padding:.75rem 1rem;border-bottom:1px solid var(--border);background:var(--bg);display:flex;align-items:center;gap:.5rem}
.src-head .icon{font-size:1.25rem}
.src-name{font-weight:800;font-size:.8125rem}
.src-desc{font-size:.5rem;color:var(--t3)}
.src-body{padding:.875rem 1rem;font-size:.75rem;color:var(--t2);line-height:1.65}
.src-foot{padding:.625rem 1rem;border-top:1px solid var(--border)}
.btn-src{display:inline-flex;align-items:center;gap:.375rem;padding:.3rem .75rem;border-radius:6px;font-size:.6875rem;font-weight:700;text-decoration:none;border:1px solid var(--border2);color:var(--t1);transition:all .2s;font-family:'Syne',sans-serif}
.btn-src:hover{border-color:var(--amber);color:var(--amber)}
/* debugger */
.dbg-panel{background:#0f172a;border:1px solid #1e293b;border-radius:14px;overflow:hidden;font-family:'JetBrains Mono',monospace;color:#e2e8f0}
.dbg-header{padding:.75rem 1.25rem;background:#090c18;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
.dbg-title{font-weight:700;color:#eef2ff;display:flex;align-items:center;gap:.5rem;font-size:.8125rem}
.dbg-controls{display:flex;gap:.375rem}
.dbg-btn{padding:.2rem .625rem;border-radius:5px;font-size:.5625rem;font-weight:700;cursor:pointer;border:1px solid #1a2236;background:#090c18;color:#7c8ba1;font-family:'JetBrains Mono',monospace;transition:all .15s}
.dbg-btn:hover{background:#1a2236;color:#eef2ff}
.dbg-btn.run{background:linear-gradient(135deg,#00df7a,#00b863);border-color:#00df7a;color:#000}
.dbg-body{display:grid;grid-template-columns:1fr 1fr}
@media(max-width:768px){.dbg-body{grid-template-columns:1fr}}
.dbg-pane{padding:.875rem 1.125rem;border-right:1px solid #090c18}
.dbg-pane:last-child{border-right:none}
.dbg-pane-title{font-size:.4375rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#3d4f6a;margin-bottom:.625rem}
.dbg-log{height:240px;overflow-y:auto;display:flex;flex-direction:column;gap:.2rem}
.dbg-entry{padding:.275rem .45rem;border-radius:4px;font-size:.5625rem;line-height:1.5;border-left:2px solid transparent}
.dbg-entry.info{background:rgba(77,166,255,.05);border-left-color:#4da6ff;color:#93c5fd}
.dbg-entry.ok{background:rgba(0,223,122,.05);border-left-color:#00df7a;color:#6ee7b7}
.dbg-entry.warn{background:rgba(255,176,32,.05);border-left-color:#ffb020;color:#fcd34d}
.dbg-entry.err{background:rgba(255,61,61,.05);border-left-color:#ff3d3d;color:#fca5a5}
.dbg-entry .ts{color:#243050;font-size:.45rem;margin-right:.3rem}
.dbg-kv{display:flex;flex-direction:column;gap:.3rem}
.dbg-row{display:flex;justify-content:space-between;align-items:center;padding:.2rem 0;border-bottom:1px solid #090c18;font-size:.5625rem}
.dbg-row:last-child{border-bottom:none}
.dbg-key{color:#3d4f6a}
.dbg-val{color:#eef2ff;font-weight:700;text-align:right;max-width:65%;font-size:.5625rem}
.dbg-val.ok{color:#00df7a}.dbg-val.err{color:#ff3d3d}.dbg-val.warn{color:#ffb020}
.dbg-test-result{padding:.625rem 1rem;background:#090c18;border-top:1px solid var(--border);font-size:.5625rem;color:#3d4f6a;min-height:40px;white-space:pre-wrap;line-height:1.6}
.dbg-test-result.ok{color:#6ee7b7}.dbg-test-result.err{color:#fca5a5}
@media(max-width:768px){.wrap{padding:1rem 1rem 3rem}.session-inner{grid-template-columns:1fr}.countdown-block{min-width:auto}}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="logo">üåæ <em style="-webkit-text-fill-color:var(--t1);font-style:normal">Prop Farm Pro</em> ‚Äî Economic Calendar</div>
  <div class="nav-r">
    <div class="ai-pill checking" id="aiPill">
      <div class="ai-dot"></div>
      <span id="aiPillTxt">AI INIT</span>
    </div>
    <div class="live-pill"><div class="ldot"></div>LIVE</div>
    <a class="back-btn" href="javascript:history.back()">‚Üê Dashboard</a>
  </div>
</nav>

<!-- SESSION COUNTDOWN HERO -->
<div class="session-hero">
  <div class="session-inner">
    <div class="session-left">
      <h1>üìÖ Economic Calendar ‚Äî <span id="heroDate">Loading...</span></h1>
      <p>Forex Factory impact data ¬∑ AI pre-session briefing ¬∑ Automation mode ¬∑ MNQ size calculator ¬∑ London session tracking</p>
      <div class="session-tags" id="sessionTags">
        <span class="stag off">Loading session info...</span>
      </div>
    </div>
    <div class="countdown-block">
      <div class="cd-label" id="cdLabel">London Session Opens In</div>
      <div class="cd-time" id="cdTime">--:--:--</div>
      <div class="cd-sub">
        <div class="cd-ny" id="cdNY">NY: ‚Äî EST</div>
        <div class="cd-london" id="cdLondon">London: ‚Äî GMT</div>
      </div>
      <div class="cd-status wait" id="cdStatus">Calculating...</div>
    </div>
  </div>
</div>

<!-- RISK BAR -->
<div class="risk-bar">
  <div class="risk-inner">
    <span class="risk-label">Today's Events</span>
    <div class="risk-stat r"><div class="rsn" id="rRed">‚Äî</div><div class="rsl">üî¥ High</div></div>
    <div class="risk-stat a"><div class="rsn" id="rAmber">‚Äî</div><div class="rsl">üü† Medium</div></div>
    <div class="risk-stat g"><div class="rsn" id="rLow">‚Äî</div><div class="rsl">üü¢ Low</div></div>
    <div class="risk-stat b"><div class="rsn" id="rTotal">‚Äî</div><div class="rsl">Total</div></div>
    <div class="risk-verdict caution" id="riskVerdict">Scanning...</div>
  </div>
</div>

<!-- MODE BAR -->
<div class="mode-bar">
  <div class="mode-inner">
    <span class="mode-lbl">Trading Mode</span>
    <div class="mode-toggle">
      <button class="mode-btn active normal" id="modeNormal" onclick="setMode('normal')">üìä Normal</button>
      <button class="mode-btn auto" id="modeAuto" onclick="setMode('auto')">ü§ñ Automation</button>
    </div>
    <span class="mode-info" id="modeInfo">Standard view ‚Äî all features</span>
    <div class="size-area">
      <span class="sz-lbl">MNQ Contract Size:</span>
      <div class="sz-pills" id="szPills">
        <div class="sz-pill" data-size="1" onclick="setSize(1)">1 MNQ</div>
        <div class="sz-pill active" data-size="2" onclick="setSize(2)">2 MNQ</div>
        <div class="sz-pill" data-size="3" onclick="setSize(3)">3 MNQ</div>
        <div class="sz-pill" data-size="5" onclick="setSize(5)">5 MNQ</div>
        <div class="sz-pill" data-size="10" onclick="setSize(10)">10 MNQ</div>
      </div>
    </div>
  </div>
</div>

<!-- CLOCK STRIP -->
<div class="clock-strip">
  <div class="clock-inner">
    <span class="ck-lbl">Sessions</span>
    <div class="ck-zones" id="clockZones"></div>
  </div>
</div>

<!-- MAIN WRAP -->
<div class="wrap">

<!-- TABS -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('events',this)">üìã Today's Events</div>
  <div class="tab" onclick="switchTab('calendar',this)">üìÖ TV Calendar</div>
  <div class="tab red-tab" onclick="switchTab('auto',this)">ü§ñ Automation Mode</div>
  <div class="tab ai" onclick="switchTab('briefing',this)">‚ö° AI Briefing</div>
  <div class="tab ai" onclick="switchTab('chat',this)">üí¨ AI Chat</div>
  <div class="tab" onclick="switchTab('history',this)">üìä Historical Reactions</div>
  <div class="tab" onclick="switchTab('sources',this)">üîó Sources</div>
  <div class="tab" onclick="switchTab('guide',this)">üìñ Futures Guide</div>
  <div class="tab" onclick="switchTab('debug',this)">üõ† Debug</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: TODAY'S EVENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel-events">

  <div class="red-rule">
    <span style="font-size:1.125rem;flex-shrink:0">‚ö°</span>
    <div><strong>RED FOLDER RULE</strong> <p>Stay flat <strong>15 min before & after</strong> any HIGH impact event. MNQ can spike 50‚Äì150 pts in seconds. AI Briefing runs the full day scan each morning.</p></div>
  </div>

  <!-- AI Scan Strip -->
  <div class="ai-scan-box" id="aiScanBox">
    <div class="ai-scan-head">
      <div class="ai-scan-title">ü§ñ AI Daily Scan ‚Äî <span id="aiScanDate">Loading...</span></div>
      <div style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button class="btn btn-acc" onclick="runAIScan()">‚Üª Re-scan</button>
        <button class="btn btn-ghost" onclick="switchTab('briefing',document.querySelectorAll('.tab')[3])">Full Briefing ‚Üí</button>
      </div>
    </div>
    <div id="aiScanOut"><div class="ai-loading"><div class="ai-spin"></div>Loading today's events and running AI scan...</div></div>
  </div>

  <!-- Forex Factory Events Table -->
  <div class="ff-box">
    <div class="ff-head">
      <div>
        <div class="ff-title">üìã Today's Economic Events <span style="font-size:.5625rem;color:var(--t3);font-weight:400;margin-left:.5rem">via Forex Factory data</span></div>
        <div class="ff-meta" id="ffMeta">Loading Forex Factory events...</div>
      </div>
      <div style="display:flex;align-items:center;gap:.625rem;flex-wrap:wrap">
        <div class="ff-filters">
          <div class="ff-filt f-all on" id="filt-all" onclick="setFilter('all')">All</div>
          <div class="ff-filt f-H" id="filt-H" onclick="setFilter('H')">üî¥ High</div>
          <div class="ff-filt f-M" id="filt-M" onclick="setFilter('M')">üü† Medium</div>
          <div class="ff-filt f-L" id="filt-L" onclick="setFilter('L')">üü¢ Low</div>
        </div>
        <button class="btn btn-ghost" onclick="loadFFEvents()">‚Üª Refresh</button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table class="ff-tbl">
        <thead>
          <tr>
            <th>Time (London/NY)</th>
            <th>Impact</th>
            <th>Event</th>
            <th>Actual</th>
            <th>Forecast</th>
            <th>Previous</th>
            <th>Affects</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="ffTbody">
          <tr><td colspan="8" class="loading-box"><div class="spinner"></div>Loading events...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-grid">
    <div class="chart-card"><div class="cc-title">Today's Impact Distribution</div><div class="cc-sub">High vs Medium vs Low events</div><div class="cc-wrap"><canvas id="chartToday"></canvas></div></div>
    <div class="chart-card"><div class="cc-title">Weekly Event Heat</div><div class="cc-sub">High-impact events per day this week</div><div class="cc-wrap"><canvas id="chartWeek"></canvas></div></div>
    <div class="chart-card"><div class="cc-title">Pre-Session Risk</div><div class="cc-sub">Events in London session window (2:35pm‚Äì8pm LDN)</div><div class="cc-wrap"><canvas id="chartSession"></canvas></div></div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: TV CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-calendar">
  <div class="tv-wrap">
    <div class="tv-head">
      <div class="tv-title">üìÖ TradingView Economic Calendar <span class="tv-badge">REAL-TIME</span></div>
      <span style="font-size:.5625rem;color:var(--t2)">Actual ¬∑ Forecast ¬∑ Previous ¬∑ Impact flags</span>
    </div>
    <div class="tradingview-widget-container">
      <div class="tradingview-widget-container__widget"></div>
      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-events.js" async>
      {"colorTheme":"light","isTransparent":false,"width":"100%","height":"680","locale":"en","importanceFilter":"-1,0,1","countryFilter":"us,eu,gb,jp,ca,au,nz,ch,cn,de,fr"}
      </script>
    </div>
  </div>
  <div class="tip-box">
    <span style="font-size:1.125rem;flex-shrink:0">üí°</span>
    <div><strong>TradingView Calendar</strong> <p>Use this for real-time Actual vs Forecast comparison during releases. Cross-reference with the <strong>Today's Events</strong> tab for your London session risk summary.</p></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: AUTOMATION MODE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-auto">

  <div class="red-rule">
    <span style="font-size:1.125rem;flex-shrink:0">ü§ñ</span>
    <div><strong>Automation Mode</strong> <p>Your automation runs <strong>London time: 2:35pm ‚Äì 8:00pm</strong> (NY: 9:35am ‚Äì 3:00pm EST). The system below shows your session status, MNQ sizing based on today's volatility, and exactly which events fall inside your active window.</p></div>
  </div>

  <!-- Big status cards -->
  <div class="auto-grid">
    <div class="auto-card b">
      <div class="ac-label">‚è± Session Status</div>
      <div class="ac-val" id="autoStatus">WAIT</div>
      <div class="ac-sub" id="autoStatusSub">Calculating...</div>
    </div>
    <div class="auto-card g">
      <div class="ac-label">üìä MNQ Contract Size</div>
      <div class="ac-val" id="autoSize">2</div>
      <div class="ac-sub" id="autoSizeSub">Based on today's risk level</div>
    </div>
    <div class="auto-card r">
      <div class="ac-label">‚ö° Events In Window</div>
      <div class="ac-val" id="autoEventsInWindow">‚Äî</div>
      <div class="ac-sub">High impact events during your session</div>
    </div>
    <div class="auto-card a">
      <div class="ac-label">üéØ Target / Risk</div>
      <div class="ac-val" id="autoTarget">$250</div>
      <div class="ac-sub" id="autoTargetSub">Daily target ¬∑ 1:1 risk</div>
    </div>
  </div>

  <!-- MNQ Size calculator -->
  <div class="size-calc">
    <div class="sc-title">üéØ MNQ Position Sizing ‚Äî 1:1 Risk/Reward</div>
    <div class="sc-grid" id="scGrid">
      <!-- filled by JS -->
    </div>
  </div>

  <!-- Events in window table -->
  <div class="ff-box">
    <div class="ff-head">
      <div>
        <div class="ff-title">üìã Events Inside Your Session Window</div>
        <div class="ff-meta">London 2:35pm‚Äì8pm = NY 9:35am‚Äì3:00pm EST</div>
      </div>
    </div>
    <div class="tbl-wrap">
      <table class="ff-tbl">
        <thead><tr><th>Time (London/NY)</th><th>Impact</th><th>Event</th><th>Affects</th><th>Automation Action</th></tr></thead>
        <tbody id="autoTbody"><tr><td colspan="5" class="loading-box"><div class="spinner"></div>Loading session events...</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- AI session plan -->
  <div class="ai-scan-box">
    <div class="ai-scan-head">
      <div class="ai-scan-title">ü§ñ AI Automation Session Plan</div>
      <button class="btn btn-acc" onclick="generateAutoScan()">‚ö° Generate Session Plan</button>
    </div>
    <div id="autoAIScan"><div style="font-size:.8125rem;color:var(--t3);font-style:italic">Click to generate a session plan tailored for your 2:35pm‚Äì8pm automation window.</div></div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: AI BRIEFING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-briefing">
  <div class="briefing-card">
    <div class="briefing-head">
      <div class="briefing-title">‚ö° AI Pre-Market Briefing <span style="font-size:.6875rem;color:var(--t3);font-weight:400" id="briefingDate"></span></div>
      <button class="btn btn-acc" id="briefingBtn" onclick="generateBriefing()">Generate Full Briefing</button>
    </div>
    <div id="briefingOut" class="briefing-body" style="color:var(--t3);font-style:italic">Click "Generate Full Briefing" for your complete pre-market plan: risk rating, safe windows, MNQ sizing, and today's automation strategy.</div>
  </div>
  <div class="info-grid">
    <div class="ibox blue-b"><div class="ibox-title">üìã Briefing Includes</div><ul class="ilist"><li><span class="idot" style="background:var(--blue)"></span><strong>Daily risk rating</strong> ‚Äî RED/AMBER/GREEN</li><li><span class="idot" style="background:var(--blue)"></span><strong>Events to avoid</strong> ‚Äî exact times</li><li><span class="idot" style="background:var(--blue)"></span><strong>Best trade windows</strong> ‚Äî for automation</li><li><span class="idot" style="background:var(--blue)"></span><strong>MNQ size recommendation</strong> ‚Äî based on volatility</li></ul></div>
    <div class="ibox green-b"><div class="ibox-title">üåæ Session Windows</div><ul class="ilist"><li><span class="idot" style="background:var(--green)"></span><strong>Automation ON:</strong> 2:35pm London / 9:35am NY</li><li><span class="idot" style="background:var(--green)"></span><strong>Automation OFF:</strong> 8:00pm London / 3:00pm NY</li><li><span class="idot" style="background:var(--green)"></span>$250‚Äì$600 daily target range</li><li><span class="idot" style="background:var(--green)"></span>Sizing: 1:1 risk, 100‚Äì600 depending on volatility</li></ul></div>
    <div class="ibox amber-b"><div class="ibox-title">üéØ MNQ Sizing Logic</div><ul class="ilist"><li><span class="idot" style="background:var(--amber)"></span><strong>0 red events</strong> ‚Üí Max size (10 MNQ)</li><li><span class="idot" style="background:var(--amber)"></span><strong>1 red event</strong> ‚Üí Reduce size (5 MNQ)</li><li><span class="idot" style="background:var(--amber)"></span><strong>2+ red events</strong> ‚Üí Min size or skip (1‚Äì2 MNQ)</li><li><span class="idot" style="background:var(--amber)"></span>AI confirms sizing each morning</li></ul></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: AI CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-chat">
  <div class="chat-wrap">
    <div class="chat-box">
      <div class="chat-head">
        <span style="font-size:1.375rem">ü§ñ</span>
        <div><div class="chat-head-txt">Prop Farm AI Analyst</div><div class="chat-head-sub">Ask anything about events, setups, or MNQ automation</div></div>
      </div>
      <div class="chat-msgs" id="chatMessages">
        <div class="msg ai-m"><div class="msg-bub">üëã I'm your Prop Farm AI Analyst. I know your session runs London 2:35pm‚Äì8pm (NY 9:35am‚Äì3pm). Ask me:
‚Ä¢ "Is today safe for automation?"
‚Ä¢ "What MNQ size should I run today?"
‚Ä¢ "What happens to MNQ after hot CPI?"
‚Ä¢ "Give me my session plan for today"
‚Ä¢ "How many points stop on 2 MNQ for $100 risk?"</div><div class="msg-time">Prop Farm AI ¬∑ Ready</div></div>
      </div>
      <div class="chat-in-row">
        <textarea class="chat-in" id="chatInput" rows="1" placeholder="Ask anything about today's events or your session..." onkeydown="handleChatKey(event)"></textarea>
        <button class="chat-send" id="chatSend" onclick="sendChat()">Send ‚Üë</button>
      </div>
    </div>
    <div class="quick-qs">
      <div class="qqs-title">‚ö° Quick Questions</div>
      <button class="qq" onclick="askQ('Is today safe to run my automation from 9:35am to 3pm NY time?')">üîç Is today safe for automation?</button>
      <button class="qq" onclick="askQ('Based on today risk level, what MNQ contract size should I run? I target $250-$600/day at 1:1 risk.')">üìä What MNQ size today?</button>
      <button class="qq" onclick="askQ('What economic events fall inside my NY session window of 9:35am to 3pm EST today?')">üìÖ Events in my session window?</button>
      <button class="qq" onclick="askQ('What typically happens to MNQ/NQ futures after a hot CPI print? How many points move?')">üìà Hot CPI ‚Üí MNQ reaction?</button>
      <button class="qq" onclick="askQ('When exactly do I re-enter MNQ after a major news event like NFP or CPI?')">‚è± Re-entry timing after news?</button>
      <button class="qq" onclick="askQ('Full FOMC day strategy for a prop trader running MNQ automation 9:35am-3pm EST.')">üè¶ FOMC day automation strategy?</button>
      <button class="qq" onclick="askQ('If I run 2 MNQ at 1:1 with a 20 point stop, what is my dollar risk and reward?')">üéØ 2 MNQ risk/reward calc?</button>
      <button class="qq" onclick="askQ('What are the best days of the week to run automation on MNQ with fewest red events?')">üìÜ Best days for automation?</button>
      <button class="qq" onclick="askQ('Explain why markets fake the wrong direction on news releases and how to avoid the trap.')">‚ö†Ô∏è Explain the news trap</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: HISTORICAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-history">
  <div class="tip-box"><span style="font-size:1.125rem;flex-shrink:0">üìñ</span><div><strong>Historical Reactions</strong> <p>"Beat" = actual better than forecast. "Miss" = worse. Initial candle often fakes the wrong direction ‚Äî wait 1‚Äì3 min for confirmation. Best entries 5‚Äì15 min AFTER release.</p></div></div>
  <div class="sdiv"><h3>üî¥ HIGH Impact Events</h3><div class="sdiv-line"></div><div class="sdiv-count">STAY FLAT ¬±15 MIN</div></div>
  <div class="cheat-grid">
    <div class="ccard"><div class="ccard-head red-h"><span style="font-size:1.0625rem">üíº</span><div><div class="cname">Non-Farm Payrolls (NFP)</div><div class="ccsched">1st Friday monthly ¬∑ 8:30am EST</div></div><span class="cfreq">MONTHLY</span></div><table class="ctable"><tr><th>Scenario</th><th>MNQ/NQ Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario up">üü¢ Big Beat</span></td><td class="mixed">Spike UP then often reverses</td><td><span class="ftag up">NQ‚Üë</span><span class="ftag up">ES‚Üë</span><span class="ftag down">ZB‚Üì</span></td><td class="up">62%</td></tr><tr><td><span class="scenario down">üî¥ Big Miss</span></td><td class="down">Hard drop, may recover</td><td><span class="ftag down">NQ‚Üì</span><span class="ftag down">ES‚Üì</span><span class="ftag up">GC‚Üë</span></td><td class="down">71%</td></tr><tr><td><span class="scenario mixed">üü° In-Line</span></td><td class="mixed">Low vol, watch wages</td><td><span class="ftag">NQ‚Üí</span><span class="ftag">ES‚Üí</span></td><td class="mixed">55%</td></tr></table></div>
    <div class="ccard"><div class="ccard-head red-h"><span style="font-size:1.0625rem">üìà</span><div><div class="cname">CPI / Core CPI</div><div class="ccsched">~12th monthly ¬∑ 8:30am EST</div></div><span class="cfreq">MONTHLY</span></div><table class="ctable"><tr><th>Scenario</th><th>MNQ/NQ Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario down">üî¥ Hot CPI</span></td><td class="down">Hard sell-off ‚Äî rate hike fears</td><td><span class="ftag down">NQ‚Üì‚Üì</span><span class="ftag up">GC‚Üë</span><span class="ftag down">ZB‚Üì</span></td><td class="down">74%</td></tr><tr><td><span class="scenario up">üü¢ Cool CPI</span></td><td class="up">Strong rally ‚Äî NQ leads</td><td><span class="ftag up">NQ‚Üë‚Üë</span><span class="ftag up">GC‚Üë</span><span class="ftag up">ZB‚Üë</span></td><td class="up">78%</td></tr><tr><td><span class="scenario mixed">üü° In-Line</span></td><td class="mixed">Whipsaw ‚Äî wait for confirm</td><td><span class="ftag">NQ‚Üí</span></td><td class="mixed">52%</td></tr></table></div>
    <div class="ccard"><div class="ccard-head red-h"><span style="font-size:1.0625rem">üè¶</span><div><div class="cname">FOMC Rate Decision</div><div class="ccsched">8x per year ¬∑ 2:00pm EST</div></div><span class="cfreq">8x/YEAR</span></div><table class="ctable"><tr><th>Scenario</th><th>MNQ/NQ Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario up">üü¢ Rate Cut / Dovish</span></td><td class="up">Massive rally ‚Äî NQ leads</td><td><span class="ftag up">NQ‚Üë‚Üë‚Üë</span><span class="ftag up">GC‚Üë</span></td><td class="up">82%</td></tr><tr><td><span class="scenario down">üî¥ Rate Hike / Hawkish</span></td><td class="down">Hard sell ‚Äî watch Powell</td><td><span class="ftag down">NQ‚Üì‚Üì</span></td><td class="down">79%</td></tr><tr><td><span class="scenario mixed">üü° Hold</span></td><td class="mixed">Statement drives real move</td><td><span class="ftag">NQ‚Üï</span></td><td class="mixed">varies</td></tr></table></div>
    <div class="ccard"><div class="ccard-head amber-h"><span style="font-size:1.0625rem">üìã</span><div><div class="cname">Initial Jobless Claims</div><div class="ccsched">Thursdays ¬∑ 8:30am EST</div></div><span class="cfreq">WEEKLY</span></div><table class="ctable"><tr><th>Scenario</th><th>MNQ/NQ Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario down">üî¥ High Claims</span></td><td class="down">Mild sell ‚Äî labor weakening</td><td><span class="ftag down">NQ‚Üì</span><span class="ftag down">ES‚Üì</span></td><td class="down">57%</td></tr><tr><td><span class="scenario up">üü¢ Low Claims</span></td><td class="up">Mild rally ‚Äî strong labor</td><td><span class="ftag up">NQ‚Üë</span><span class="ftag up">ES‚Üë</span></td><td class="up">58%</td></tr></table></div>
    <div class="ccard"><div class="ccard-head amber-h"><span style="font-size:1.0625rem">üõ¢Ô∏è</span><div><div class="cname">EIA Crude Oil Inventories</div><div class="ccsched">Wednesdays ¬∑ 10:30am EST</div></div><span class="cfreq">WEEKLY</span></div><table class="ctable"><tr><th>Scenario</th><th>CL Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario down">üî¥ Build</span></td><td class="down">CL sells off</td><td><span class="ftag down">CL‚Üì‚Üì</span><span class="ftag">NQ‚Üí</span></td><td class="down">68%</td></tr><tr><td><span class="scenario up">üü¢ Draw</span></td><td class="up">CL rallies</td><td><span class="ftag up">CL‚Üë‚Üë</span><span class="ftag">NQ‚Üí</span></td><td class="up">70%</td></tr></table></div>
    <div class="ccard"><div class="ccard-head red-h"><span style="font-size:1.0625rem">üåç</span><div><div class="cname">GDP (Advance)</div><div class="ccsched">Quarterly ¬∑ 8:30am EST</div></div><span class="cfreq">QUARTERLY</span></div><table class="ctable"><tr><th>Scenario</th><th>MNQ/NQ Reaction</th><th>Futures</th><th>%</th></tr><tr><td><span class="scenario up">üü¢ Beat</span></td><td class="up">Initial rally ‚Äî watch for fade</td><td><span class="ftag up">NQ‚Üë</span><span class="ftag down">GC‚Üì</span></td><td class="up">59%</td></tr><tr><td><span class="scenario down">üî¥ Miss</span></td><td class="down">Sell-off</td><td><span class="ftag down">NQ‚Üì</span><span class="ftag up">ZB‚Üë</span></td><td class="down">65%</td></tr></table></div>
  </div>
  <div class="info-grid">
    <div class="ibox blue-b"><div class="ibox-title">üìÖ Best Days for Automation</div><ul class="ilist"><li><span class="idot" style="background:var(--green)"></span><strong>Tuesday & Wednesday</strong> ‚Äî fewest red events, cleanest trends</li><li><span class="idot" style="background:var(--amber)"></span><strong>Thursday</strong> ‚Äî wait until after Claims 8:30am EST</li><li><span class="idot" style="background:var(--red)"></span><strong>NFP Friday</strong> ‚Äî reduce size or skip</li><li><span class="idot" style="background:var(--red)"></span><strong>FOMC Day</strong> ‚Äî avoid all day or reduce to 1 MNQ</li></ul></div>
    <div class="ibox red-b"><div class="ibox-title">‚ö†Ô∏è The News Trap</div><ul class="ilist"><li><span class="idot" style="background:var(--red)"></span>Initial candle often fakes wrong direction</li><li><span class="idot" style="background:var(--red)"></span>"Good news" can still drop if already priced in</li><li><span class="idot" style="background:var(--amber)"></span>Wait 1‚Äì3 min candle close for confirmation</li><li><span class="idot" style="background:var(--green)"></span>Best entries 5‚Äì15 min AFTER release</li></ul></div>
    <div class="ibox green-b"><div class="ibox-title">üåæ Prop Farm Strategy</div><ul class="ilist"><li><span class="idot" style="background:var(--green)"></span>Check calendar the night before</li><li><span class="idot" style="background:var(--green)"></span>Generate AI Briefing before session starts</li><li><span class="idot" style="background:var(--amber)"></span>Reduce MNQ size on red event days</li><li><span class="idot" style="background:var(--blue)"></span>Use AI Chat for event-specific plans</li></ul></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: SOURCES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-sources">
  <div class="src-grid">
    <div class="src-card"><div class="src-head"><div class="icon">üè≠</div><div><div class="src-name">Forex Factory</div><div class="src-desc">Primary data source for this calendar</div></div></div><div class="src-body">The gold standard for traders. Red/Orange/Yellow flags, Actual vs Forecast vs Previous, release times, and currency filtering.</div><div class="src-foot"><a class="btn-src" href="https://www.forexfactory.com/calendar" target="_blank">üè≠ Open Forex Factory</a></div></div>
    <div class="src-card"><div class="src-head"><div class="icon">üìä</div><div><div class="src-name">Investing.com</div><div class="src-desc">Economic calendar + analysis</div></div></div><div class="src-body">Full calendar with historical charts per event, country filtering, and real-time actual vs forecast comparison.</div><div class="src-foot"><a class="btn-src" href="https://www.investing.com/economic-calendar/" target="_blank">Open Calendar</a></div></div>
    <div class="src-card"><div class="src-head"><div class="icon">üì°</div><div><div class="src-name">CME FedWatch</div><div class="src-desc">Fed rate probability tool</div></div></div><div class="src-body">Market-implied probability of Fed rate decisions. Essential before FOMC meetings. Use to gauge hawkish/dovish expectations.</div><div class="src-foot"><a class="btn-src" href="https://www.cmegroup.com/markets/interest-rates/cme-fedwatch-tool.html" target="_blank">Open FedWatch</a></div></div>
    <div class="src-card"><div class="src-head"><div class="icon">üèõÔ∏è</div><div><div class="src-name">BLS.gov</div><div class="src-desc">Official US data releases</div></div></div><div class="src-body">Official source for NFP, CPI, PPI, Jobless Claims. Release calendar available months in advance. Zero lag on release times.</div><div class="src-foot"><a class="btn-src" href="https://www.bls.gov/schedule/news_release/ecopro.htm" target="_blank">Release Calendar</a></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: FUTURES GUIDE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-guide">
  <div class="sdiv"><h3>‚ö° MNQ / NQ Futures Event Impact Guide</h3><div class="sdiv-line"></div></div>
  <div class="qrtable-wrap"><div class="qrhead"><span class="qrtitle">Event ‚Üí MNQ Impact Reference</span></div><div style="overflow-x:auto"><table class="qr"><tr><th>Event</th><th>Impact</th><th>When (EST)</th><th>Affects</th><th>MNQ Move</th><th>Automation Action</th></tr><tr><td><strong>FOMC Rate Decision</strong></td><td><span class="ipill H">HIGH</span></td><td>8x/year 2pm</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">ES</span><span class="ft">GC</span><span class="ft">ZB</span></div></td><td class="down"><strong>100‚Äì400 pts</strong></td><td class="down"><strong>SHUT DOWN ALL DAY</strong></td></tr><tr><td><strong>Non-Farm Payrolls</strong></td><td><span class="ipill H">HIGH</span></td><td>1st Fri 8:30am</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">ES</span><span class="ft">GC</span></div></td><td class="down"><strong>80‚Äì250 pts</strong></td><td class="down"><strong>REDUCE to 1 MNQ</strong></td></tr><tr><td><strong>CPI / Core CPI</strong></td><td><span class="ipill H">HIGH</span></td><td>~12th 8:30am</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">GC</span><span class="ft">ZB</span></div></td><td class="down"><strong>80‚Äì200 pts</strong></td><td class="down"><strong>REDUCE to 1 MNQ</strong></td></tr><tr><td><strong>GDP (Advance)</strong></td><td><span class="ipill H">HIGH</span></td><td>Quarterly 8:30am</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">ZB</span></div></td><td class="mixed"><strong>40‚Äì120 pts</strong></td><td class="down"><strong>REDUCE size</strong></td></tr><tr><td><strong>Initial Jobless Claims</strong></td><td><span class="ipill M">MEDIUM</span></td><td>Thu 8:30am</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">ES</span></div></td><td class="mixed"><strong>15‚Äì50 pts</strong></td><td class="mixed">MONITOR ‚Äî slight reduce</td></tr><tr><td><strong>ISM PMI</strong></td><td><span class="ipill M">MEDIUM</span></td><td>1st biz day 10am</td><td><div class="futs"><span class="ft">MNQ</span><span class="ft">NQ</span><span class="ft">CL</span></div></td><td class="mixed"><strong>20‚Äì60 pts</strong></td><td class="mixed">MONITOR</td></tr><tr><td><strong>EIA Crude Oil</strong></td><td><span class="ipill M">MEDIUM</span></td><td>Wed 10:30am</td><td><div class="futs"><span class="ft">CL</span><span class="ft">RB</span></div></td><td class="up"><strong>Low MNQ impact</strong></td><td class="ok">NORMAL SIZE</td></tr></table></div></div>
  <div class="info-grid" style="grid-template-columns:repeat(auto-fill,minmax(220px,1fr))">
    <div class="ibox blue-b"><div class="ibox-title">üìå MNQ Facts</div><ul class="ilist"><li><span class="idot" style="background:var(--blue)"></span><strong>MNQ</strong> = Micro Nasdaq 100</li><li><span class="idot" style="background:var(--blue)"></span>1 point = <strong>$2.00</strong> per contract</li><li><span class="idot" style="background:var(--blue)"></span>10 MNQ = 1 NQ (standard)</li><li><span class="idot" style="background:var(--blue)"></span>1:1 on 2 MNQ = $100/100 risk/reward</li><li><span class="idot" style="background:var(--amber)"></span>20pt stop on 2 MNQ = $80 risk</li></ul></div>
    <div class="ibox amber-b"><div class="ibox-title">üïê Key Times EST</div><ul class="ilist"><li><span class="idot" style="background:var(--red)"></span><strong>8:30am</strong> ‚Äî Most US data</li><li><span class="idot" style="background:var(--amber)"></span><strong>9:30am</strong> ‚Äî NYSE open</li><li><span class="idot" style="background:var(--cyan)"></span><strong>9:35am</strong> ‚Äî Your automation ON</li><li><span class="idot" style="background:var(--amber)"></span><strong>10:00am</strong> ‚Äî ISM, Consumer data</li><li><span class="idot" style="background:var(--amber)"></span><strong>10:30am</strong> ‚Äî EIA Oil (Wed)</li><li><span class="idot" style="background:var(--red)"></span><strong>2:00pm</strong> ‚Äî FOMC Decision</li><li><span class="idot" style="background:var(--cyan)"></span><strong>3:00pm</strong> ‚Äî Your automation OFF</li></ul></div>
    <div class="ibox green-b"><div class="ibox-title">üí° Pro Tips</div><ul class="ilist"><li><span class="idot" style="background:var(--green)"></span>MNQ $2/point ‚Äî 50pt stop = $100 risk</li><li><span class="idot" style="background:var(--green)"></span>NQ moves ~2x more than ES on news</li><li><span class="idot" style="background:var(--amber)"></span>Check 1hr before session for late additions</li><li><span class="idot" style="background:var(--blue)"></span>High VIX = reduce size regardless of events</li></ul></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: DEBUG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-debug">
  <div class="dbg-panel">
    <div class="dbg-header">
      <div class="dbg-title">üõ† AI Proxy Debugger</div>
      <div class="dbg-controls">
        <button class="dbg-btn run" onclick="dbgPing()">‚ñ∂ Ping</button>
        <button class="dbg-btn run" onclick="dbgTestAI()">ü§ñ Test AI</button>
        <button class="dbg-btn" onclick="dbgClear()">üóë Clear</button>
      </div>
    </div>
    <div class="dbg-body">
      <div class="dbg-pane">
        <div class="dbg-pane-title">Connection Status</div>
        <div class="dbg-kv">
          <div class="dbg-row"><span class="dbg-key">Proxy URL</span><span class="dbg-val" id="ds-url">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">Origin</span><span class="dbg-val" id="ds-origin">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">Reachable</span><span class="dbg-val" id="ds-reach">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">Status Code</span><span class="dbg-val" id="ds-code">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">CORS</span><span class="dbg-val" id="ds-cors">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">AI Response</span><span class="dbg-val" id="ds-ai">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">Model</span><span class="dbg-val" id="ds-model">‚Äî</span></div>
          <div class="dbg-row"><span class="dbg-key">Last Check</span><span class="dbg-val" id="ds-time">‚Äî</span></div>
        </div>
        <div class="dbg-test-result" id="dbgTestOut">Click ‚ñ∂ Ping or ü§ñ Test AI to run diagnostics...</div>
      </div>
      <div class="dbg-pane">
        <div class="dbg-pane-title">Live Request Log</div>
        <div class="dbg-log" id="dbgLog">
          <div class="dbg-entry info"><span class="ts">INIT</span>Debugger ready</div>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- /.wrap -->

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROXY_URL   = 'https://plain-mouse-96e3.killiumgaming1.workers.dev';
const FINNHUB_KEY = 'd6a0pr9r01qsjlb99n50d6a0pr9r01qsjlb99n5g';

// Session: London 2:35pm‚Äì8pm = NY 9:35am‚Äì3:00pm EST
// In UTC: 14:35‚Äì20:00 (winter, GMT+0) / 13:35‚Äì19:00 (summer, BST = UTC+1)
const SESSION_START_LON_H = 14; // 2pm London
const SESSION_START_LON_M = 35;
const SESSION_END_LON_H   = 20; // 8pm London
const SESSION_END_LON_M   = 0;
// NY equivalent (UTC-5 winter, UTC-4 summer)
const SESSION_START_NY    = '9:35 AM';
const SESSION_END_NY      = '3:00 PM';

const SYSTEM_PROP = `You are an expert prop futures trading analyst for Prop Farm Pro. The user trades MNQ (Micro Nasdaq 100 futures) ‚Äî 1 point = $2. They run automation London session: 2:35pm‚Äì8:00pm London time (9:35am‚Äì3:00pm EST). Daily target $250‚Äì$600, using 1:1 risk/reward. Sizing: 1‚Äì10 MNQ depending on volatility. Red events (HIGH impact) = reduce size or stop automation. Keep answers concise, specific to MNQ, and actionable. Always mention specific point moves and dollar amounts for MNQ.`;

let currentMode  = 'normal';
let currentSize  = 2;
let activeFilter = 'all';
let ffEvents     = [];
let chartsBuilt  = false;
let chatHistory  = [];
let dbgReqN      = 0;

// ‚îÄ‚îÄ AI PROXY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setAIPill(state, txt) {
  const p = document.getElementById('aiPill');
  const t = document.getElementById('aiPillTxt');
  p.className = 'ai-pill ' + state;
  t.textContent = txt;
}

async function callAI(userMsg, maxTokens = 600, history = []) {
  if (!PROXY_URL || PROXY_URL.includes('PASTE')) {
    return '‚öôÔ∏è Configure PROXY_URL in the script to enable AI features.';
  }
  const messages = history.length ? history : [{ role: 'user', content: userMsg }];
  dbgLog('info', `‚Üí AI #${++dbgReqN}: "${userMsg.substring(0,55)}‚Ä¶"`);
  try {
    const t0  = Date.now();
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages, max_tokens: maxTokens, system: SYSTEM_PROP }),
    });
    const ms  = Date.now() - t0;
    if (!res.ok) {
      const e = await res.json().catch(() => ({}));
      dbgLog('err', `‚Üê ${res.status} after ${ms}ms`);
      dbgSetVal('ds-code', res.status, 'err');
      if (res.status === 403) return '‚ùå CORS blocked ‚Äî update ALLOWED_ORIGIN in Worker to: ' + window.location.origin;
      if (res.status === 429) return '‚è≥ Rate limited ‚Äî wait 60 seconds.';
      return `‚ùå Error ${res.status}: ${e.error || 'Unknown'}`;
    }
    const data  = await res.json();
    const text  = data.content?.[0]?.text || '(no response)';
    const model = data.model || '‚Äî';
    dbgLog('ok', `‚Üê OK ${ms}ms ¬∑ ${model}`);
    dbgSetVal('ds-ai', '‚úÖ Working', 'ok');
    dbgSetVal('ds-model', model.split('/').pop(), 'ok');
    dbgSetVal('ds-code', 200, 'ok');
    dbgSetVal('ds-time', new Date().toLocaleTimeString());
    return text;
  } catch(err) {
    dbgLog('err', `‚Üê Network: ${err.message}`);
    dbgSetVal('ds-reach', '‚ùå Failed', 'err');
    return '‚ùå Cannot reach proxy: ' + err.message;
  }
}

// ‚îÄ‚îÄ INIT PROXY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initProxy() {
  setAIPill('checking', 'AI INIT');
  dbgSetVal('ds-url', PROXY_URL || 'NOT SET', !PROXY_URL ? 'err' : '');
  dbgSetVal('ds-origin', window.location.origin);
  if (!PROXY_URL || PROXY_URL.includes('PASTE')) {
    setAIPill('err', 'NOT SET'); return;
  }
  try {
    const t0  = Date.now();
    const res = await fetch(PROXY_URL, { method: 'GET' });
    const ms  = Date.now() - t0;
    dbgSetVal('ds-code', res.status, res.ok ? 'ok' : 'err');
    dbgSetVal('ds-reach', res.ok ? `‚úÖ ${ms}ms` : `‚ö†Ô∏è ${res.status}`, res.ok ? 'ok' : 'warn');
    const cors = res.headers.get('access-control-allow-origin');
    dbgSetVal('ds-cors', cors ? `‚úÖ ${cors}` : '‚ö†Ô∏è Missing', cors ? 'ok' : 'warn');
    dbgSetVal('ds-time', new Date().toLocaleTimeString());
    setAIPill(res.ok ? 'ok' : 'err', res.ok ? 'AI READY' : 'AI ERROR');
    dbgLog(res.ok ? 'ok' : 'warn', `Proxy ${res.status} in ${ms}ms`);
  } catch(e) {
    setAIPill('err', 'NO REACH');
    dbgSetVal('ds-reach', '‚ùå ' + e.message, 'err');
    dbgLog('err', 'Proxy unreachable: ' + e.message);
  }
}

// ‚îÄ‚îÄ FOREX FACTORY EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// FF blocks direct scraping. We use a CORS proxy to fetch & parse their JSON feed.
// Fallback: generate a realistic event list via AI if FF is blocked.

const FF_CORS = 'https://corsproxy.io/?https://nfs.faireconomy.media/ff_calendar_thisweek.json';

const HIGH_KW  = ['nonfarm','nfp','payroll','fomc','federal reserve','cpi','consumer price index','core cpi','ppi','producer price','gdp','gross domestic product','unemployment rate','jobs report','employment change','interest rate decision','inflation','rate decision','monetary policy','non-farm'];
const MED_KW   = ['jobless claims','initial claims','ism manufacturing','ism services','pmi','retail sales','housing starts','consumer confidence','durable goods','trade balance','industrial production','manufacturing','services pmi','composite pmi','pending home','existing home','building permits','eia','oil inventories','crude oil','powell speaks','lagarde','consumer sentiment'];
const FUT_MAP  = {
  'nonfarm|nfp|payroll': ['MNQ','NQ','ES','YM','GC','ZB'],
  'cpi|inflation|consumer price': ['MNQ','NQ','GC','ZB','CL'],
  'fomc|federal reserve|interest rate|monetary policy|rate decision': ['MNQ','NQ','ES','YM','GC','ZB'],
  'gdp|gross domestic': ['MNQ','NQ','ES','ZB'],
  'ism|pmi|manufacturing|services': ['MNQ','NQ','ES','CL'],
  'jobless|initial claims|unemployment': ['MNQ','NQ','ES'],
  'crude|eia|oil inventories': ['CL','RB'],
  'gold': ['GC','SI'],
};

function classImpact(name, impact) {
  // Use FF's own impact level if available, else classify
  if (impact === 'High') return 'H';
  if (impact === 'Medium') return 'M';
  if (impact === 'Low' || impact === 'Non-Economic') return 'L';
  const t = name.toLowerCase();
  if (HIGH_KW.some(k => t.includes(k))) return 'H';
  if (MED_KW.some(k => t.includes(k)))  return 'M';
  return 'L';
}

function getFutures(name) {
  const t = name.toLowerCase();
  for (const [pattern, futs] of Object.entries(FUT_MAP)) {
    if (pattern.split('|').some(k => t.includes(k))) return futs;
  }
  return ['MNQ','NQ','ES'];
}

// Convert UTC timestamp to London and NY time strings
function toTimezones(dateStr) {
  if (!dateStr) return { lon: '‚Äî', ny: '‚Äî', utcH: -1, utcM: 0 };
  try {
    const d = new Date(dateStr);
    const lon = d.toLocaleTimeString('en-GB', { timeZone: 'Europe/London', hour: '2-digit', minute: '2-digit', hour12: false });
    const ny  = d.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: 'numeric', minute: '2-digit', hour12: true });
    const lonParts = lon.split(':');
    return { lon, ny, utcH: d.getUTCHours(), utcM: d.getUTCMinutes(), lonH: parseInt(lonParts[0]), lonM: parseInt(lonParts[1]) };
  } catch(e) {
    return { lon: '‚Äî', ny: '‚Äî', utcH: -1, utcM: 0 };
  }
}

// Check if event falls inside London session window (14:35‚Äì20:00 London)
function isInSession(times) {
  if (times.lonH < 0) return false;
  const mins = times.lonH * 60 + times.lonM;
  const start = SESSION_START_LON_H * 60 + SESSION_START_LON_M;
  const end   = SESSION_END_LON_H   * 60 + SESSION_END_LON_M;
  return mins >= start && mins <= end;
}

function isPassed(dateStr) {
  if (!dateStr) return false;
  return new Date(dateStr) < new Date();
}

function isNext(events, idx) {
  const now = new Date();
  for (let i = 0; i < events.length; i++) {
    if (events[i].date && new Date(events[i].date) > now) return i === idx;
  }
  return false;
}

async function loadFFEvents() {
  document.getElementById('ffTbody').innerHTML = '<tr><td colspan="8" class="loading-box"><div class="spinner"></div>Fetching Forex Factory data...</td></tr>';
  document.getElementById('autoTbody').innerHTML = '<tr><td colspan="5" class="loading-box"><div class="spinner"></div>Fetching events...</td></tr>';

  let events = [];
  let source  = 'FF';

  try {
    const res  = await fetch(FF_CORS, { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (!Array.isArray(data) || !data.length) throw new Error('Empty response');

    // Filter to today only (compare in New York timezone)
    const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    events = data.filter(e => {
      if (!e.date) return false;
      const d = new Date(e.date).toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
      return d === today;
    }).map(e => ({
      name:     e.title   || e.name || 'Unknown',
      currency: e.country || e.currency || 'USD',
      impact:   classImpact(e.title || '', e.impact || ''),
      actual:   e.actual   || '',
      forecast: e.forecast || '',
      previous: e.previous || '',
      date:     e.date     || '',
      times:    toTimezones(e.date),
      futures:  getFutures(e.title || ''),
    }));

    dbgLog('ok', `Forex Factory: ${events.length} events loaded for today`);
    source = 'Forex Factory';
  } catch(err) {
    dbgLog('warn', `FF failed (${err.message}), using built-in data`);
    events = getBuiltInEvents();
    source = 'Built-in (FF blocked)';
  }

  // Sort by time
  events.sort((a, b) => {
    const ta = a.date ? new Date(a.date).getTime() : 0;
    const tb = b.date ? new Date(b.date).getTime() : 0;
    return ta - tb;
  });

  ffEvents = events;

  // Update stats
  const reds   = events.filter(e => e.impact === 'H').length;
  const ambers = events.filter(e => e.impact === 'M').length;
  const lows   = events.filter(e => e.impact === 'L').length;
  document.getElementById('rRed').textContent   = reds;
  document.getElementById('rAmber').textContent = ambers;
  document.getElementById('rLow').textContent   = lows;
  document.getElementById('rTotal').textContent = events.length;

  const verdict = document.getElementById('riskVerdict');
  if (reds >= 3)    { verdict.textContent = `üî¥ DANGER ‚Äî ${reds} red events`; verdict.className = 'risk-verdict danger'; }
  else if (reds>=2) { verdict.textContent = `üî¥ HIGH RISK ‚Äî ${reds} red events`; verdict.className = 'risk-verdict danger'; }
  else if (reds===1){ verdict.textContent = 'üü† CAUTION ‚Äî 1 high-impact event'; verdict.className = 'risk-verdict caution'; }
  else if (ambers>=2){ verdict.textContent = `üü° MODERATE ‚Äî ${ambers} medium events`; verdict.className = 'risk-verdict caution'; }
  else              { verdict.textContent = 'üü¢ CLEAR ‚Äî Good automation day'; verdict.className = 'risk-verdict clear'; }

  document.getElementById('ffMeta').textContent = `${events.length} events ¬∑ Source: ${source} ¬∑ Updated ${new Date().toLocaleTimeString()}`;

  renderFFTable(events);
  renderAutoTable(events);
  buildCharts(reds, ambers, lows, events);
  updateAutoCards(reds, ambers);
  runAIScan();
}

function renderFFTable(events) {
  const filtered = activeFilter === 'all' ? events : events.filter(e => e.impact === activeFilter);
  if (!filtered.length) {
    document.getElementById('ffTbody').innerHTML = '<tr><td colspan="8" class="empty-row">No events match the current filter.</td></tr>';
    return;
  }
  document.getElementById('ffTbody').innerHTML = filtered.map((e, i) => {
    const globalIdx = events.indexOf(e);
    const passed  = isPassed(e.date);
    const next    = isNext(events, globalIdx);
    const inSess  = isInSession(e.times);
    const rowCls  = (passed ? 'PASSED ' : '') + (next ? 'NEXT ' : '') + (e.impact === 'H' ? 'is-H' : e.impact === 'M' ? 'is-M' : '');
    const act     = e.impact === 'H' ? '<span class="act-cell avoid">üî¥ AVOID ¬±15min</span>' : e.impact === 'M' ? '<span class="act-cell caution">üü† Reduce size</span>' : '<span class="act-cell ok">üü¢ OK to trade</span>';
    const beatCls = e.actual && e.forecast ? (parseFloat(e.actual.replace(/[^0-9.-]/g,'')) > parseFloat(e.forecast.replace(/[^0-9.-]/g,'')) ? 'beat' : 'miss') : '';
    const futs    = (inSess ? e.futures : e.futures).map(f => `<span class="ft${e.impact==='H'&&['MNQ','NQ','ES'].includes(f)?' hot':''}">${f}</span>`).join('');
    return `<tr class="${rowCls.trim()}">
      <td class="t-cell">
        ${e.times.lon !== '‚Äî' ? e.times.lon : '‚Äî'}<br>
        <span class="ny">${e.times.ny}</span>
        ${inSess ? '<br><span class="ny" style="color:var(--amber);font-size:.45rem">‚ö° IN YOUR SESSION</span>' : ''}
        ${next ? '<span class="next-tag">‚ñ∂ NEXT</span>' : ''}
        ${passed ? '<span class="pass-tag">‚úì passed</span>' : ''}
      </td>
      <td><div class="imp-badge ${e.impact}"><div class="imp-dot ${e.impact}"></div>${e.impact==='H'?'HIGH':e.impact==='M'?'MED':'LOW'}</div></td>
      <td><span class="ev-name">${esc(e.name)}</span><span class="ev-cur">${esc(e.currency)}</span></td>
      <td class="num-cell ${beatCls}">${e.actual || '<span style="color:var(--t3)">‚Äî</span>'}</td>
      <td class="forecast-cell">${e.forecast || '<span style="color:var(--t3)">‚Äî</span>'}</td>
      <td class="prev-cell">${e.previous || '<span style="color:var(--t3)">‚Äî</span>'}</td>
      <td><div class="ft-cell">${futs}</div></td>
      <td>${act}</td>
    </tr>`;
  }).join('');
}

function renderAutoTable(events) {
  const sessEvents = events.filter(e => isInSession(e.times));
  if (!sessEvents.length) {
    document.getElementById('autoTbody').innerHTML = '<tr><td colspan="5" class="empty-row">üü¢ No events in your session window today ‚Äî automation can run freely</td></tr>';
    document.getElementById('autoEventsInWindow').textContent = '0';
    return;
  }
  const highInSess = sessEvents.filter(e => e.impact === 'H').length;
  document.getElementById('autoEventsInWindow').textContent = highInSess;
  document.getElementById('autoTbody').innerHTML = sessEvents.map(e => {
    const passed = isPassed(e.date);
    const autoAct = e.impact === 'H'
      ? '<span class="act-cell avoid">üõë STOP automation ¬±15min</span>'
      : e.impact === 'M'
      ? '<span class="act-cell caution">‚ö†Ô∏è Reduce to 1 MNQ</span>'
      : '<span class="act-cell ok">‚úÖ Run normally</span>';
    const futs = e.futures.map(f => `<span class="ft">${f}</span>`).join('');
    return `<tr class="${passed?'PASSED':''}">
      <td class="t-cell">${e.times.lon}<br><span class="ny">${e.times.ny}</span></td>
      <td><div class="imp-badge ${e.impact}"><div class="imp-dot ${e.impact}"></div>${e.impact==='H'?'HIGH':e.impact==='M'?'MED':'LOW'}</div></td>
      <td><span class="ev-name">${esc(e.name)}</span><span class="ev-cur">${esc(e.currency)}</span></td>
      <td><div class="ft-cell">${futs}</div></td>
      <td>${autoAct}</td>
    </tr>`;
  }).join('');
}

function setFilter(f) {
  activeFilter = f;
  document.querySelectorAll('.ff-filt').forEach(el => {
    el.classList.remove('on');
    const cls = el.classList.contains(`f-${f}`) || (f==='all' && el.classList.contains('f-all'));
    if (cls) el.classList.add('on');
  });
  renderFFTable(ffEvents);
}

// ‚îÄ‚îÄ BUILT-IN EVENTS (fallback when FF is blocked) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getBuiltInEvents() {
  const now  = new Date();
  const base = new Date(now);
  base.setHours(0, 0, 0, 0);
  function ev(hLon, mLon, name, cur, imp, forecast, prev) {
    // Convert London time to UTC (rough: London = UTC during winter, UTC+1 summer)
    const lonOffset = isDST() ? 1 : 0;
    const utcH = hLon - lonOffset;
    const d = new Date(base);
    d.setUTCHours(utcH, mLon, 0, 0);
    return { name, currency: cur, impact: classImpact(name, imp), actual: '', forecast, previous: prev, date: d.toISOString(), times: toTimezones(d.toISOString()), futures: getFutures(name) };
  }
  function isDST() { const d = new Date(); return d.getMonth() > 2 && d.getMonth() < 10; }

  const dow = now.getDay(); // 0=Sun, 1=Mon...
  const events = [];

  // Common weekly events
  events.push(ev(13, 30, 'Initial Jobless Claims', 'USD', 'Medium', '220K', '218K'));
  events.push(ev(15, 0,  'S&P Global Composite PMI', 'USD', 'Medium', '52.5', '52.0'));

  if (dow === 5) { // Friday
    events.push(ev(13, 30, 'Non-Farm Payrolls', 'USD', 'High', '190K', '175K'));
    events.push(ev(13, 30, 'Unemployment Rate', 'USD', 'High', '3.9%', '3.9%'));
  }
  if (dow === 3) { // Wednesday
    events.push(ev(15, 30, 'EIA Crude Oil Inventories', 'USD', 'Medium', '-1.2M', '0.8M'));
  }
  if (dow === 2) { // Tuesday
    events.push(ev(14, 30, 'CPI m/m', 'USD', 'High', '0.3%', '0.2%'));
    events.push(ev(14, 30, 'Core CPI m/m', 'USD', 'High', '0.3%', '0.3%'));
  }
  // Always add some low events
  events.push(ev(14, 0,  'Fed Member Speech', 'USD', 'Low', '', ''));
  events.push(ev(16, 0,  'Consumer Confidence', 'USD', 'Medium', '102.5', '101.8'));

  return events.sort((a,b) => new Date(a.date) - new Date(b.date));
}

// ‚îÄ‚îÄ AI SCAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runAIScan() {
  const out = document.getElementById('aiScanOut');
  out.innerHTML = '<div class="ai-loading"><div class="ai-spin"></div>AI scanning today\'s events for your session...</div>';
  document.getElementById('aiScanDate').textContent = new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long' });

  if (!ffEvents.length) {
    out.innerHTML = '<div style="color:var(--t3);font-size:.8125rem;font-style:italic">Load events first, then re-run AI scan.</div>';
    return;
  }

  const reds  = ffEvents.filter(e => e.impact === 'H');
  const ambs  = ffEvents.filter(e => e.impact === 'M');
  const sesEv = ffEvents.filter(e => isInSession(e.times));
  const redInSess = sesEv.filter(e => e.impact === 'H');

  const evList = ffEvents.map(e => `${e.times.ny} ‚Äî [${e.impact}] ${e.name} (${e.currency})`).join('\n');
  const prompt = `Today's economic events:\n${evList}\n\nMy session: NY 9:35am‚Äì3pm EST (London 2:35pm‚Äì8pm).\nEvents in my window: ${sesEv.map(e=>e.name).join(', ') || 'None'}.\nHigh impact in window: ${redInSess.map(e=>e.name).join(', ') || 'None'}.\n\nGive me a quick scan (under 200 words):\n1. üö¶ TODAY'S RISK LEVEL (Red/Amber/Green) ‚Äî one sentence why\n2. ‚ö†Ô∏è KEY EVENTS TO AVOID (times and names)\n3. ‚úÖ SAFE WINDOWS in my 9:35am‚Äì3pm session\n4. üìä RECOMMENDED MNQ SIZE for today\n5. ‚ö° ONE KEY THING TO WATCH\n\nBe direct and specific. Use ‚óè for bullets.`;

  const result = await callAI(prompt, 350);
  const fmt = result
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br>');
  out.innerHTML = `<div class="ai-scan-body">${fmt}</div>`;
}

async function generateAutoScan() {
  const out = document.getElementById('autoAIScan');
  out.innerHTML = '<div class="ai-loading"><div class="ai-spin"></div>Generating automation session plan...</div>';

  const sesEv = ffEvents.filter(e => isInSession(e.times));
  const reds  = sesEv.filter(e => e.impact === 'H');
  const prompt = `My automation trades MNQ (Micro Nasdaq) from 9:35am‚Äì3pm EST (London 2:35pm‚Äì8pm).\nI use 1:1 risk/reward. Target: $250‚Äì$600/day. Current size: ${currentSize} MNQ.\nToday's events in window:\n${sesEv.map(e=>`‚Ä¢ ${e.times.ny} [${e.impact}] ${e.name}`).join('\n') || '‚Ä¢ None'}\n\nGenerate a specific automation session plan:\n1. üö¶ SESSION RATING (Go / Caution / Skip)\n2. üìä RECOMMENDED MNQ SIZE and why\n3. ‚è± PAUSE WINDOWS (exact NY times to stop automation)\n4. ‚úÖ BEST TRADE WINDOWS in my session\n5. üéØ REALISTIC TARGET for today given risk level\n6. üîë ONE RULE for today\n\nFormat clearly with headers. Be specific about times and dollar amounts.`;

  const result = await callAI(prompt, 450);
  const fmt = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  out.innerHTML = `<div class="ai-scan-body">${fmt}</div>`;
}

// ‚îÄ‚îÄ AI BRIEFING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generateBriefing() {
  const btn = document.getElementById('briefingBtn');
  const out = document.getElementById('briefingOut');
  btn.disabled = true; btn.textContent = '‚è≥ Generating...';
  out.innerHTML = ''; out.className = '';
  out.innerHTML = '<div class="bload"><div class="bspin"></div>AI generating your pre-market briefing...</div>';

  const day   = new Date().toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  const reds  = ffEvents.filter(e => e.impact === 'H');
  const sesEv = ffEvents.filter(e => isInSession(e.times));
  const evList = ffEvents.length ? ffEvents.map(e => `${e.times.ny} [${e.impact}] ${e.name}`).join('\n') : 'No event data loaded';

  const prompt = `Today: ${day}\nAll events:\n${evList}\nMy session: 9:35am‚Äì3pm EST\nCurrent MNQ size: ${currentSize}\n\nFull pre-market briefing for MNQ prop trader:\n\n1. üìä DAILY RISK RATING ‚Äî Red/Amber/Green with explanation\n2. ‚è∞ AVOID WINDOWS ‚Äî specific EST times and events (stay flat ¬±15min)\n3. ‚úÖ BEST TRADE WINDOWS ‚Äî specific EST time ranges\n4. üìà MNQ SIZING RECOMMENDATION ‚Äî how many contracts and why\n5. üéØ DAILY TARGET ‚Äî realistic P&L target given today's conditions\n6. ü§ñ AUTOMATION GUIDANCE ‚Äî should I run it? Modifications needed?\n7. ‚ö° KEY THING TO WATCH ‚Äî one market indicator or event\n\nFormat with clear emoji headers. Be direct and practical. Include specific EST times and MNQ point values.`;

  const result = await callAI(prompt, 700);
  btn.disabled = false; btn.textContent = '‚Üª Regenerate Briefing';
  const fmt = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
  out.innerHTML = fmt;
  out.className = 'briefing-body';
}

// ‚îÄ‚îÄ MODE + SIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(m) {
  currentMode = m;
  document.getElementById('modeNormal').classList.toggle('active', m === 'normal');
  document.getElementById('modeNormal').classList.toggle('normal', m === 'normal');
  document.getElementById('modeAuto').classList.toggle('active', m === 'auto');
  document.getElementById('modeAuto').classList.toggle('auto', m === 'auto');
  document.getElementById('modeInfo').textContent = m === 'normal' ? 'Standard view ‚Äî all features' : 'ü§ñ Automation view ‚Äî session-focused';
  if (m === 'auto') switchTab('auto', document.querySelectorAll('.tab')[2]);
}

function setSize(n) {
  currentSize = n;
  document.querySelectorAll('.sz-pill').forEach(p => p.classList.toggle('active', parseInt(p.dataset.size) === n));
  document.getElementById('autoSize').textContent = n;
  document.getElementById('autoSizeSub').textContent = `${n} MNQ ¬∑ $${n*2}/point ¬∑ target $${Math.round(n*2*50)}+/day`;
  buildSizeCalc(n);
}

function buildSizeCalc(n) {
  const grid = document.getElementById('scGrid');
  const stops = [10, 20, 25, 30, 50];
  grid.innerHTML = stops.map(pts => {
    const risk    = n * 2 * pts;
    const reward  = risk; // 1:1
    const rateHML = pts <= 15 ? 'b' : pts <= 25 ? 'g' : pts <= 35 ? 'a' : 'r';
    return `<div class="sc-row ${rateHML}">
      <div class="sc-label">${pts} Point Stop</div>
      <div class="sc-val">$${risk}</div>
      <div class="sc-hint">${n} MNQ ¬∑ $${risk} risk<br>$${reward} reward (1:1)</div>
    </div>`;
  }).join('');
}

function updateAutoCards(reds, ambers) {
  // Recommend size based on risk
  let recSize = 10;
  if (reds >= 3) recSize = 1;
  else if (reds >= 2) recSize = 2;
  else if (reds === 1) recSize = 5;
  else if (ambers >= 2) recSize = 7;

  document.getElementById('autoSize').textContent = recSize;
  document.getElementById('autoSizeSub').textContent = reds >= 2 ? `Reduced ‚Äî ${reds} red events today` : reds === 1 ? `Cautious ‚Äî 1 red event in window` : `Clear day ‚Äî full size recommended`;
  document.getElementById('autoTarget').textContent = `$${recSize * 50}`;
  document.getElementById('autoTargetSub').textContent = `~50pt target ¬∑ ${recSize} MNQ ¬∑ 1:1`;
  buildSizeCalc(recSize);
}

// ‚îÄ‚îÄ SESSION COUNTDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCountdown() {
  const now  = new Date();
  const lon  = now.toLocaleTimeString('en-GB', { timeZone: 'Europe/London', hour12: false });
  const ny   = now.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  const lonH = parseInt(lon.split(':')[0]);
  const lonM = parseInt(lon.split(':')[1]);
  const lonS = parseInt(lon.split(':')[2]);
  const lonTotalS = lonH * 3600 + lonM * 60 + lonS;
  const startS    = SESSION_START_LON_H * 3600 + SESSION_START_LON_M * 60;
  const endS      = SESSION_END_LON_H   * 3600 + SESSION_END_LON_M   * 60;

  const cdTime   = document.getElementById('cdTime');
  const cdStatus = document.getElementById('cdStatus');
  const cdLabel  = document.getElementById('cdLabel');
  const cdNY     = document.getElementById('cdNY');
  const cdLondon = document.getElementById('cdLondon');

  cdNY.textContent     = `NY: ${now.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: true })} EST`;
  cdLondon.textContent = `London: ${lon.substring(0,5)} GMT`;

  if (lonTotalS < startS) {
    // Before session
    const diff = startS - lonTotalS;
    const hh = Math.floor(diff / 3600);
    const mm = Math.floor((diff % 3600) / 60);
    const ss = diff % 60;
    cdTime.textContent = `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    cdLabel.textContent = 'Session Starts In (London 2:35pm)';
    cdStatus.textContent = '‚è≥ WAITING ‚Äî Automation not yet running';
    cdStatus.className = 'cd-status wait';
  } else if (lonTotalS >= startS && lonTotalS < endS) {
    // In session
    const diff = endS - lonTotalS;
    const hh = Math.floor(diff / 3600);
    const mm = Math.floor((diff % 3600) / 60);
    const ss = diff % 60;
    cdTime.textContent = `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    cdLabel.textContent = 'Session Ends In (London 8:00pm)';
    cdStatus.textContent = '‚úÖ LIVE ‚Äî Automation window open';
    cdStatus.className = 'cd-status live';
  } else {
    // After session
    cdTime.textContent = '--:--:--';
    cdLabel.textContent = 'Session Complete';
    cdStatus.textContent = 'üî¥ CLOSED ‚Äî Session ended';
    cdStatus.className = 'cd-status done';
  }

  updateSessionHeroTags(lonTotalS, startS, endS);
}

function pad(n) { return String(n).padStart(2,'0'); }

function updateSessionHeroTags(lonNow, startS, endS) {
  const reds = ffEvents.filter(e => e.impact === 'H').length;
  const tags = [];
  if (lonNow >= startS && lonNow < endS) tags.push('<span class="stag on">üü¢ Automation LIVE</span>');
  else if (lonNow < startS) tags.push(`<span class="stag warn">‚è≥ Starts at 2:35pm London</span>`);
  else tags.push('<span class="stag off">üî¥ Session Ended</span>');
  tags.push(`<span class="stag ${reds>=2?'hot':reds>=1?'warn':'on'}">üî¥ ${reds} High Impact Events</span>`);
  tags.push('<span class="stag off">üá∫üá∏ USD ¬∑ üá™üá∫ EUR ¬∑ üá¨üáß GBP</span>');
  tags.push('<span class="stag off">MNQ 2:35pm‚Äì8pm London</span>');
  document.getElementById('sessionTags').innerHTML = tags.join('');
}

// ‚îÄ‚îÄ CLOCKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ZONES = [
  { id:'ny',     flag:'üá∫üá∏', label:'NY EST',    tz:'America/New_York',  openH:9,  closeH:16 },
  { id:'london', flag:'üá¨üáß', label:'LDN GMT',   tz:'Europe/London',     openH:8,  closeH:17 },
  { id:'frank',  flag:'üá™üá∫', label:'FRA CET',   tz:'Europe/Berlin',     openH:7,  closeH:15 },
  { id:'tokyo',  flag:'üáØüáµ', label:'TKY JST',   tz:'Asia/Tokyo',        openH:0,  closeH:6  },
  { id:'sydney', flag:'üá¶üá∫', label:'SYD AEST',  tz:'Australia/Sydney',  openH:22, closeH:7  },
  { id:'utc',    flag:'üåê', label:'UTC',         tz:'UTC',               openH:-1, closeH:-1 },
];
function isMarketOpen(z) {
  if (z.openH < 0) return false;
  const nowH = new Date().toLocaleTimeString('en-GB', { timeZone: z.tz, hour12: false }).split(':')[0] * 1;
  return z.openH < z.closeH ? (nowH >= z.openH && nowH < z.closeH) : (nowH >= z.openH || nowH < z.closeH);
}
function buildClocks() {
  document.getElementById('clockZones').innerHTML = ZONES.map(z =>
    `<div class="ck-zone" id="ckz-${z.id}"><span class="ck-flag">${z.flag}</span><div><div class="ck-time" id="ckt-${z.id}">--:--</div><div class="ck-name"><span class="sdot" id="cks-${z.id}"></span>${z.label}</div></div></div>`
  ).join('');
}
function updateClocks() {
  const now = new Date();
  ZONES.forEach(z => {
    const el = document.getElementById('ckt-' + z.id); if (!el) return;
    el.textContent = now.toLocaleTimeString('en-US', { timeZone: z.tz, hour:'2-digit', minute:'2-digit', hour12:false });
    const op = isMarketOpen(z);
    document.getElementById('cks-' + z.id).className = 'sdot' + (op ? ' open' : '');
    document.getElementById('ckz-' + z.id).className = 'ck-zone' + (op ? ' open' : '');
  });
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let charts = {};
function buildCharts(r, a, l, events) {
  if (charts.today) charts.today.destroy();
  if (charts.week)  charts.week.destroy();
  if (charts.sess)  charts.sess.destroy();

  const cfg = { responsive:true, maintainAspectRatio:false, plugins: { legend: { labels: { color:'#7c8ba1', font:{size:11} } } } };
  charts.today = new Chart(document.getElementById('chartToday'), { type:'doughnut', data: { labels:['High','Medium','Low'], datasets:[{ data:[r||.1,a||.1,l||.1], backgroundColor:['#ef4444','#f59e0b','#10b981'], borderWidth:2, borderColor:'#fff' }] }, options:{ ...cfg, cutout:'65%' } });
  charts.week  = new Chart(document.getElementById('chartWeek'), { type:'bar', data: { labels:['Mon','Tue','Wed','Thu','Fri'], datasets:[ { label:'High', data:[0,0,0,2,2], backgroundColor:'#ff3d3d', borderRadius:4 }, { label:'Med', data:[1,2,2,1,1], backgroundColor:'#ffb020', borderRadius:4 } ] }, options:{ ...cfg, scales:{ x:{ stacked:true, grid:{color:'#e2e8f0'}, ticks:{color:'#64748b'} }, y:{ stacked:true, grid:{color:'#e2e8f0'}, ticks:{color:'#64748b',stepSize:1} } } } });
  const sessHigh = events.filter(e => isInSession(e.times) && e.impact === 'H').length;
  const sessMed  = events.filter(e => isInSession(e.times) && e.impact === 'M').length;
  const sessLow  = events.filter(e => isInSession(e.times) && e.impact === 'L').length;
  const outsideH = r - sessHigh;
  charts.sess  = new Chart(document.getElementById('chartSession'), { type:'doughnut', data: { labels:['High In Session','Med In Session','Low In Session','Outside Session'], datasets:[{ data:[sessHigh||.1,sessMed||.1,sessLow||.1,outsideH||.1], backgroundColor:['#ef4444','#f59e0b','#10b981','#e2e8f0'], borderWidth:2, borderColor:'#fff' }] }, options:{ ...cfg, cutout:'60%' } });
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleChatKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); } }
async function sendChat() {
  const inp = document.getElementById('chatInput');
  const msg = inp.value.trim(); if (!msg) return;
  inp.value = '';
  addMsg('user', msg);
  chatHistory.push({ role: 'user', content: msg });
  if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
  const btn = document.getElementById('chatSend'); btn.disabled = true;
  addMsg('ai-m', '‚è≥ Thinking...', true);
  const reply = await callAI(msg, 600, chatHistory);
  chatHistory.push({ role: 'assistant', content: reply });
  if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
  replaceLastMsg(reply);
  btn.disabled = false;
}
function askQ(q) { document.getElementById('chatInput').value = q; sendChat(); }
function addMsg(role, text, isLoading=false) {
  const box = document.getElementById('chatMessages');
  const d = document.createElement('div');
  d.className = `msg ${role}${isLoading?' loading':''}`;
  const t = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false });
  d.innerHTML = `<div class="msg-bub">${text}</div><div class="msg-time">${role==='user'?'You':'Prop Farm AI'} ¬∑ ${t}</div>`;
  box.appendChild(d); box.scrollTop = box.scrollHeight;
}
function replaceLastMsg(text) {
  const box = document.getElementById('chatMessages');
  const all = box.querySelectorAll('.msg.ai-m');
  if (!all.length) { addMsg('ai-m', text); return; }
  const last = all[all.length-1];
  last.classList.remove('loading');
  last.querySelector('.msg-bub').textContent = text;
  box.scrollTop = box.scrollHeight;
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(id, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  if (el) el.classList.add('active');
  else document.querySelectorAll('.tab').forEach(t => { if (t.getAttribute('onclick')?.includes(`'${id}'`)) t.classList.add('active'); });
  const p = document.getElementById('panel-' + id); if (p) p.classList.add('active');
  if (id === 'briefing') document.getElementById('briefingDate').textContent = new Date().toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long' });
}

// ‚îÄ‚îÄ DEBUGGER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dbgLog(type, msg) {
  const log = document.getElementById('dbgLog');
  const d   = document.createElement('div');
  d.className = 'dbg-entry ' + type;
  const ts  = new Date().toLocaleTimeString('en-GB', { hour12:false });
  d.innerHTML = `<span class="ts">${ts}</span>${msg}`;
  log.appendChild(d); log.scrollTop = log.scrollHeight;
}
function dbgSetVal(id, val, cls) {
  const el = document.getElementById(id); if (!el) return;
  el.textContent = val; el.className = 'dbg-val' + (cls ? ' '+cls : '');
}
function dbgClear() { document.getElementById('dbgLog').innerHTML = ''; dbgLog('info','Log cleared'); }
async function dbgPing() {
  document.getElementById('dbgTestOut').className = 'dbg-test-result';
  document.getElementById('dbgTestOut').textContent = '‚è≥ Pinging...';
  try {
    const t0 = Date.now();
    const res = await fetch(PROXY_URL, { method:'GET' });
    const ms  = Date.now()-t0;
    const data = await res.json().catch(()=>({}));
    document.getElementById('dbgTestOut').textContent = `Status: ${res.status}\nTime: ${ms}ms\nBody: ${JSON.stringify(data,null,2)}`;
    document.getElementById('dbgTestOut').className = 'dbg-test-result '+(res.ok?'ok':'err');
    dbgSetVal('ds-code', res.status, res.ok?'ok':'err');
    dbgSetVal('ds-time', new Date().toLocaleTimeString());
    dbgLog(res.ok?'ok':'warn', `Ping ${res.status} in ${ms}ms`);
  } catch(e) {
    document.getElementById('dbgTestOut').textContent = '‚ùå ' + e.message;
    document.getElementById('dbgTestOut').className = 'dbg-test-result err';
    dbgLog('err', 'Ping failed: '+e.message);
  }
}
async function dbgTestAI() {
  document.getElementById('dbgTestOut').className = 'dbg-test-result';
  document.getElementById('dbgTestOut').textContent = '‚è≥ Testing AI...';
  const r = await callAI('Reply with exactly: PROP FARM AI CONNECTED ‚úÖ', 30);
  const ok = r.includes('CONNECTED') || r.includes('‚úÖ');
  document.getElementById('dbgTestOut').textContent = r;
  document.getElementById('dbgTestOut').className = 'dbg-test-result '+(ok?'ok':'err');
  setAIPill(ok?'ok':'err', ok?'AI READY':'AI ERROR');
}

// ‚îÄ‚îÄ UTIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('heroDate').textContent = new Date().toLocaleDateString('en-GB', { weekday:'long', day:'numeric', month:'long', year:'numeric' });

buildClocks();
setInterval(() => { updateClocks(); updateCountdown(); }, 1000);
updateClocks();
updateCountdown();
buildSizeCalc(currentSize);

initProxy().then(() => loadFFEvents());
</script>
</body>
</html>
