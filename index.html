<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Farm Pro ‚Äî Supabase Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0e1a;
            --bg-card: #0f1629;
            --bg-elevated: #1a2035;
            --bg-hover: #1e2844;
            --border: rgba(99,179,237,0.12);
            --border-glow: rgba(99,179,237,0.3);
            --text: #e8f0ff;
            --text-muted: #7a8bb5;
            --text-dim: #3d4f78;
            --accent: #3b7ef8;
            --accent-glow: rgba(59,126,248,0.25);
            --accent-hover: #5a95ff;
            --success: #22d3a0;
            --success-glow: rgba(34,211,160,0.2);
            --danger: #f05c6a;
            --danger-glow: rgba(240,92,106,0.2);
            --warning: #f5a623;
            --warning-glow: rgba(245,166,35,0.2);
            --purple: #9b6ffa;
            --cyan: #06d6d6;
            --gold: #ffd166;
            --radius: 14px;
            --radius-sm: 8px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 40px rgba(59,126,248,0.15);
        }

        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; min-height: 100vh; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-glow); border-radius: 3px; }

        /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
        .auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: flex-start; justify-content: center; z-index: 9999; transition: opacity 0.4s ease; overflow-y: auto; padding: 1.5rem 1rem; }
        .auth-screen.hidden { opacity: 0; pointer-events: none; display: none !important; }
        .auth-bg { position: fixed; inset: 0; background: radial-gradient(ellipse 80% 60% at 50% -20%, rgba(59,126,248,0.15) 0%, transparent 70%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(155,111,250,0.1) 0%, transparent 60%); pointer-events: none; }
        .auth-grid { position: fixed; inset: 0; background-image: linear-gradient(rgba(99,179,237,0.04) 1px, transparent 1px), linear-gradient(90deg, rgba(99,179,237,0.04) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 30%, transparent 100%); pointer-events: none; }
        .auth-box { position: relative; z-index: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 3rem; width: 460px; max-width: 95vw; box-shadow: var(--shadow), 0 0 60px rgba(59,126,248,0.08); margin: auto; align-self: flex-start; }
        .auth-logo { text-align: center; margin-bottom: 2rem; }
        .auth-logo .logo-icon { font-size: 3rem; display: block; margin-bottom: 0.75rem; filter: drop-shadow(0 0 20px rgba(59,126,248,0.6)); }
        .auth-logo h1 { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.03em; background: linear-gradient(135deg, #e8f0ff 0%, #7ab4ff 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-logo p { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }
        .auth-tabs { display: flex; background: var(--bg-elevated); border-radius: var(--radius-sm); padding: 4px; margin-bottom: 2rem; gap: 4px; }
        .auth-tab { flex: 1; padding: 0.5rem; border: none; border-radius: 6px; font-family: inherit; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: transparent; color: var(--text-muted); }
        .auth-tab.active { background: var(--accent); color: white; box-shadow: 0 0 12px var(--accent-glow); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .forgot-link { text-align: right; margin-top: -0.75rem; margin-bottom: 1rem; }
        .forgot-link a { color: var(--accent); font-size: 0.8rem; text-decoration: none; cursor: pointer; }
        .forgot-link a:hover { text-decoration: underline; }

        /* ‚îÄ‚îÄ FORM BASICS ‚îÄ‚îÄ */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin-bottom: 0.5rem; }
        .form-input { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-input::placeholder { color: var(--text-dim); }
        .form-input:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-select { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; transition: all 0.2s; cursor: pointer; }
        .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-select option { background: var(--bg-elevated); }
        .form-textarea { width: 100%; padding: 0.875rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9375rem; min-height: 100px; resize: vertical; transition: all 0.2s; }
        .form-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; margin-bottom: 1.25rem; }
        .form-footer { display: flex; gap: 0.75rem; padding-top: 1.25rem; border-top: 1px solid var(--border); }
        .checkbox-label { display: flex; align-items: center; gap: 0.625rem; cursor: pointer; font-size: 0.9rem; }
        .checkbox-label input[type=checkbox] { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn { padding: 0.875rem 1.5rem; border: none; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 0 20px var(--accent-glow); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 0 30px rgba(59,126,248,0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary.full-width { width: 100%; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--border-glow); }
        .btn-danger { background: var(--danger-glow); color: var(--danger); border: 1px solid rgba(240,92,106,0.3); }
        .btn-danger:hover { background: rgba(240,92,106,0.3); }
        .btn-oauth { width: 100%; background: var(--bg-elevated); color: var(--text); border: 1px solid var(--border); margin-bottom: 0.75rem; }
        .btn-oauth:hover { border-color: var(--border-glow); background: var(--bg-hover); }
        .btn-success { background: rgba(34,211,160,0.15); color: var(--success); border: 1px solid rgba(34,211,160,0.3); }
        .btn-success:hover { background: rgba(34,211,160,0.25); }

        /* ‚îÄ‚îÄ MESSAGES ‚îÄ‚îÄ */
        .auth-error { background: var(--danger-glow); border: 1px solid rgba(240,92,106,0.3); color: var(--danger); padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .auth-error.show { display: block; }
        .auth-success { background: var(--success-glow); border: 1px solid rgba(34,211,160,0.3); color: var(--success); padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .auth-success.show { display: block; }
        .divider { display: flex; align-items: center; gap: 1rem; margin: 1.25rem 0; color: var(--text-dim); font-size: 0.8rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.show { display: flex; }

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        .sidebar { width: 260px; flex-shrink: 0; background: var(--bg-card); border-right: 1px solid var(--border); height: 100vh; position: sticky; top: 0; overflow-y: auto; padding: 1.5rem 1rem; display: flex; flex-direction: column; transition: transform 0.3s ease; z-index: 200; }
        .sidebar-logo { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; margin-bottom: 1.5rem; }
        .sidebar-logo .logo-em { font-size: 1.75rem; filter: drop-shadow(0 0 8px rgba(59,126,248,0.5)); }
        .sidebar-logo h2 { font-size: 1.125rem; font-weight: 700; letter-spacing: -0.02em; background: linear-gradient(135deg, #e8f0ff, #7ab4ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .user-chip { display: flex; align-items: center; gap: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 0.75rem; margin-bottom: 1.5rem; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem; flex-shrink: 0; overflow: hidden; }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .user-info { overflow: hidden; }
        .user-name { font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-role { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .user-role.admin { color: var(--gold); }
        .nav-section { margin-bottom: 1.5rem; }
        .nav-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); padding: 0 0.75rem; margin-bottom: 0.5rem; }
        .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.15s; font-weight: 500; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-elevated); color: var(--text); }
        .nav-item.active { background: rgba(59,126,248,0.15); color: var(--accent); border: 1px solid rgba(59,126,248,0.2); }
        .nav-item .nav-icon { font-size: 1.1rem; width: 20px; text-align: center; }
        .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
        .logout-btn { width: 100%; padding: 0.625rem 0.75rem; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: var(--text-muted); font-family: inherit; font-size: 0.9rem; font-weight: 500; border-radius: var(--radius-sm); transition: all 0.15s; }
        .logout-btn:hover { background: var(--danger-glow); color: var(--danger); }

        /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
        .main { flex: 1; overflow-x: hidden; min-width: 0; }
        .topbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .page-title { font-size: 1.375rem; font-weight: 700; letter-spacing: -0.02em; }
        .menu-btn { display: none; background: none; border: none; cursor: pointer; color: var(--text); font-size: 1.5rem; }
        .topbar-right { display: flex; align-items: center; gap: 0.75rem; }
        .icon-btn { width: 38px; height: 38px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--text-muted); }
        .icon-btn:hover { border-color: var(--border-glow); color: var(--text); }
        .container { padding: 2rem; max-width: 1600px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 150; }
        .overlay.show { display: block; }

        /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
        .page { display: none; }
        .page.active { display: block; }

        /* ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ */
        .alert { padding: 1rem 1.25rem; border-radius: var(--radius-sm); font-size: 0.9rem; font-weight: 500; margin-bottom: 1.5rem; display: none; animation: slideDown 0.3s ease; }
        .alert.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .alert-success { background: var(--success-glow); border: 1px solid rgba(34,211,160,0.3); color: var(--success); }
        .alert-error { background: var(--danger-glow); border: 1px solid rgba(240,92,106,0.3); color: var(--danger); }
        .alert-info { background: var(--accent-glow); border: 1px solid rgba(59,126,248,0.3); color: #7ab4ff; }
        .alert-warning { background: var(--warning-glow); border: 1px solid rgba(245,166,35,0.3); color: var(--warning); }

        /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
        .hero { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; position: relative; overflow: hidden; }
        .hero-glow { position: absolute; top: -60px; right: -60px; width: 300px; height: 300px; background: radial-gradient(circle, rgba(59,126,248,0.12) 0%, transparent 70%); pointer-events: none; }
        .hero-greeting { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .hero-title { font-size: 2rem; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 1.5rem; }
        .hero-title span { background: linear-gradient(135deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero-stats { display: flex; gap: 2.5rem; flex-wrap: wrap; }
        .hero-stat-value { font-size: 1.75rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; }
        .hero-stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }

        /* ‚îÄ‚îÄ METRICS ‚îÄ‚îÄ */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; transition: all 0.2s; }
        .metric-card:hover { border-color: var(--border-glow); transform: translateY(-2px); box-shadow: var(--shadow-glow); }
        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .metric-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); }
        .metric-icon { font-size: 1.25rem; }
        .metric-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em; margin-bottom: 0.25rem; }
        .metric-sub { font-size: 0.8rem; color: var(--text-muted); }
        .metric-sub.pos { color: var(--success); }
        .metric-sub.neg { color: var(--danger); }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); }
        .card-title { font-size: 1rem; font-weight: 700; letter-spacing: -0.01em; }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
        .card-body { padding: 1.5rem; }
        .chart-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .chart-grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .chart-wrap { position: relative; height: 260px; }
        .chart-wrap-sm { position: relative; height: 200px; }

        /* ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }

        /* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .action-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 1rem; }
        .action-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px var(--accent-glow); }
        .action-icon { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
        .action-icon.blue { background: rgba(59,126,248,0.15); }
        .action-icon.green { background: rgba(34,211,160,0.15); }
        .action-icon.purple { background: rgba(155,111,250,0.15); }
        .action-icon.gold { background: rgba(255,209,102,0.15); }
        .action-icon.teal { background: rgba(6,214,214,0.15); }
        .action-info h4 { font-size: 0.875rem; font-weight: 700; margin-bottom: 0.2rem; }
        .action-info p { font-size: 0.75rem; color: var(--text-muted); }

        /* ‚îÄ‚îÄ ACCOUNT CARDS ‚îÄ‚îÄ */
        .accounts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .acc-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem; transition: all 0.2s; }
        .acc-card:hover { border-color: var(--border-glow); transform: translateY(-2px); }
        .acc-card.at-risk { border-color: rgba(240,92,106,0.4); background: rgba(240,92,106,0.03); }
        .acc-card.warning-card { border-color: rgba(245,166,35,0.4); }
        .acc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .acc-num { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .acc-nickname { font-size: 0.75rem; color: var(--cyan); font-weight: 500; margin-top: 2px; }
        .badge { padding: 0.3rem 0.65rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-success { background: rgba(34,211,160,0.15); color: var(--success); }
        .badge-active { background: rgba(59,126,248,0.15); color: var(--accent); }
        .badge-danger { background: var(--danger-glow); color: var(--danger); }
        .badge-warning { background: var(--warning-glow); color: var(--warning); }
        .badge-muted { background: rgba(122,139,181,0.15); color: var(--text-muted); }
        .badge-admin { background: rgba(255,209,102,0.15); color: var(--gold); }
        .acc-progress { margin-bottom: 1rem; }
        .prog-header { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.4rem; }
        .prog-bar { height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; }
        .prog-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.5s ease; }
        .prog-fill.red { background: linear-gradient(90deg, var(--danger), #c0392b); }
        .acc-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .acc-stat-lbl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.2rem; }
        .acc-stat-val { font-size: 1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .acc-name-edit { display: flex; align-items: center; gap: 0.4rem; margin-top: 0.5rem; }
        .acc-name-input { flex: 1; padding: 0.3rem 0.6rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 5px; color: var(--text); font-size: 0.8rem; font-family: inherit; }
        .acc-name-input:focus { outline: none; border-color: var(--accent); }

        /* ‚îÄ‚îÄ TEMPLATE CARDS ‚îÄ‚îÄ */
        .templates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .tmpl-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; transition: all 0.2s; }
        .tmpl-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .tmpl-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem; }
        .tmpl-icon { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
        .tmpl-name { font-size: 1.05rem; font-weight: 700; }
        .tmpl-desc { font-size: 0.8rem; color: var(--text-muted); }
        .tmpl-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; text-align: center; }
        .tmpl-stat-val { font-size: 1.3rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .tmpl-stat-lbl { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); }
        .tmpl-details { border-top: 1px solid var(--border); padding-top: 1rem; display: grid; gap: 0.5rem; }
        .tmpl-row { display: flex; justify-content: space-between; font-size: 0.85rem; }
        .tmpl-row span:first-child { color: var(--text-muted); }
        .tmpl-row span:last-child { font-weight: 600; font-family: 'JetBrains Mono', monospace; }

        /* ‚îÄ‚îÄ FORM CARD ‚îÄ‚îÄ */
        .form-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; max-width: 900px; }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .table-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.75rem; }
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 0.75rem 1.25rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); background: var(--bg-elevated); border-bottom: 1px solid var(--border); white-space: nowrap; }
        td { padding: 0.875rem 1.25rem; border-bottom: 1px solid rgba(99,179,237,0.06); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: var(--bg-hover); }

        /* ‚îÄ‚îÄ FILTER PILLS ‚îÄ‚îÄ */
        .filter-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
        .pill { padding: 0.4rem 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.15s; color: var(--text-muted); }
        .pill:hover { border-color: var(--border-glow); color: var(--text); }
        .pill.active { background: rgba(59,126,248,0.15); border-color: rgba(59,126,248,0.4); color: var(--accent); }

        /* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
        .admin-banner { background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(155,111,250,0.1)); border: 1px solid rgba(255,209,102,0.3); border-radius: var(--radius); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .admin-banner-icon { font-size: 1.5rem; }
        .admin-banner-text strong { color: var(--gold); display: block; font-size: 0.875rem; }
        .admin-banner-text span { color: var(--text-muted); font-size: 0.8rem; }
        .admin-view-banner { background: rgba(155,111,250,0.1); border: 1px solid rgba(155,111,250,0.3); border-radius: var(--radius-sm); padding: 0.75rem 1.25rem; margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .admin-view-banner span { color: var(--purple); font-size: 0.875rem; }

        /* ‚îÄ‚îÄ RISK INFO ‚îÄ‚îÄ */
        .risk-info { margin-top: 0.75rem; padding: 0.625rem; border-radius: var(--radius-sm); font-size: 0.8rem; font-weight: 500; }
        .risk-info.safe { background: rgba(34,211,160,0.1); color: var(--success); }
        .risk-info.warning { background: var(--warning-glow); color: var(--warning); }
        .risk-info.danger { background: var(--danger-glow); color: var(--danger); }

        /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 0.75rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .spinner { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-state { display: flex; align-items: center; justify-content: center; padding: 4rem; color: var(--text-muted); flex-direction: column; gap: 1rem; }
        .loading-state .spinner { border-top-color: var(--accent); border-color: rgba(59,126,248,0.3); width: 32px; height: 32px; border-width: 3px; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        /* ‚îÄ‚îÄ PSYCHOLOGY PAGE STYLES ‚îÄ‚îÄ */
        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        .psych-hero { background: linear-gradient(135deg, rgba(155,111,250,0.15), rgba(59,126,248,0.1)); border: 1px solid rgba(155,111,250,0.25); border-radius: 20px; padding: 2.5rem; margin-bottom: 1.5rem; text-align: center; position: relative; overflow: hidden; }
        .psych-hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse 60% 60% at 50% 0%, rgba(155,111,250,0.15) 0%, transparent 70%); }
        .psych-hero-emoji { font-size: 3.5rem; display: block; margin-bottom: 1rem; filter: drop-shadow(0 0 20px rgba(155,111,250,0.5)); position: relative; }
        .psych-hero-title { font-size: 1.75rem; font-weight: 700; letter-spacing: -0.03em; margin-bottom: 0.5rem; position: relative; }
        .psych-hero-subtitle { color: var(--text-muted); font-size: 0.9rem; position: relative; }
        .daily-quote-card { background: linear-gradient(135deg, rgba(59,126,248,0.1), rgba(155,111,250,0.08)); border: 1px solid rgba(155,111,250,0.3); border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; text-align: center; position: relative; }
        .daily-quote-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--purple); margin-bottom: 1rem; }
        .daily-quote-text { font-size: 1.25rem; font-weight: 500; line-height: 1.6; color: var(--text); margin-bottom: 1rem; font-style: italic; }
        .daily-quote-author { font-size: 0.85rem; color: var(--text-muted); }
        .quote-nav { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 1rem; }
        .quote-nav-btn { width: 36px; height: 36px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; color: var(--text-muted); }
        .quote-nav-btn:hover { border-color: var(--purple); color: var(--purple); }
        .quote-counter { font-size: 0.8rem; color: var(--text-dim); font-family: 'JetBrains Mono', monospace; }
        .psych-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .psych-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; }
        .psych-card-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem; }
        .psych-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .psych-card-title { font-size: 1rem; font-weight: 700; }
        .rule-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .rule-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: var(--radius-sm); }
        .rule-num { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; color: white; }
        .rule-text { font-size: 0.875rem; color: var(--text-muted); line-height: 1.5; }
        .mood-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .mood-btn { padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; text-align: center; font-size: 1.5rem; transition: all 0.15s; }
        .mood-btn:hover { border-color: var(--accent); transform: scale(1.05); }
        .mood-btn.selected { border-color: var(--accent); background: rgba(59,126,248,0.15); }
        .mood-label { font-size: 0.65rem; color: var(--text-muted); display: block; margin-top: 0.3rem; font-family: inherit; }
        .affirmation-list { display: flex; flex-direction: column; gap: 0.625rem; }
        .affirmation-item { padding: 0.75rem 1rem; background: var(--bg-elevated); border-left: 3px solid var(--purple); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-size: 0.875rem; color: var(--text-muted); }
        .checklist-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-elevated); border-radius: var(--radius-sm); margin-bottom: 0.5rem; cursor: pointer; transition: all 0.15s; }
        .checklist-item:hover { background: var(--bg-hover); }
        .checklist-item.done { opacity: 0.5; }
        .checklist-item.done .checklist-text { text-decoration: line-through; }
        .checklist-checkbox { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border-glow); flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .checklist-item.done .checklist-checkbox { background: var(--success); border-color: var(--success); }
        .checklist-text { font-size: 0.875rem; color: var(--text-muted); }
        .journal-textarea { width: 100%; min-height: 120px; padding: 1rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-family: inherit; font-size: 0.9rem; resize: vertical; }
        .journal-textarea:focus { outline: none; border-color: var(--purple); box-shadow: 0 0 0 3px rgba(155,111,250,0.15); }
        .streak-display { text-align: center; padding: 1.5rem; }
        .streak-number { font-size: 3.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; background: linear-gradient(135deg, var(--gold), var(--warning)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .streak-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
        .trading-tips { display: grid; gap: 0.75rem; }
        .tip-item { padding: 1rem; background: var(--bg-elevated); border-radius: var(--radius-sm); border-left: 3px solid var(--cyan); }
        .tip-title { font-size: 0.8rem; font-weight: 700; color: var(--cyan); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
        .tip-text { font-size: 0.85rem; color: var(--text-muted); }
        .mantra-banner { background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(245,166,35,0.08)); border: 1px solid rgba(255,209,102,0.25); border-radius: 16px; padding: 1.5rem 2rem; text-align: center; margin-bottom: 1.5rem; }
        .mantra-text { font-size: 1.4rem; font-weight: 700; color: var(--gold); letter-spacing: -0.01em; }
        .mantra-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.4rem; }

        /* ‚îÄ‚îÄ PUBLIC JOURNAL STYLES ‚îÄ‚îÄ */
        .share-banner { background: linear-gradient(135deg, rgba(6,214,214,0.1), rgba(59,126,248,0.08)); border: 1px solid rgba(6,214,214,0.25); border-radius: var(--radius); padding: 1.25rem 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .share-banner-left { display: flex; align-items: center; gap: 1rem; }
        .share-icon { font-size: 1.5rem; }
        .share-info strong { display: block; color: var(--cyan); font-size: 0.9rem; }
        .share-info span { color: var(--text-muted); font-size: 0.8rem; }
        .share-link-input { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .share-link-box { padding: 0.5rem 0.875rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; min-width: 200px; max-width: 320px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .share-toggle { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
        .toggle-switch { position: relative; width: 44px; height: 24px; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .toggle-switch.on { background: var(--cyan); border-color: var(--cyan); }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: all 0.2s; }
        .toggle-switch.on::after { left: 23px; }

        /* ‚îÄ‚îÄ PUBLIC VIEW ‚îÄ‚îÄ */
        .public-view { position: fixed; inset: 0; background: var(--bg); z-index: 99999; overflow-y: auto; display: none; }
        .public-view.show { display: block; }
        .public-topbar { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 1.25rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .public-brand { display: flex; align-items: center; gap: 0.75rem; }
        .public-brand .logo { font-size: 1.5rem; }
        .public-brand h2 { font-size: 1.1rem; font-weight: 700; }
        .public-badge { padding: 0.3rem 0.75rem; background: rgba(6,214,214,0.15); border: 1px solid rgba(6,214,214,0.3); border-radius: 20px; font-size: 0.75rem; font-weight: 700; color: var(--cyan); }
        .public-container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        .public-header { background: linear-gradient(135deg, rgba(59,126,248,0.1), rgba(155,111,250,0.08)); border: 1px solid var(--border); border-radius: 20px; padding: 2rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.5rem; }
        .public-avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--purple)); display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 700; flex-shrink: 0; }
        .public-user-info h2 { font-size: 1.5rem; font-weight: 700; }
        .public-user-info p { color: var(--text-muted); font-size: 0.875rem; }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1024px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .menu-btn { display: flex !important; }
            .chart-grid, .chart-grid-3 { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .metrics-grid { grid-template-columns: 1fr 1fr; }
            .hero-stats { gap: 1.5rem; }
            .topbar { padding: 1rem; }
            .auth-box { padding: 2rem 1.5rem; }
        }
        @media (max-width: 480px) {
            .metrics-grid { grid-template-columns: 1fr; }
        }
        /* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
        .onboard-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:10000;display:flex;align-items:center;justify-content:center;padding:1rem; }
        .onboard-overlay.hidden { display:none; }
        .onboard-card { background:var(--bg-card);border:1px solid var(--border);border-radius:24px;padding:2.5rem;width:520px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .onboard-progress { display:flex;gap:0.5rem;justify-content:center;margin-bottom:2rem; }
        .onboard-dot { width:8px;height:8px;border-radius:50%;background:var(--bg-elevated);border:1px solid var(--border);transition:all 0.2s; }
        .onboard-dot.active { background:var(--accent);border-color:var(--accent);transform:scale(1.3); }
        .onboard-dot.done { background:var(--success);border-color:var(--success); }
        .onboard-step { display:none; }
        .onboard-step.active { display:block; }
        .onboard-emoji { font-size:3rem;text-align:center;margin-bottom:1rem;filter:drop-shadow(0 0 20px rgba(59,126,248,0.5)); }
        .onboard-title { font-size:1.5rem;font-weight:700;text-align:center;letter-spacing:-0.02em;margin-bottom:0.5rem; }
        .onboard-sub { color:var(--text-muted);text-align:center;font-size:0.9rem;margin-bottom:1.5rem; }
        .onboard-nav { display:flex;gap:0.75rem;margin-top:1.5rem; }
        .onboard-nav .btn { flex:1; }
        /* ‚îÄ‚îÄ PROFILE MODAL ‚îÄ‚îÄ */
        .modal-overlay { position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:flex;align-items:center;justify-content:center;padding:1rem; }
        .modal-overlay.hidden { display:none; }
        .modal-card { background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:2rem;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        .modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem; }
        .modal-title { font-size:1.2rem;font-weight:700; }
        .modal-close { width:32px;height:32px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:all 0.15s; }
        .modal-close:hover { border-color:var(--danger);color:var(--danger); }
        /* ‚îÄ‚îÄ CONTRACT EDITOR ‚îÄ‚îÄ */
        .contract-editor { background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1.25rem; }
        .contract-row { display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem; }
        .contract-row:last-child { margin-bottom:0; }
        .contract-label { flex:1;font-size:0.875rem;font-weight:600; }
        .contract-input { width:80px;padding:0.4rem 0.6rem;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-family:inherit;font-size:0.875rem;text-align:center; }
        .contract-input:focus { outline:none;border-color:var(--accent); }
    </style>
</head>
<body>

<!-- PUBLIC JOURNAL VIEW (shown when ?journal=userId) -->
<div class="public-view" id="publicView">
    <div class="public-topbar">
        <div class="public-brand">
            <span class="logo">üåæ</span>
            <h2>Prop Farm Pro</h2>
        </div>
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <span class="public-badge">üìñ Public Journal</span>
            <button class="btn btn-secondary" style="padding:0.4rem 0.875rem;font-size:0.8rem;" onclick="document.getElementById('publicView').classList.remove('show')">‚úï Close</button>
        </div>
    </div>
    <div class="public-container">
        <div class="public-header">
            <div class="public-avatar" id="publicAvatar">T</div>
            <div class="public-user-info">
                <h2 id="publicUserName">Trader</h2>
                <p id="publicUserSub">Public trading journal ‚Ä¢ Updated live</p>
            </div>
        </div>
        <div class="metrics-grid" id="publicMetrics"></div>
        <div style="margin-bottom:1.5rem;" class="table-card">
            <div class="table-header"><span class="card-title">Trade History</span><span id="publicTradeCount" style="color:var(--text-muted);font-size:0.85rem;"></span></div>
            <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Cycle</th></tr></thead><tbody id="publicTradeBody"></tbody></table></div>
        </div>
    </div>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- AUTH SCREEN -->
<div class="auth-screen" id="authScreen">
    <div class="auth-bg"></div>
    <div class="auth-grid"></div>
    <div class="auth-box">
        <div class="auth-logo">
            <span class="logo-icon">üåæ</span>
            <h1>Prop Farm Pro</h1>
            <p>Professional Trading Portfolio Management</p>
        </div>

        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">Create Account</button>
            <button class="auth-tab" onclick="switchAuthTab('reset')">Reset Password</button>
        </div>

        <div class="auth-error" id="authError"></div>
        <div class="auth-success" id="authSuccess"></div>

        <!-- SIGN IN -->
        <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
            <button type="button" class="btn btn-oauth" onclick="handleGoogleAuth()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#EA4335" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/><path fill="#4285F4" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/><path fill="#FBBC05" d="M3.88 10.78A5.54 5.54 0 013.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 000 9c0 1.45.35 2.82.96 4.04l2.92-2.26z"/><path fill="#34A853" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/></svg>
                Sign In with Google
            </button>
            <div class="divider">or use username &amp; password</div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="loginUsername" placeholder="FarmKing47" required autocomplete="username" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
            </div>
            <div class="forgot-link"><a onclick="switchAuthTab('reset')">Forgot password?</a></div>
            <button type="submit" class="btn btn-primary" style="width:100%;" id="loginBtn">
                <span id="loginBtnText">Sign In</span>
                <span id="loginSpinner" class="spinner" style="display:none;"></span>
            </button>
        </form>

        <!-- SIGN UP -->
        <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
            <button type="button" class="btn btn-oauth" onclick="handleGoogleAuth()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#EA4335" d="M9 3.48c1.69 0 2.83.73 3.48 1.34l2.54-2.48C13.46.89 11.43 0 9 0 5.48 0 2.44 2.02.96 4.96l2.91 2.26C4.6 5.05 6.62 3.48 9 3.48z"/><path fill="#4285F4" d="M17.64 9.2c0-.74-.06-1.28-.19-1.84H9v3.34h4.96c-.1.83-.64 2.08-1.84 2.92l2.84 2.2c1.7-1.57 2.68-3.88 2.68-6.62z"/><path fill="#FBBC05" d="M3.88 10.78A5.54 5.54 0 013.58 9c0-.62.11-1.22.29-1.78L.96 4.96A9.008 9.008 0 000 9c0 1.45.35 2.82.96 4.04l2.92-2.26z"/><path fill="#34A853" d="M9 18c2.43 0 4.47-.8 5.96-2.18l-2.84-2.2c-.76.53-1.78.9-3.12.9-2.38 0-4.4-1.57-5.12-3.74L.97 13.04C2.45 15.98 5.48 18 9 18z"/></svg>
                Sign Up with Google ‚Äî Instant!
            </button>
            <div class="divider">or create with username &amp; password</div>
            <div class="form-group">
                <label class="form-label">Username <span style="color:var(--text-muted);font-size:0.8rem;">(your public trading name)</span></label>
                <input type="text" class="form-input" id="signupUsername" placeholder="FarmKing47" required minlength="3" maxlength="30" autocomplete="username" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
                <div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.3rem;">Letters, numbers, underscores only.</div>
            </div>
            <div class="form-group">
                <label class="form-label">Password <span style="color:var(--text-muted);font-size:0.8rem;">(min 6 characters)</span></label>
                <input type="password" class="form-input" id="signupPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" autocomplete="new-password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm Password</label>
                <input type="password" class="form-input" id="signupConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password">
            </div>
            <div style="background:rgba(34,211,160,0.07);border:1px solid rgba(34,211,160,0.2);border-radius:8px;padding:0.75rem;margin-bottom:1rem;font-size:0.8rem;color:var(--success);">
                ‚úÖ No email required! After signing up you'll set up your profile. You can link email/Google later in Settings.
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;" id="signupBtn">
                <span id="signupBtnText">Create Account ‚Üí</span>
                <span id="signupSpinner" class="spinner" style="display:none;"></span>
            </button>
        </form>

        <!-- RESET PASSWORD -->
        <form class="auth-form" id="resetForm" onsubmit="handlePasswordReset(event)">
            <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:1.5rem;">Enter your username or the email linked to your account.</p>
            <div class="form-group">
                <label class="form-label">Username or Email</label>
                <input type="text" class="form-input" id="resetEmail" placeholder="FarmKing47 or trader@example.com" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;" id="resetBtn">
                <span id="resetBtnText">Send Reset Link</span>
                <span id="resetSpinner" class="spinner" style="display:none;"></span>
            </button>
            <button type="button" class="btn btn-secondary" style="width:100%;margin-top:0.75rem;" onclick="switchAuthTab('login')">‚Üê Back to Sign In</button>
        </form>
    </div>
</div>

<!-- ONBOARDING OVERLAY -->
<div class="onboard-overlay hidden" id="onboardOverlay">
  <div class="onboard-card">
    <div class="onboard-progress" id="onboardProgress"></div>

    <!-- Step 0: Welcome + Profile setup -->
    <div class="onboard-step active" id="onboardStep0">
      <div class="onboard-emoji">üåæ</div>
      <div class="onboard-title">Welcome to Prop Farm Pro!</div>
      <div class="onboard-sub">Let's set up your trading profile in 2 quick steps.</div>
      <div class="form-group">
        <label class="form-label">Username <span style="color:var(--text-muted);font-size:0.8rem;">(shown on your journal)</span></label>
        <input type="text" class="form-input" id="obUsername" placeholder="FarmKing47" maxlength="30" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
      </div>
      <div class="form-group">
        <label class="form-label">Display Name <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
        <input type="text" class="form-input" id="obDisplayName" placeholder="The Prop King" maxlength="40">
      </div>
      <div class="form-group">
        <label class="form-label">Journal Bio <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
        <input type="text" class="form-input" id="obBio" placeholder="Futures trader farming consistent profits üåæ" maxlength="120">
      </div>
      <div class="form-group">
        <label class="form-label">Firm Name <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
        <input type="text" class="form-input" id="obFirmName" placeholder="e.g. Topstep, Apex, FTMO" maxlength="40">
      </div>
      <div class="form-group">
        <label class="form-label">Social / YouTube Link <span style="color:var(--text-muted);font-size:0.8rem;">(optional)</span></label>
        <input type="url" class="form-input" id="obSocialLink" placeholder="https://youtube.com/@yourhandle">
      </div>
    </div>

    <!-- Step 1: Trading goals -->
    <div class="onboard-step" id="onboardStep1">
      <div class="onboard-emoji">üéØ</div>
      <div class="onboard-title">Set Your Farming Goals</div>
      <div class="onboard-sub">You can change these anytime in Settings.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div class="form-group">
          <label class="form-label">Account Goal (# of PA accounts)</label>
          <input type="number" class="form-input" id="obAccountGoal" value="20" min="1" max="200">
        </div>
        <div class="form-group">
          <label class="form-label">Starting Balance / Account</label>
          <input type="number" class="form-input" id="obStartBal" value="50000" min="1000">
        </div>
        <div class="form-group">
          <label class="form-label">Goal per Account ($)</label>
          <input type="number" class="form-input" id="obGoalAcc" value="4600" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Payout per Account ($)</label>
          <input type="number" class="form-input" id="obPayoutAcc" value="2000" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Daily Target Min ($)</label>
          <input type="number" class="form-input" id="obDailyMin" value="250" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Daily Target Max ($)</label>
          <input type="number" class="form-input" id="obDailyMax" value="300" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">Max Daily Drawdown ($)</label>
          <input type="number" class="form-input" id="obMaxDD" value="2500" min="0">
        </div>
      </div>
    </div>

    <div class="onboard-nav">
      <button class="btn btn-secondary" id="onboardBackBtn" onclick="onboardBack()" style="display:none;">‚Üê Back</button>
      <button class="btn btn-primary" id="onboardNextBtn" onclick="onboardNext()">Next ‚Üí</button>
    </div>
  </div>
</div>

<!-- PROFILE MODAL (edit profile from settings) -->
<div class="modal-overlay hidden" id="profileModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Profile</div>
      <button class="modal-close" onclick="closeProfileModal()">‚úï</button>
    </div>
    <div class="form-group">
      <label class="form-label">Username</label>
      <input type="text" class="form-input" id="profileUsername" maxlength="30" oninput="this.value=this.value.replace(/[^a-zA-Z0-9_]/g,'')">
    </div>
    <div class="form-group">
      <label class="form-label">Display Name</label>
      <input type="text" class="form-input" id="profileDisplayName" maxlength="40">
    </div>
    <div class="form-group">
      <label class="form-label">Journal Bio / Tagline</label>
      <input type="text" class="form-input" id="profileBio" maxlength="120">
    </div>
    <div class="form-group">
      <label class="form-label">Firm Name</label>
      <input type="text" class="form-input" id="profileFirmName" maxlength="40">
    </div>
    <div class="form-group">
      <label class="form-label">Social / YouTube Link</label>
      <input type="url" class="form-input" id="profileSocialLink">
    </div>
    <div style="background:rgba(59,126,248,0.07);border:1px solid rgba(59,126,248,0.2);border-radius:8px;padding:0.875rem;margin-bottom:1.25rem;font-size:0.82rem;color:var(--text-muted);">
      üí° Link your email for password recovery: <input type="email" class="form-input" id="profileEmail" placeholder="trader@example.com" style="margin-top:0.5rem;">
    </div>
    <div class="form-footer">
      <button class="btn btn-primary" onclick="saveProfileModal()">üíæ Save Profile</button>
      <button class="btn btn-secondary" onclick="closeProfileModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <span class="logo-em">üåæ</span>
            <h2>Prop Farm</h2>
        </div>

        <div class="user-chip">
            <div class="user-avatar" id="userAvatar">T</div>
            <div class="user-info">
                <div class="user-name" id="userName">Trader</div>
                <div class="user-role" id="userRole">Member</div>
            </div>
        </div>

        <nav class="nav-section">
            <div class="nav-label">Main</div>
            <div class="nav-item active" data-page="overview"><span class="nav-icon">üìä</span>Overview</div>
            <div class="nav-item" data-page="cyclePerformance"><span class="nav-icon">üîÑ</span>Cycle Performance</div>
            <div class="nav-item" data-page="templates"><span class="nav-icon">üìã</span>Templates</div>
            <div class="nav-item" data-page="accounts"><span class="nav-icon">üíº</span>Accounts</div>
            <div class="nav-item" data-page="analytics"><span class="nav-icon">üìà</span>Analytics</div>
            <div class="nav-item" data-page="riskMonitor"><span class="nav-icon">‚ö†Ô∏è</span>Risk Monitor</div>
            <div class="nav-item" data-page="psychology"><span class="nav-icon">üß†</span>Psychology</div>
        </nav>

        <nav class="nav-section">
            <div class="nav-label">Actions</div>
            <div class="nav-item" data-page="addTrade"><span class="nav-icon">‚ûï</span>Add Trade</div>
            <div class="nav-item" data-page="logPayout"><span class="nav-icon">üí∞</span>Log Payout</div>
            <div class="nav-item" data-page="tradeLog"><span class="nav-icon">üìù</span>Trade Log</div>
            <div class="nav-item" data-page="shareJournal"><span class="nav-icon">üîó</span>Share Journal</div>
            <div class="nav-item" data-page="deleteData"><span class="nav-icon">üóëÔ∏è</span>Delete Data</div>
            <div class="nav-item" onclick="window.location.href='pamm_calculator_dashboard.html'"><span class="nav-icon">üìä</span><span>PAMM Calculator</span></div>
            <div class="nav-item" onclick="window.location.href='economic-calendar.html'"><span class="nav-icon">üìÖ</span><span>Economic Calendar</span></div>
        </nav>

        <nav class="nav-section">
            <div class="nav-label">Config</div>
            <div class="nav-item" data-page="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</div>
            <div class="nav-item" data-page="adminPanel" id="adminNavItem" style="display:none;"><span class="nav-icon">üëë</span>Admin Panel</div>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="handleLogout()"><span>üö™</span> Sign Out</button>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main" id="main">
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-btn" id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
                <h1 class="page-title" id="pageTitle">Overview</h1>
            </div>
            <div class="topbar-right">
                <button class="icon-btn" onclick="refreshData()" title="Refresh data">‚Üª</button>
                <button class="icon-btn" onclick="exportCSV()" title="Export CSV">üì•</button>
            </div>
        </div>

        <div class="container">
            <div class="alert" id="alert"></div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page active" id="overviewPage">
                <div id="adminViewingBanner" class="admin-view-banner" style="display:none;">
                    <span>üëÅÔ∏è Viewing as admin: <strong id="adminViewingLabel">‚Äî</strong></span>
                    <button class="btn btn-secondary" style="padding:0.3rem 0.875rem;font-size:0.8rem;" onclick="exitAdminView()">Exit View</button>
                </div>
                <div class="hero">
                    <div class="hero-glow"></div>
                    <div class="hero-greeting" id="heroGreeting">Welcome back, <span id="heroName">Trader</span></div>
                    <div class="hero-title"><span id="heroTitle">Building Your</span> Trading Empire</div>
                    <div class="hero-stats">
                        <div><div class="hero-stat-value" id="heroTotalPnL">$0</div><div class="hero-stat-label">Total P&L</div></div>
                        <div><div class="hero-stat-value" id="heroProgress">0%</div><div class="hero-stat-label">Portfolio Progress</div></div>
                        <div><div class="hero-stat-value" id="heroAccounts">0/20</div><div class="hero-stat-label">Accounts at Goal</div></div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="action-card" onclick="navigateTo('addTrade')"><div class="action-icon blue">‚ûï</div><div class="action-info"><h4>Add Trade</h4><p>Log new position</p></div></div>
                    <div class="action-card" onclick="refreshData()"><div class="action-icon green">üîÑ</div><div class="action-info"><h4>Refresh</h4><p>Sync from database</p></div></div>
                    <div class="action-card" onclick="navigateTo('shareJournal')"><div class="action-icon teal">üîó</div><div class="action-info"><h4>Share Journal</h4><p>Public trade link</p></div></div>
                    <div class="action-card" onclick="navigateTo('psychology')"><div class="action-icon purple">üß†</div><div class="action-info"><h4>Psychology</h4><p>Mindset & motivation</p></div></div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">üí∞</span></div><div class="metric-value" id="totalPnL">$0</div><div class="metric-sub" id="pnlSub">All time</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">üéØ</span></div><div class="metric-value" id="winRate">0%</div><div class="metric-sub" id="winStatsSub">0 / 0 trades</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Profit Factor</span><span class="metric-icon">üìä</span></div><div class="metric-value" id="profitFactor">0.00</div><div class="metric-sub" id="pfSub">‚Äî</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Streak</span><span class="metric-icon">üî•</span></div><div class="metric-value" id="winStreak">0</div><div class="metric-sub" id="streakSub">No active streak</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Trades</span><span class="metric-icon">üìà</span></div><div class="metric-value" id="totalTrades">0</div><div class="metric-sub" id="tradesSub">Across all accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Avg Trade</span><span class="metric-icon">üíµ</span></div><div class="metric-value" id="avgTrade">$0</div><div class="metric-sub">Per trade</div></div>
                </div>

                <div class="stats-row">
                    <div class="stat-card"><div class="stat-val" id="bestDay">$0</div><div class="stat-lbl">Best Day</div></div>
                    <div class="stat-card"><div class="stat-val" id="worstDay">$0</div><div class="stat-lbl">Worst Day</div></div>
                    <div class="stat-card"><div class="stat-val" id="avgWin">$0</div><div class="stat-lbl">Avg Win</div></div>
                    <div class="stat-card"><div class="stat-val" id="avgLoss">$0</div><div class="stat-lbl">Avg Loss</div></div>
                    <div class="stat-card"><div class="stat-val" id="longestStreak">0</div><div class="stat-lbl">Longest Streak</div></div>
                    <div class="stat-card"><div class="stat-val" id="payoutProgress">0%</div><div class="stat-lbl">Payout Progress</div></div>
                </div>

                <div class="chart-grid">
                    <div class="card"><div class="card-header"><div class="card-title">Portfolio Growth</div><div class="card-sub">Cumulative P&L over time</div></div><div class="card-body"><div class="chart-wrap"><canvas id="growthChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Win Rate by Condition</div></div><div class="card-body"><div class="chart-wrap"><canvas id="winRateChart"></canvas></div></div></div>
                </div>

                <div class="chart-grid-3">
                    <div class="card"><div class="card-header"><div class="card-title">Daily P&L</div><div class="card-sub">Last 14 days</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="dailyChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Risk Distribution</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="riskChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Account Status</div><div class="card-sub" id="accStatusSub">Portfolio overview</div></div><div class="card-body"><div class="chart-wrap-sm"><canvas id="accountStatusChart"></canvas></div></div></div>
                </div>

                <div class="section-header">
                    <div class="section-title">Top Performing Templates</div>
                    <button class="btn btn-secondary" onclick="navigateTo('templates')" style="padding:0.5rem 1rem;font-size:0.85rem;">View All</button>
                </div>
                <div class="templates-grid" id="topTemplatesGrid"></div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PSYCHOLOGY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="psychologyPage">
                <div class="psych-hero">
                    <span class="psych-hero-emoji">üß†</span>
                    <div class="psych-hero-title">Trading Psychology</div>
                    <div class="psych-hero-subtitle">Your mindset is your greatest edge. Protect it daily.</div>
                </div>

                <div class="mantra-banner">
                    <div class="mantra-text" id="mantraText">"Plant the seed. Trust the process. Harvest the reward."</div>
                    <div class="mantra-sub">üåæ The Farmer's Mantra</div>
                </div>

                <!-- Daily Quote -->
                <div class="daily-quote-card">
                    <div class="daily-quote-label">‚ú® Daily Motivation</div>
                    <div class="daily-quote-text" id="dailyQuoteText">Loading...</div>
                    <div class="daily-quote-author" id="dailyQuoteAuthor">‚Äî</div>
                    <div class="quote-nav">
                        <button class="quote-nav-btn" onclick="prevQuote()">‚Üê</button>
                        <span class="quote-counter" id="quoteCounter">1 / 20</span>
                        <button class="quote-nav-btn" onclick="nextQuote()">‚Üí</button>
                    </div>
                </div>

                <div class="psych-grid">
                    <!-- Mood tracker -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(59,126,248,0.15);">üòä</div>
                            <div class="psych-card-title">Today's Trading Mindset</div>
                        </div>
                        <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">How are you feeling before the session?</p>
                        <div class="mood-grid">
                            <button class="mood-btn" onclick="selectMood(this,'üî•','In the zone')"><span class="mood-label">üî•</span><span class="mood-label">In the Zone</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'üòé','Calm & ready')"><span class="mood-label">üòé</span><span class="mood-label">Calm & Ready</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'üòå','Neutral')"><span class="mood-label">üòå</span><span class="mood-label">Neutral</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'üò§','A little tense')"><span class="mood-label">üò§</span><span class="mood-label">A little Tense</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'üò∞','Anxious')"><span class="mood-label">üò∞</span><span class="mood-label">Anxious</span></button>
                            <button class="mood-btn" onclick="selectMood(this,'üö´','Sit this out')"><span class="mood-label">üö´</span><span class="mood-label">Sit This Out</span></button>
                        </div>
                        <div id="moodAdvice" style="margin-top:1rem;padding:0.875rem;background:var(--bg-elevated);border-radius:var(--radius-sm);font-size:0.85rem;color:var(--text-muted);display:none;"></div>
                    </div>

                    <!-- Pre-trade checklist -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(34,211,160,0.15);">‚úÖ</div>
                            <div class="psych-card-title">Pre-Trade Checklist</div>
                        </div>
                        <div id="checklistItems">
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Checked economic calendar for news events</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Reviewed yesterday's trades and lessons</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Know my max loss for today</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">Risk is within my template rules</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">I'm trading from logic, not emotion</span></div>
                            <div class="checklist-item" onclick="toggleCheck(this)"><div class="checklist-checkbox"></div><span class="checklist-text">I accept that I might lose today</span></div>
                        </div>
                        <div id="checklistStatus" style="margin-top:0.75rem;font-size:0.8rem;color:var(--text-muted);text-align:center;"></div>
                        <button class="btn btn-secondary" style="width:100%;margin-top:0.75rem;padding:0.5rem;" onclick="resetChecklist()">Reset Checklist</button>
                    </div>

                    <!-- The Farmer's Rules -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(255,209,102,0.15);">üìú</div>
                            <div class="psych-card-title">The Farmer's Golden Rules</div>
                        </div>
                        <div class="rule-list">
                            <div class="rule-item"><div class="rule-num">1</div><div class="rule-text">Protect the field first. Small consistent days beat revenge trading every time.</div></div>
                            <div class="rule-item"><div class="rule-num">2</div><div class="rule-text">$250‚Äì$300/day is a great harvest. Don't get greedy with the crops.</div></div>
                            <div class="rule-item"><div class="rule-num">3</div><div class="rule-text">Bad weather days happen. A losing day is data, not failure.</div></div>
                            <div class="rule-item"><div class="rule-num">4</div><div class="rule-text">The 45-day first cycle is your planting season. Be patient.</div></div>
                            <div class="rule-item"><div class="rule-num">5</div><div class="rule-text">One red day cannot destroy 44 green ones. Stay focused on the season.</div></div>
                        </div>
                    </div>

                    <!-- Daily affirmations -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(155,111,250,0.15);">üí™</div>
                            <div class="psych-card-title">Daily Affirmations</div>
                        </div>
                        <div class="affirmation-list">
                            <div class="affirmation-item">I am a disciplined trader who follows my system.</div>
                            <div class="affirmation-item">I control risk, not results.</div>
                            <div class="affirmation-item">I trade the process, not the profit.</div>
                            <div class="affirmation-item">Every day I show up, I grow stronger.</div>
                            <div class="affirmation-item">My account is protected because I protect it.</div>
                            <div class="affirmation-item">I am building generational wealth one trade at a time.</div>
                        </div>
                    </div>

                    <!-- Trading tips -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(6,214,214,0.15);">üí°</div>
                            <div class="psych-card-title">Prop Farm Mindset Tips</div>
                        </div>
                        <div class="trading-tips">
                            <div class="tip-item"><div class="tip-title">On Losing Days</div><div class="tip-text">A loss is tuition. The lesson is in your notes. Review, don't revenge trade.</div></div>
                            <div class="tip-item"><div class="tip-title">On Consecutive Wins</div><div class="tip-text">When on a hot streak, size down not up. The market humbles overconfidence.</div></div>
                            <div class="tip-item"><div class="tip-title">On Waiting</div><div class="tip-text">The best trade is often no trade. Patience is a position.</div></div>
                            <div class="tip-item"><div class="tip-title">On the Fail Line</div><div class="tip-text">Every $50 you keep above the fail line is $50 you earned. Treat it like gold.</div></div>
                        </div>
                    </div>

                    <!-- Win streak + journal -->
                    <div class="psych-card">
                        <div class="psych-card-header">
                            <div class="psych-card-icon" style="background:rgba(255,209,102,0.15);">üî•</div>
                            <div class="psych-card-title">Your Win Streak</div>
                        </div>
                        <div class="streak-display">
                            <div class="streak-number" id="psychStreakNum">0</div>
                            <div class="streak-label">Consecutive Wins</div>
                        </div>
                        <div style="margin-top:1.25rem;">
                            <label class="form-label">Today's Trading Journal Note</label>
                            <textarea class="journal-textarea" id="journalNote" placeholder="What happened today? What did you learn? What will you do differently?..." oninput="saveJournalNote()"></textarea>
                            <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.75rem;color:var(--text-dim);">
                                <span id="journalSaveStatus">Auto-saves as you type</span>
                                <span id="journalCharCount">0 chars</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SHARE JOURNAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="shareJournalPage">
                <div class="share-banner">
                    <div class="share-banner-left">
                        <span class="share-icon">üîó</span>
                        <div class="share-info">
                            <strong>Public Journal Sharing</strong>
                            <span>Share your trading progress with anyone ‚Äî no login required</span>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;">
                        <div class="share-toggle">
                            <span style="color:var(--text-muted);font-size:0.85rem;" id="shareStatusLabel">Sharing Off</span>
                            <div class="toggle-switch" id="shareToggle" onclick="toggleSharing()"></div>
                        </div>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;font-size:1.05rem;font-weight:700;">üìé Your Journal Share Link</h3>
                    <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:1.25rem;">Anyone with this link can view your trade journal in read-only mode. Enable sharing above to make it live.</p>
                    <div style="display:flex;gap:0.75rem;margin-bottom:1.25rem;flex-wrap:wrap;">
                        <div class="share-link-box" id="shareLinkDisplay" style="flex:1;max-width:none;padding:0.875rem;">
                            Enable sharing to generate your link
                        </div>
                    </div>
                    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" style="padding:0.5rem 1.25rem;font-size:0.875rem;" onclick="copyShareLink()">üìã Copy Link</button>
                        <button class="btn btn-secondary" style="padding:0.5rem 1.25rem;font-size:0.875rem;" onclick="previewJournal()">üëÅÔ∏è Preview Journal</button>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1rem;font-size:1.05rem;font-weight:700;">üé® Journal Customization</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Display Name (shown publicly)</label>
                            <input type="text" class="form-input" id="journalDisplayName" placeholder="e.g. FX Farmer, The Prop King...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Journal Bio / Tagline</label>
                            <input type="text" class="form-input" id="journalBio" placeholder="e.g. Prop trader farming consistent profits üåæ">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">What data to show publicly</label>
                        <div style="display:grid;gap:0.5rem;">
                            <label class="checkbox-label"><input type="checkbox" id="showPnL" checked> Show P&L amounts</label>
                            <label class="checkbox-label"><input type="checkbox" id="showWinRate" checked> Show win rate</label>
                            <label class="checkbox-label"><input type="checkbox" id="showTrades" checked> Show individual trades</label>
                            <label class="checkbox-label"><input type="checkbox" id="showAccounts"> Show account numbers (PA #1, etc.)</label>
                        </div>
                    </div>
                    <div class="form-footer">
                        <button class="btn btn-primary" style="width:auto;" onclick="saveJournalSettings()">üíæ Save Settings</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Journal Preview</div>
                        <div class="card-sub">This is what visitors will see</div>
                    </div>
                    <div class="card-body">
                        <div class="metrics-grid" id="journalPreviewMetrics"></div>
                        <div class="table-card" style="margin-top:1rem;">
                            <div class="table-wrap"><table><thead><tr><th>Date</th><th>P&L</th><th>Condition</th><th>Cycle</th></tr></thead><tbody id="journalPreviewBody"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CYCLE PERFORMANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="cyclePerformancePage">
                <p style="color:var(--text-muted);margin-bottom:1.5rem;">Track your farming journey across your <strong id="cycleAccText">active accounts</strong>. First cycle target: $4,600 profit per account in 45 days. After first payout: monthly $2,000 per account in 8‚Äì20 days.</p>
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">First Payout Progress</span><span class="metric-icon">üéØ</span></div><div class="metric-value" id="firstPayoutProg">0%</div><div class="metric-sub" id="firstPayoutSub">Not yet qualified</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Payouts Earned</span><span class="metric-icon">üí∞</span></div><div class="metric-value" id="totalPayoutsAmt">$0</div><div class="metric-sub" id="payoutCountSub">0 payouts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Current Cycle</span><span class="metric-icon">üìÖ</span></div><div class="metric-value" id="currentCycleStatus">Cycle 1</div><div class="metric-sub" id="cycleInfoSub">Building to first payout</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Daily Average</span><span class="metric-icon">üìä</span></div><div class="metric-value" id="dailyAvg">$0</div><div class="metric-sub" id="dailyTarget">Target: $250‚Äì$300</div></div>
                </div>
                <div class="alert alert-info show">üåæ <strong>The Farmer Mentality:</strong> Plant daily wins ($250‚Äì$300). Protect the field. Stay patient (45 days first cycle). Take the harvest when accounts mature.</div>
                <div class="table-card" style="margin-bottom:1.5rem;">
                    <div class="table-header"><span class="card-title">Cycle-by-Cycle Comparison</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Cycle</th><th>Total P&L</th><th>Trades</th><th>Trading Days</th><th>Avg/Day</th><th>Win Rate</th><th>Best Day</th><th>Worst Day</th><th>Status</th></tr></thead><tbody id="cycleCompBody"></tbody></table></div>
                </div>
                <div class="chart-grid">
                    <div class="card"><div class="card-header"><div class="card-title">Cycle P&L Comparison</div></div><div class="card-body"><div class="chart-wrap"><canvas id="cyclePnLChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Daily Average by Cycle</div></div><div class="card-body"><div class="chart-wrap"><canvas id="cycleDailyChart"></canvas></div></div></div>
                </div>
                <div class="section-header" style="margin-top:1.5rem;"><div class="section-title">Cycle Details</div></div>
                <div class="templates-grid" id="cycleDetailsGrid"></div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TEMPLATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="templatesPage">
                <div class="section-header"><div class="section-title">Market Conditions</div></div>
                <div class="templates-grid" id="marketCondGrid"></div>
                <div class="section-header"><div class="section-title">Risk Templates</div></div>
                <div class="templates-grid" id="riskTemplGrid"></div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ACCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="accountsPage">
                <div class="section-header">
                    <div class="section-title" id="accountsTitle">Portfolio Accounts</div>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="padding:0.5rem 1rem;font-size:0.85rem;">Export CSV</button>
                </div>
                <div style="background:rgba(6,214,214,0.08);border:1px solid rgba(6,214,214,0.2);border-radius:var(--radius-sm);padding:0.875rem 1.25rem;margin-bottom:1.25rem;font-size:0.875rem;color:var(--cyan);">
                    üí° Click the pencil icon on any account to give it a custom name (e.g. "Main Warrior", "Backup Farm")
                </div>
                <div class="filter-pills">
                    <div class="pill active" onclick="filterAccounts('all',event)">All</div>
                    <div class="pill" onclick="filterAccounts('active',event)">Active Only</div>
                    <div class="pill" onclick="filterAccounts('goal',event)">Goal Reached</div>
                    <div class="pill" onclick="filterAccounts('profitable',event)">Profitable</div>
                </div>
                <div class="accounts-grid" id="accountsGrid"></div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="analyticsPage">
                <div class="table-card">
                    <div class="table-header"><span class="card-title">Template Comparison</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Template</th><th>Total P&L</th><th>Trades</th><th>Win Rate</th><th>Avg Win</th><th>Avg Loss</th><th>Best Trade</th><th>Profit Factor</th></tr></thead><tbody id="analyticsBody"></tbody></table></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RISK MONITOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="riskMonitorPage">
                <div class="alert alert-info show" style="margin-bottom:1.5rem;"><strong>Trailing Drawdown Rules:</strong> Starting Balance: $50,000 | Max Drawdown: $2,500 | Fail Line: $47,500 | Safety Net: $52,600 (fail line locks at $50,100 forever once reached)</div>
                <div class="accounts-grid" id="riskGrid"></div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ADD TRADE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="addTradePage">
                <div class="form-card">
                    <form id="tradeForm" onsubmit="handleTradeSubmit(event)">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="noTradeDay" onchange="toggleNoTradeDay(this.checked)">
                                üìÖ No-Trade Day (rest day / market closed)
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="copierMode" onchange="toggleCopierMode(this.checked)">
                                üîÑ Trade Copier Mode (copy to multiple accounts)
                            </label>
                        </div>

                        <div class="form-grid" id="tradeFormGrid">
                            <div id="singleAccWrap">
                                <div class="form-group">
                                    <label class="form-label">PA Account *</label>
                                    <select class="form-select" id="tradeAccount" required></select>
                                </div>
                            </div>
                            <div id="multiAccWrap" style="display:none;grid-column:1/-1;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label">Lead Account *</label>
                                        <select class="form-select" id="leadAccount"></select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Follower Accounts *</label>
                                        <div style="border:1px solid var(--border);border-radius:var(--radius-sm);padding:1rem;background:var(--bg-elevated);max-height:180px;overflow-y:auto;">
                                            <div id="followerCheckboxes" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Cycle *</label>
                                <select class="form-select" id="tradeCycle" required>
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                    <option value="7">Cycle 7</option><option value="8">Cycle 8</option><option value="9">Cycle 9</option>
                                    <option value="10">Cycle 10</option><option value="11">Cycle 11</option><option value="12">Cycle 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Market Condition *</label>
                                <select class="form-select" id="tradeCondition" required>
                                    <option value="">Select</option>
                                    <option value="High Impact News">High Impact News</option>
                                    <option value="No Impact">No Impact</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Template *</label>
                                <select class="form-select" id="tradeRisk" required onchange="updateContracts(this.value)">
                                    <option value="">Select risk</option>
                                    <option value="100">$100 (1 contract)</option>
                                    <option value="200">$200 (2 contracts)</option>
                                    <option value="300">$300 (3 contracts)</option>
                                    <option value="400">$400 (4 contracts)</option>
                                    <option value="500">$500 (5 contracts)</option>
                                    <option value="600">$600 (6 contracts)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trade Date *</label>
                                <input type="date" class="form-input" id="tradeDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P&L ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="tradePnL" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contracts</label>
                                <input type="number" class="form-input" id="tradeContracts" readonly style="opacity:0.6;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="tradeNotes" placeholder="Entry reason, market conditions, lessons learned..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="tradeSubmitBtn" style="width:auto;">
                                <span id="tradeSubmitText">Submit Trade</span>
                                <span id="tradeSubmitSpinner" class="spinner" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetTradeForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ LOG PAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="logPayoutPage">
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Available for Withdrawal</span><span class="metric-icon">üíµ</span></div><div class="metric-value" id="availableWithdrawal">$0</div><div class="metric-sub" id="withdrawalStatus">Not qualified yet</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Withdrawn</span><span class="metric-icon">üí∞</span></div><div class="metric-value" id="totalWithdrawn">$0</div><div class="metric-sub" id="withdrawnCount">0 payouts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Current Phase</span><span class="metric-icon">üîÑ</span></div><div class="metric-value" id="cyclePhase">Cycle 1</div><div class="metric-sub" id="phaseInfo">Building to first payout</div></div>
                </div>
                <div class="form-card">
                    <h3 style="margin-bottom:1.5rem;font-size:1.1rem;font-weight:700;">Record New Payout</h3>
                    <form id="payoutForm" onsubmit="handlePayoutSubmit(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Payout Type *</label>
                                <select class="form-select" id="payoutType" required>
                                    <option value="">Select type</option>
                                    <option value="first_min">First Payout ‚Äì Minimum ($2,600 qualified)</option>
                                    <option value="first_full">First Payout ‚Äì Full ($4,600 = $2k withdrawal)</option>
                                    <option value="monthly">Monthly Payout ($2,000)</option>
                                    <option value="custom">Custom Amount</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Withdrawal Amount ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="withdrawalAmount" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payout Date *</label>
                                <input type="date" class="form-input" id="payoutDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account *</label>
                                <select class="form-select" id="payoutAccount" required></select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cycle Completed *</label>
                                <select class="form-select" id="cycleCompleted" required>
                                    <option value="">Select</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Cycle Starting *</label>
                                <select class="form-select" id="newCycle" required>
                                    <option value="">Select</option>
                                    <option value="2">Cycle 2</option><option value="3">Cycle 3</option><option value="4">Cycle 4</option>
                                    <option value="5">Cycle 5</option><option value="6">Cycle 6</option><option value="7">Cycle 7</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-textarea" id="payoutNotes" placeholder="First milestone reached! Ready for monthly farming cycle..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="payoutSubmitBtn" style="width:auto;">
                                <span id="payoutSubmitText">üí∞ Log Payout</span>
                                <span id="payoutSubmitSpinner" class="spinner" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetPayoutForm()">Clear</button>
                        </div>
                    </form>
                </div>
                <div class="table-card" style="margin-top:1.5rem;">
                    <div class="table-header"><span class="card-title">Payout History</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Cycle Completed</th><th>New Cycle</th><th>Notes</th></tr></thead><tbody id="payoutHistBody"></tbody></table></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TRADE LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="tradeLogPage">
                <div class="table-card">
                    <div class="table-header">
                        <span class="card-title">All Trades (Last 200)</span>
                        <div style="display:flex;gap:0.5rem;">
                            <input type="text" class="form-input" id="tradeLogSearch" placeholder="Search account, condition..." style="padding:0.4rem 0.75rem;font-size:0.85rem;width:200px;" oninput="filterTradeLog()">
                        </div>
                    </div>
                    <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Contracts</th><th>Cycle</th><th>Notes</th></tr></thead><tbody id="tradeLogBody"></tbody></table></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ DELETE DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="deleteDataPage">
                <div class="alert alert-error show">‚ö†Ô∏è Deleted data cannot be recovered. All deletions are permanent and immediate.</div>
                <div class="form-card">
                    <h3 style="margin-bottom:1.5rem;font-size:1.1rem;">Delete Options</h3>
                    <div style="display:grid;gap:1.25rem;">
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">üîÑ Delete by Cycle</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Remove all trades from a specific cycle</p>
                            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                                <select class="form-select" id="deleteCycleSelect" style="flex:1;min-width:160px;">
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                    <option value="7">Cycle 7</option><option value="8">Cycle 8</option><option value="9">Cycle 9</option>
                                    <option value="10">Cycle 10</option><option value="11">Cycle 11</option><option value="12">Cycle 12</option>
                                </select>
                                <button class="btn btn-secondary" onclick="deleteByCycle()">Delete Cycle</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">üíº Delete by Account</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">Remove all trades from a specific account</p>
                            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                                <select class="form-select" id="deleteAccSelect" style="flex:1;min-width:160px;"><option value="">Select account</option></select>
                                <button class="btn btn-secondary" onclick="deleteByAccount()">Delete Account</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid rgba(240,92,106,0.3);border-radius:var(--radius);background:rgba(240,92,106,0.03);">
                            <h4 style="margin-bottom:0.5rem;color:var(--danger);">üí£ Delete ALL Data</h4>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem;">‚ö†Ô∏è Permanently deletes ALL your trades AND all payout records!</p>
                            <button class="btn btn-danger" onclick="confirmDeleteAll()">Delete Everything</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="settingsPage">

                <!-- Profile Card -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;">
                    <h3 style="font-size:1.05rem;font-weight:700;">üë§ My Profile</h3>
                    <button class="btn btn-secondary" style="padding:0.4rem 1rem;font-size:0.85rem;" onclick="openProfileModal()">‚úèÔ∏è Edit Profile</button>
                  </div>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">
                    <div><div class="form-label">Username</div><div id="profileDisplayUsername" style="font-weight:600;font-size:1rem;">‚Äî</div></div>
                    <div><div class="form-label">Display Name</div><div id="profileDisplayName2" style="font-weight:600;">‚Äî</div></div>
                    <div><div class="form-label">Bio</div><div id="profileDisplayBio" style="color:var(--text-muted);font-size:0.875rem;">‚Äî</div></div>
                    <div><div class="form-label">Firm</div><div id="profileDisplayFirm" style="font-weight:600;">‚Äî</div></div>
                  </div>
                </div>

                <!-- Stats -->
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Account Goal</span><span class="metric-icon">üéØ</span></div><div class="metric-value" id="settingsGoal">20</div><div class="metric-sub">Total accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Active Accounts</span><span class="metric-icon">üíº</span></div><div class="metric-value" id="settingsActive">0</div><div class="metric-sub">With trades</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Portfolio Goal</span><span class="metric-icon">üí∞</span></div><div class="metric-value" id="settingsPortGoal">$92K</div><div class="metric-sub" id="settingsPortCalc">$4,600 √ó 20 accounts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Potential Payout</span><span class="metric-icon">üåæ</span></div><div class="metric-value" id="settingsPayout">$40K</div><div class="metric-sub" id="settingsPayCalc">$2,000 √ó 20 accounts</div></div>
                </div>

                <!-- Trading Goals -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1.25rem;font-size:1.05rem;font-weight:700;">üéØ Trading Goals & Configuration</h3>
                    <form id="settingsForm" onsubmit="handleSettingsSave(event)">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-bottom:1.25rem;">
                          <div class="form-group">
                            <label class="form-label">Account Goal</label>
                            <select class="form-select" id="accountGoalSelect" onchange="handleGoalSelectChange(this.value)">
                                <option value="1">1 Account</option>
                                <option value="5">5 Accounts</option>
                                <option value="10">10 Accounts</option>
                                <option value="20" selected>20 Accounts</option>
                                <option value="50">50 Accounts</option>
                                <option value="100">100 Accounts</option>
                                <option value="custom">Custom...</option>
                            </select>
                          </div>
                          <div class="form-group" id="customGoalWrap" style="display:none;">
                            <label class="form-label">Custom Account Count</label>
                            <input type="number" class="form-input" id="customGoalInput" min="1" max="200" placeholder="1‚Äì200">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Goal per Account ($)</label>
                            <input type="number" class="form-input" id="settingsGoalPerAcc" value="4600" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Payout per Account ($)</label>
                            <input type="number" class="form-input" id="settingsPayoutPerAcc" value="2000" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Daily Target Min ($)</label>
                            <input type="number" class="form-input" id="settingsDailyMin" value="250" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Daily Target Max ($)</label>
                            <input type="number" class="form-input" id="settingsDailyMax" value="300" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Max Daily Drawdown ($)</label>
                            <input type="number" class="form-input" id="settingsMaxDD" value="2500" min="0">
                          </div>
                          <div class="form-group">
                            <label class="form-label">Starting Balance ($)</label>
                            <input type="number" class="form-input" id="settingsStartBal" value="50000" min="0">
                          </div>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" style="width:auto;">üíæ Save Settings</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSettings()">Reset to Default</button>
                        </div>
                    </form>
                </div>

                <!-- Contract Size Editor -->
                <div class="form-card" style="margin-bottom:1.5rem;">
                  <h3 style="margin-bottom:0.5rem;font-size:1.05rem;font-weight:700;">üìã Risk Template Contract Sizes</h3>
                  <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Edit the number of contracts for each risk level. These update the Add Trade dropdown and template stats.</p>
                  <div class="contract-editor" id="contractEditor"></div>
                  <button class="btn btn-primary" style="width:auto;margin-top:0.75rem;" onclick="saveContractSizes()">üíæ Save Contract Sizes</button>
                </div>

                <!-- Account table -->
                <div class="table-card" style="margin-top:1.5rem;">
                    <div class="table-header"><span class="card-title">All Configured Accounts</span></div>
                    <div class="table-wrap"><table><thead><tr><th>Account</th><th>Nickname</th><th>Status</th><th>P&L</th><th>Progress</th><th>Trades</th><th>Win Rate</th><th>To Goal</th></tr></thead><tbody id="settingsAccBody"></tbody></table></div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="page" id="adminPanelPage">
                <div class="admin-banner">
                    <span class="admin-banner-icon">üëë</span>
                    <div class="admin-banner-text">
                        <strong>Admin Panel ‚Äî Full Visibility</strong>
                        <span>View all users, manage roles, view any user's trades, remove users.</span>
                    </div>
                </div>

                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Users</span><span class="metric-icon">üë•</span></div><div class="metric-value" id="adminTotalUsers">‚Äî</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Trades</span><span class="metric-icon">üìà</span></div><div class="metric-value" id="adminTotalTrades">‚Äî</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Combined P&L</span><span class="metric-icon">üí∞</span></div><div class="metric-value" id="adminTotalPnL">‚Äî</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Active Today</span><span class="metric-icon">üü¢</span></div><div class="metric-value" id="adminActiveToday">‚Äî</div></div>
                </div>

                <div class="table-card" style="margin-bottom:1.5rem;">
                    <div class="table-header">
                        <span class="card-title">User Management</span>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <input type="text" class="form-input" id="adminUserSearch" placeholder="Search email..." style="padding:0.4rem 0.75rem;font-size:0.85rem;width:200px;" oninput="filterAdminUsers()">
                            <button class="btn btn-secondary" onclick="loadAdminData()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Email</th><th>Role</th><th>Trades</th><th>Total P&L</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="adminUsersBody"></tbody></table>
                    </div>
                </div>

                <div id="adminUserTradesWrap" style="display:none;margin-bottom:1.5rem;">
                    <div class="section-header">
                        <div class="section-title">Trades for: <span id="adminViewingUserLabel" style="color:var(--accent);">‚Äî</span></div>
                        <div style="display:flex;gap:0.75rem;">
                            <button class="btn btn-secondary" onclick="viewUserDashboard()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">üëÅÔ∏è View Dashboard</button>
                            <button class="btn btn-secondary" onclick="closeUserTrades()" style="padding:0.4rem 0.875rem;font-size:0.8rem;">‚úï Close</button>
                        </div>
                    </div>
                    <div class="table-card">
                        <div class="table-wrap"><table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Cycle</th><th>Notes</th></tr></thead><tbody id="adminUserTradesBody"></tbody></table></div>
                    </div>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;">üîë Manage User Role</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Promote or demote any registered user.</p>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">User Email</label>
                            <input type="email" class="form-input" id="roleUserEmail" placeholder="trader@example.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Role</label>
                            <select class="form-select" id="roleUserRole">
                                <option value="user">User (standard)</option>
                                <option value="admin">Admin (full access)</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width:auto;" onclick="updateUserRole()">Update Role</button>
                </div>

                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;">üîí Reset User Password</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">Send a password reset email to any user.</p>
                    <div class="form-group" style="max-width:400px;">
                        <label class="form-label">User Email</label>
                        <input type="email" class="form-input" id="resetUserEmail" placeholder="trader@example.com">
                    </div>
                    <button class="btn btn-secondary" style="width:auto;" onclick="adminResetUserPassword()">üìß Send Reset Email</button>
                </div>

                <div class="form-card" style="border-color:rgba(240,92,106,0.2);background:rgba(240,92,106,0.02);">
                    <h3 style="margin-bottom:0.5rem;font-size:1rem;color:var(--danger);">üóëÔ∏è Remove User Data</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.25rem;">‚ö†Ô∏è Permanently deletes all trades and payouts for a user. Cannot be undone.</p>
                    <div class="form-group" style="max-width:400px;">
                        <label class="form-label">User Email</label>
                        <input type="email" class="form-input" id="removeUserEmail" placeholder="trader@example.com">
                    </div>
                    <button class="btn btn-danger" style="width:auto;" onclick="adminRemoveUserData()">Delete All User Data</button>
                </div>
            </div>

        </div><!-- /container -->
    </main>
</div><!-- /dashboard -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STARTING_BALANCE = 50000;
const MAX_DRAWDOWN = 2500;
const SAFETY_NET = 52600;
const GOAL_PER_ACCOUNT = 4600;
const PAYOUT_PER_ACCOUNT = 2000;
const DAILY_TARGET_MIN = 250;
const DAILY_TARGET_MAX = 300;

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ
let sbClient = null;
let currentUser = null;
let currentProfile = null;
let allData = [];
let payoutData = [];
let charts = {};
let accountFilter = 'all';
let USER_ACCOUNT_GOAL = 20;
let adminViewingUserId = null;
let adminViewingEmail = null;
let adminAllProfiles = [];
let adminAllTrades = [];
let journalSharing = false;

// Account nicknames stored in localStorage
function getNicknames() {
    try { return JSON.parse(localStorage.getItem('acc_nicknames') || '{}'); } catch { return {}; }
}
function saveNickname(accNum, name) {
    const n = getNicknames();
    if (name.trim()) n[accNum] = name.trim();
    else delete n[accNum];
    localStorage.setItem('acc_nicknames', JSON.stringify(n));
}
function getNickname(accNum) { return getNicknames()[accNum] || ''; }
function getAccLabel(accNum) {
    const n = getNickname(accNum);
    return n ? `PA #${accNum} ‚Äî ${n}` : `PA Account #${accNum}`;
}

// ‚îÄ‚îÄ‚îÄ Quotes ‚îÄ‚îÄ‚îÄ
const QUOTES = [
    { text: "The stock market is a device for transferring money from the impatient to the patient.", author: "Warren Buffett" },
    { text: "In trading, the one who wins is not who is right most often, but who loses least when wrong.", author: "Unknown" },
    { text: "Risk comes from not knowing what you're doing.", author: "Warren Buffett" },
    { text: "The goal of a successful trader is to make the best trades. Money is secondary.", author: "Alexander Elder" },
    { text: "Every battle is won before it is fought.", author: "Sun Tzu" },
    { text: "The market pays you to be disciplined.", author: "Unknown" },
    { text: "Don't think about what the market's going to do; you have absolutely no control over that. Think about what you're going to do if it gets there.", author: "William O'Neil" },
    { text: "Amateurs think about how much money they can make. Professionals think about how much money they could lose.", author: "Unknown" },
    { text: "It's not whether you're right or wrong that's important, but how much money you make when you're right and how much you lose when you're wrong.", author: "George Soros" },
    { text: "The key to trading success is emotional discipline. If intelligence were the key, there would be a lot more people making money trading.", author: "Victor Sperandeo" },
    { text: "Trade what you see, not what you think.", author: "Unknown" },
    { text: "A plan without action is just a dream. Action without a plan is just a disaster.", author: "Unknown" },
    { text: "The farmer does not plant seeds and dig them up every day to check. He trusts the process.", author: "Prop Farm Wisdom" },
    { text: "Consistency over perfection. Show up every day.", author: "Prop Farm Wisdom" },
    { text: "Protect the account. The account protects the dream.", author: "Prop Farm Wisdom" },
    { text: "Small daily wins compound into life-changing wealth.", author: "Prop Farm Wisdom" },
    { text: "Discipline is choosing between what you want now and what you want most.", author: "Abraham Lincoln" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "Do not pray for easy lives. Pray to be stronger men.", author: "John F. Kennedy" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" }
];
let quoteIdx = 0;

const MOOD_ADVICE = {
    'üî•': { text: "You're in the zone! Stick to your rules ‚Äî hot streaks can turn into overtrading fast. Stay disciplined.", color: 'var(--success)' },
    'üòé': { text: "Calm and ready is the perfect trading state. Execute your plan with confidence.", color: 'var(--success)' },
    'üòå': { text: "Neutral is fine. Don't force trades. Wait for your setup. One good trade beats five mediocre ones.", color: 'var(--accent)' },
    'üò§': { text: "‚ö†Ô∏è Tension detected. Size down today. A smaller win builds confidence. Don't let tension become mistakes.", color: 'var(--warning)' },
    'üò∞': { text: "üö® Anxious traders make bad decisions. Consider sitting out or trading with 50% size. Protect the account.", color: 'var(--danger)' },
    'üö´': { text: "Smart move recognizing you're not ready. A no-trade day is a zero ‚Äî which beats a red day every time. Rest up.", color: 'var(--purple)' }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSupabase() {
    const url = 'https://zxwdfvdbbawynddwwfri.supabase.co';
    const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4d2RmdmRiYmF3eW5kZHd3ZnJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzAxNDIsImV4cCI6MjA4NzAwNjE0Mn0.NQ6jypfrevL9pzV7l6jCjOajZLCwdZVYh0CHxDzBflI';
    try { sbClient = window.supabase.createClient(url, key); return true; }
    catch (e) { console.error('Supabase init error:', e); return false; }
}

async function checkSession() {
    if (!initSupabase()) return;

    // Check for public journal view
    const params = new URLSearchParams(window.location.search);
    const journalUserId = params.get('journal');
    if (journalUserId) { loadPublicJournal(journalUserId); return; }

    // Listen for auth changes FIRST (handles Google OAuth redirect coming back to page)
    sbClient.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session) {
            currentUser = session.user;
            await loadProfile();

            // For brand new users (no profile yet), create one
            if (!currentProfile) {
                const pending = window._pendingUsername;
                const googleName = (session.user.user_metadata?.full_name || session.user.user_metadata?.name || '').split(' ')[0].replace(/[^a-zA-Z0-9_]/g,'');
                const uname = pending || googleName || session.user.email?.split('@')[0]?.replace(/[^a-zA-Z0-9_]/g,'') || 'Trader';
                try {
                    const { data } = await sbClient.from('profiles').upsert({
                        id: currentUser.id,
                        email: session.user.email || null,
                        username: uname,
                        role: 'user',
                        account_goal: 20
                    }).select().single();
                    currentProfile = data;
                } catch(e) { console.error('Profile create error:', e); }
                window._pendingUsername = null;
            }
            showDashboard();
        }
        else if (event === 'SIGNED_OUT') {
            currentUser = null;
            currentProfile = null;
            hideDashboard();
        }
    });

    // Then check for existing session (returning user / page refresh)
    try {
        const { data: { session } } = await sbClient.auth.getSession();
        if (session) {
            currentUser = session.user;
            await loadProfile();
            showDashboard();
        }
    } catch (e) { console.error('Session check error:', e); }
}

async function loadProfile() {
    if (!currentUser) return;
    try {
        const { data, error } = await sbClient.from('profiles').select('*').eq('id', currentUser.id).single();
        if (!error && data) { currentProfile = data; USER_ACCOUNT_GOAL = data.account_goal || 20; }
    } catch (e) { console.error('Load profile error:', e); }
}

checkSession();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PUBLIC JOURNAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPublicJournal(userId) {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('publicView').classList.add('show');

    try {
        const [{ data: profile }, { data: trades }] = await Promise.all([
            sbClient.from('profiles').select('email, account_goal').eq('id', userId).single(),
            sbClient.from('trades').select('*').eq('user_id', userId).order('trade_date', { ascending: false }).limit(200)
        ]);

        const displayName = profile?.email?.split('@')[0] || 'Trader';
        const initials = displayName.substring(0, 2).toUpperCase();
        document.getElementById('publicAvatar').textContent = initials;
        document.getElementById('publicUserName').textContent = displayName + "'s Trading Journal";
        document.getElementById('publicUserSub').textContent = `${trades?.length || 0} trades ‚Ä¢ Public Journal`;
        document.getElementById('publicTradeCount').textContent = (trades?.length || 0) + ' trades';

        const validTrades = (trades || []).filter(t => !t.no_trade_day);
        const pnl = validTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = validTrades.filter(t => parseFloat(t.pnl || 0) > 0);
        const winRate = validTrades.length > 0 ? Math.round(wins.length / validTrades.length * 100) : 0;
        const streak = calcStreak(validTrades);

        document.getElementById('publicMetrics').innerHTML = `
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">üí∞</span></div><div class="metric-value" style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</div><div class="metric-sub">${validTrades.length} trades</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">üéØ</span></div><div class="metric-value">${winRate}%</div><div class="metric-sub">${wins.length} wins / ${validTrades.length} trades</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Streak</span><span class="metric-icon">üî•</span></div><div class="metric-value">${streak.current}</div><div class="metric-sub">Longest: ${streak.longest}</div></div>
            <div class="metric-card"><div class="metric-header"><span class="metric-label">Best Trade</span><span class="metric-icon">‚≠ê</span></div><div class="metric-value">${fmtCurrency(validTrades.length ? Math.max(...validTrades.map(t => parseFloat(t.pnl || 0))) : 0)}</div><div class="metric-sub">All time</div></div>
        `;

        const tbody = document.getElementById('publicTradeBody');
        tbody.innerHTML = '';
        (trades || []).slice(0, 100).forEach(t => {
            if (t.no_trade_day) return;
            const pnl = parseFloat(t.pnl || 0);
            const row = tbody.insertRow();
            row.innerHTML = `<td>${t.trade_date}</td><td>PA #${t.account}</td><td>${t.market_condition || '‚Äî'}</td><td>$${t.risk_template}</td><td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.cycle}</td>`;
        });
    } catch (err) {
        document.getElementById('publicUserName').textContent = 'Journal Not Found';
        document.getElementById('publicUserSub').textContent = 'This journal is not available or sharing is disabled.';
    }
}

function getShareLink() {
    return `${window.location.origin}${window.location.pathname}?journal=${currentUser?.id}`;
}

function toggleSharing() {
    journalSharing = !journalSharing;
    const toggle = document.getElementById('shareToggle');
    const label = document.getElementById('shareStatusLabel');
    const linkBox = document.getElementById('shareLinkDisplay');
    toggle.classList.toggle('on', journalSharing);
    label.textContent = journalSharing ? 'Sharing On ‚úì' : 'Sharing Off';
    label.style.color = journalSharing ? 'var(--success)' : 'var(--text-muted)';
    linkBox.textContent = journalSharing ? getShareLink() : 'Enable sharing to generate your link';
    localStorage.setItem('journal_sharing', journalSharing ? '1' : '0');
    showAlert(journalSharing ? '‚úì Journal sharing enabled! Your link is ready.' : '‚úì Sharing disabled.', journalSharing ? 'success' : 'info');
}

function copyShareLink() {
    if (!journalSharing) { showAlert('Enable sharing first!', 'error'); return; }
    const link = getShareLink();
    navigator.clipboard.writeText(link).then(() => showAlert('‚úì Link copied to clipboard!', 'success'));
}

function previewJournal() {
    if (currentUser) {
        window.open(getShareLink(), '_blank');
    }
}

function saveJournalSettings() {
    const settings = {
        displayName: document.getElementById('journalDisplayName').value,
        bio: document.getElementById('journalBio').value,
        showPnL: document.getElementById('showPnL').checked,
        showWinRate: document.getElementById('showWinRate').checked,
        showTrades: document.getElementById('showTrades').checked,
        showAccounts: document.getElementById('showAccounts').checked
    };
    localStorage.setItem('journal_settings', JSON.stringify(settings));
    showAlert('‚úì Journal settings saved!', 'success');
    updateShareJournalPage();
}

function updateShareJournalPage() {
    // Restore sharing state
    journalSharing = localStorage.getItem('journal_sharing') === '1';
    const toggle = document.getElementById('shareToggle');
    const label = document.getElementById('shareStatusLabel');
    const linkBox = document.getElementById('shareLinkDisplay');
    toggle.classList.toggle('on', journalSharing);
    label.textContent = journalSharing ? 'Sharing On ‚úì' : 'Sharing Off';
    label.style.color = journalSharing ? 'var(--success)' : 'var(--text-muted)';
    if (currentUser) linkBox.textContent = journalSharing ? getShareLink() : 'Enable sharing to generate your link';

    // Restore settings
    try {
        const s = JSON.parse(localStorage.getItem('journal_settings') || '{}');
        if (s.displayName) document.getElementById('journalDisplayName').value = s.displayName;
        if (s.bio) document.getElementById('journalBio').value = s.bio;
        if (s.showPnL !== undefined) document.getElementById('showPnL').checked = s.showPnL;
        if (s.showWinRate !== undefined) document.getElementById('showWinRate').checked = s.showWinRate;
        if (s.showTrades !== undefined) document.getElementById('showTrades').checked = s.showTrades;
        if (s.showAccounts !== undefined) document.getElementById('showAccounts').checked = s.showAccounts;
    } catch {}

    // Preview
    const trades = allData.filter(t => !t.no_trade_day);
    const pnl = sumPnL(trades);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const wr = trades.length > 0 ? Math.round(wins.length / trades.length * 100) : 0;
    document.getElementById('journalPreviewMetrics').innerHTML = `
        <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L</span><span class="metric-icon">üí∞</span></div><div class="metric-value" style="color:${pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(pnl)}</div><div class="metric-sub">${trades.length} trades</div></div>
        <div class="metric-card"><div class="metric-header"><span class="metric-label">Win Rate</span><span class="metric-icon">üéØ</span></div><div class="metric-value">${wr}%</div><div class="metric-sub">${wins.length} / ${trades.length}</div></div>
    `;
    const tbody = document.getElementById('journalPreviewBody');
    tbody.innerHTML = '';
    [...allData].filter(t=>!t.no_trade_day).sort((a,b)=>new Date(b.trade_date)-new Date(a.trade_date)).slice(0,10).forEach(t => {
        const p = parseFloat(t.pnl||0);
        const row = tbody.insertRow();
        row.innerHTML = `<td>${t.trade_date}</td><td style="color:${p>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(p)}</td><td>${t.market_condition||'‚Äî'}</td><td>${t.cycle}</td>`;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PSYCHOLOGY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showQuote(idx) {
    const q = QUOTES[idx];
    document.getElementById('dailyQuoteText').textContent = '"' + q.text + '"';
    document.getElementById('dailyQuoteAuthor').textContent = '‚Äî ' + q.author;
    document.getElementById('quoteCounter').textContent = (idx + 1) + ' / ' + QUOTES.length;
}
function nextQuote() { quoteIdx = (quoteIdx + 1) % QUOTES.length; showQuote(quoteIdx); }
function prevQuote() { quoteIdx = (quoteIdx - 1 + QUOTES.length) % QUOTES.length; showQuote(quoteIdx); }

function selectMood(btn, emoji, label) {
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    const advice = MOOD_ADVICE[emoji];
    const el = document.getElementById('moodAdvice');
    if (advice) {
        el.textContent = advice.text;
        el.style.color = advice.color;
        el.style.borderLeft = '3px solid ' + advice.color;
        el.style.display = 'block';
    }
    localStorage.setItem('today_mood', emoji);
}

function toggleCheck(item) {
    item.classList.toggle('done');
    if (item.classList.contains('done')) {
        item.querySelector('.checklist-checkbox').textContent = '‚úì';
        item.querySelector('.checklist-checkbox').style.color = 'white';
    } else {
        item.querySelector('.checklist-checkbox').textContent = '';
    }
    const total = document.querySelectorAll('.checklist-item').length;
    const done = document.querySelectorAll('.checklist-item.done').length;
    const status = document.getElementById('checklistStatus');
    if (done === total) { status.textContent = '‚úÖ All checks passed! You\'re ready to trade.'; status.style.color = 'var(--success)'; }
    else { status.textContent = `${done} / ${total} completed`; status.style.color = 'var(--text-muted)'; }
}

function resetChecklist() {
    document.querySelectorAll('.checklist-item').forEach(item => {
        item.classList.remove('done');
        item.querySelector('.checklist-checkbox').textContent = '';
    });
    document.getElementById('checklistStatus').textContent = '';
}

let journalSaveTimer;
function saveJournalNote() {
    const text = document.getElementById('journalNote').value;
    document.getElementById('journalCharCount').textContent = text.length + ' chars';
    clearTimeout(journalSaveTimer);
    journalSaveTimer = setTimeout(() => {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem('journal_' + today, text);
        document.getElementById('journalSaveStatus').textContent = '‚úì Saved ' + new Date().toLocaleTimeString();
    }, 800);
}

function loadTodayJournal() {
    const today = new Date().toISOString().split('T')[0];
    const saved = localStorage.getItem('journal_' + today) || '';
    document.getElementById('journalNote').value = saved;
    document.getElementById('journalCharCount').textContent = saved.length + ' chars';
}

function updatePsychPage() {
    // today's quote (based on day of year)
    const dayOfYear = Math.floor((Date.now() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    quoteIdx = dayOfYear % QUOTES.length;
    showQuote(quoteIdx);
    // streak
    const trades = allData.filter(t => !t.no_trade_day);
    const streak = calcStreak(trades);
    document.getElementById('psychStreakNum').textContent = streak.current;
    // restore mood
    const savedMood = localStorage.getItem('today_mood');
    if (savedMood) {
        document.querySelectorAll('.mood-btn').forEach(btn => {
            if (btn.querySelector('.mood-label')?.textContent === savedMood) btn.classList.add('selected');
        });
    }
    // load journal
    loadTodayJournal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH HANDLERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t, i) => {
        const tabs = ['login','signup','reset'];
        t.classList.toggle('active', tabs[i] === tab);
    });
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    const map = { login: 'loginForm', signup: 'signupForm', reset: 'resetForm' };
    document.getElementById(map[tab])?.classList.add('active');
    clearAuthMessages();
}

function setBtnLoading(prefix, loading) {
    const btn = document.getElementById(prefix + 'Btn');
    const text = document.getElementById(prefix + 'BtnText');
    const spin = document.getElementById(prefix + 'Spinner');
    if (btn) btn.disabled = loading;
    if (text) text.style.display = loading ? 'none' : 'inline';
    if (spin) spin.style.display = loading ? 'inline-block' : 'none';
}

function showAuthError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 8000);
}
function showAuthSuccess(msg) {
    const el = document.getElementById('authSuccess');
    el.textContent = msg; el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 10000);
}
function clearAuthMessages() {
    document.getElementById('authError').classList.remove('show');
    document.getElementById('authSuccess').classList.remove('show');
}

async function handleLogin(e) {
    e.preventDefault();
    clearAuthMessages();
    setBtnLoading('login', true);
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username || !password) {
        setBtnLoading('login', false);
        showAuthError('Please enter your username and password.');
        return;
    }
    try {
        // Try to find email from username in profiles table
        const { data: profile } = await sbClient
            .from('profiles')
            .select('email')
            .ilike('username', username)
            .maybeSingle();

        // Use real email if found, otherwise fall back to internal @propfarmpro.app address
        const email = (profile?.email && !profile.email.includes('@propfarmpro.app'))
            ? profile.email
            : (profile?.email || `${username.toLowerCase()}@propfarmpro.app`);

        const { error } = await sbClient.auth.signInWithPassword({ email, password });
        setBtnLoading('login', false);
        if (error) {
            if (error.message.includes('Invalid login credentials')) {
                showAuthError('‚ùå Wrong username or password. Check your details and try again.');
            } else {
                showAuthError(error.message);
            }
        }
    } catch(err) {
        setBtnLoading('login', false);
        showAuthError('Sign in error: ' + err.message);
    }
}

async function handleSignup(e) {
    e.preventDefault();
    clearAuthMessages();
    const username = document.getElementById('signupUsername').value.trim();
    const pass = document.getElementById('signupPassword').value;
    const confirm = document.getElementById('signupConfirm').value;
    if (!username || username.length < 3) { showAuthError('Username must be at least 3 characters.'); return; }
    if (pass !== confirm) { showAuthError('Passwords do not match.'); return; }
    setBtnLoading('signup', true);
    // Check username taken
    const { data: existing } = await sbClient.from('profiles').select('id').ilike('username', username).maybeSingle();
    if (existing) { setBtnLoading('signup', false); showAuthError('‚ùå Username already taken. Choose a different one.'); return; }
    window._pendingUsername = username;
    const internalEmail = `${username.toLowerCase()}@propfarmpro.app`;
    const { data, error } = await sbClient.auth.signUp({ email: internalEmail, password: pass, options: { data: { username } } });
    setBtnLoading('signup', false);
    if (error) { showAuthError(error.message); window._pendingUsername = null; return; }
    if (data?.session) { showAuthSuccess('‚úÖ Account created! Setting up your profile...'); return; }
    showAuthSuccess('‚úÖ Account created! Signing you in...');
}

async function handlePasswordReset(e) {
    e.preventDefault();
    clearAuthMessages();
    setBtnLoading('reset', true);
    const input = document.getElementById('resetEmail').value.trim();
    let emailToReset = input;
    if (!input.includes('@')) {
        const { data: profile } = await sbClient.from('profiles').select('email').ilike('username', input).maybeSingle();
        if (!profile?.email || profile.email.includes('@propfarmpro.app')) {
            setBtnLoading('reset', false);
            showAuthError('No recovery email linked to this account. Link one in Settings ‚Üí My Profile first.');
            return;
        }
        emailToReset = profile.email;
    }
    const { error } = await sbClient.auth.resetPasswordForEmail(emailToReset, { redirectTo: window.location.href });
    setBtnLoading('reset', false);
    if (error) { showAuthError(error.message); return; }
    showAuthSuccess('‚úÖ Reset link sent! Check your inbox and spam folder.');
}

async function handleGoogleAuth() {
    clearAuthMessages();
    try {
        const { error } = await sbClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.href.split('?')[0].split('#')[0]
            }
        });
        if (error) showAuthError('Google sign-in failed: ' + error.message);
    } catch(e) {
        showAuthError('Google sign-in error: ' + e.message);
    }
}

async function handleLogout() {
    adminViewingUserId = null;
    adminViewingEmail = null;
    await sbClient.auth.signOut();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDashboard() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.add('show');

    const displayName = currentProfile?.username
        || currentProfile?.display_name
        || currentUser?.user_metadata?.full_name?.split(' ')[0]
        || currentUser?.user_metadata?.name?.split(' ')[0]
        || currentUser?.email?.split('@')[0]?.replace(/@propfarmpro\.app$/, '')
        || 'Trader';

    const initials = displayName.substring(0, 2).toUpperCase();
    const isAdmin = currentProfile?.role === 'admin';

    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userRole').textContent = isAdmin ? 'üëë Admin' : 'Member';
    document.getElementById('userRole').className = 'user-role' + (isAdmin ? ' admin' : '');
    document.getElementById('heroName').textContent = displayName;
    document.getElementById('adminNavItem').style.display = isAdmin ? 'flex' : 'none';

    populateDropdowns();
    setTodayDates();
    buildContractEditor();
    loadDashboardData();

    // Show onboarding only for brand new users with no username set
    if (!currentProfile?.username) {
        setTimeout(() => startOnboarding(), 800);
    }
}

function hideDashboard() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('dashboard').classList.remove('show');
    allData = [];
    payoutData = [];
    destroyCharts();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA LOADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDashboardData() {
    const uid = adminViewingUserId || currentUser?.id;
    if (!uid) return;
    try {
        const [{ data: trades, error: te }, { data: payouts, error: pe }] = await Promise.all([
            sbClient.from('trades').select('*').eq('user_id', uid).order('trade_date', { ascending: true }),
            sbClient.from('payouts').select('*').eq('user_id', uid).order('payout_date', { ascending: true })
        ]);
        if (te) throw te;
        allData = trades || [];
        payoutData = pe ? [] : (payouts || []);
        updateAllViews();
    } catch (err) {
        console.error('Load data error:', err);
        showAlert('Failed to load data: ' + err.message, 'error');
    }
}

async function refreshData() {
    showAlert('Syncing...', 'info');
    await loadProfile();
    await loadDashboardData();
    showAlert('‚úì Data refreshed', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRADE SUBMISSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleTradeSubmit(e) {
    e.preventDefault();
    setBtnLoadingCustom('tradeSubmit', true);

    const isNoTrade = document.getElementById('noTradeDay').checked;
    const isCopier = document.getElementById('copierMode').checked;
    const cycle = parseInt(document.getElementById('tradeCycle').value) || 1;
    const date = document.getElementById('tradeDate').value;
    const notes = document.getElementById('tradeNotes').value || '';
    const ts = new Date().toISOString();
    const userId = currentUser.id;

    if (!date) { showAlert('Please select a trade date', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }

    let trades = [];

    if (isNoTrade) {
        trades.push({ user_id: userId, account: 'N/A', account_type: 'no_trade', market_condition: 'No Trade', risk_template: '0', trade_date: date, cycle, pnl: 0, contracts: 0, notes: notes || 'No-trade day', no_trade_day: true, timestamp: ts });
    } else if (isCopier) {
        const lead = document.getElementById('leadAccount').value;
        const followers = [...document.querySelectorAll('.follower-checkbox:checked')].map(c => c.value);
        const pnlRaw = document.getElementById('tradePnL').value;
        const condition = document.getElementById('tradeCondition').value;
        const risk = document.getElementById('tradeRisk').value;
        if (!lead || !followers.length || !condition || !risk || pnlRaw === '') { showAlert('Fill all required fields', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const pnl = parseFloat(pnlRaw);
        const contracts = parseInt(risk) / 100;
        [lead, ...followers].forEach((acc, i) => {
            trades.push({ user_id: userId, account: String(acc), account_type: i === 0 ? 'lead' : 'follower', copy_group: ts, market_condition: condition, risk_template: risk, trade_date: date, cycle, pnl, contracts, notes, no_trade_day: false, timestamp: ts });
        });
    } else {
        const acc = document.getElementById('tradeAccount').value;
        const pnlRaw = document.getElementById('tradePnL').value;
        const condition = document.getElementById('tradeCondition').value;
        const risk = document.getElementById('tradeRisk').value;
        if (!acc || !condition || !risk || pnlRaw === '') { showAlert('Fill all required fields', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const pnl = parseFloat(pnlRaw);
        if (isNaN(pnl)) { showAlert('P&L must be a number', 'error'); setBtnLoadingCustom('tradeSubmit', false); return; }
        const contracts = parseInt(risk) / 100;
        trades.push({ user_id: userId, account: String(acc), account_type: 'single', market_condition: condition, risk_template: risk, trade_date: date, cycle, pnl, contracts, notes, no_trade_day: false, timestamp: ts });
    }

    try {
        const { error } = await sbClient.from('trades').insert(trades);
        if (error) throw error;
        showAlert('‚úì ' + trades.length + ' trade(s) logged!', 'success');
        resetTradeForm();
        await loadDashboardData();
        setTimeout(() => navigateTo('overview'), 1200);
    } catch (err) {
        showAlert('Failed: ' + (err.message || 'Unknown error'), 'error');
    } finally { setBtnLoadingCustom('tradeSubmit', false); }
}

function setBtnLoadingCustom(id, loading) {
    const btn = document.getElementById(id + 'Btn');
    const text = document.getElementById(id + 'Text');
    const spin = document.getElementById(id + 'Spinner');
    if (btn) btn.disabled = loading;
    if (text) text.style.display = loading ? 'none' : 'inline';
    if (spin) spin.style.display = loading ? 'inline-block' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAYOUT SUBMISSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handlePayoutSubmit(e) {
    e.preventDefault();
    setBtnLoadingCustom('payoutSubmit', true);
    const payout = {
        user_id: currentUser.id,
        payout_type: document.getElementById('payoutType').value,
        amount: parseFloat(document.getElementById('withdrawalAmount').value),
        payout_date: document.getElementById('payoutDate').value,
        account: document.getElementById('payoutAccount').value,
        cycle_completed: parseInt(document.getElementById('cycleCompleted').value),
        new_cycle: parseInt(document.getElementById('newCycle').value),
        notes: document.getElementById('payoutNotes').value
    };
    const { error } = await sbClient.from('payouts').insert([payout]);
    setBtnLoadingCustom('payoutSubmit', false);
    if (error) { showAlert('‚úó Failed: ' + error.message, 'error'); return; }
    showAlert('‚úì Payout logged!', 'success');
    resetPayoutForm();
    await loadDashboardData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DELETE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteByCycle() {
    const cycle = document.getElementById('deleteCycleSelect').value;
    if (!cycle) { showAlert('Select a cycle first', 'error'); return; }
    if (!confirm(`Delete ALL trades from Cycle ${cycle}?`)) return;
    const { error } = await sbClient.from('trades').delete().eq('user_id', currentUser.id).eq('cycle', parseInt(cycle));
    if (error) { showAlert('Delete failed: ' + error.message, 'error'); return; }
    showAlert(`‚úì Cycle ${cycle} trades deleted`, 'success');
    await loadDashboardData();
}

async function deleteByAccount() {
    const acc = document.getElementById('deleteAccSelect').value;
    if (!acc) { showAlert('Select an account first', 'error'); return; }
    if (!confirm(`Delete ALL trades from PA Account #${acc}?`)) return;
    const { error } = await sbClient.from('trades').delete().eq('user_id', currentUser.id).eq('account', acc);
    if (error) { showAlert('Delete failed: ' + error.message, 'error'); return; }
    showAlert(`‚úì Account #${acc} trades deleted`, 'success');
    await loadDashboardData();
}

async function confirmDeleteAll() {
    if (!confirm('‚ö†Ô∏è Delete ALL your trades AND payouts? IRREVERSIBLE!')) return;
    const confirmed = prompt('Type "DELETE ALL" to confirm:');
    if (confirmed !== 'DELETE ALL') { showAlert('Cancelled', 'info'); return; }
    await Promise.all([
        sbClient.from('trades').delete().eq('user_id', currentUser.id),
        sbClient.from('payouts').delete().eq('user_id', currentUser.id)
    ]);
    showAlert('‚úì All data deleted', 'success');
    await loadDashboardData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function handleSettingsSave(e) {
    e.preventDefault();
    let goal = parseInt(document.getElementById('accountGoalSelect').value);
    if (isNaN(goal)) goal = parseInt(document.getElementById('customGoalInput').value);
    if (!goal || goal < 1 || goal > 200) { showAlert('Enter a valid goal (1‚Äì200)', 'error'); return; }

    const updates = {
        id: currentUser.id,
        account_goal: goal,
        goal_per_account: parseFloat(document.getElementById('settingsGoalPerAcc')?.value) || 4600,
        payout_per_account: parseFloat(document.getElementById('settingsPayoutPerAcc')?.value) || 2000,
        daily_target_min: parseFloat(document.getElementById('settingsDailyMin')?.value) || 250,
        daily_target_max: parseFloat(document.getElementById('settingsDailyMax')?.value) || 300,
        max_drawdown: parseFloat(document.getElementById('settingsMaxDD')?.value) || 2500,
        starting_balance: parseFloat(document.getElementById('settingsStartBal')?.value) || 50000,
    };

    const { error } = await sbClient.from('profiles').upsert(updates);
    if (error) { showAlert('Save failed: ' + error.message, 'error'); return; }
    currentProfile = { ...currentProfile, ...updates };
    USER_ACCOUNT_GOAL = goal;
    applyProfileToConfig(updates);
    populateDropdowns();
    updateAllViews();
    showAlert(`‚úì Settings saved!`, 'success');
}

function handleGoalSelectChange(val) {
    document.getElementById('customGoalWrap').style.display = val === 'custom' ? 'block' : 'none';
}
function resetSettings() { document.getElementById('accountGoalSelect').value = '20'; document.getElementById('customGoalWrap').style.display = 'none'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCOUNT NAMING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAccNickname(accNum, inputEl) {
    saveNickname(accNum, inputEl.value);
    populateDropdowns();
    updateAllViews();
    showAlert(`‚úì Account #${accNum} named "${inputEl.value || '(cleared'}"`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadAdminData() {
    if (currentProfile?.role !== 'admin') return;
    document.getElementById('adminUsersBody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted);">Loading...</td></tr>';
    try {
        const [{ data: profiles }, { data: allTrades }] = await Promise.all([
            sbClient.from('profiles').select('*').order('created_at', { ascending: false }),
            sbClient.from('trades').select('*')
        ]);
        adminAllProfiles = profiles || [];
        adminAllTrades = allTrades || [];
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('adminTotalUsers').textContent = adminAllProfiles.length;
        document.getElementById('adminTotalTrades').textContent = adminAllTrades.length;
        const combinedPnL = adminAllTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        document.getElementById('adminTotalPnL').textContent = fmtCurrency(combinedPnL);
        const activeToday = new Set(adminAllTrades.filter(t => t.trade_date === today).map(t => t.user_id)).size;
        document.getElementById('adminActiveToday').textContent = activeToday;
        renderAdminUsers(adminAllProfiles);
    } catch (err) { showAlert('Failed to load admin data: ' + err.message, 'error'); }
}

function renderAdminUsers(profiles) {
    const tbody = document.getElementById('adminUsersBody');
    tbody.innerHTML = '';
    if (!profiles.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-muted);">No users found</td></tr>'; return; }
    profiles.forEach(profile => {
        const userTrades = adminAllTrades.filter(t => t.user_id === profile.id);
        const userPnL = userTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const row = tbody.insertRow();
        row.dataset.email = (profile.email || '').toLowerCase();
        row.innerHTML = `
            <td><strong>${profile.email || '‚Äî'}</strong></td>
            <td><span class="badge ${profile.role === 'admin' ? 'badge-admin' : 'badge-active'}">${profile.role || 'user'}</span></td>
            <td>${userTrades.length}</td>
            <td style="color:${userPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(userPnL)}</td>
            <td>${profile.created_at ? new Date(profile.created_at).toLocaleDateString() : '‚Äî'}</td>
            <td><div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="viewUserTrades('${profile.id}','${profile.email}')">üëÅ Trades</button>
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="viewUserDashboardById('${profile.id}','${profile.email}')">üìä Dashboard</button>
                <button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="quickToggleRole('${profile.id}','${profile.role || 'user'}','${profile.email}')">${profile.role === 'admin' ? '‚Üì Demote' : '‚Üë Promote'}</button>
                <button class="btn btn-danger" style="padding:0.3rem 0.6rem;font-size:0.75rem;" onclick="adminRemoveUserDataById('${profile.id}','${profile.email}')">üóë</button>
            </div></td>`;
    });
}

function filterAdminUsers() {
    const q = document.getElementById('adminUserSearch').value.toLowerCase();
    document.querySelectorAll('#adminUsersBody tr').forEach(row => { row.style.display = !q || (row.dataset.email || '').includes(q) ? '' : 'none'; });
}

async function viewUserTrades(userId, email) {
    const { data: trades } = await sbClient.from('trades').select('*').eq('user_id', userId).order('trade_date', { ascending: false }).limit(100);
    document.getElementById('adminViewingUserLabel').textContent = email;
    document.getElementById('adminUserTradesWrap').style.display = 'block';
    const tbody = document.getElementById('adminUserTradesBody');
    tbody.innerHTML = '';
    if (!trades?.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted);">No trades</td></tr>'; return; }
    trades.forEach(t => {
        const pnl = parseFloat(t.pnl || 0);
        const row = tbody.insertRow();
        row.innerHTML = `<td>${t.trade_date}</td><td>PA #${t.account}</td><td>${t.market_condition||'‚Äî'}</td><td>$${t.risk_template||'‚Äî'}</td><td style="color:${pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.cycle}</td><td>${t.notes||'‚Äî'}</td>`;
    });
    document.getElementById('adminUserTradesWrap').scrollIntoView({ behavior: 'smooth' });
}
function closeUserTrades() { document.getElementById('adminUserTradesWrap').style.display = 'none'; }

async function viewUserDashboardById(userId, email) {
    adminViewingUserId = userId;
    adminViewingEmail = email;
    document.getElementById('adminViewingLabel').textContent = email;
    document.getElementById('adminViewingBanner').style.display = 'flex';
    await loadDashboardData();
    navigateTo('overview');
}
function viewUserDashboard() { if (adminViewingUserId) viewUserDashboardById(adminViewingUserId, adminViewingEmail); }
function exitAdminView() {
    adminViewingUserId = null; adminViewingEmail = null;
    document.getElementById('adminViewingBanner').style.display = 'none';
    loadDashboardData();
}

async function quickToggleRole(userId, currentRole, email) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    if (!confirm(`Change ${email}'s role to ${newRole}?`)) return;
    const { error } = await sbClient.from('profiles').update({ role: newRole }).eq('id', userId);
    if (error) { showAlert('Role update failed: ' + error.message, 'error'); return; }
    showAlert(`‚úì ${email} is now ${newRole}`, 'success');
    loadAdminData();
}

async function updateUserRole() {
    const email = document.getElementById('roleUserEmail').value.trim();
    const role = document.getElementById('roleUserRole').value;
    if (!email) { showAlert('Enter a user email', 'error'); return; }
    const { data: profile, error: fe } = await sbClient.from('profiles').select('id').eq('email', email).single();
    if (fe || !profile) { showAlert('User not found. They must sign up first.', 'error'); return; }
    const { error } = await sbClient.from('profiles').update({ role }).eq('id', profile.id);
    if (error) { showAlert('Failed: ' + error.message, 'error'); return; }
    showAlert(`‚úì ${email} role updated to ${role}`, 'success');
    document.getElementById('roleUserEmail').value = '';
    loadAdminData();
}

async function adminResetUserPassword() {
    const email = document.getElementById('resetUserEmail').value.trim();
    if (!email) { showAlert('Enter a user email', 'error'); return; }
    const { error } = await sbClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
    if (error) { showAlert('Failed: ' + error.message, 'error'); return; }
    showAlert(`‚úì Reset email sent to ${email}`, 'success');
    document.getElementById('resetUserEmail').value = '';
}

async function adminRemoveUserData() {
    const email = document.getElementById('removeUserEmail').value.trim();
    if (!email) { showAlert('Enter a user email', 'error'); return; }
    const { data: profile } = await sbClient.from('profiles').select('id').eq('email', email).single();
    if (!profile) { showAlert('User not found', 'error'); return; }
    await adminRemoveUserDataById(profile.id, email);
    document.getElementById('removeUserEmail').value = '';
}

async function adminRemoveUserDataById(userId, email) {
    if (!confirm(`Delete ALL trades and payouts for ${email}? Cannot be undone.`)) return;
    const [{ error: e1 }, { error: e2 }] = await Promise.all([
        sbClient.from('trades').delete().eq('user_id', userId),
        sbClient.from('payouts').delete().eq('user_id', userId)
    ]);
    if (e1 || e2) { showAlert('Delete failed', 'error'); return; }
    showAlert(`‚úì All data for ${email} deleted`, 'success');
    loadAdminData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VIEW UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAllViews() {
    updateHero();
    updateMetrics();
    updateStats();
    updateCharts();
    updateTemplates();
    updateAccounts();
    updateAnalytics();
    updateTradeLog();
    updateRiskMonitor();
    updateCyclePerformance();
    updatePayoutPage();
    updateSettingsPage();
    updatePsychPage();
    updateShareJournalPage();
}

function updateHero() {
    const totalPnL = sumPnL(allData);
    const goal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
    const progress = Math.min((totalPnL / goal) * 100, 100);
    const atGoal = getAccountsAtGoal();
    document.getElementById('heroTotalPnL').textContent = fmtCurrency(totalPnL);
    document.getElementById('heroProgress').textContent = Math.round(progress) + '%';
    document.getElementById('heroAccounts').textContent = `${atGoal}/${USER_ACCOUNT_GOAL}`;
    document.getElementById('heroTitle').textContent = totalPnL >= goal ? 'Harvesting Your' : 'Building Your';
}

function updateMetrics() {
    const pnl = sumPnL(allData);
    const trades = allData.filter(t => !t.no_trade_day);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const losses = trades.filter(t => parseFloat(t.pnl || 0) < 0);
    const winRate = trades.length > 0 ? (wins.length / trades.length) * 100 : 0;
    const totalWinsAmt = wins.reduce((s, t) => s + parseFloat(t.pnl), 0);
    const totalLossAmt = Math.abs(losses.reduce((s, t) => s + parseFloat(t.pnl), 0));
    const pf = totalLossAmt > 0 ? totalWinsAmt / totalLossAmt : 0;
    const avg = trades.length > 0 ? pnl / trades.length : 0;
    const streak = calcStreak(trades);
    const progress = Math.min((pnl / (USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT)) * 100, 100);

    document.getElementById('totalPnL').textContent = fmtCurrency(pnl);
    document.getElementById('pnlSub').textContent = `All time ‚Ä¢ ${allData.length} entries`;
    document.getElementById('winRate').textContent = Math.round(winRate) + '%';
    document.getElementById('winStatsSub').textContent = `${wins.length} wins / ${trades.length} trades`;
    document.getElementById('profitFactor').textContent = pf.toFixed(2);
    document.getElementById('pfSub').textContent = pf > 1.5 ? 'üî• Excellent' : pf > 1 ? 'Good' : pf > 0 ? 'Needs work' : '‚Äî';
    document.getElementById('winStreak').textContent = streak.current;
    document.getElementById('streakSub').textContent = streak.current > 0 ? `üî• ${streak.current} wins in a row!` : 'No active streak';
    document.getElementById('totalTrades').textContent = trades.length;
    document.getElementById('tradesSub').textContent = `Across ${USER_ACCOUNT_GOAL} accounts`;
    document.getElementById('avgTrade').textContent = fmtCurrency(avg);
    document.getElementById('payoutProgress').textContent = Math.round(progress) + '%';
}

function updateStats() {
    const trades = allData.filter(t => !t.no_trade_day);
    if (!trades.length) return;
    const daily = {};
    trades.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
    const days = Object.values(daily);
    document.getElementById('bestDay').textContent = fmtCurrency(days.length ? Math.max(...days) : 0);
    document.getElementById('worstDay').textContent = fmtCurrency(days.length ? Math.min(...days) : 0);
    const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
    const losses = trades.filter(t => parseFloat(t.pnl || 0) < 0);
    const avgW = wins.length ? wins.reduce((s, t) => s + parseFloat(t.pnl), 0) / wins.length : 0;
    const avgL = losses.length ? losses.reduce((s, t) => s + parseFloat(t.pnl), 0) / losses.length : 0;
    document.getElementById('avgWin').textContent = fmtCurrency(avgW);
    document.getElementById('avgLoss').textContent = fmtCurrency(avgL);
    document.getElementById('longestStreak').textContent = calcStreak(trades).longest;
}

function updateCharts() {
    destroyCharts();
    const trades = allData.filter(t => !t.no_trade_day);
    if (!trades.length) return;

    const C = { blue: '#3b7ef8', purple: '#9b6ffa', green: '#22d3a0', red: '#f05c6a', gold: '#ffd166', cyan: '#06d6d6' };
    const grid = 'rgba(99,179,237,0.07)';
    const baseOpts = { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } } };

    const dates = [...new Set(trades.map(t => t.trade_date))].sort();
    let sum = 0;
    const cumulative = dates.map(d => { sum += trades.filter(t => t.trade_date === d).reduce((s, t) => s + parseFloat(t.pnl || 0), 0); return sum; });
    charts.growth = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: { labels: dates, datasets: [{ data: cumulative, borderColor: C.blue, backgroundColor: 'rgba(59,126,248,0.08)', fill: true, tension: 0.4, borderWidth: 2.5, pointRadius: 0, pointHoverRadius: 5 }] },
        options: { ...baseOpts, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: grid }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', maxTicksLimit: 8, font: { size: 10 } }, border: { display: false } } } }
    });

    const condStats = {};
    trades.forEach(t => { const c = t.market_condition || 'Other'; if (!condStats[c]) condStats[c] = { w: 0, t: 0 }; condStats[c].t++; if (parseFloat(t.pnl || 0) > 0) condStats[c].w++; });
    const condLabels = Object.keys(condStats);
    charts.winRate = new Chart(document.getElementById('winRateChart'), {
        type: 'doughnut',
        data: { labels: condLabels, datasets: [{ data: condLabels.map(l => condStats[l].t > 0 ? ((condStats[l].w / condStats[l].t) * 100).toFixed(0) : 0), backgroundColor: [C.blue, C.purple, C.green, C.gold], borderWidth: 0 }] },
        options: { ...baseOpts, cutout: '72%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 8, boxWidth: 10 } } } }
    });

    const daily = {};
    trades.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
    const dKeys = Object.keys(daily).sort().slice(-14);
    charts.daily = new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: { labels: dKeys.map(d => d.substring(5)), datasets: [{ data: dKeys.map(k => daily[k]), backgroundColor: dKeys.map(k => daily[k] >= 0 ? 'rgba(34,211,160,0.7)' : 'rgba(240,92,106,0.7)'), borderRadius: 5, borderSkipped: false }] },
        options: { ...baseOpts, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: grid }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
    });

    const riskC = {};
    trades.forEach(t => { const r = '$' + (t.risk_template || '?'); riskC[r] = (riskC[r] || 0) + 1; });
    charts.risk = new Chart(document.getElementById('riskChart'), {
        type: 'pie',
        data: { labels: Object.keys(riskC), datasets: [{ data: Object.values(riskC), backgroundColor: [C.blue, C.purple, C.green, C.gold, C.cyan, C.red], borderWidth: 0 }] },
        options: { ...baseOpts, plugins: { legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 6, boxWidth: 10 } } } }
    });

    const atGoal = getAccountsAtGoal();
    const active = getActiveAccountCount() - atGoal;
    const inactive = Math.max(0, USER_ACCOUNT_GOAL - getActiveAccountCount());
    document.getElementById('accStatusSub').textContent = `${USER_ACCOUNT_GOAL} accounts total`;
    charts.accStatus = new Chart(document.getElementById('accountStatusChart'), {
        type: 'doughnut',
        data: { labels: ['At Goal', 'In Progress', 'Not Started'], datasets: [{ data: [atGoal, active, inactive], backgroundColor: [C.green, C.blue, 'rgba(122,139,181,0.3)'], borderWidth: 0 }] },
        options: { ...baseOpts, cutout: '70%', plugins: { legend: { display: true, position: 'bottom', labels: { color: '#7a8bb5', font: { size: 10 }, padding: 6, boxWidth: 10 } } } }
    });
}

function destroyCharts() { Object.values(charts).forEach(c => { try { c?.destroy(); } catch (e) {} }); charts = {}; }

function updateTemplates() {
    const tpls = groupByTemplate(allData);
    const render = (grid, names) => {
        grid.innerHTML = '';
        names.forEach(name => grid.appendChild(createTemplateCard(name, tpls[name] || emptyTemplate())));
    };
    render(document.getElementById('marketCondGrid'), ['High Impact News', 'No Impact']);
    render(document.getElementById('riskTemplGrid'), [100, 200, 300, 400, 500, 600].map(r => `$${r} Risk`));
    const topGrid = document.getElementById('topTemplatesGrid');
    topGrid.innerHTML = '';
    const sorted = Object.entries(tpls).filter(([, d]) => d.trades > 0).sort((a, b) => b[1].totalPnL - a[1].totalPnL).slice(0, 3);
    if (!sorted.length) { topGrid.innerHTML = '<p style="color:var(--text-muted);">No trades yet. Add your first trade!</p>'; return; }
    sorted.forEach(([name, data]) => topGrid.appendChild(createTemplateCard(name, data)));
}

function emptyTemplate() { return { totalPnL: 0, trades: 0, winRate: 0, avgWin: 0, avgLoss: 0, bestTrade: 0 }; }

function createTemplateCard(name, data) {
    const el = document.createElement('div');
    el.className = 'tmpl-card';
    el.innerHTML = `
        <div class="tmpl-header">
            <div class="tmpl-icon">${tmplIcon(name)}</div>
            <div><div class="tmpl-name">${name}</div><div class="tmpl-desc">${tmplDesc(name)}</div></div>
        </div>
        <div class="tmpl-stats">
            <div><div class="tmpl-stat-val" style="color:${data.totalPnL >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(data.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div>
            <div><div class="tmpl-stat-val">${data.trades}</div><div class="tmpl-stat-lbl">Trades</div></div>
            <div><div class="tmpl-stat-val">${Math.round(data.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div>
        </div>
        <div class="tmpl-details">
            <div class="tmpl-row"><span>Avg Win</span><span>${fmtCurrency(data.avgWin)}</span></div>
            <div class="tmpl-row"><span>Avg Loss</span><span>${fmtCurrency(data.avgLoss)}</span></div>
            <div class="tmpl-row"><span>Best Trade</span><span>${fmtCurrency(data.bestTrade)}</span></div>
        </div>`;
    return el;
}

function updateAccounts() {
    const grid = document.getElementById('accountsGrid');
    grid.innerHTML = '';
    const byAcc = groupByAccount(allData);
    let shown = 0;
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        if (accountFilter === 'active' && acc.trades === 0) continue;
        if (accountFilter === 'goal' && acc.pnl < GOAL_PER_ACCOUNT) continue;
        if (accountFilter === 'profitable' && acc.pnl <= 0) continue;
        const atGoal = acc.pnl >= GOAL_PER_ACCOUNT;
        const nickname = getNickname(i);
        const card = document.createElement('div');
        card.className = 'acc-card';
        card.innerHTML = `
            <div class="acc-header">
                <div>
                    <div class="acc-num">PA #${i}</div>
                    ${nickname ? `<div class="acc-nickname">‚úèÔ∏è ${nickname}</div>` : ''}
                </div>
                <span class="badge ${atGoal ? 'badge-success' : acc.trades > 0 ? 'badge-active' : 'badge-muted'}">${atGoal ? '‚úì GOAL' : acc.trades > 0 ? 'ACTIVE' : 'EMPTY'}</span>
            </div>
            <div class="acc-progress">
                <div class="prog-header"><span>${fmtCurrency(acc.pnl)}</span><span>${Math.round(acc.progress)}%</span></div>
                <div class="prog-bar"><div class="prog-fill" style="width:${acc.progress}%"></div></div>
            </div>
            <div class="acc-stats">
                <div><div class="acc-stat-lbl">Trades</div><div class="acc-stat-val">${acc.trades}</div></div>
                <div><div class="acc-stat-lbl">Win Rate</div><div class="acc-stat-val">${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</div></div>
                <div><div class="acc-stat-lbl">To Goal</div><div class="acc-stat-val">${fmtCurrency(Math.max(GOAL_PER_ACCOUNT - acc.pnl, 0))}</div></div>
                <div><div class="acc-stat-lbl">Balance</div><div class="acc-stat-val">${fmtCurrency(50000 + acc.pnl)}</div></div>
            </div>
            <div class="acc-name-edit">
                <input type="text" class="acc-name-input" value="${nickname}" placeholder="‚úèÔ∏è Give this account a name..." maxlength="30" id="accName${i}">
                <button class="btn btn-secondary" style="padding:0.3rem 0.75rem;font-size:0.8rem;" onclick="saveAccNickname(${i}, document.getElementById('accName${i}'))">Save</button>
            </div>`;
        grid.appendChild(card);
        shown++;
    }
    if (!shown) grid.innerHTML = '<p style="color:var(--text-muted);padding:2rem;">No accounts match this filter.</p>';
    document.getElementById('accountsTitle').textContent = `${USER_ACCOUNT_GOAL} Portfolio Accounts`;
}

function filterAccounts(filter, e) {
    accountFilter = filter;
    document.querySelectorAll('.filter-pills .pill').forEach(p => p.classList.remove('active'));
    if (e?.target) e.target.classList.add('active');
    updateAccounts();
}

function updateAnalytics() {
    const tbody = document.getElementById('analyticsBody');
    tbody.innerHTML = '';
    const tpls = groupByTemplate(allData);
    const sorted = Object.entries(tpls).filter(([, d]) => d.trades > 0).sort((a, b) => b[1].totalPnL - a[1].totalPnL);
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">No trades yet</td></tr>'; return; }
    sorted.forEach(([name, d]) => {
        const tw = d.avgWin * (d.trades * d.winRate / 100);
        const tl = Math.abs(d.avgLoss * (d.trades * (100 - d.winRate) / 100));
        const pf = tl > 0 ? (tw / tl).toFixed(2) : '‚àû';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>${name}</strong></td><td style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</td><td>${d.trades}</td><td>${Math.round(d.winRate)}%</td><td>${fmtCurrency(d.avgWin)}</td><td>${fmtCurrency(d.avgLoss)}</td><td>${fmtCurrency(d.bestTrade)}</td><td>${pf}</td>`;
    });
}

function updateTradeLog() {
    const tbody = document.getElementById('tradeLogBody');
    tbody.innerHTML = '';
    if (!allData.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">No trades yet</td></tr>'; return; }
    const sorted = [...allData].sort((a, b) => new Date(b.trade_date) - new Date(a.trade_date)).slice(0, 200);
    sorted.forEach(t => {
        const pnl = parseFloat(t.pnl || 0);
        const row = tbody.insertRow();
        const accLabel = t.account !== 'N/A' ? getAccLabel(t.account) : 'N/A';
        row.dataset.search = `${t.trade_date} ${t.account} ${accLabel} ${t.market_condition || ''} ${t.notes || ''}`.toLowerCase();
        if (t.no_trade_day) {
            row.style.opacity = '0.55';
            row.innerHTML = `<td>${t.trade_date}</td><td colspan="7" style="color:var(--text-muted);font-style:italic;">üìÖ No-Trade Day ‚Äî ${t.notes || ''}</td>`;
        } else {
            row.innerHTML = `<td>${t.trade_date}</td><td>${accLabel}</td><td>${t.market_condition || '‚Äî'}</td><td>$${t.risk_template}</td><td style="color:${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmtCurrency(pnl)}</td><td>${t.contracts}</td><td>${t.cycle}</td><td>${t.notes || '‚Äî'}</td>`;
        }
    });
}

function filterTradeLog() {
    const q = document.getElementById('tradeLogSearch').value.toLowerCase();
    document.querySelectorAll('#tradeLogBody tr').forEach(row => { row.style.display = !q || (row.dataset.search || '').includes(q) ? '' : 'none'; });
}

function updateRiskMonitor() {
    const grid = document.getElementById('riskGrid');
    grid.innerHTML = '';
    const byAcc = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        const bal = 50000 + acc.pnl;
        const high = acc.highestBalance;
        const failLine = high >= SAFETY_NET ? 50100 : high - MAX_DRAWDOWN;
        const cushion = bal - failLine;
        const cushionPct = Math.max(0, Math.min(100, (cushion / MAX_DRAWDOWN) * 100));
        const level = cushion <= 0 ? 'danger' : cushion <= 500 ? 'warning' : 'safe';
        const nickname = getNickname(i);
        const card = document.createElement('div');
        card.className = `acc-card${level === 'danger' ? ' at-risk' : level === 'warning' ? ' warning-card' : ''}`;
        card.innerHTML = `
            <div class="acc-header">
                <div><div class="acc-num">PA #${i}</div>${nickname ? `<div class="acc-nickname">‚úèÔ∏è ${nickname}</div>` : ''}</div>
                <span class="badge ${level === 'danger' ? 'badge-danger' : level === 'warning' ? 'badge-warning' : 'badge-success'}">${level === 'danger' ? 'AT RISK' : level === 'warning' ? 'WARNING' : 'SAFE'}</span>
            </div>
            <div class="acc-progress">
                <div class="prog-header"><span>Balance: ${fmtCurrency(bal)}</span><span>${Math.round(cushionPct)}% Cushion</span></div>
                <div class="prog-bar"><div class="prog-fill ${level === 'danger' ? 'red' : ''}" style="width:${cushionPct}%"></div></div>
            </div>
            <div class="acc-stats">
                <div><div class="acc-stat-lbl">P&L</div><div class="acc-stat-val" style="color:${acc.pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(acc.pnl)}</div></div>
                <div><div class="acc-stat-lbl">Fail Line</div><div class="acc-stat-val">${fmtCurrency(failLine)}</div></div>
                <div><div class="acc-stat-lbl">Cushion</div><div class="acc-stat-val" style="color:var(--${level==='safe'?'success':level==='warning'?'warning':'danger'})">${fmtCurrency(cushion)}</div></div>
                <div><div class="acc-stat-lbl">Peak Balance</div><div class="acc-stat-val">${fmtCurrency(high)}</div></div>
            </div>
            <div class="risk-info ${level}">
                ${level==='danger'?'‚ö†Ô∏è CRITICAL: At or below fail line!':level==='warning'?'‚ö†Ô∏è Less than $500 from fail line':high>=SAFETY_NET?'‚úÖ Safety net locked ‚Äî fail line at $50,100 forever':`‚úÖ Safe ‚Äî ${fmtCurrency(SAFETY_NET-high)} to safety net`}
            </div>`;
        grid.appendChild(card);
    }
}

function updateCyclePerformance() {
    const trades = allData.filter(t => !t.no_trade_day);
    const totalPnL = sumPnL(trades);
    const activeAcc = getActiveAccountCount();
    document.getElementById('cycleAccText').textContent = `${activeAcc} active account${activeAcc !== 1 ? 's' : ''}`;
    const activeGoal = activeAcc * GOAL_PER_ACCOUNT;
    const prog = activeAcc > 0 ? Math.min((totalPnL / activeGoal) * 100, 100) : 0;
    document.getElementById('firstPayoutProg').textContent = Math.round(prog) + '%';
    document.getElementById('firstPayoutSub').textContent = totalPnL >= activeGoal ? `‚úÖ Qualified` : `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} remaining`;
    const tradingDays = [...new Set(trades.map(t => t.trade_date))].length;
    const dAvg = tradingDays > 0 ? totalPnL / tradingDays : 0;
    document.getElementById('dailyAvg').textContent = fmtCurrency(dAvg);
    document.getElementById('dailyTarget').textContent = activeAcc > 0 ? `Target: $${activeAcc * DAILY_TARGET_MIN}‚Äì$${activeAcc * DAILY_TARGET_MAX}/day` : 'No active accounts';
    const totalWithdrawn = payoutData.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
    document.getElementById('totalPayoutsAmt').textContent = fmtCurrency(totalWithdrawn);
    document.getElementById('payoutCountSub').textContent = payoutData.length === 0 ? 'No payouts yet' : `${payoutData.length} payout(s) recorded`;
    const cycleData = groupByCycle(trades);
    const cycleNums = Object.keys(cycleData).map(Number).sort((a, b) => a - b);
    const curCycle = cycleNums.length ? Math.max(...cycleNums) : 1;
    document.getElementById('currentCycleStatus').textContent = `Cycle ${curCycle}`;
    document.getElementById('cycleInfoSub').textContent = totalPnL < activeGoal ? `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} to first payout` : 'Monthly farming cycle active';
    const tbody = document.getElementById('cycleCompBody');
    tbody.innerHTML = '';
    if (!cycleNums.length) tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:2rem;">No cycle data yet</td></tr>';
    else cycleNums.forEach(cn => {
        const d = cycleData[cn];
        const status = d.totalPnL >= activeGoal ? '‚úÖ Payout Ready' : d.totalPnL >= activeGoal * 0.75 ? 'üü° Near Goal' : 'üîµ In Progress';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>Cycle ${cn}</strong></td><td style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</td><td>${d.trades}</td><td>${d.tradingDays}</td><td>${fmtCurrency(d.dailyAvg)}</td><td>${Math.round(d.winRate)}%</td><td>${fmtCurrency(d.bestDay)}</td><td>${fmtCurrency(d.worstDay)}</td><td>${status}</td>`;
    });
    if (charts.cyclePnL) { charts.cyclePnL.destroy(); delete charts.cyclePnL; }
    if (charts.cycleDailyAvg) { charts.cycleDailyAvg.destroy(); delete charts.cycleDailyAvg; }
    if (cycleNums.length) {
        const labels = cycleNums.map(c => `Cycle ${c}`);
        const pnlVals = cycleNums.map(c => cycleData[c].totalPnL);
        charts.cyclePnL = new Chart(document.getElementById('cyclePnLChart'), {
            type: 'bar',
            data: { labels, datasets: [{ data: pnlVals, backgroundColor: pnlVals.map(v => v >= 0 ? 'rgba(34,211,160,0.7)' : 'rgba(240,92,106,0.7)'), borderRadius: 6, borderSkipped: false }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: 'rgba(99,179,237,0.07)' }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
        });
        charts.cycleDailyAvg = new Chart(document.getElementById('cycleDailyChart'), {
            type: 'line',
            data: { labels, datasets: [{ data: cycleNums.map(c => cycleData[c].dailyAvg), borderColor: '#3b7ef8', backgroundColor: 'rgba(59,126,248,0.08)', fill: true, tension: 0.4, borderWidth: 2.5, pointRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#7a8bb5', font: { size: 10 } }, grid: { color: 'rgba(99,179,237,0.07)' }, border: { display: false } }, x: { grid: { display: false }, ticks: { color: '#7a8bb5', font: { size: 10 } }, border: { display: false } } } }
        });
    }
    const detGrid = document.getElementById('cycleDetailsGrid');
    detGrid.innerHTML = '';
    [...cycleNums].reverse().forEach(cn => {
        const d = cycleData[cn];
        const card = document.createElement('div');
        card.className = 'tmpl-card';
        card.innerHTML = `
            <div class="tmpl-header">
                <div class="tmpl-icon" style="background:${d.totalPnL>=activeGoal?'linear-gradient(135deg,#22d3a0,#059669)':'linear-gradient(135deg,#3b7ef8,#9b6ffa)'}">üåæ</div>
                <div><div class="tmpl-name">Cycle ${cn}</div><div class="tmpl-desc">${d.tradingDays} trading days ‚Ä¢ ${d.trades} trades</div></div>
            </div>
            <div class="tmpl-stats">
                <div><div class="tmpl-stat-val" style="color:${d.totalPnL>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(d.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div>
                <div><div class="tmpl-stat-val">${d.trades}</div><div class="tmpl-stat-lbl">Trades</div></div>
                <div><div class="tmpl-stat-val">${Math.round(d.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div>
            </div>
            <div class="tmpl-details">
                <div class="tmpl-row"><span>Daily Avg</span><span>${fmtCurrency(d.dailyAvg)}</span></div>
                <div class="tmpl-row"><span>Best Day</span><span>${fmtCurrency(d.bestDay)}</span></div>
                <div class="tmpl-row"><span>Worst Day</span><span>${fmtCurrency(d.worstDay)}</span></div>
            </div>`;
        detGrid.appendChild(card);
    });
}

function updatePayoutPage() {
    const trades = allData.filter(t => !t.no_trade_day);
    const totalPnL = sumPnL(trades);
    const totalWithdrawn = payoutData.reduce((s, p) => s + parseFloat(p.amount || 0), 0);
    document.getElementById('totalWithdrawn').textContent = fmtCurrency(totalWithdrawn);
    document.getElementById('withdrawnCount').textContent = `${payoutData.length} payout(s)`;
    const activeAcc = getActiveAccountCount();
    const activeGoal = activeAcc * GOAL_PER_ACCOUNT;
    const available = totalPnL >= activeGoal ? activeAcc * PAYOUT_PER_ACCOUNT : 0;
    document.getElementById('availableWithdrawal').textContent = fmtCurrency(available);
    document.getElementById('withdrawalStatus').textContent = available > 0 ? '‚úÖ Qualified' : `${fmtCurrency(Math.max(0, activeGoal - totalPnL))} to qualify`;
    const lastPayout = payoutData.length > 0 ? payoutData[payoutData.length - 1] : null;
    document.getElementById('cyclePhase').textContent = lastPayout ? `Cycle ${lastPayout.new_cycle}` : 'Cycle 1';
    document.getElementById('phaseInfo').textContent = lastPayout ? 'Monthly farming cycle active' : 'Building to first payout';
    const tbody = document.getElementById('payoutHistBody');
    tbody.innerHTML = '';
    if (!payoutData.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem;">No payouts recorded yet</td></tr>'; return; }
    [...payoutData].sort((a, b) => new Date(b.payout_date) - new Date(a.payout_date)).forEach(p => {
        const row = tbody.insertRow();
        row.innerHTML = `<td>${p.payout_date}</td><td><strong>${p.payout_type||'‚Äî'}</strong></td><td style="color:var(--success)">${fmtCurrency(parseFloat(p.amount||0))}</td><td>PA #${p.account}</td><td>Cycle ${p.cycle_completed}</td><td>Cycle ${p.new_cycle}</td><td>${p.notes||'‚Äî'}</td>`;
    });
}

function updateSettingsPage() {
    const active = getActiveAccountCount();
    const setTxt = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    const setVal2 = (id, v) => { const el = document.getElementById(id); if (el) el.value = v; };

    // Profile display
    const p = currentProfile || {};
    setTxt('profileDisplayUsername', p.username || '‚Äî');
    setTxt('profileDisplayName2', p.display_name || '‚Äî');
    setTxt('profileDisplayBio', p.journal_bio || '‚Äî');
    setTxt('profileDisplayFirm', p.firm_name || '‚Äî');

    setTxt('settingsGoal', USER_ACCOUNT_GOAL);
    setTxt('settingsActive', active);
    setTxt('settingsPortGoal', fmtCurrency(USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT));
    setTxt('settingsPortCalc', `$${GOAL_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL} accounts`);
    setTxt('settingsPayout', fmtCurrency(USER_ACCOUNT_GOAL * PAYOUT_PER_ACCOUNT));
    setTxt('settingsPayCalc', `$${PAYOUT_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL} accounts`);

    const goalVal = [1, 5, 10, 20, 50, 100].includes(USER_ACCOUNT_GOAL) ? USER_ACCOUNT_GOAL.toString() : 'custom';
    setVal2('accountGoalSelect', goalVal);
    const customWrap = document.getElementById('customGoalWrap');
    if (goalVal === 'custom' && customWrap) { customWrap.style.display = 'block'; setVal2('customGoalInput', USER_ACCOUNT_GOAL); }

    // Populate goal fields from profile
    setVal2('settingsGoalPerAcc', p.goal_per_account || GOAL_PER_ACCOUNT);
    setVal2('settingsPayoutPerAcc', p.payout_per_account || PAYOUT_PER_ACCOUNT);
    setVal2('settingsDailyMin', p.daily_target_min || 250);
    setVal2('settingsDailyMax', p.daily_target_max || 300);
    setVal2('settingsMaxDD', p.max_drawdown || 2500);
    setVal2('settingsStartBal', p.starting_balance || 50000);

    const tbody = document.getElementById('settingsAccBody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const byAcc = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = byAcc[i];
        const nickname = getNickname(i);
        const status = acc.trades === 0 ? '<span style="color:var(--text-muted)">Not Started</span>' : acc.pnl >= GOAL_PER_ACCOUNT ? '<span style="color:var(--success)">‚úÖ Goal Reached</span>' : '<span style="color:var(--accent)">In Progress</span>';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>PA #${i}</strong></td><td style="color:var(--cyan)">${nickname || '<span style="color:var(--text-dim)">‚Äî</span>'}</td><td>${status}</td><td style="color:${acc.pnl>=0?'var(--success)':'var(--danger)'}">${fmtCurrency(acc.pnl)}</td><td>${Math.round(acc.progress)}%</td><td>${acc.trades}</td><td>${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</td><td>${fmtCurrency(Math.max(0, GOAL_PER_ACCOUNT - acc.pnl))}</td>`;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PAGE_TITLES = {
    overview: 'Overview', cyclePerformance: 'Cycle Performance', templates: 'Templates',
    accounts: 'Accounts', analytics: 'Analytics', riskMonitor: 'Risk Monitor',
    psychology: 'üß† Trading Psychology', addTrade: 'Add Trade', logPayout: 'Log Payout',
    tradeLog: 'Trade Log', shareJournal: 'üîó Share Journal', deleteData: 'Delete Data',
    settings: 'Settings', adminPanel: 'Admin Panel'
};

function navigateTo(page) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById(page + 'Page');
    if (el) el.classList.add('active');
    document.getElementById('pageTitle').textContent = PAGE_TITLES[page] || page;
    if (page === 'adminPanel') loadAdminData();
    if (page === 'shareJournal') updateShareJournalPage();
    if (page === 'psychology') updatePsychPage();
    if (window.innerWidth <= 1024) closeSidebar();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.addEventListener('click', () => navigateTo(item.dataset.page));
});

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const open = sidebar.classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show', open);
}
function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORM HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateDropdowns() {
    ['tradeAccount', 'leadAccount', 'deleteAccSelect', 'payoutAccount'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const isPayoutAcc = id === 'payoutAccount';
        el.innerHTML = `<option value="">Select account</option>`;
        if (isPayoutAcc) el.innerHTML += '<option value="all">All Accounts</option>';
        for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
            const nick = getNickname(i);
            el.innerHTML += `<option value="${i}">${nick ? `PA #${i} ‚Äî ${nick}` : `PA Account #${i}`}</option>`;
        }
    });
    const followers = document.getElementById('followerCheckboxes');
    followers.innerHTML = '';
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const nick = getNickname(i);
        followers.innerHTML += `<label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;padding:0.4rem;border-radius:5px;background:var(--bg-elevated);font-size:0.8rem;"><input type="checkbox" class="follower-checkbox" value="${i}" style="accent-color:var(--accent);cursor:pointer;"> ${nick ? `PA #${i} ‚Äî ${nick}` : `PA #${i}`}</label>`;
    }
}

function setTodayDates() {
    const today = new Date().toISOString().split('T')[0];
    ['tradeDate', 'payoutDate'].forEach(id => { const el = document.getElementById(id); if (el) el.value = today; });
    const suggestedCycle = payoutData.length > 0 ? payoutData[payoutData.length - 1].new_cycle : 1;
    const cycleEl = document.getElementById('tradeCycle');
    if (cycleEl && suggestedCycle) cycleEl.value = suggestedCycle;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _onboardStep = 0;
const ONBOARD_STEPS = 2;

function startOnboarding() {
    _onboardStep = 0;
    // Pre-fill if returning
    const p = currentProfile;
    const setV = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
    setV('obUsername', p?.username || window._pendingUsername || '');
    setV('obDisplayName', p?.display_name || '');
    setV('obBio', p?.journal_bio || '');
    setV('obFirmName', p?.firm_name || '');
    setV('obSocialLink', p?.google_link || '');
    setV('obAccountGoal', p?.account_goal || 20);
    setV('obGoalAcc', p?.goal_per_account || 4600);
    setV('obPayoutAcc', p?.payout_per_account || 2000);
    setV('obDailyMin', p?.daily_target_min || 250);
    setV('obDailyMax', p?.daily_target_max || 300);
    setV('obMaxDD', p?.max_drawdown || 2500);
    setV('obStartBal', p?.starting_balance || 50000);
    renderOnboardStep();
    document.getElementById('onboardOverlay').classList.remove('hidden');
}

function renderOnboardStep() {
    for (let i = 0; i < ONBOARD_STEPS; i++) {
        const s = document.getElementById('onboardStep' + i);
        if (s) s.classList.toggle('active', i === _onboardStep);
    }
    const prog = document.getElementById('onboardProgress');
    prog.innerHTML = '';
    for (let i = 0; i < ONBOARD_STEPS; i++) {
        const dot = document.createElement('div');
        dot.className = 'onboard-dot' + (i === _onboardStep ? ' active' : i < _onboardStep ? ' done' : '');
        prog.appendChild(dot);
    }
    document.getElementById('onboardBackBtn').style.display = _onboardStep > 0 ? 'block' : 'none';
    document.getElementById('onboardNextBtn').textContent = _onboardStep === ONBOARD_STEPS - 1 ? "üåæ Let's Farm!" : 'Next ‚Üí';
}

function onboardBack() { if (_onboardStep > 0) { _onboardStep--; renderOnboardStep(); } }

async function onboardNext() {
    if (_onboardStep === 0) {
        const uname = document.getElementById('obUsername').value.trim();
        if (!uname || uname.length < 3) { showAlert('Please enter a username (at least 3 chars).', 'error'); return; }
    }
    if (_onboardStep === ONBOARD_STEPS - 1) {
        await saveOnboardingData();
        document.getElementById('onboardOverlay').classList.add('hidden');
        showAlert('üåæ Welcome! Your journal is ready. Happy farming!', 'success');
        return;
    }
    _onboardStep++;
    renderOnboardStep();
}

async function saveOnboardingData() {
    const g = (id) => { const el = document.getElementById(id); return el ? el.value : null; };
    const updates = {
        id: currentUser.id,
        username: g('obUsername')?.trim() || null,
        display_name: g('obDisplayName')?.trim() || null,
        journal_bio: g('obBio')?.trim() || null,
        firm_name: g('obFirmName')?.trim() || null,
        google_link: g('obSocialLink')?.trim() || null,
        account_goal: parseInt(g('obAccountGoal')) || 20,
        goal_per_account: parseFloat(g('obGoalAcc')) || 4600,
        payout_per_account: parseFloat(g('obPayoutAcc')) || 2000,
        daily_target_min: parseFloat(g('obDailyMin')) || 250,
        daily_target_max: parseFloat(g('obDailyMax')) || 300,
        max_drawdown: parseFloat(g('obMaxDD')) || 2500,
        starting_balance: parseFloat(g('obStartBal')) || 50000,
    };
    try {
        await sbClient.from('profiles').upsert(updates);
        currentProfile = { ...currentProfile, ...updates };
        USER_ACCOUNT_GOAL = updates.account_goal;
        applyProfileToConfig(updates);
        const name = updates.username || 'Trader';
        document.getElementById('userAvatar').textContent = name.substring(0, 2).toUpperCase();
        document.getElementById('userName').textContent = name;
        document.getElementById('heroName').textContent = name;
        updateAllViews();
    } catch(e) { showAlert('Could not save: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProfileModal() {
    const p = currentProfile || {};
    const setV = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
    setV('profileUsername', p.username);
    setV('profileDisplayName', p.display_name);
    setV('profileBio', p.journal_bio);
    setV('profileFirmName', p.firm_name);
    setV('profileSocialLink', p.google_link);
    // Only show real email (not internal @propfarmpro.app)
    const realEmail = (currentUser?.email || '').includes('@propfarmpro.app') ? '' : (currentUser?.email || '');
    setV('profileEmail', realEmail);
    document.getElementById('profileModal').classList.remove('hidden');
}

function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }

async function saveProfileModal() {
    const g = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
    const username = g('profileUsername');
    if (!username || username.length < 3) { showAlert('Username must be at least 3 characters.', 'error'); return; }
    const updates = {
        id: currentUser.id,
        username,
        display_name: g('profileDisplayName') || null,
        journal_bio: g('profileBio') || null,
        firm_name: g('profileFirmName') || null,
        google_link: g('profileSocialLink') || null,
    };
    // If real email provided, update auth email
    const newEmail = g('profileEmail');
    if (newEmail && !newEmail.includes('@propfarmpro.app')) {
        updates.email = newEmail;
        try { await sbClient.auth.updateUser({ email: newEmail }); } catch(e) {}
    }
    try {
        await sbClient.from('profiles').upsert(updates);
        currentProfile = { ...currentProfile, ...updates };
        document.getElementById('userAvatar').textContent = username.substring(0, 2).toUpperCase();
        document.getElementById('userName').textContent = username;
        document.getElementById('heroName').textContent = username;
        updateSettingsPage();
        closeProfileModal();
        showAlert('‚úÖ Profile saved!', 'success');
    } catch(e) { showAlert('Save failed: ' + e.message, 'error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTRACT SIZE EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CONTRACT_SIZES = JSON.parse(localStorage.getItem('contract_sizes') || 'null') || { 100:1, 200:2, 300:3, 400:4, 500:5, 600:6 };

function buildContractEditor() {
    const el = document.getElementById('contractEditor');
    if (!el) return;
    el.innerHTML = '';
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const row = document.createElement('div');
        row.className = 'contract-row';
        row.innerHTML = `
            <div class="contract-label">$${risk} Risk Template</div>
            <div style="color:var(--text-muted);font-size:0.8rem;">Contracts:</div>
            <input type="number" class="contract-input" id="contractSize_${risk}" value="${CONTRACT_SIZES[risk] || Math.round(risk/100)}" min="1" max="50">
        `;
        el.appendChild(row);
    });
    // Rebuild trade form dropdown with updated contract sizes
    rebuildRiskDropdown();
}

function saveContractSizes() {
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const el = document.getElementById('contractSize_' + risk);
        if (el) CONTRACT_SIZES[risk] = parseInt(el.value) || Math.round(risk/100);
    });
    localStorage.setItem('contract_sizes', JSON.stringify(CONTRACT_SIZES));
    rebuildRiskDropdown();
    showAlert('‚úÖ Contract sizes saved!', 'success');
}

function rebuildRiskDropdown() {
    const sel = document.getElementById('tradeRisk');
    if (!sel) return;
    const prev = sel.value;
    sel.innerHTML = '<option value="">Select risk</option>';
    [100, 200, 300, 400, 500, 600].forEach(risk => {
        const c = CONTRACT_SIZES[risk] || Math.round(risk/100);
        const opt = document.createElement('option');
        opt.value = risk;
        opt.textContent = `$${risk} (${c} contract${c !== 1 ? 's' : ''})`;
        sel.appendChild(opt);
    });
    if (prev) sel.value = prev;
}

function updateContracts(risk) {
    const c = risk ? (CONTRACT_SIZES[parseInt(risk)] || Math.round(parseInt(risk)/100)) : '';
    document.getElementById('tradeContracts').value = c;
}



function toggleNoTradeDay(checked) {
    ['tradeCondition', 'tradeRisk', 'tradePnL', 'tradeContracts', 'tradeAccount', 'leadAccount'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.disabled = checked;
        if (id !== 'tradeContracts') el.required = !checked;
    });
    document.querySelectorAll('.follower-checkbox').forEach(cb => cb.disabled = checked);
    if (checked && !document.getElementById('tradeNotes').value) document.getElementById('tradeNotes').value = 'No trading today ‚Äî rest day';
}

function toggleCopierMode(checked) {
    document.getElementById('singleAccWrap').style.display = checked ? 'none' : 'block';
    document.getElementById('multiAccWrap').style.display = checked ? 'block' : 'none';
    document.getElementById('tradeAccount').required = !checked;
}

function resetTradeForm() {
    document.getElementById('tradeForm').reset();
    setTodayDates();
    toggleCopierMode(false);
    toggleNoTradeDay(false);
    document.getElementById('tradeContracts').value = '';
}

function resetPayoutForm() {
    document.getElementById('payoutForm').reset();
    document.getElementById('payoutDate').value = new Date().toISOString().split('T')[0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CSV EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
    if (!allData.length) { showAlert('No data to export', 'error'); return; }
    const headers = ['Date', 'Account', 'Nickname', 'Condition', 'Risk', 'P&L', 'Contracts', 'Cycle', 'Notes', 'No-Trade Day'];
    const rows = allData.map(t => {
        const nick = getNickname(t.account) || '';
        return [t.trade_date, t.account, nick, t.market_condition, t.risk_template, t.pnl, t.contracts, t.cycle, (t.notes || '').replace(/"/g, '""'), t.no_trade_day ? 'Yes' : 'No'];
    });
    const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `prop_farm_pro_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    showAlert('‚úì CSV exported', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showAlert(msg, type) {
    const el = document.getElementById('alert');
    el.textContent = msg;
    el.className = `alert alert-${type} show`;
    clearTimeout(el._timer);
    el._timer = setTimeout(() => el.classList.remove('show'), 5000);
}

function fmtCurrency(n) {
    const abs = Math.abs(Number(n) || 0);
    const f = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(abs);
    return n < 0 ? '(' + f + ')' : f;
}

function sumPnL(data) { return data.reduce((s, t) => s + parseFloat(t.pnl || 0), 0); }

function calcStreak(data) {
    if (!data.length) return { current: 0, longest: 0 };
    const sorted = [...data].sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date));
    let longest = 0, run = 0;
    sorted.forEach(t => { if (parseFloat(t.pnl || 0) > 0) { run++; longest = Math.max(longest, run); } else run = 0; });
    let curr = 0;
    for (let i = sorted.length - 1; i >= 0; i--) { if (parseFloat(sorted[i].pnl || 0) > 0) curr++; else break; }
    return { current: curr, longest };
}

function getAccountsAtGoal() {
    let count = 0;
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const pnl = allData.filter(t => t.account == i).reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        if (pnl >= GOAL_PER_ACCOUNT) count++;
    }
    return count;
}

function getActiveAccountCount() {
    return new Set(allData.filter(t => t.account && t.account !== 'N/A').map(t => parseInt(t.account)).filter(n => !isNaN(n))).size;
}

function groupByAccount(data) {
    const res = {};
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const trades = data.filter(t => parseInt(t.account) === i);
        const pnl = trades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0).length;
        let bal = 50000, high = 50000;
        [...trades].sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date)).forEach(t => { bal += parseFloat(t.pnl || 0); high = Math.max(high, bal); });
        res[i] = { pnl, trades: trades.length, winRate: trades.length > 0 ? (wins / trades.length) * 100 : 0, progress: Math.min(Math.max((pnl / GOAL_PER_ACCOUNT) * 100, 0), 100), highestBalance: high };
    }
    return res;
}

function groupByCycle(data) {
    const res = {};
    for (let c = 1; c <= 12; c++) {
        const ct = data.filter(t => parseInt(t.cycle) === c);
        if (!ct.length) continue;
        const pnl = ct.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
        const wins = ct.filter(t => parseFloat(t.pnl || 0) > 0);
        const days = [...new Set(ct.map(t => t.trade_date))];
        const daily = {};
        ct.forEach(t => { daily[t.trade_date] = (daily[t.trade_date] || 0) + parseFloat(t.pnl || 0); });
        const dVals = Object.values(daily);
        res[c] = { totalPnL: pnl, trades: ct.length, tradingDays: days.length, dailyAvg: days.length > 0 ? pnl / days.length : 0, winRate: ct.length > 0 ? (wins.length / ct.length) * 100 : 0, bestDay: dVals.length ? Math.max(...dVals) : 0, worstDay: dVals.length ? Math.min(...dVals) : 0 };
    }
    return res;
}

function groupByTemplate(data) {
    const build = (filter) => {
        const t = data.filter(filter).filter(x => !x.no_trade_day);
        const wins = t.filter(x => parseFloat(x.pnl || 0) > 0);
        const losses = t.filter(x => parseFloat(x.pnl || 0) < 0);
        return {
            totalPnL: t.reduce((s, x) => s + parseFloat(x.pnl || 0), 0), trades: t.length,
            winRate: t.length > 0 ? (wins.length / t.length) * 100 : 0,
            avgWin: wins.length > 0 ? wins.reduce((s, x) => s + parseFloat(x.pnl), 0) / wins.length : 0,
            avgLoss: losses.length > 0 ? losses.reduce((s, x) => s + parseFloat(x.pnl), 0) / losses.length : 0,
            bestTrade: t.length > 0 ? Math.max(...t.map(x => parseFloat(x.pnl || 0))) : 0
        };
    };
    const res = {};
    ['High Impact News', 'No Impact'].forEach(c => { res[c] = build(t => t.market_condition === c); });
    [100, 200, 300, 400, 500, 600].forEach(r => { res[`$${r} Risk`] = build(t => parseInt(t.risk_template) === r); });
    return res;
}

function tmplIcon(name) {
    if (name.includes('High')) return 'üì∞';
    if (name.includes('No Impact')) return 'üìâ';
    const r = parseInt(name.replace(/\D/g, ''));
    if (r <= 200) return 'üü¢'; if (r <= 400) return 'üü°'; return 'üî¥';
}
function tmplDesc(name) {
    if (name.includes('High')) return 'High volatility news sessions';
    if (name.includes('No Impact')) return 'Low volatility, calmer markets';
    const r = parseInt(name.replace(/\D/g, ''));
    return r ? `$${r} risk ‚Äî ${r / 100} contract${r > 100 ? 's' : ''}` : 'Custom template';
}
</script>
</body>
</html>
