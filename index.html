<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Farm Pro - Complete Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-tertiary: #94a3b8;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --purple: #8b5cf6;
            --orange: #f97316;
            --cyan: #06b6d4;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* DEBUG PANEL */
        .debug-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 1rem;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            z-index: 9998;
            display: none;
        }

        .debug-panel.show {
            display: block;
        }

        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
        }

        .debug-title {
            font-weight: 700;
            color: var(--accent);
        }

        .debug-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .debug-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .debug-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .debug-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            word-break: break-all;
        }

        .debug-btn {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .debug-btn:hover {
            background: var(--accent-hover);
        }

        .debug-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .debug-toggle:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        /* LOGIN */
        .login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .login-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 440px;
            width: 90%;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.875rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.show {
            display: block;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent);
            color: white;
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .top-bar {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--border-hover);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .container {
            padding: 2rem;
            max-width: 1800px;
        }

        /* HERO BANNER (for overview) */
        .hero-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-greeting {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }

        .hero-stats {
            display: flex;
            gap: 3rem;
            margin-top: 2rem;
        }

        .hero-stat {
            display: flex;
            flex-direction: column;
        }

        .hero-stat-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .hero-stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* QUICK ACTIONS */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .action-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .action-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .action-icon.blue { background: rgba(59, 130, 246, 0.1); }
        .action-icon.green { background: rgba(16, 185, 129, 0.1); }
        .action-icon.purple { background: rgba(139, 92, 246, 0.1); }
        .action-icon.orange { background: rgba(245, 158, 11, 0.1); }

        .action-info h4 {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .action-info p {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
            transition: all 0.2s;
        }

        .metric-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .metric-icon.blue { background: rgba(59, 130, 246, 0.1); }
        .metric-icon.green { background: rgba(16, 185, 129, 0.1); }
        .metric-icon.purple { background: rgba(139, 92, 246, 0.1); }
        .metric-icon.orange { background: rgba(245, 158, 11, 0.1); }
        .metric-icon.cyan { background: rgba(6, 182, 212, 0.1); }

        .metric-value {
            font-size: 2.25rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .metric-change.positive { color: var(--success); }
        .metric-change.negative { color: var(--danger); }
        .metric-change.neutral { color: var(--text-secondary); }

        /* CHARTS */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 700;
        }

        .chart-subtitle {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container-small {
            position: relative;
            height: 200px;
        }

        /* TEMPLATES */
        .templates-section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .template-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.75rem;
            transition: all 0.2s;
        }

        .template-card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .template-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .template-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            flex-shrink: 0;
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .template-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .template-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .template-stat {
            text-align: center;
        }

        .template-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.25rem;
        }

        .template-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .template-details {
            padding-top: 1.25rem;
            border-top: 1px solid var(--border);
            display: grid;
            gap: 0.75rem;
        }

        .template-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .template-detail-label {
            color: var(--text-secondary);
        }

        .template-detail-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ACCOUNTS */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .account-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .account-card:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }

        .account-card.at-risk {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.02);
        }

        .account-card.warning {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.02);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .account-number {
            font-size: 1.125rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .account-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .account-progress {
            margin-bottom: 1.25rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .account-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .account-stat {
            display: flex;
            flex-direction: column;
        }

        .account-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .account-stat-value {
            font-size: 1.125rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
        }

        .risk-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            font-size: 0.8125rem;
        }

        .risk-info.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .risk-info.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .risk-info.safe {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        /* FORM */
        .form-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            max-width: 1200px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
            background: var(--bg-primary);
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-footer {
            display: flex;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        /* TABLE */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.9375rem;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        /* STATS */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-mini-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-mini-value {
            font-size: 1.75rem;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .stat-mini-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* FILTER PILLS */
        .filter-pills {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-pill.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* ALERT */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            font-size: 0.9375rem;
            font-weight: 600;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* PAGE */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .hero-stats {
                gap: 2rem;
            }
        }

        @media (max-width: 1024px) {
            .chart-grid, .chart-grid-3 {
                grid-template-columns: 1fr;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-toggle {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .hero-banner {
                padding: 2rem;
            }

            .hero-title {
                font-size: 1.75rem;
            }

            .hero-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .metrics-grid, .templates-grid, .accounts-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- DEBUG TOGGLE -->
    <button class="debug-toggle" onclick="toggleDebug()">üîß</button>

    <!-- DEBUG PANEL -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-header">
            <span class="debug-title">üîß Debug Console</span>
            <span class="debug-close" onclick="toggleDebug()">√ó</span>
        </div>

        <button class="debug-btn" onclick="testAPI()">Test API Connection</button>
        <button class="debug-btn" onclick="showDataStructure()">Show Data Structure</button>
        <button class="debug-btn" onclick="validateData()">Validate Data</button>
        <button class="debug-btn" onclick="exportDebugLog()">Export Debug Log</button>
        <button class="debug-btn secondary" onclick="exportCSV()">Export CSV Data</button>

        <div class="debug-section">
            <div class="debug-label">CURRENT USER</div>
            <div class="debug-value" id="debugCurrentUser">Not logged in</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">ACCOUNT GOAL</div>
            <div class="debug-value" id="debugAccountGoal">Not set</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">API URL</div>
            <div class="debug-value" id="debugApiUrl">Not set</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">API STATUS</div>
            <div class="debug-value" id="debugApiStatus">Not tested</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">TOTAL TRADES</div>
            <div class="debug-value" id="debugTotalTrades">0</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">ACTIVE ACCOUNTS</div>
            <div class="debug-value" id="debugActiveAccounts">0</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">LAST LOAD TIME</div>
            <div class="debug-value" id="debugLoadTime">Never</div>
        </div>

        <div class="debug-section">
            <div class="debug-label">CONSOLE OUTPUT</div>
            <div class="debug-value" id="debugConsole" style="max-height: 200px; overflow-y: auto; font-size: 0.75rem;">
                Ready...
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">üåæ Prop Farm Pro</h1>
            <p class="login-subtitle">Professional Trading Portfolio Management</p>
            <div class="login-error" id="loginError">Invalid password</div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="passwordInput" placeholder="Enter password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">Access Dashboard</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard" id="dashboard">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">üåæ Prop Farm</div>
            <div class="user-badge" id="userBadge" style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 10px; margin-bottom: 2rem; text-align: center; font-weight: 600;">
                User Dashboard
            </div>
            
            <nav class="nav-section">
                <div class="nav-title">Main</div>
                <div class="nav-item active" data-page="overview">
                    <span class="nav-icon">üìä</span>
                    <span>Overview</span>
                </div>
                <div class="nav-item" data-page="cyclePerformance">
                    <span class="nav-icon">üîÑ</span>
                    <span>Cycle Performance</span>
                </div>
                <div class="nav-item" data-page="templates">
                    <span class="nav-icon">üìã</span>
                    <span>Templates</span>
                </div>
                <div class="nav-item" data-page="accounts">
                    <span class="nav-icon">üíº</span>
                    <span>Accounts</span>
                </div>
                <div class="nav-item" data-page="analytics">
                    <span class="nav-icon">üìà</span>
                    <span>Analytics</span>
                </div>
                <div class="nav-item" data-page="riskMonitor">
                    <span class="nav-icon">‚ö†Ô∏è</span>
                    <span>Risk Monitor</span>
                </div>
            </nav>

            <nav class="nav-section">
                <div class="nav-title">Actions</div>
                <div class="nav-item" data-page="addTrade">
                    <span class="nav-icon">‚ûï</span>
                    <span>Add Trade</span>
                </div>
                <div class="nav-item" data-page="logPayout">
                    <span class="nav-icon">üí∞</span>
                    <span>Log Payout</span>
                </div>
                <div class="nav-item" data-page="tradeLog">
                    <span class="nav-icon">üìù</span>
                    <span>Trade Log</span>
                </div>
                <div class="nav-item" data-page="deleteData">
                    <span class="nav-icon">üóëÔ∏è</span>
                    <span>Delete Data</span>
                </div>
            </nav>

            <nav class="nav-section">
                <div class="nav-title">Settings</div>
                <div class="nav-item" data-page="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </div>
                <div class="nav-item" onclick="logout()">
                    <span class="nav-icon">üö™</span>
                    <span>Logout</span>
                </div>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content" id="mainContent">
            <!-- TOP BAR -->
            <div class="top-bar">
                <div class="top-bar-left">
                    <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                    <h1 class="page-title" id="pageTitle">Overview</h1>
                </div>
                <div class="top-bar-actions">
                    <button class="btn btn-secondary btn-icon" onclick="refreshData()" title="Refresh">
                        ‚Üª
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="toggleDebug()" title="Debug">
                        üîß
                    </button>
                </div>
            </div>

            <!-- CONTAINER -->
            <div class="container">
                <!-- ALERT -->
                <div class="alert" id="alert"></div>

                <!-- PAGE: OVERVIEW -->
                <div class="page active" id="overviewPage">
                    <!-- HERO BANNER -->
                    <div class="hero-banner">
                        <div class="hero-content">
                            <div class="hero-greeting">Welcome back, <span id="heroUserName">Trader</span></div>
                            <div class="hero-title" id="heroTitle">Building Your Trading Empire</div>
                            <div class="hero-stats">
                                <div class="hero-stat">
                                    <div class="hero-stat-value" id="heroTotalPnL">$0</div>
                                    <div class="hero-stat-label">Total P&L</div>
                                </div>
                                <div class="hero-stat">
                                    <div class="hero-stat-value" id="heroProgress">0%</div>
                                    <div class="hero-stat-label">Portfolio Progress</div>
                                </div>
                                <div class="hero-stat">
                                    <div class="hero-stat-value" id="heroAccounts">0/20</div>
                                    <div class="hero-stat-label">Accounts at Goal</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QUICK ACTIONS -->
                    <div class="quick-actions">
                        <div class="action-card" onclick="navigateTo('addTrade')">
                            <div class="action-icon blue">‚ûï</div>
                            <div class="action-info">
                                <h4>Add Trade</h4>
                                <p>Log new position</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="refreshData()">
                            <div class="action-icon green">üîÑ</div>
                            <div class="action-info">
                                <h4>Refresh Data</h4>
                                <p>Update metrics</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="exportCSV()">
                            <div class="action-icon purple">üì•</div>
                            <div class="action-info">
                                <h4>Export CSV</h4>
                                <p>Download trades</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="navigateTo('settings')">
                            <div class="action-icon orange">‚öôÔ∏è</div>
                            <div class="action-info">
                                <h4>Settings</h4>
                                <p>Configure accounts</p>
                            </div>
                        </div>
                    </div>

                    <!-- KEY METRICS -->
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Total P&L</span>
                                <div class="metric-icon blue">üí∞</div>
                            </div>
                            <div class="metric-value" id="totalPnL">$0</div>
                            <div class="metric-change neutral" id="pnlChange">$0 this month</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Win Rate</span>
                                <div class="metric-icon green">üéØ</div>
                            </div>
                            <div class="metric-value" id="winRate">0%</div>
                            <div class="metric-change neutral" id="winStats">0 wins / 0 trades</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Profit Factor</span>
                                <div class="metric-icon purple">üìä</div>
                            </div>
                            <div class="metric-value" id="profitFactor">0.00</div>
                            <div class="metric-change neutral" id="profitFactorInfo">No data</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Win Streak</span>
                                <div class="metric-icon orange">üî•</div>
                            </div>
                            <div class="metric-value" id="winStreak">0</div>
                            <div class="metric-change neutral" id="streakInfo">No active streak</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Total Trades</span>
                                <div class="metric-icon cyan">üìà</div>
                            </div>
                            <div class="metric-value" id="totalTrades">0</div>
                            <div class="metric-change neutral" id="totalTradesLabel">Across all accounts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Avg Trade</span>
                                <div class="metric-icon orange">üíµ</div>
                            </div>
                            <div class="metric-value" id="avgTrade">$0</div>
                            <div class="metric-change neutral" id="avgTradeInfo">Per trade</div>
                        </div>
                    </div>

                    <!-- STATS COMPARISON -->
                    <div class="stats-row">
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="bestDay">$0</div>
                            <div class="stat-mini-label">Best Day</div>
                        </div>
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="worstDay">$0</div>
                            <div class="stat-mini-label">Worst Day</div>
                        </div>
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="avgWin">$0</div>
                            <div class="stat-mini-label">Avg Win</div>
                        </div>
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="avgLoss">$0</div>
                            <div class="stat-mini-label">Avg Loss</div>
                        </div>
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="longestStreak">0</div>
                            <div class="stat-mini-label">Longest Streak</div>
                        </div>
                        <div class="stat-mini-card">
                            <div class="stat-mini-value" id="monthlyProgress">0%</div>
                            <div class="stat-mini-label">Payout Progress</div>
                        </div>
                    </div>

                    <!-- MAIN CHARTS -->
                    <div class="chart-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Portfolio Growth</h3>
                                    <p class="chart-subtitle">Cumulative P&L over time</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Win Rate</h3>
                                    <p class="chart-subtitle">By strategy</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="winRateChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 3-COLUMN CHARTS -->
                    <div class="chart-grid-3">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Daily Performance</h3>
                                    <p class="chart-subtitle">P&L by day</p>
                                </div>
                            </div>
                            <div class="chart-container-small">
                                <canvas id="dailyChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Risk Distribution</h3>
                                    <p class="chart-subtitle">By template</p>
                                </div>
                            </div>
                            <div class="chart-container-small">
                                <canvas id="riskChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Account Status</h3>
                                    <p class="chart-subtitle" id="accountStatusSubtitle">Portfolio overview</p>
                                </div>
                            </div>
                            <div class="chart-container-small">
                                <canvas id="accountStatusChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Templates -->
                    <div class="templates-section">
                        <div class="section-header">
                            <h2 class="section-title">Top Performing Templates</h2>
                            <div class="section-actions">
                                <button class="btn btn-secondary" onclick="navigateTo('templates')">View All</button>
                            </div>
                        </div>
                        <div class="templates-grid" id="topTemplatesGrid"></div>
                    </div>
                </div>
                <!-- PAGE: CYCLE PERFORMANCE -->
                <div class="page" id="cyclePerformancePage">
                    <h2 class="section-title" style="margin-bottom: 1rem;">üîÑ Cycle Performance Tracker</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Track your farming journey across your <strong id="cycleActiveAccountsText">active accounts</strong>. 
                        First cycle target is $4,600 profit per account in 45 days ($250-$300/day). 
                        After first payout, monthly cycles need $2,000 per account in 8-20 days.
                    </p>

                    <!-- Payout Summary Cards -->
                    <div class="metrics-grid" style="margin-bottom: 2rem;">
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">First Payout Progress</span>
                                <div class="metric-icon blue">üéØ</div>
                            </div>
                            <div class="metric-value" id="firstPayoutProgress">0%</div>
                            <div class="metric-change neutral" id="firstPayoutStatus">Not yet qualified</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Total Payouts Earned</span>
                                <div class="metric-icon green">üí∞</div>
                            </div>
                            <div class="metric-value" id="totalPayouts">$0</div>
                            <div class="metric-change neutral" id="payoutCount">0 payouts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Current Cycle Status</span>
                                <div class="metric-icon purple">üìÖ</div>
                            </div>
                            <div class="metric-value" id="currentCycleStatus">Cycle 1</div>
                            <div class="metric-change neutral" id="currentCycleInfo">Building to first payout</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Daily Average</span>
                                <div class="metric-icon orange">üìä</div>
                            </div>
                            <div class="metric-value" id="dailyAverage">$0</div>
                            <div class="metric-change neutral" id="dailyTarget">Target: $250-$300</div>
                        </div>
                    </div>

                    <!-- Farming Strategy Info -->
                    <div class="alert alert-info show" style="margin-bottom: 2rem;">
                        <strong>üåæ The Farmer Mentality:</strong><br>
                        Plant daily wins ($250-$300 per account). Protect the field (stay out of red folder news). Stay patient (45 days first cycle). 
                        Take the harvest when accounts mature ($54,600 per account = full $2k payout). After first harvest, monthly cycles are easier (just $2k in 8-20 days per account).
                    </div>

                    <!-- Active Accounts Summary -->
                    <div class="form-card" style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem;">üìä Active Accounts Summary</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                            Cycle performance tracks only accounts with trades. Your goal settings in Settings page apply to the full portfolio view.
                        </p>
                        <div class="stats-row">
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="cycleActiveAccounts">0</div>
                                <div class="stat-mini-label">Active Accounts</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="cycleAvgPerAccount">$0</div>
                                <div class="stat-mini-label">Avg Per Account</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="cycleTotalGoal">$0</div>
                                <div class="stat-mini-label">Total Goal (Active)</div>
                            </div>
                            <div class="stat-mini-card">
                                <div class="stat-mini-value" id="cycleRemainingGoal">$0</div>
                                <div class="stat-mini-label">Remaining to Goal</div>
                            </div>
                        </div>
                    </div>

                    <!-- Cycle Comparison Table -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3 class="chart-title">Cycle-by-Cycle Comparison</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cycle</th>
                                        <th>Total P&L</th>
                                        <th>Trades</th>
                                        <th>Trading Days</th>
                                        <th>Avg Per Day</th>
                                        <th>Win Rate</th>
                                        <th>Best Day</th>
                                        <th>Worst Day</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="cycleComparisonBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cycle Charts -->
                    <div class="chart-grid" style="margin-top: 2rem;">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Cycle P&L Comparison</h3>
                                    <p class="chart-subtitle">Total profit per cycle</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="cyclePnLChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div>
                                    <h3 class="chart-title">Daily Average by Cycle</h3>
                                    <p class="chart-subtitle">Average daily profit</p>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="cycleDailyAvgChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Individual Cycle Details -->
                    <div class="templates-section" style="margin-top: 2rem;">
                        <div class="section-header">
                            <h2 class="section-title">Cycle Details</h2>
                        </div>
                        <div class="templates-grid" id="cycleDetailsGrid"></div>
                    </div>
                </div>

                <!-- PAGE: SETTINGS -->
                <div class="page" id="settingsPage">
                    <h2 class="section-title" style="margin-bottom: 1rem;">‚öôÔ∏è Account Settings</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Configure your portfolio size and account goals. This affects how the dashboard calculates your overall targets.
                    </p>

                    <!-- Current Settings Summary -->
                    <div class="metrics-grid" style="margin-bottom: 2rem;">
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Current Account Goal</span>
                                <div class="metric-icon blue">üéØ</div>
                            </div>
                            <div class="metric-value" id="settingsCurrentGoal">20</div>
                            <div class="metric-change neutral">Total accounts in portfolio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Active Accounts</span>
                                <div class="metric-icon green">üíº</div>
                            </div>
                            <div class="metric-value" id="settingsActiveAccounts">0</div>
                            <div class="metric-change neutral">Accounts with trades</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Portfolio Goal</span>
                                <div class="metric-icon purple">üí∞</div>
                            </div>
                            <div class="metric-value" id="settingsPortfolioGoal">$92,000</div>
                            <div class="metric-change neutral" id="settingsGoalCalc">$4,600 √ó 20 accounts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Potential Payout</span>
                                <div class="metric-icon orange">üåæ</div>
                            </div>
                            <div class="metric-value" id="settingsPotentialPayout">$40,000</div>
                            <div class="metric-change neutral" id="settingsPayoutCalc">$2,000 √ó 20 accounts</div>
                        </div>
                    </div>

                    <!-- Settings Form -->
                    <div class="form-card">
                        <h3 style="margin-bottom: 1.5rem;">üìä Portfolio Configuration</h3>
                        
                        <div class="alert alert-info show" style="margin-bottom: 2rem;">
                            <strong>üí° How This Works:</strong><br>
                            ‚Ä¢ <strong>Cycle Performance</strong> tracks ONLY accounts you've actually traded<br>
                            ‚Ä¢ <strong>Rest of Dashboard</strong> shows all accounts in your goal (even untouched ones)<br>
                            ‚Ä¢ Set your goal to match how many accounts you own or plan to trade
                        </div>

                        <form id="settingsForm">
                            <div class="form-group">
                                <label class="form-label">Account Goal</label>
                                <select class="form-select" id="accountGoalSelect">
                                    <option value="1">1 Account ($4,600 goal, $2k payout)</option>
                                    <option value="5">5 Accounts ($23,000 goal, $10k payout)</option>
                                    <option value="10">10 Accounts ($46,000 goal, $20k payout)</option>
                                    <option value="20" selected>20 Accounts ($92,000 goal, $40k payout)</option>
                                    <option value="50">50 Accounts ($230,000 goal, $100k payout)</option>
                                    <option value="100">100 Accounts ($460,000 goal, $200k payout)</option>
                                    <option value="custom">Custom Amount...</option>
                                </select>
                            </div>

                            <div class="form-group" id="customGoalGroup" style="display: none;">
                                <label class="form-label">Custom Account Goal</label>
                                <input type="number" class="form-input" id="customAccountGoal" min="1" max="200" placeholder="Enter number of accounts (1-200)">
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Enter any number between 1 and 200 accounts
                                </p>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Goal Per Account</label>
                                <input type="number" class="form-input" id="goalPerAccount" value="4600" readonly style="background: var(--bg-secondary);">
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    Standard prop firm payout threshold ($4,600 profit = $2k withdrawal)
                                </p>
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary">
                                    üíæ Save Settings
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetSettingsForm()">
                                    Reset to Default
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Accounts Table -->
                    <div class="table-card" style="margin-top: 2rem;">
                        <div class="table-header">
                            <h3 class="chart-title">All Configured Accounts</h3>
                            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
                                Based on your current goal setting
                            </p>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Status</th>
                                        <th>P&L</th>
                                        <th>Progress</th>
                                        <th>Trades</th>
                                        <th>Win Rate</th>
                                        <th>To Goal</th>
                                    </tr>
                                </thead>
                                <tbody id="settingsAccountsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PAGE: TEMPLATES -->
                <div class="page" id="templatesPage">
                    <div class="templates-section">
                        <div class="section-header">
                            <h2 class="section-title">Market Conditions</h2>
                        </div>
                        <div class="templates-grid" id="marketConditionsGrid"></div>
                    </div>

                    <div class="templates-section">
                        <div class="section-header">
                            <h2 class="section-title">Risk Templates</h2>
                        </div>
                        <div class="templates-grid" id="riskTemplatesGrid"></div>
                    </div>
                </div>

                <!-- PAGE: ACCOUNTS -->
                <div class="page" id="accountsPage">
                    <div class="section-header">
                        <h2 class="section-title" id="accountsPageTitle">Portfolio Accounts</h2>
                        <div class="section-actions">
                            <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
                        </div>
                    </div>

                    <div class="filter-pills">
                        <div class="filter-pill active" onclick="filterAccounts('all')">All Accounts</div>
                        <div class="filter-pill" onclick="filterAccounts('active')">Active Only</div>
                        <div class="filter-pill" onclick="filterAccounts('goal')">Goal Reached</div>
                        <div class="filter-pill" onclick="filterAccounts('profitable')">Profitable</div>
                    </div>

                    <div class="accounts-grid" id="accountsGrid"></div>
                </div>

                <!-- PAGE: ANALYTICS -->
                <div class="page" id="analyticsPage">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">Performance Analytics</h2>
                    
                    <div class="table-card">
                        <div class="table-header">
                            <h3 class="chart-title">Template Comparison</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Template</th>
                                        <th>Total P&L</th>
                                        <th>Trades</th>
                                        <th>Win Rate</th>
                                        <th>Avg Win</th>
                                        <th>Avg Loss</th>
                                        <th>Best Trade</th>
                                        <th>Profit Factor</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PAGE: RISK MONITOR -->
                <div class="page" id="riskMonitorPage">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">‚ö†Ô∏è Account Risk Monitor</h2>
                    
                    <div class="alert alert-info show" style="margin-bottom: 2rem;">
                        <strong>Trailing Drawdown Rules:</strong><br>
                        ‚Ä¢ Starting Balance: $50,000 | Max Drawdown: $2,500 | Fail Line: $47,500<br>
                        ‚Ä¢ Safety Net: $52,600 (Once reached, fail line locks at $50,100 forever)<br>
                        ‚Ä¢ Before safety net: Fail line trails your highest balance
                    </div>

                    <div class="accounts-grid" id="riskMonitorGrid"></div>
                </div>
                <!-- PAGE: ADD TRADE -->
                <div class="page" id="addTradePage">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">Add New Trade</h2>
                    
                    <div class="form-card">
                        <form id="tradeForm">
                            <div class="form-grid">
                                <!-- NO-TRADE DAY MODE -->
                                <div class="form-group" style="grid-column: 1/-1;">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="noTradeDay" style="width: auto; cursor: pointer;">
                                        <span>üìÖ No-Trade Day (Weekend, Holiday, Rest Day)</span>
                                    </label>
                                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                        Check this to log a day when you didn't trade (market closed, personal break, etc.)
                                    </p>
                                </div>

                                <!-- TRADE COPIER MODE -->
                                <div class="form-group" style="grid-column: 1/-1;">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" id="copierMode" style="width: auto; cursor: pointer;">
                                        <span>üîÑ Trade Copier Mode (Copy to multiple accounts)</span>
                                    </label>
                                </div>

                                <!-- SINGLE ACCOUNT MODE -->
                                <div id="singleAccountMode">
                                    <div class="form-group">
                                        <label class="form-label">PA Account *</label>
                                        <select class="form-select" id="account" required></select>
                                    </div>
                                </div>

                                <!-- MULTI ACCOUNT MODE -->
                                <div id="multiAccountMode" style="display: none; grid-column: 1/-1;">
                                    <div class="form-group">
                                        <label class="form-label">Lead Account *</label>
                                        <select class="form-select" id="leadAccount"></select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Follower Accounts (Select multiple) *</label>
                                        <div style="border: 2px solid var(--border); border-radius: 12px; padding: 1rem; background: var(--bg-secondary); max-height: 200px; overflow-y: auto;">
                                            <div id="followerCheckboxes" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        Cycle (Month) *
                                        <span id="suggestedCycleHint" style="color: var(--success); font-weight: 400; font-size: 0.75rem;"></span>
                                    </label>
                                    <select class="form-select" id="cycle" required>
                                        <option value="">Select cycle</option>
                                        <option value="1">Cycle 1 (Month 1)</option>
                                        <option value="2">Cycle 2 (Month 2)</option>
                                        <option value="3">Cycle 3 (Month 3)</option>
                                        <option value="4">Cycle 4 (Month 4)</option>
                                        <option value="5">Cycle 5 (Month 5)</option>
                                        <option value="6">Cycle 6 (Month 6)</option>
                                        <option value="7">Cycle 7 (Month 7)</option>
                                        <option value="8">Cycle 8 (Month 8)</option>
                                        <option value="9">Cycle 9 (Month 9)</option>
                                        <option value="10">Cycle 10 (Month 10)</option>
                                        <option value="11">Cycle 11 (Month 11)</option>
                                        <option value="12">Cycle 12 (Month 12)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Market Condition *</label>
                                    <select class="form-select" id="marketCondition" required>
                                        <option value="">Select condition</option>
                                        <option value="High Impact News">High Impact News</option>
                                        <option value="No Impact">No Impact</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Risk Template *</label>
                                    <select class="form-select" id="riskTemplate" required>
                                        <option value="">Select risk level</option>
                                        <option value="100">$100 (1 contract)</option>
                                        <option value="200">$200 (2 contracts)</option>
                                        <option value="300">$300 (3 contracts)</option>
                                        <option value="400">$400 (4 contracts)</option>
                                        <option value="500">$500 (5 contracts)</option>
                                        <option value="600">$600 (6 contracts)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Trade Date *</label>
                                    <input type="date" class="form-input" id="tradeDate" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">P&L ($) *</label>
                                    <input type="number" step="0.01" class="form-input" id="pnl" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Contracts (auto-filled)</label>
                                    <input type="number" class="form-input" id="contracts" readonly style="background: var(--bg-secondary);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trade Notes</label>
                                <textarea class="form-input form-textarea" id="notes" placeholder="Entry reason, market conditions, lessons learned..."></textarea>
                            </div>
                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <span id="submitText">Submit Trade</span>
                                    <span id="submitLoading" class="loading" style="display: none;"></span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('tradeForm').reset(); setTodayDate();">Clear</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- PAGE: LOG PAYOUT -->
                <div class="page" id="logPayoutPage">
                    <h2 class="section-title" style="margin-bottom: 1rem;">üí∞ Log Payout / Withdrawal</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Record when you take a payout from your prop firm. This helps track your farming progress and cycles.
                    </p>

                    <!-- Current Status Summary -->
                    <div class="metrics-grid" style="margin-bottom: 2rem;">
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Available for Withdrawal</span>
                                <div class="metric-icon green">üíµ</div>
                            </div>
                            <div class="metric-value" id="availableWithdrawal">$0</div>
                            <div class="metric-change neutral" id="withdrawalStatus">Not qualified yet</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Total Withdrawn</span>
                                <div class="metric-icon blue">üí∞</div>
                            </div>
                            <div class="metric-value" id="totalWithdrawn">$0</div>
                            <div class="metric-change neutral" id="withdrawalCount">0 payouts</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Current Cycle Phase</span>
                                <div class="metric-icon purple">üîÑ</div>
                            </div>
                            <div class="metric-value" id="cyclePhase">First Cycle</div>
                            <div class="metric-change neutral" id="phaseInfo">Building to first payout</div>
                        </div>
                    </div>

                    <!-- Payout Form -->
                    <div class="form-card">
                        <h3 style="margin-bottom: 1.5rem;">Record New Payout</h3>
                        
                        <form id="payoutForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Payout Type *</label>
                                    <select class="form-select" id="payoutType" required>
                                        <option value="">Select payout type</option>
                                        <option value="first_min">First Payout - Minimum ($2,600 qualified)</option>
                                        <option value="first_full">First Payout - Full ($4,600 = $2k withdrawal)</option>
                                        <option value="monthly">Monthly Payout ($2,000)</option>
                                        <option value="custom">Custom Amount</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Withdrawal Amount ($) *</label>
                                    <select class="form-select" id="withdrawalTemplate">
                                        <option value="">Quick amounts...</option>
                                        <option value="500">$500</option>
                                        <option value="1000">$1,000</option>
                                        <option value="1500">$1,500</option>
                                        <option value="2000">$2,000</option>
                                        <option value="2500">$2,500</option>
                                        <option value="3000">$3,000</option>
                                        <option value="4000">$4,000</option>
                                        <option value="5000">$5,000</option>
                                        <option value="custom">Custom...</option>
                                    </select>
                                    <input type="number" step="0.01" class="form-input" id="withdrawalAmount" placeholder="0.00" required style="margin-top: 0.5rem;">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Payout Date *</label>
                                    <input type="date" class="form-input" id="payoutDate" required>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Account(s) *</label>
                                    <select class="form-select" id="payoutAccount" required>
                                        <option value="">Select account</option>
                                        <option value="all">All Accounts (Portfolio)</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Cycle Completed *</label>
                                    <select class="form-select" id="cycleCompleted" required>
                                        <option value="">Which cycle finished?</option>
                                        <option value="1">Cycle 1</option>
                                        <option value="2">Cycle 2</option>
                                        <option value="3">Cycle 3</option>
                                        <option value="4">Cycle 4</option>
                                        <option value="5">Cycle 5</option>
                                        <option value="6">Cycle 6</option>
                                        <option value="7">Cycle 7</option>
                                        <option value="8">Cycle 8</option>
                                        <option value="9">Cycle 9</option>
                                        <option value="10">Cycle 10</option>
                                        <option value="11">Cycle 11</option>
                                        <option value="12">Cycle 12</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">New Cycle Starting *</label>
                                    <select class="form-select" id="newCycle" required>
                                        <option value="">Select new cycle</option>
                                        <option value="2">Cycle 2</option>
                                        <option value="3">Cycle 3</option>
                                        <option value="4">Cycle 4</option>
                                        <option value="5">Cycle 5</option>
                                        <option value="6">Cycle 6</option>
                                        <option value="7">Cycle 7</option>
                                        <option value="8">Cycle 8</option>
                                        <option value="9">Cycle 9</option>
                                        <option value="10">Cycle 10</option>
                                        <option value="11">Cycle 11</option>
                                        <option value="12">Cycle 12</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Payment Method</label>
                                    <select class="form-select" id="paymentMethod">
                                        <option value="">Select method (optional)</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="paypal">PayPal</option>
                                        <option value="wise">Wise</option>
                                        <option value="crypto">Crypto</option>
                                        <option value="check">Check</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Payout Notes</label>
                                <textarea class="form-input form-textarea" id="payoutNotes" placeholder="e.g., First milestone reached! Ready for monthly farming cycle..."></textarea>
                            </div>

                            <div class="alert alert-info show" style="margin-bottom: 1rem;">
                                <strong>üìù What happens when you log a payout:</strong><br>
                                ‚Ä¢ Your withdrawal is recorded in the payout history<br>
                                ‚Ä¢ The system marks this cycle as complete<br>
                                ‚Ä¢ Future trades will automatically use the new cycle number<br>
                                ‚Ä¢ Your progress tracker adjusts to the next goal
                            </div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-primary" id="payoutSubmitBtn">
                                    <span id="payoutSubmitText">üí∞ Log Payout</span>
                                    <span id="payoutSubmitLoading" class="loading" style="display: none;"></span>
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('payoutForm').reset(); setTodayPayoutDate();">Clear</button>
                            </div>
                        </form>
                    </div>

                    <!-- Payout History -->
                    <div class="table-card" style="margin-top: 2rem;">
                        <div class="table-header">
                            <h3 class="chart-title">Payout History</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Account</th>
                                        <th>Cycle Completed</th>
                                        <th>New Cycle</th>
                                        <th>Payment Method</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="payoutHistoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PAGE: TRADE LOG -->
                <div class="page" id="tradeLogPage">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">Complete Trade Log</h2>
                    
                    <div class="table-card">
                        <div class="table-header">
                            <h3 class="chart-title">All Trades (Last 100)</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Account</th>
                                        <th>Market Condition</th>
                                        <th>Risk</th>
                                        <th>P&L</th>
                                        <th>Contracts</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="tradeLogBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PAGE: DELETE DATA -->
                <div class="page" id="deleteDataPage">
                    <h2 class="section-title" style="margin-bottom: 1.5rem;">üóëÔ∏è Delete Data</h2>
                    
                    <div class="alert alert-error show" style="margin-bottom: 2rem;">
                        <strong>‚ö†Ô∏è Warning:</strong> Deleted data cannot be recovered. Please be careful!
                    </div>

                    <div class="form-card">
                        <h3 style="margin-bottom: 1.5rem;">Delete Options</h3>
                        
                        <div style="display: grid; gap: 1.5rem;">
                            <div style="padding: 1.5rem; border: 2px solid var(--border); border-radius: 12px;">
                                <h4 style="margin-bottom: 0.5rem;">üîÑ Delete by Cycle</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">Remove all trades from a specific cycle/month</p>
                                <div style="display: flex; gap: 1rem;">
                                    <select class="form-select" id="deleteCycleSelect" style="flex: 1;">
                                        <option value="">Select cycle to delete</option>
                                        <option value="1">Cycle 1</option>
                                        <option value="2">Cycle 2</option>
                                        <option value="3">Cycle 3</option>
                                        <option value="4">Cycle 4</option>
                                        <option value="5">Cycle 5</option>
                                        <option value="6">Cycle 6</option>
                                        <option value="7">Cycle 7</option>
                                        <option value="8">Cycle 8</option>
                                        <option value="9">Cycle 9</option>
                                        <option value="10">Cycle 10</option>
                                        <option value="11">Cycle 11</option>
                                        <option value="12">Cycle 12</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="deleteByCycle()">Delete Cycle</button>
                                </div>
                            </div>

                            <div style="padding: 1.5rem; border: 2px solid var(--border); border-radius: 12px;">
                                <h4 style="margin-bottom: 0.5rem;">üíº Delete by Account</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">Remove all trades from a specific account</p>
                                <div style="display: flex; gap: 1rem;">
                                    <select class="form-select" id="deleteAccountSelect" style="flex: 1;">
                                        <option value="">Select account to delete</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="deleteByAccount()">Delete Account</button>
                                </div>
                            </div>

                            <div style="padding: 1.5rem; border: 2px solid #ef4444; border-radius: 12px; background: rgba(239, 68, 68, 0.05);">
                                <h4 style="margin-bottom: 0.5rem; color: var(--danger);">üí£ Delete ALL Data</h4>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">‚ö†Ô∏è This will permanently delete ALL trades from ALL accounts!</p>
                                <button class="btn btn-secondary" onclick="confirmDeleteAll()" style="background: var(--danger); color: white; border: none;">Delete Everything</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script>
        // ‚úÖ MULTI-USER CONFIGURATION WITH ACCOUNT GOALS
        function vmc(t,c){t=t-0x15e;const Z=vmt();let z=Z[t];return z;}(function(t,c){const vmu={t:0x6f,c:0x70,Z:0x468,z:0x46a,g:0x45e,e:0x461,r:0x469,F:0x6d,s:0x74,q:0x6d,T:0x6e,m:0x76,X:0x463,G:0x78},vmK={t:0x331},vmj={t:0xf1};function S(t,c,Z){return vmc(Z-0x302,c);}const Z=t();function I(t,c,Z){return vmc(t- -vmj.t,c);}function H(t,c,Z){return vmc(Z- -vmK.t,t);}while(!![]){try{const z=-parseInt(I(0x76,vmu.t,vmu.c))/0x1*(-parseInt(I(0x75,0x7b,0x7c))/0x2)+parseInt(S(0x464,vmu.Z,0x463))/0x3+-parseInt(S(0x46f,vmu.z,0x467))/0x4+-parseInt(S(vmu.g,0x469,vmu.e))/0x5*(-parseInt(S(0x470,vmu.r,0x46a))/0x6)+parseInt(I(vmu.F,vmu.s,vmu.q))/0x7*(-parseInt(I(0x6f,vmu.T,vmu.m))/0x8)+parseInt(S(0x462,vmu.X,0x465))/0x9+-parseInt(I(vmu.G,0x80,0x7e))/0xa;if(z===c)break;else Z['push'](Z['shift']());}catch(g){Z['push'](Z['shift']());}}}(vmt,0xe8173));function vmG(t,c,Z){return vmc(Z- -0x1e,t);}function vmt(){const b=['Trader\x20Two','497saWlln','84325YmKXSF','213168JDSQxI','4165083XVvkND','Demo\x20User','10628559dOBUcF','https://sheetdb.io/api/v1/3if5pdgxfo1p2','1978488JcTjlC','15920LeGWnP','110MDoKvP','144mHNPus','5125410VqfnTi','demo','https://sheetdb.io/api/v1/eltwz49i4x169'];vmt=function(){return b;};return vmt();}function vmm(t,c,Z){const vmL={t:0x315};return vmc(Z-vmL.t,t);}const USERS={'trader2025':{'sheetAPI':vmm(0x486,0x487,0x480),'name':vmX(-0x1,-0x3,-0x6),'defaultAccountGoal':0x5},'trader2026':{'sheetAPI':vmm(0x47d,0x47b,0x479),'name':vmm(0x47d,0x47b,0x481),'defaultAccountGoal':0x14},'demo':{'sheetAPI':vmm(0x480,0x47b,0x479),'name':vmG(0x146,0x140,0x144),'defaultAccountGoal':0xa}};function vmX(t,c,Z){return vmc(c- -0x16d,t);}globalThis['USERS']=USERS;

        let CURRENT_USER = null;
        let SHEET_API = null;
        let USER_ACCOUNT_GOAL = 20;  // Dynamic - set from user settings
        
        const STARTING_BALANCE = 50000;
        const MAX_DRAWDOWN = 2500;
        const SAFETY_NET = 52600;
        
        // Payout Goals (PER ACCOUNT)
        const GOAL_PER_ACCOUNT = 4600;    // $4,600 profit per account
        const FIRST_PAYOUT_MIN = 2600;    // $2,600 profit = Qualify
        const MONTHLY_PAYOUT_GOAL = 2000; // After first payout, $2k per account
        const PAYOUT_PER_ACCOUNT = 2000;  // $2,000 withdrawal per account
        const DAILY_TARGET_MIN = 250;
        const DAILY_TARGET_MAX = 300;
        const FIRST_CYCLE_DAYS = 45;
        const TYPICAL_CYCLE_DAYS_MIN = 8;
        const TYPICAL_CYCLE_DAYS_MAX = 20;

        let allData = [];
        let charts = {};
        let accountFilter = 'all';
        let debugLog = [];
        let payoutData = [];

        // DEBUG FUNCTIONS
        function debugMsg(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            const consoleEl = document.getElementById('debugConsole');
            if (consoleEl) {
                consoleEl.innerHTML += `<div style="color: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#0f172a'}">${logEntry}</div>`;
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
            
            console.log(logEntry);
        }

        function toggleDebug() {
            document.getElementById('debugPanel').classList.toggle('show');
        }

        async function testAPI() {
            debugMsg('Testing API connection...', 'info');
            document.getElementById('debugApiStatus').textContent = 'Testing...';
            
            try {
                const start = performance.now();
                const response = await fetch(SHEET_API);
                const data = await response.json();
                const elapsed = (performance.now() - start).toFixed(0);
                
                document.getElementById('debugApiStatus').textContent = `‚úì OK (${elapsed}ms)`;
                debugMsg(`API Response: ${response.status} - ${data.length} records in ${elapsed}ms`, 'success');
                showAlert(`‚úì API works! Found ${data.length} trades (${elapsed}ms)`, 'success');
            } catch (error) {
                document.getElementById('debugApiStatus').textContent = `‚úó Error`;
                debugMsg(`API Error: ${error.message}`, 'error');
                showAlert(`‚úó API Error: ${error.message}`, 'error');
            }
        }

        function showDataStructure() {
            if (allData.length === 0) {
                showAlert('No data loaded yet. Try refreshing first.', 'error');
                return;
            }

            const sample = allData[0];
            const structure = {
                totalRecords: allData.length,
                columns: Object.keys(sample),
                sampleData: sample
            };

            debugMsg('Data Structure:', 'info');
            debugMsg(JSON.stringify(structure, null, 2), 'info');
            showAlert(`Data has ${structure.columns.length} columns: ${structure.columns.join(', ')}`, 'info');
        }

        function validateData() {
            if (allData.length === 0) {
                showAlert('No data to validate', 'error');
                return;
            }

            let issues = [];
            
            allData.forEach((trade, i) => {
                if (!trade.account) issues.push(`Row ${i+1}: Missing account`);
                if (!trade.pnl) issues.push(`Row ${i+1}: Missing P&L`);
                if (!trade.trade_date) issues.push(`Row ${i+1}: Missing date`);
                if (isNaN(parseFloat(trade.pnl))) issues.push(`Row ${i+1}: Invalid P&L value`);
            });

            if (issues.length === 0) {
                debugMsg('‚úì Data validation passed', 'success');
                showAlert('‚úì All data is valid!', 'success');
            } else {
                debugMsg(`‚úó Found ${issues.length} validation issues`, 'error');
                issues.forEach(issue => debugMsg(issue, 'error'));
                showAlert(`Found ${issues.length} data issues. Check debug console.`, 'error');
            }
        }

        function exportDebugLog() {
            const logText = debugLog.join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prop_farm_debug_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showAlert('‚úì Debug log exported', 'success');
        }

        // LOGIN - MULTI USER
        if (sessionStorage.getItem('farm_auth') === 'true') {
            const storedPassword = sessionStorage.getItem('farm_password');
            if (storedPassword && USERS[storedPassword]) {
                CURRENT_USER = USERS[storedPassword];
                SHEET_API = CURRENT_USER.sheetAPI;
                loadUserSettings();
                showDashboard();
            }
        }

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            
            if (USERS[password]) {
                CURRENT_USER = USERS[password];
                SHEET_API = CURRENT_USER.sheetAPI;
                sessionStorage.setItem('farm_auth', 'true');
                sessionStorage.setItem('farm_password', password);
                debugMsg(`User logged in: ${CURRENT_USER.name}`, 'success');
                loadUserSettings();
                showDashboard();
            } else {
                document.getElementById('loginError').classList.add('show');
                setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
            }
        });

        function showDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.add('show');
            
            // Update user display
            document.getElementById('userBadge').textContent = `üë§ ${CURRENT_USER.name}`;
            document.getElementById('heroUserName').textContent = CURRENT_USER.name;
            document.getElementById('debugCurrentUser').textContent = CURRENT_USER.name;
            document.getElementById('debugApiUrl').textContent = SHEET_API;
            document.getElementById('debugAccountGoal').textContent = `${USER_ACCOUNT_GOAL} accounts`;
            
            initDashboard();
        }

        function logout() {
            sessionStorage.removeItem('farm_auth');
            sessionStorage.removeItem('farm_password');
            if (CURRENT_USER) {
                localStorage.removeItem(`prop_farm_payouts_${CURRENT_USER.name}`);
                localStorage.removeItem(`prop_farm_settings_${CURRENT_USER.name}`);
            }
            location.reload();
        }

        // USER SETTINGS MANAGEMENT
        function loadUserSettings() {
            const storageKey = `prop_farm_settings_${CURRENT_USER.name}`;
            const stored = localStorage.getItem(storageKey);
            
            if (stored) {
                const settings = JSON.parse(stored);
                USER_ACCOUNT_GOAL = settings.accountGoal || CURRENT_USER.defaultAccountGoal || 20;
            } else {
                USER_ACCOUNT_GOAL = CURRENT_USER.defaultAccountGoal || 20;
            }
            
            debugMsg(`User settings loaded: ${USER_ACCOUNT_GOAL} accounts`, 'info');
        }

        function saveUserSettings(accountGoal) {
            const storageKey = `prop_farm_settings_${CURRENT_USER.name}`;
            const settings = {
                accountGoal: accountGoal,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem(storageKey, JSON.stringify(settings));
            USER_ACCOUNT_GOAL = accountGoal;
            debugMsg(`Settings saved: ${accountGoal} accounts`, 'success');
        }

        // INIT
        function initDashboard() {
            debugMsg('Dashboard initializing...', 'info');
            populateAccountDropdown();
            setupEventListeners();
            setupPayoutForm();
            setupSettingsForm();
            setTodayDate();
            loadDashboardData();
            loadPayoutData();
        }

        function populateAccountDropdown() {
            const select = document.getElementById('account');
            const leadSelect = document.getElementById('leadAccount');
            const deleteSelect = document.getElementById('deleteAccountSelect');
            const followerDiv = document.getElementById('followerCheckboxes');
            const payoutAccountSelect = document.getElementById('payoutAccount');
            
            // Clear all dropdowns
            select.innerHTML = '<option value="">Select account</option>';
            leadSelect.innerHTML = '<option value="">Select lead account</option>';
            deleteSelect.innerHTML = '<option value="">Select account</option>';
            followerDiv.innerHTML = '';
            
            // Populate based on USER_ACCOUNT_GOAL
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                select.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
                leadSelect.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
                deleteSelect.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
                
                // Follower checkboxes
                followerDiv.innerHTML += `
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; background: var(--bg-primary);">
                        <input type="checkbox" class="follower-checkbox" value="${i}" style="cursor: pointer;">
                        <span style="font-size: 0.875rem;">PA #${i}</span>
                    </label>
                `;
            }
            
            // Payout account dropdown
            if (payoutAccountSelect) {
                payoutAccountSelect.innerHTML = '<option value="">Select account</option><option value="all">All Accounts (Portfolio)</option>';
                for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                    payoutAccountSelect.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
                }
            }
            
            debugMsg(`Account dropdowns populated with ${USER_ACCOUNT_GOAL} accounts`, 'info');
        }

        function setTodayDate() {
            document.getElementById('tradeDate').valueAsDate = new Date();
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.page);
                });
            });

            document.getElementById('menuToggle').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('show');
            });

            document.getElementById('riskTemplate').addEventListener('change', (e) => {
                const risk = parseInt(e.target.value);
                if (risk) {
                    document.getElementById('contracts').value = risk / 100;
                } else {
                    document.getElementById('contracts').value = '';
                }
            });

            document.getElementById('tradeForm').addEventListener('submit', handleFormSubmit);

            // No-Trade Day toggle - disable/enable fields
            document.getElementById('noTradeDay').addEventListener('change', (e) => {
                const isNoTradeDay = e.target.checked;
                
                // Fields to disable when it's a no-trade day
                const fieldsToDisable = [
                    'account', 'leadAccount', 'copierMode',
                    'marketCondition', 'riskTemplate', 'pnl', 'contracts'
                ];
                
                fieldsToDisable.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = isNoTradeDay;
                        if (isNoTradeDay) {
                            field.required = false;
                        }
                    }
                });
                
                // Disable follower checkboxes
                document.querySelectorAll('.follower-checkbox').forEach(cb => {
                    cb.disabled = isNoTradeDay;
                });
                
                if (isNoTradeDay) {
                    // Auto-fill notes
                    const notesField = document.getElementById('notes');
                    if (!notesField.value) {
                        notesField.value = 'No trading today - market closed / rest day';
                    }
                    
                    showAlert('üìÖ No-trade day mode enabled. Only date, cycle, and notes are needed.', 'info');
                } else {
                    // Re-enable required fields
                    document.getElementById('account').required = !document.getElementById('copierMode').checked;
                    document.getElementById('marketCondition').required = true;
                    document.getElementById('riskTemplate').required = true;
                    document.getElementById('pnl').required = true;
                }
            });

            // Trade copier mode toggle
            document.getElementById('copierMode').addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                document.getElementById('singleAccountMode').style.display = isChecked ? 'none' : 'block';
                document.getElementById('multiAccountMode').style.display = isChecked ? 'block' : 'none';
                
                // Toggle required attributes
                document.getElementById('account').required = !isChecked;
                document.getElementById('leadAccount').required = isChecked;
            });
            
            // Set suggested cycle when opening add trade page
            const cycleSelect = document.getElementById('cycle');
            const suggestedCycle = getSuggestedCycle();
            cycleSelect.value = suggestedCycle;
            
            const hint = document.getElementById('suggestedCycleHint');
            if (hint && suggestedCycle > 1) {
                hint.textContent = `(Current active cycle)`;
            }
        }

        function navigateTo(page) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');

            const titles = {
                overview: 'Overview',
                cyclePerformance: 'Cycle Performance',
                templates: 'Templates',
                accounts: 'Accounts',
                analytics: 'Analytics',
                riskMonitor: 'Risk Monitor',
                addTrade: 'Add Trade',
                logPayout: 'Log Payout',
                tradeLog: 'Trade Log',
                deleteData: 'Delete Data',
                settings: 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[page];

            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('show');
            }
            
            // Update settings page when navigating to it
            if (page === 'settings') {
                updateSettingsPage();
            }
        }

        // DATA
        async function loadDashboardData() {
            debugMsg('Loading data from API...', 'info');
            const loadStart = performance.now();
            
            try {
                const response = await fetch(SHEET_API);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const loadTime = (performance.now() - loadStart).toFixed(0);
                
                debugMsg(`‚úì Loaded ${data.length} trades in ${loadTime}ms`, 'success');
                
                allData = data || [];
                document.getElementById('debugTotalTrades').textContent = allData.length;
                
                // Count active accounts
                const activeAccounts = getActiveAccountCount();
                document.getElementById('debugActiveAccounts').textContent = activeAccounts;
                
                document.getElementById('debugLoadTime').textContent = `${loadTime}ms ago`;
                
                updateAllViews();
                
                if (allData.length === 0) {
                    showAlert('No trades found. Add your first trade!', 'info');
                }
            } catch (error) {
                debugMsg(`‚úó Load error: ${error.message}`, 'error');
                showAlert(`Failed to load data: ${error.message}`, 'error');
                allData = [];
                updateAllViews();
            }
        }

        function updateAllViews() {
            debugMsg('Updating all views...', 'info');
            updateHeroStats();
            updateMetrics();
            updateStatsComparison();
            updateCharts();
            updateTemplates();
            updateAccounts();
            updateAnalytics();
            updateTradeLog();
            updateRiskMonitor();
            updateCyclePerformance();
            updatePayoutPage();
        }
        function updateHeroStats() {
            const totalPnL = allData.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
            const accountsAtGoal = getAccountsAtGoal();
            
            // Calculate progress toward portfolio goal
            const portfolioGoal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
            const progress = Math.min((totalPnL / portfolioGoal) * 100, 100);

            document.getElementById('heroTotalPnL').textContent = formatCurrency(totalPnL);
            document.getElementById('heroProgress').textContent = Math.round(progress) + '%';
            document.getElementById('heroAccounts').textContent = `${accountsAtGoal}/${USER_ACCOUNT_GOAL}`;

            // Update hero title based on progress
            const messages = totalPnL >= portfolioGoal
                ? ['Harvesting Monthly Payouts', 'Farmer Mentality Proven', 'Steady Monthly Income']
                : totalPnL >= (portfolioGoal * 0.75)
                ? ['First Payout Qualified!', 'Ready for Harvest', 'Unlock That Payout!']
                : ['Building Your Trading Empire', 'Plant Daily Wins', 'Protect the Field', 'Stay Patient''Expanding the Generational Homestead', 'Sowing the Seeds of Process', 'Protecting the Fertile Ground', 'Respecting the Growing Season', 'Guard the Seed Capital', 'Culling the Weak Setups', 'Harvesting Without Greed', 'Surviving the Market Winter'];
            
            document.getElementById('heroTitle').textContent = messages[Math.floor(Math.random() * messages.length)];
        }

        function updateMetrics() {
            const totalPnL = allData.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
            const totalTrades = allData.length;
            const wins = allData.filter(t => parseFloat(t.pnl || 0) > 0).length;
            const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;

            const totalWins = allData.filter(t => parseFloat(t.pnl || 0) > 0).reduce((sum, t) => sum + parseFloat(t.pnl), 0);
            const totalLosses = Math.abs(allData.filter(t => parseFloat(t.pnl || 0) < 0).reduce((sum, t) => sum + parseFloat(t.pnl), 0));
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : 0;

            const avgTrade = totalTrades > 0 ? totalPnL / totalTrades : 0;
            const streak = calculateStreak(allData);
            
            // Calculate progress toward portfolio goal
            const portfolioGoal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
            const progress = Math.min((totalPnL / portfolioGoal) * 100, 100);

            document.getElementById('totalPnL').textContent = formatCurrency(totalPnL);
            document.getElementById('pnlChange').textContent = formatCurrency(totalPnL) + ' total';
            document.getElementById('pnlChange').className = `metric-change ${totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('winRate').textContent = Math.round(winRate) + '%';
            document.getElementById('winStats').textContent = `${wins} wins / ${totalTrades} trades`;
            
            document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
            document.getElementById('profitFactorInfo').textContent = profitFactor > 1 ? 'Good performance' : 'Needs improvement';
            document.getElementById('profitFactorInfo').className = `metric-change ${profitFactor > 1 ? 'positive' : 'negative'}`;
            
            document.getElementById('winStreak').textContent = streak.current;
            if (streak.current > 0) {
                document.getElementById('streakInfo').textContent = `üî• ${streak.current} wins in a row!`;
                document.getElementById('streakInfo').className = 'metric-change positive';
            } else {
                document.getElementById('streakInfo').textContent = 'No active streak';
                document.getElementById('streakInfo').className = 'metric-change neutral';
            }
            
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('totalTradesLabel').textContent = `Across ${USER_ACCOUNT_GOAL} accounts`;
            
            document.getElementById('avgTrade').textContent = formatCurrency(avgTrade);
            document.getElementById('avgTradeInfo').textContent = avgTrade >= 0 ? 'Per trade' : 'Loss per trade';
            document.getElementById('avgTradeInfo').className = `metric-change ${avgTrade >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('monthlyProgress').textContent = Math.round(progress) + '%';
        }

        function updateStatsComparison() {
            if (allData.length === 0) {
                document.getElementById('bestDay').textContent = '$0';
                document.getElementById('worstDay').textContent = '$0';
                document.getElementById('avgWin').textContent = '$0';
                document.getElementById('avgLoss').textContent = '$0';
                document.getElementById('longestStreak').textContent = '0';
                return;
            }

            const dailyPnL = {};
            allData.forEach(t => {
                const date = t.trade_date;
                dailyPnL[date] = (dailyPnL[date] || 0) + parseFloat(t.pnl || 0);
            });

            const days = Object.values(dailyPnL);
            const bestDay = days.length > 0 ? Math.max(...days) : 0;
            const worstDay = days.length > 0 ? Math.min(...days) : 0;

            document.getElementById('bestDay').textContent = formatCurrency(bestDay);
            document.getElementById('worstDay').textContent = formatCurrency(worstDay);

            const wins = allData.filter(t => parseFloat(t.pnl || 0) > 0);
            const losses = allData.filter(t => parseFloat(t.pnl || 0) < 0);

            const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? losses.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / losses.length : 0;

            document.getElementById('avgWin').textContent = formatCurrency(avgWin);
            document.getElementById('avgLoss').textContent = formatCurrency(avgLoss);

            const streak = calculateStreak(allData);
            document.getElementById('longestStreak').textContent = streak.longest;
        }

        function updateCharts() {
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            if (allData.length === 0) return;

            // Growth Chart
            const dates = [...new Set(allData.map(t => t.trade_date))].sort();
            const cumulative = [];
            let sum = 0;
            
            dates.forEach(date => {
                const dayTrades = allData.filter(t => t.trade_date === date);
                sum += dayTrades.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
                cumulative.push(sum);
            });

            charts.growth = new Chart(document.getElementById('growthChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Portfolio P&L',
                        data: cumulative,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { callback: value => '$' + value.toLocaleString() },
                            grid: { color: '#e2e8f0' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { maxRotation: 0, maxTicksLimit: 10 }
                        }
                    }
                }
            });

            // Win Rate Chart
            const templateStats = {};
            allData.forEach(trade => {
                const template = trade.market_condition || 'Unknown';
                if (!templateStats[template]) {
                    templateStats[template] = { wins: 0, total: 0 };
                }
                templateStats[template].total++;
                if (parseFloat(trade.pnl || 0) > 0) templateStats[template].wins++;
            });

            const templateLabels = Object.keys(templateStats);
            const winRates = templateLabels.map(label => {
                const stats = templateStats[label];
                return stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
            });

            charts.winRate = new Chart(document.getElementById('winRateChart'), {
                type: 'doughnut',
                data: {
                    labels: templateLabels,
                    datasets: [{
                        data: winRates,
                        backgroundColor: ['#667eea', '#764ba2', '#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 10 } }
                        }
                    }
                }
            });

            // Daily Performance Chart
            const dailyPnL = {};
            allData.forEach(t => {
                const date = t.trade_date;
                dailyPnL[date] = (dailyPnL[date] || 0) + parseFloat(t.pnl || 0);
            });

            const dailyDates = Object.keys(dailyPnL).sort().slice(-14);
            const dailyValues = dailyDates.map(date => dailyPnL[date]);

            charts.daily = new Chart(document.getElementById('dailyChart'), {
                type: 'bar',
                data: {
                    labels: dailyDates.map(d => d.substring(5)),
                    datasets: [{
                        data: dailyValues,
                        backgroundColor: dailyValues.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            ticks: { callback: value => '$' + value.toLocaleString() },
                            grid: { color: '#e2e8f0' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Risk Distribution Chart
            const riskCounts = {};
            allData.forEach(t => {
                const risk = t.risk_template || 'Unknown';
                riskCounts[risk] = (riskCounts[risk] || 0) + 1;
            });

            charts.risk = new Chart(document.getElementById('riskChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(riskCounts).map(r => '$' + r),
                    datasets: [{
                        data: Object.values(riskCounts),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 10, font: { size: 10 } } }
                    }
                }
            });

            // Account Status Chart
            const accountsAtGoal = getAccountsAtGoal();
            const accountsActive = getActiveAccountCount() - accountsAtGoal;
            const accountsInactive = USER_ACCOUNT_GOAL - getActiveAccountCount();

            document.getElementById('accountStatusSubtitle').textContent = `${USER_ACCOUNT_GOAL} accounts total`;

            charts.accountStatus = new Chart(document.getElementById('accountStatusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['At Goal', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [accountsAtGoal, accountsActive, accountsInactive],
                        backgroundColor: ['#10b981', '#3b82f6', '#94a3b8'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 10 } }
                    }
                }
            });
        }

        function updateTemplates() {
            const templates = groupByTemplate(allData);
            
            const marketGrid = document.getElementById('marketConditionsGrid');
            marketGrid.innerHTML = '';
            ['High Impact News', 'No Impact'].forEach(name => {
                marketGrid.appendChild(createTemplateCard(name, templates[name]));
            });

            const riskGrid = document.getElementById('riskTemplatesGrid');
            riskGrid.innerHTML = '';
            ['100', '200', '300', '400', '500', '600'].forEach(risk => {
                riskGrid.appendChild(createTemplateCard(`$${risk} Risk`, templates[risk]));
            });

            const topGrid = document.getElementById('topTemplatesGrid');
            topGrid.innerHTML = '';
            const sorted = Object.entries(templates)
                .filter(([name, data]) => data.trades > 0)
                .sort((a, b) => b[1].totalPnL - a[1].totalPnL)
                .slice(0, 3);
            
            if (sorted.length === 0) {
                topGrid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No trades yet. Add your first trade!</p>';
            } else {
                sorted.forEach(([name, data]) => {
                    topGrid.appendChild(createTemplateCard(name, data));
                });
            }
        }

        function createTemplateCard(name, data) {
            const card = document.createElement('div');
            card.className = 'template-card';
            
            const icon = getTemplateIcon(name);
            const desc = getTemplateDesc(name);

            card.innerHTML = `
                <div class="template-header">
                    <div class="template-icon">${icon}</div>
                    <div class="template-info">
                        <div class="template-name">${name}</div>
                        <div class="template-desc">${desc}</div>
                    </div>
                </div>
                <div class="template-stats-grid">
                    <div class="template-stat">
                        <div class="template-stat-value">${formatCurrency(data.totalPnL)}</div>
                        <div class="template-stat-label">Total P&L</div>
                    </div>
                    <div class="template-stat">
                        <div class="template-stat-value">${data.trades}</div>
                        <div class="template-stat-label">Trades</div>
                    </div>
                    <div class="template-stat">
                        <div class="template-stat-value">${Math.round(data.winRate)}%</div>
                        <div class="template-stat-label">Win Rate</div>
                    </div>
                </div>
                <div class="template-details">
                    <div class="template-detail-row">
                        <span class="template-detail-label">Avg Win</span>
                        <span class="template-detail-value">${formatCurrency(data.avgWin)}</span>
                    </div>
                    <div class="template-detail-row">
                        <span class="template-detail-label">Avg Loss</span>
                        <span class="template-detail-value">${formatCurrency(data.avgLoss)}</span>
                    </div>
                    <div class="template-detail-row">
                        <span class="template-detail-label">Best Trade</span>
                        <span class="template-detail-value">${formatCurrency(data.bestTrade)}</span>
                    </div>
                </div>
            `;
            return card;
        }

        function updateAccounts() {
            const grid = document.getElementById('accountsGrid');
            grid.innerHTML = '';

            const accountData = groupByAccount(allData);
            
            document.getElementById('accountsPageTitle').textContent = `${USER_ACCOUNT_GOAL} Portfolio Accounts`;
            
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                const acc = accountData[i];
                
                if (accountFilter === 'active' && acc.trades === 0) continue;
                if (accountFilter === 'goal' && acc.pnl < GOAL_PER_ACCOUNT) continue;
                if (accountFilter === 'profitable' && acc.pnl <= 0) continue;
                
                const card = document.createElement('div');
                card.className = 'account-card';
                
                card.innerHTML = `
                    <div class="account-header">
                        <div class="account-number">PA #${i}</div>
                        <span class="account-badge ${acc.pnl >= GOAL_PER_ACCOUNT ? 'badge-success' : 'badge-active'}">
                            ${acc.pnl >= GOAL_PER_ACCOUNT ? 'GOAL ‚úì' : 'ACTIVE'}
                        </span>
                    </div>
                    <div class="account-progress">
                        <div class="progress-header">
                            <span>${formatCurrency(acc.pnl)}</span>
                            <span>${Math.round(acc.progress)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${acc.progress}%"></div>
                        </div>
                    </div>
                    <div class="account-stats">
                        <div class="account-stat">
                            <span class="account-stat-label">Trades</span>
                            <span class="account-stat-value">${acc.trades}</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">Win Rate</span>
                            <span class="account-stat-value">${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">To Goal</span>
                            <span class="account-stat-value">${formatCurrency(Math.max(GOAL_PER_ACCOUNT - acc.pnl, 0))}</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">Balance</span>
                            <span class="account-stat-value">${formatCurrency(STARTING_BALANCE + acc.pnl)}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function filterAccounts(filter) {
            accountFilter = filter;
            document.querySelectorAll('.filter-pill').forEach(pill => pill.classList.remove('active'));
            event.target.classList.add('active');
            updateAccounts();
        }

        function updateAnalytics() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            const templates = groupByTemplate(allData);
            const sorted = Object.entries(templates)
                .filter(([name, data]) => data.trades > 0)
                .sort((a, b) => b[1].totalPnL - a[1].totalPnL);

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No trades yet</td></tr>';
                return;
            }

            sorted.forEach(([name, data]) => {
                const totalWins = data.avgWin * (data.trades * data.winRate / 100);
                const totalLosses = Math.abs(data.avgLoss * (data.trades * (100 - data.winRate) / 100));
                const profitFactor = totalLosses > 0 ? (totalWins / totalLosses).toFixed(2) : '0.00';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${name}</strong></td>
                    <td><strong>${formatCurrency(data.totalPnL)}</strong></td>
                    <td>${data.trades}</td>
                    <td>${Math.round(data.winRate)}%</td>
                    <td>${formatCurrency(data.avgWin)}</td>
                    <td>${formatCurrency(data.avgLoss)}</td>
                    <td>${formatCurrency(data.bestTrade)}</td>
                    <td>${profitFactor}</td>
                `;
            });
        }

        function updateTradeLog() {
            const tbody = document.getElementById('tradeLogBody');
            tbody.innerHTML = '';

            if (allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No trades yet</td></tr>';
                return;
            }

            const sorted = [...allData].sort((a, b) => new Date(b.trade_date) - new Date(a.trade_date));

            sorted.slice(0, 100).forEach(trade => {
                const row = tbody.insertRow();
                const pnl = parseFloat(trade.pnl || 0);
                const isNoTradeDay = trade.no_trade_day || trade.market_condition === 'No Trade';
                
                if (isNoTradeDay) {
                    row.style.background = 'rgba(148, 163, 184, 0.1)';
                    row.innerHTML = `
                        <td>${trade.trade_date}</td>
                        <td colspan="6" style="text-align: center; color: var(--text-secondary); font-style: italic;">
                            üìÖ No-Trade Day - ${trade.notes || 'Market closed / Rest day'}
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${trade.trade_date}</td>
                        <td>PA #${trade.account}</td>
                        <td>${trade.market_condition}</td>
                        <td>$${trade.risk_template}</td>
                        <td style="color: ${pnl >= 0 ? 'var(--success)' : 'var(--danger)'}"><strong>${formatCurrency(pnl)}</strong></td>
                        <td>${trade.contracts}</td>
                        <td>${trade.notes || '-'}</td>
                    `;
                }
            });
        }
        // RISK MONITOR - FIXED VERSION
        function updateRiskMonitor() {
            const grid = document.getElementById('riskMonitorGrid');
            grid.innerHTML = '';

            const accountData = groupByAccount(allData);
            let accountsAtRisk = 0;
            let accountsWarning = 0;
            
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                const acc = accountData[i];
                const currentBalance = STARTING_BALANCE + acc.pnl;
                const highestBalance = acc.highestBalance || STARTING_BALANCE;
                
                // Calculate fail line based on rules
                let failLine;
                if (highestBalance >= SAFETY_NET) {
                    // Safety net reached - fail line is locked at $50,100
                    failLine = STARTING_BALANCE + (SAFETY_NET - STARTING_BALANCE) - MAX_DRAWDOWN;
                } else {
                    // Before safety net - fail line trails highest balance
                    failLine = highestBalance - MAX_DRAWDOWN;
                }
                
                const cushion = currentBalance - failLine;
                const cushionPercent = (cushion / MAX_DRAWDOWN) * 100;
                
                let riskLevel = 'safe';
                let riskClass = '';
                let badgeClass = 'badge-active';
                let badgeText = 'SAFE';
                
                if (cushion <= 0) {
                    riskLevel = 'danger';
                    riskClass = 'at-risk';
                    badgeClass = 'badge-danger';
                    badgeText = 'AT RISK';
                    accountsAtRisk++;
                } else if (cushion <= 500) {
                    riskLevel = 'warning';
                    riskClass = 'warning';
                    badgeClass = 'badge-warning';
                    badgeText = 'WARNING';
                    accountsWarning++;
                }
                
                const card = document.createElement('div');
                card.className = `account-card ${riskClass}`;
                
                card.innerHTML = `
                    <div class="account-header">
                        <div class="account-number">PA #${i}</div>
                        <span class="account-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="account-progress">
                        <div class="progress-header">
                            <span>Balance: ${formatCurrency(currentBalance)}</span>
                            <span>${Math.round(cushionPercent)}% Cushion</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${riskLevel === 'danger' ? 'danger' : ''}" style="width: ${Math.max(0, Math.min(100, cushionPercent))}%"></div>
                        </div>
                    </div>
                    <div class="account-stats">
                        <div class="account-stat">
                            <span class="account-stat-label">Current P&L</span>
                            <span class="account-stat-value" style="color: ${acc.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(acc.pnl)}</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">Fail Line</span>
                            <span class="account-stat-value">${formatCurrency(failLine)}</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">Cushion</span>
                            <span class="account-stat-value" style="color: ${riskLevel === 'danger' ? 'var(--danger)' : riskLevel === 'warning' ? 'var(--warning)' : 'var(--success)'}">${formatCurrency(cushion)}</span>
                        </div>
                        <div class="account-stat">
                            <span class="account-stat-label">Highest Balance</span>
                            <span class="account-stat-value">${formatCurrency(highestBalance)}</span>
                        </div>
                    </div>
                    <div class="risk-info ${riskLevel}">
                        ${riskLevel === 'danger' 
                            ? '‚ö†Ô∏è CRITICAL: Account at or below fail line!' 
                            : riskLevel === 'warning' 
                            ? '‚ö†Ô∏è WARNING: Less than $500 from fail line' 
                            : highestBalance >= SAFETY_NET 
                            ? '‚úì Safety net reached! Fail line locked at $50,100' 
                            : `‚úì Safe - ${formatCurrency(Math.abs(SAFETY_NET - highestBalance))} from safety net`}
                    </div>
                `;
                grid.appendChild(card);
            }
            
            debugMsg(`Risk Monitor: ${accountsAtRisk} at risk, ${accountsWarning} warning, ${USER_ACCOUNT_GOAL - accountsAtRisk - accountsWarning} safe`, 'info');
        }

        // CYCLE PERFORMANCE
        function updateCyclePerformance() {
            const totalPnL = allData.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
            const activeAccounts = getActiveAccountCount();
            
            // Update text to show active accounts
            document.getElementById('cycleActiveAccountsText').textContent = `${activeAccounts} active account${activeAccounts !== 1 ? 's' : ''}`;
            
            // Update payout summary cards (based on ACTIVE accounts only)
            updatePayoutSummary(totalPnL, activeAccounts);
            
            // Group data by cycle
            const cycleData = groupByCycle(allData);
            
            // Update comparison table
            updateCycleComparisonTable(cycleData);
            
            // Update cycle charts
            updateCycleCharts(cycleData);
            
            // Update cycle detail cards
            updateCycleDetails(cycleData);
            
            // Update active accounts summary
            updateActiveAccountsSummary(activeAccounts, totalPnL);
        }

        function updateActiveAccountsSummary(activeAccounts, totalPnL) {
            document.getElementById('cycleActiveAccounts').textContent = activeAccounts;
            
            const avgPerAccount = activeAccounts > 0 ? totalPnL / activeAccounts : 0;
            document.getElementById('cycleAvgPerAccount').textContent = formatCurrency(avgPerAccount);
            
            const totalGoalActive = activeAccounts * GOAL_PER_ACCOUNT;
            document.getElementById('cycleTotalGoal').textContent = formatCurrency(totalGoalActive);
            
            const remaining = Math.max(0, totalGoalActive - totalPnL);
            document.getElementById('cycleRemainingGoal').textContent = formatCurrency(remaining);
        }

        function updatePayoutSummary(totalPnL, activeAccounts) {
            // Calculate goal based on ACTIVE accounts only
            const activeGoal = activeAccounts * GOAL_PER_ACCOUNT;
            
            // First Payout Progress
            const firstPayoutProg = activeAccounts > 0 ? Math.min((totalPnL / activeGoal) * 100, 100) : 0;
            document.getElementById('firstPayoutProgress').textContent = Math.round(firstPayoutProg) + '%';
            
            let status, statusClass;
            if (totalPnL >= activeGoal) {
                status = `‚úì Qualified! ${activeAccounts} account${activeAccounts !== 1 ? 's' : ''} ready`;
                statusClass = 'positive';
            } else if (activeAccounts > 0) {
                const perAccount = totalPnL / activeAccounts;
                status = `${formatCurrency(activeGoal - totalPnL)} to goal (${activeAccounts} active account${activeAccounts !== 1 ? 's' : ''})`;
                statusClass = 'neutral';
            } else {
                status = 'No active accounts yet';
                statusClass = 'neutral';
            }
            document.getElementById('firstPayoutStatus').textContent = status;
            document.getElementById('firstPayoutStatus').className = `metric-change ${statusClass}`;
            
            // Total Payouts Earned (theoretical)
            let totalPayouts = 0;
            let payoutCount = 0;
            
            if (totalPnL >= activeGoal) {
                totalPayouts = activeAccounts * PAYOUT_PER_ACCOUNT;
                payoutCount = 1;
                
                // Add subsequent payouts
                const afterFirst = totalPnL - activeGoal;
                const additionalCycles = Math.floor(afterFirst / (activeAccounts * MONTHLY_PAYOUT_GOAL));
                totalPayouts += (additionalCycles * activeAccounts * PAYOUT_PER_ACCOUNT);
                payoutCount += additionalCycles;
            }
            
            document.getElementById('totalPayouts').textContent = formatCurrency(totalPayouts);
            document.getElementById('payoutCount').textContent = payoutCount === 0 
                ? 'No payouts yet' 
                : `${payoutCount} payout${payoutCount > 1 ? 's' : ''} earned`;
            
            // Current Cycle Status
            const activeCycles = Object.keys(groupByCycle(allData)).filter(c => c !== 'undefined');
            const currentCycle = activeCycles.length > 0 ? Math.max(...activeCycles.map(c => parseInt(c))) : 1;
            
            let cycleStatus, cycleInfo;
            if (totalPnL < activeGoal) {
                cycleStatus = `Cycle ${currentCycle}`;
                cycleInfo = activeAccounts > 0 
                    ? `${formatCurrency(activeGoal - totalPnL)} to first payout`
                    : 'Start trading to begin cycle';
            } else {
                cycleStatus = `Cycle ${currentCycle}`;
                const afterFirst = totalPnL - activeGoal;
                const monthlyGoal = activeAccounts * MONTHLY_PAYOUT_GOAL;
                const currentMonthlyProgress = afterFirst % monthlyGoal;
                cycleInfo = `${formatCurrency(monthlyGoal - currentMonthlyProgress)} to next payout`;
            }
            
            document.getElementById('currentCycleStatus').textContent = cycleStatus;
            document.getElementById('currentCycleInfo').textContent = cycleInfo;
            
            // Daily Average
            const tradingDays = [...new Set(allData.map(t => t.trade_date))].length;
            const dailyAvg = tradingDays > 0 ? totalPnL / tradingDays : 0;
            
            document.getElementById('dailyAverage').textContent = formatCurrency(dailyAvg);
            
            let targetClass = 'neutral';
            const targetPerDay = activeAccounts * DAILY_TARGET_MIN;
            if (dailyAvg >= targetPerDay) {
                targetClass = 'positive';
            } else if (dailyAvg > 0) {
                targetClass = 'neutral';
            } else {
                targetClass = 'negative';
            }
            
            document.getElementById('dailyTarget').textContent = activeAccounts > 0 
                ? `Target: ${formatCurrency(targetPerDay)}-${formatCurrency(activeAccounts * DAILY_TARGET_MAX)}/day`
                : 'No active accounts';
            document.getElementById('dailyTarget').className = `metric-change ${targetClass}`;
        }

        function groupByCycle(data) {
            const grouped = {};
            
            for (let cycle = 1; cycle <= 12; cycle++) {
                const cycleTrades = data.filter(t => parseInt(t.cycle) === cycle);
                
                if (cycleTrades.length === 0) continue;
                
                const pnl = cycleTrades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
                const wins = cycleTrades.filter(t => parseFloat(t.pnl || 0) > 0);
                const losses = cycleTrades.filter(t => parseFloat(t.pnl || 0) < 0);
                
                const tradingDays = [...new Set(cycleTrades.map(t => t.trade_date))].length;
                const dailyAvg = tradingDays > 0 ? pnl / tradingDays : 0;
                
                // Calculate daily P&L for best/worst day
                const dailyPnL = {};
                cycleTrades.forEach(t => {
                    const date = t.trade_date;
                    dailyPnL[date] = (dailyPnL[date] || 0) + parseFloat(t.pnl || 0);
                });
                
                const days = Object.values(dailyPnL);
                const bestDay = days.length > 0 ? Math.max(...days) : 0;
                const worstDay = days.length > 0 ? Math.min(...days) : 0;
                
                grouped[cycle] = {
                    cycle,
                    totalPnL: pnl,
                    trades: cycleTrades.length,
                    tradingDays,
                    dailyAvg,
                    winRate: cycleTrades.length > 0 ? (wins.length / cycleTrades.length) * 100 : 0,
                    bestDay,
                    worstDay,
                    avgWin: wins.length > 0 ? wins.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / wins.length : 0,
                    avgLoss: losses.length > 0 ? losses.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / losses.length : 0
                };
            }
            
            return grouped;
        }

        function updateCycleComparisonTable(cycleData) {
            const tbody = document.getElementById('cycleComparisonBody');
            tbody.innerHTML = '';
            
            const cycles = Object.keys(cycleData).sort((a, b) => parseInt(a) - parseInt(b));
            
            if (cycles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No cycle data yet</td></tr>';
                return;
            }
            
            cycles.forEach(cycleNum => {
                const data = cycleData[cycleNum];
                const row = tbody.insertRow();
                
                // Determine status
                const activeAccounts = getActiveAccountCount();
                const cycleGoal = activeAccounts * GOAL_PER_ACCOUNT;
                
                let status = '';
                if (data.totalPnL >= cycleGoal) {
                    status = '‚úÖ Payout Ready';
                } else if (data.totalPnL >= cycleGoal * 0.75) {
                    status = 'üü° Near Goal';
                } else {
                    status = 'üîµ In Progress';
                }
                
                row.innerHTML = `
                    <td><strong>Cycle ${cycleNum}</strong></td>
                    <td style="color: ${data.totalPnL >= 0 ? 'var(--success)' : 'var(--danger)'}"><strong>${formatCurrency(data.totalPnL)}</strong></td>
                    <td>${data.trades}</td>
                    <td>${data.tradingDays}</td>
                    <td>${formatCurrency(data.dailyAvg)}</td>
                    <td>${Math.round(data.winRate)}%</td>
                    <td>${formatCurrency(data.bestDay)}</td>
                    <td>${formatCurrency(data.worstDay)}</td>
                    <td>${status}</td>
                `;
            });
        }

        function updateCycleCharts(cycleData) {
            const cycles = Object.keys(cycleData).sort((a, b) => parseInt(a) - parseInt(b));
            
            if (cycles.length === 0) return;
            
            // Destroy existing charts
            if (charts.cyclePnL) charts.cyclePnL.destroy();
            if (charts.cycleDailyAvg) charts.cycleDailyAvg.destroy();
            
            // Cycle P&L Chart
            const pnlData = cycles.map(c => cycleData[c].totalPnL);
            
            charts.cyclePnL = new Chart(document.getElementById('cyclePnLChart'), {
                type: 'bar',
                data: {
                    labels: cycles.map(c => `Cycle ${c}`),
                    datasets: [{
                        label: 'Total P&L',
                        data: pnlData,
                        backgroundColor: pnlData.map(v => v >= 0 ? '#10b981' : '#ef4444'),
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => 'P&L: $' + context.parsed.y.toLocaleString()
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: value => '$' + value.toLocaleString() },
                            grid: { color: '#e2e8f0' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
            
            // Daily Average Chart
            const dailyAvgData = cycles.map(c => cycleData[c].dailyAvg);
            
            charts.cycleDailyAvg = new Chart(document.getElementById('cycleDailyAvgChart'), {
                type: 'line',
                data: {
                    labels: cycles.map(c => `Cycle ${c}`),
                    datasets: [{
                        label: 'Daily Average',
                        data: dailyAvgData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 500 },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => 'Avg: $' + context.parsed.y.toFixed(2)
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { callback: value => '$' + value.toLocaleString() },
                            grid: { color: '#e2e8f0' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateCycleDetails(cycleData) {
            const grid = document.getElementById('cycleDetailsGrid');
            grid.innerHTML = '';
            
            const cycles = Object.keys(cycleData).sort((a, b) => parseInt(b) - parseInt(a));
            
            if (cycles.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No cycle data yet</p>';
                return;
            }
            
            const activeAccounts = getActiveAccountCount();
            const cycleGoal = activeAccounts * GOAL_PER_ACCOUNT;
            
            cycles.forEach(cycleNum => {
                const data = cycleData[cycleNum];
                const card = document.createElement('div');
                card.className = 'template-card';
                
                let icon = 'üå±';
                let statusText = 'In Progress';
                let statusColor = '#3b82f6';
                
                if (data.totalPnL >= cycleGoal) {
                    icon = 'üåæ';
                    statusText = 'Payout Ready';
                    statusColor = '#10b981';
                } else if (data.totalPnL >= cycleGoal * 0.75) {
                    icon = 'üåø';
                    statusText = 'Near Goal';
                    statusColor = '#f59e0b';
                }
                
                card.innerHTML = `
                    <div class="template-header">
                        <div class="template-icon" style="background: ${statusColor}">${icon}</div>
                        <div class="template-info">
                            <div class="template-name">Cycle ${cycleNum}</div>
                            <div class="template-desc">${statusText} ‚Ä¢ ${data.tradingDays} trading days</div>
                        </div>
                    </div>
                    <div class="template-stats-grid">
                        <div class="template-stat">
                            <div class="template-stat-value">${formatCurrency(data.totalPnL)}</div>
                            <div class="template-stat-label">Total P&L</div>
                        </div>
                        <div class="template-stat">
                            <div class="template-stat-value">${data.trades}</div>
                            <div class="template-stat-label">Trades</div>
                        </div>
                        <div class="template-stat">
                            <div class="template-stat-value">${Math.round(data.winRate)}%</div>
                            <div class="template-stat-label">Win Rate</div>
                        </div>
                    </div>
                    <div class="template-details">
                        <div class="template-detail-row">
                            <span class="template-detail-label">Daily Average</span>
                            <span class="template-detail-value">${formatCurrency(data.dailyAvg)}</span>
                        </div>
                        <div class="template-detail-row">
                            <span class="template-detail-label">Best Day</span>
                            <span class="template-detail-value">${formatCurrency(data.bestDay)}</span>
                        </div>
                        <div class="template-detail-row">
                            <span class="template-detail-label">Worst Day</span>
                            <span class="template-detail-value">${formatCurrency(data.worstDay)}</span>
                        </div>
                        <div class="template-detail-row">
                            <span class="template-detail-label">Avg Win</span>
                            <span class="template-detail-value">${formatCurrency(data.avgWin)}</span>
                        </div>
                        <div class="template-detail-row">
                            <span class="template-detail-label">Avg Loss</span>
                            <span class="template-detail-value">${formatCurrency(data.avgLoss)}</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // SETTINGS PAGE
        function setupSettingsForm() {
            const form = document.getElementById('settingsForm');
            const accountGoalSelect = document.getElementById('accountGoalSelect');
            const customGoalGroup = document.getElementById('customGoalGroup');
            const customAccountGoal = document.getElementById('customAccountGoal');
            
            // Set current value
            accountGoalSelect.value = USER_ACCOUNT_GOAL;
            
            // Handle custom option
            accountGoalSelect.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customGoalGroup.style.display = 'block';
                    customAccountGoal.required = true;
                    customAccountGoal.focus();
                } else {
                    customGoalGroup.style.display = 'none';
                    customAccountGoal.required = false;
                }
            });
            
            // Form submit
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                let newGoal;
                if (accountGoalSelect.value === 'custom') {
                    newGoal = parseInt(customAccountGoal.value);
                    if (isNaN(newGoal) || newGoal < 1 || newGoal > 200) {
                        showAlert('Please enter a valid number between 1 and 200', 'error');
                        return;
                    }
                } else {
                    newGoal = parseInt(accountGoalSelect.value);
                }
                
                saveUserSettings(newGoal);
                populateAccountDropdown();
                updateAllViews();
                
                showAlert(`‚úì Settings saved! Portfolio now set to ${newGoal} accounts`, 'success');
                
                setTimeout(() => {
                    navigateTo('overview');
                }, 1500);
            });
        }

        function resetSettingsForm() {
            const defaultGoal = CURRENT_USER.defaultAccountGoal || 20;
            document.getElementById('accountGoalSelect').value = defaultGoal;
            document.getElementById('customGoalGroup').style.display = 'none';
            document.getElementById('customAccountGoal').value = '';
        }

        function updateSettingsPage() {
            const activeAccounts = getActiveAccountCount();
            const portfolioGoal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
            const potentialPayout = USER_ACCOUNT_GOAL * PAYOUT_PER_ACCOUNT;
            
            document.getElementById('settingsCurrentGoal').textContent = USER_ACCOUNT_GOAL;
            document.getElementById('settingsActiveAccounts').textContent = activeAccounts;
            document.getElementById('settingsPortfolioGoal').textContent = formatCurrency(portfolioGoal);
            document.getElementById('settingsGoalCalc').textContent = `$${GOAL_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL} accounts`;
            document.getElementById('settingsPotentialPayout').textContent = formatCurrency(potentialPayout);
            document.getElementById('settingsPayoutCalc').textContent = `$${PAYOUT_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL} accounts`;
            
            // Update accounts table
            updateSettingsAccountsTable();
        }

        function updateSettingsAccountsTable() {
            const tbody = document.getElementById('settingsAccountsBody');
            tbody.innerHTML = '';
            
            const accountData = groupByAccount(allData);
            
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                const acc = accountData[i];
                const row = tbody.insertRow();
                
                let status = acc.trades === 0 ? 'Not Started' : acc.pnl >= GOAL_PER_ACCOUNT ? 'Goal Reached' : 'In Progress';
                let statusClass = acc.trades === 0 ? 'neutral' : acc.pnl >= GOAL_PER_ACCOUNT ? 'positive' : 'neutral';
                
                row.innerHTML = `
                    <td><strong>PA #${i}</strong></td>
                    <td><span style="color: var(--text-${statusClass})">${status}</span></td>
                    <td style="color: ${acc.pnl >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(acc.pnl)}</td>
                    <td>${Math.round(acc.progress)}%</td>
                    <td>${acc.trades}</td>
                    <td>${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</td>
                    <td>${formatCurrency(Math.max(0, GOAL_PER_ACCOUNT - acc.pnl))}</td>
                `;
            }
        }
        // PAYOUT MANAGEMENT
        async function loadPayoutData() {
            try {
                // Store payouts per user
                const storageKey = `prop_farm_payouts_${CURRENT_USER.name}`;
                const stored = localStorage.getItem(storageKey);
                payoutData = stored ? JSON.parse(stored) : [];
                debugMsg(`Loaded ${payoutData.length} payouts for ${CURRENT_USER.name}`, 'info');
            } catch (error) {
                debugMsg(`Error loading payouts: ${error.message}`, 'error');
                payoutData = [];
            }
        }

        function updatePayoutPage() {
            loadPayoutData();
            
            const totalPnL = allData.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
            const totalWithdrawn = payoutData.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
            const activeAccounts = getActiveAccountCount();
            const activeGoal = activeAccounts * GOAL_PER_ACCOUNT;
            
            // Calculate available for withdrawal
            let available = 0;
            let status = 'Not qualified yet';
            let statusClass = 'neutral';
            
            if (totalPnL >= activeGoal) {
                const afterPayouts = totalPnL - totalWithdrawn;
                const monthlyGoal = activeAccounts * MONTHLY_PAYOUT_GOAL;
                if (afterPayouts >= monthlyGoal) {
                    available = Math.floor(afterPayouts / monthlyGoal) * (activeAccounts * PAYOUT_PER_ACCOUNT);
                    status = `‚úÖ ${Math.floor(afterPayouts / monthlyGoal)} payout(s) ready`;
                    statusClass = 'positive';
                }
            } else if (totalPnL >= (activeAccounts * FIRST_PAYOUT_MIN)) {
                available = activeAccounts * PAYOUT_PER_ACCOUNT;
                status = '‚úÖ First payout qualified';
                statusClass = 'positive';
            }
            
            document.getElementById('availableWithdrawal').textContent = formatCurrency(available);
            document.getElementById('withdrawalStatus').textContent = status;
            document.getElementById('withdrawalStatus').className = `metric-change ${statusClass}`;
            
            // Total withdrawn
            document.getElementById('totalWithdrawn').textContent = formatCurrency(totalWithdrawn);
            document.getElementById('withdrawalCount').textContent = payoutData.length === 0 
                ? 'No payouts yet' 
                : `${payoutData.length} payout${payoutData.length > 1 ? 's' : ''}`;
            
            // Cycle phase
            let phase = 'First Cycle';
            let phaseInfo = 'Building to first payout';
            
            if (payoutData.length === 0) {
                phase = 'First Cycle';
                phaseInfo = activeAccounts > 0 
                    ? `${formatCurrency(activeGoal - totalPnL)} to first payout`
                    : 'Start trading to begin';
            } else {
                const lastPayout = payoutData[payoutData.length - 1];
                phase = `Cycle ${lastPayout.new_cycle || 2}`;
                phaseInfo = 'Monthly farming cycle';
            }
            
            document.getElementById('cyclePhase').textContent = phase;
            document.getElementById('phaseInfo').textContent = phaseInfo;
            
            // Update payout history table
            updatePayoutHistory();
        }

        function updatePayoutHistory() {
            const tbody = document.getElementById('payoutHistoryBody');
            tbody.innerHTML = '';
            
            if (payoutData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 2rem;">No payouts recorded yet</td></tr>';
                return;
            }
            
            const sorted = [...payoutData].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach(payout => {
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>${payout.date}</td>
                    <td><strong>${payout.type}</strong></td>
                    <td style="color: var(--success)"><strong>${formatCurrency(parseFloat(payout.amount))}</strong></td>
                    <td>${payout.account}</td>
                    <td>Cycle ${payout.cycle_completed || 1}</td>
                    <td>Cycle ${payout.new_cycle || 2}</td>
                    <td>${payout.payment_method || '-'}</td>
                    <td>${payout.notes || '-'}</td>
                `;
            });
        }

        function setTodayPayoutDate() {
            document.getElementById('payoutDate').valueAsDate = new Date();
        }

        // Setup payout form listener
        function setupPayoutForm() {
            const form = document.getElementById('payoutForm');
            if (form) {
                form.addEventListener('submit', handlePayoutSubmit);
                setTodayPayoutDate();
                
                // Withdrawal template selector
                document.getElementById('withdrawalTemplate').addEventListener('change', (e) => {
                    const amountInput = document.getElementById('withdrawalAmount');
                    if (e.target.value && e.target.value !== 'custom') {
                        amountInput.value = e.target.value;
                    } else if (e.target.value === 'custom') {
                        amountInput.value = '';
                        amountInput.focus();
                    }
                });
                
                // Auto-populate based on payout type
                document.getElementById('payoutType').addEventListener('change', (e) => {
                    const amountInput = document.getElementById('withdrawalAmount');
                    const templateSelect = document.getElementById('withdrawalTemplate');
                    const newCycleSelect = document.getElementById('newCycle');
                    const cycleCompletedSelect = document.getElementById('cycleCompleted');
                    
                    const lastPayout = payoutData.length > 0 ? payoutData[payoutData.length - 1] : null;
                    const lastCycle = lastPayout ? parseInt(lastPayout.new_cycle) : 1;
                    
                    switch(e.target.value) {
                        case 'first_min':
                        case 'first_full':
                            templateSelect.value = '2000';
                            amountInput.value = '2000';
                            cycleCompletedSelect.value = '1';
                            newCycleSelect.value = '2';
                            break;
                        case 'monthly':
                            templateSelect.value = '2000';
                            amountInput.value = '2000';
                            cycleCompletedSelect.value = lastCycle;
                            newCycleSelect.value = Math.min(lastCycle + 1, 12);
                            break;
                        case 'custom':
                            templateSelect.value = 'custom';
                            amountInput.value = '';
                            amountInput.focus();
                            break;
                    }
                });
                
                // Auto-suggest current cycle
                const lastPayout = payoutData.length > 0 ? payoutData[payoutData.length - 1] : null;
                if (lastPayout) {
                    const lastCycle = parseInt(lastPayout.new_cycle) || 1;
                    document.getElementById('cycleCompleted').value = lastCycle;
                    document.getElementById('newCycle').value = Math.min(lastCycle + 1, 12);
                } else {
                    document.getElementById('cycleCompleted').value = '1';
                    document.getElementById('newCycle').value = '2';
                }
            }
        }

        async function handlePayoutSubmit(e) {
            e.preventDefault();
            
            const btn = document.getElementById('payoutSubmitBtn');
            btn.disabled = true;
            document.getElementById('payoutSubmitText').style.display = 'none';
            document.getElementById('payoutSubmitLoading').style.display = 'inline-block';
            
            const payoutType = document.getElementById('payoutType').value;
            const amount = document.getElementById('withdrawalAmount').value;
            const date = document.getElementById('payoutDate').value;
            const account = document.getElementById('payoutAccount').value;
            const cycleCompleted = document.getElementById('cycleCompleted').value;
            const newCycle = document.getElementById('newCycle').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('payoutNotes').value;
            
            const payout = {
                date,
                type: payoutType === 'first_min' ? 'First Payout (Min)' 
                    : payoutType === 'first_full' ? 'First Payout (Full)' 
                    : payoutType === 'monthly' ? 'Monthly Payout'
                    : 'Custom Payout',
                amount: parseFloat(amount),
                account: account === 'all' ? 'All Accounts (Portfolio)' : `PA Account #${account}`,
                cycle_completed: parseInt(cycleCompleted),
                new_cycle: parseInt(newCycle),
                payment_method: paymentMethod,
                notes,
                timestamp: new Date().toISOString()
            };
            
            debugMsg('Logging payout...', 'info');
            
            try {
                // Store in localStorage
                payoutData.push(payout);
                const storageKey = `prop_farm_payouts_${CURRENT_USER.name}`;
                localStorage.setItem(storageKey, JSON.stringify(payoutData));
                
                debugMsg(`‚úì Payout logged: ${formatCurrency(payout.amount)}`, 'success');
                showAlert(`‚úì Payout logged successfully! Cycle ${newCycle} is now active.`, 'success');
                
                // Reset form
                document.getElementById('payoutForm').reset();
                setTodayPayoutDate();
                
                // Update views
                updatePayoutPage();
                
                // Show info about new cycle
                setTimeout(() => {
                    showAlert(`üåæ Cycle ${newCycle} started! Future trades will use this cycle by default.`, 'info');
                }, 2000);
                
            } catch (error) {
                debugMsg(`‚úó Payout error: ${error.message}`, 'error');
                showAlert(`‚úó Failed to log payout: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                document.getElementById('payoutSubmitText').style.display = 'inline';
                document.getElementById('payoutSubmitLoading').style.display = 'none';
            }
        }

        // Get suggested cycle for new trades
        function getSuggestedCycle() {
            if (payoutData.length === 0) return 1;
            const lastPayout = payoutData[payoutData.length - 1];
            return parseInt(lastPayout.new_cycle) || 1;
        }

        // FORM SUBMIT
        async function handleFormSubmit(e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            document.getElementById('submitText').style.display = 'none';
            document.getElementById('submitLoading').style.display = 'inline-block';

            const copierMode = document.getElementById('copierMode').checked;
            const noTradeDay = document.getElementById('noTradeDay').checked;
            
            // If it's a no-trade day, log it differently
            if (noTradeDay) {
                const trade_date = document.getElementById('tradeDate').value;
                const cycle = document.getElementById('cycle').value;
                const notes = document.getElementById('notes').value || 'No-trade day';
                const timestamp = new Date().toISOString();
                
                const noTradeDayEntry = {
                    "account": "N/A",
                    "account_type": "no_trade",
                    "copy_group": "",
                    "market_condition": "No Trade",
                    "risk_template": 0,
                    "trade_date": trade_date,
                    "cycle": cycle,
                    "pnl": 0,
                    "contracts": 0,
                    "notes": "üìÖ " + notes,
                    "timestamp": timestamp,
                    "no_trade_day": true
                };
                
                try {
                    const response = await fetch(SHEET_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: [noTradeDayEntry] })
                    });

                    if (response.ok || response.status === 201) {
                        debugMsg('‚úì No-trade day logged', 'success');
                        showAlert('‚úì No-trade day logged successfully!', 'success');
                        document.getElementById('tradeForm').reset();
                        setTodayDate();
                        setTimeout(() => {
                            loadDashboardData();
                            navigateTo('overview');
                        }, 1000);
                    } else {
                        throw new Error('Failed to log no-trade day');
                    }
                } catch (error) {
                    debugMsg(`‚úó Error: ${error.message}`, 'error');
                    showAlert('‚úó Failed to log no-trade day', 'error');
                } finally {
                    btn.disabled = false;
                    document.getElementById('submitText').style.display = 'inline';
                    document.getElementById('submitLoading').style.display = 'none';
                }
                return;
            }

            const market_condition = document.getElementById('marketCondition').value;
            const risk_template = document.getElementById('riskTemplate').value;
            const trade_date = document.getElementById('tradeDate').value;
            const cycle = document.getElementById('cycle').value;
            const pnl = document.getElementById('pnl').value;
            const contracts = document.getElementById('contracts').value;
            const notes = document.getElementById('notes').value || '';
            const timestamp = new Date().toISOString();

            debugMsg('Submitting trade...', 'info');

            const trades = [];

            if (copierMode) {
                // Multi-account mode
                const leadAccount = document.getElementById('leadAccount').value;
                const followers = Array.from(document.querySelectorAll('.follower-checkbox:checked')).map(cb => cb.value);
                
                if (!leadAccount) {
                    showAlert('Please select a lead account', 'error');
                    btn.disabled = false;
                    document.getElementById('submitText').style.display = 'inline';
                    document.getElementById('submitLoading').style.display = 'none';
                    return;
                }
                
                if (followers.length === 0) {
                    showAlert('Please select at least one follower account', 'error');
                    btn.disabled = false;
                    document.getElementById('submitText').style.display = 'inline';
                    document.getElementById('submitLoading').style.display = 'none';
                    return;
                }

                const copyGroup = timestamp;

                // Add lead trade
                trades.push({
                    "account": leadAccount,
                    "account_type": "lead",
                    "copy_group": copyGroup,
                    "market_condition": market_condition,
                    "risk_template": risk_template,
                    "trade_date": trade_date,
                    "cycle": cycle,
                    "pnl": pnl,
                    "contracts": contracts,
                    "notes": notes,
                    "timestamp": timestamp,
                    "no_trade_day": false
                });

                // Add follower trades
                followers.forEach(follower => {
                    trades.push({
                        "account": follower,
                        "account_type": "follower",
                        "copy_group": copyGroup,
                        "market_condition": market_condition,
                        "risk_template": risk_template,
                        "trade_date": trade_date,
                        "cycle": cycle,
                        "pnl": pnl,
                        "contracts": contracts,
                        "notes": notes,
                        "timestamp": timestamp,
                        "no_trade_day": false
                    });
                });

                debugMsg(`Trade copier: 1 lead + ${followers.length} followers = ${trades.length} total trades`, 'info');
            } else {
                // Single account mode
                const account = document.getElementById('account').value;
                trades.push({
                    "account": account,
                    "account_type": "single",
                    "copy_group": "",
                    "market_condition": market_condition,
                    "risk_template": risk_template,
                    "trade_date": trade_date,
                    "cycle": cycle,
                    "pnl": pnl,
                    "contracts": contracts,
                    "notes": notes,
                    "timestamp": timestamp,
                    "no_trade_day": false
                });
            }

            const payload = { data: trades };

            try {
                const response = await fetch(SHEET_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseText = await response.text();
                
                if (response.ok || response.status === 201) {
                    debugMsg(`‚úì ${trades.length} trade(s) submitted successfully`, 'success');
                    showAlert(`‚úì ${trades.length} trade(s) added successfully!`, 'success');
                    document.getElementById('tradeForm').reset();
                    document.getElementById('copierMode').checked = false;
                    document.getElementById('singleAccountMode').style.display = 'block';
                    document.getElementById('multiAccountMode').style.display = 'none';
                    document.getElementById('account').required = true;
                    document.getElementById('leadAccount').required = false;
                    setTodayDate();
                    setTimeout(() => {
                        loadDashboardData();
                        navigateTo('overview');
                    }, 1000);
                } else {
                    throw new Error(responseText);
                }
            } catch (error) {
                debugMsg(`‚úó Submission error: ${error.message}`, 'error');
                showAlert('‚úó Submission failed. Check console (F12)', 'error');
            } finally {
                btn.disabled = false;
                document.getElementById('submitText').style.display = 'inline';
                document.getElementById('submitLoading').style.display = 'none';
            }
        }

        // DELETE FUNCTIONS
        async function deleteByCycle() {
            const cycleSelect = document.getElementById('deleteCycleSelect');
            const cycle = cycleSelect.value;
            
            if (!cycle) {
                showAlert('Please select a cycle to delete', 'error');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è Delete ALL trades from Cycle ${cycle}? This cannot be undone!`)) {
                return;
            }
            
            debugMsg(`Deleting trades from Cycle ${cycle}...`, 'info');
            
            try {
                const tradesToDelete = allData.filter(t => t.cycle == cycle);
                
                if (tradesToDelete.length === 0) {
                    showAlert(`No trades found in Cycle ${cycle}`, 'info');
                    return;
                }
                
                debugMsg(`Found ${tradesToDelete.length} trades to delete`, 'info');
                
                let deleteCount = 0;
                for (const trade of tradesToDelete) {
                    try {
                        const response = await fetch(`${SHEET_API}/timestamp/${trade.timestamp}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            deleteCount++;
                        } else {
                            debugMsg(`Failed to delete trade: ${trade.timestamp}`, 'error');
                        }
                    } catch (error) {
                        debugMsg(`Error deleting trade: ${error.message}`, 'error');
                    }
                }
                
                debugMsg(`‚úì Deleted ${deleteCount} trades from Cycle ${cycle}`, 'success');
                showAlert(`‚úì Deleted ${deleteCount} trades from Cycle ${cycle}`, 'success');
                
                cycleSelect.value = '';
                setTimeout(() => loadDashboardData(), 1000);
                
            } catch (error) {
                debugMsg(`‚úó Delete error: ${error.message}`, 'error');
                showAlert(`‚úó Delete failed: ${error.message}`, 'error');
            }
        }

        async function deleteByAccount() {
            const accountSelect = document.getElementById('deleteAccountSelect');
            const account = accountSelect.value;
            
            if (!account) {
                showAlert('Please select an account to delete', 'error');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è Delete ALL trades from PA Account #${account}? This cannot be undone!`)) {
                return;
            }
            
            debugMsg(`Deleting trades from Account ${account}...`, 'info');
            
            try {
                const tradesToDelete = allData.filter(t => t.account == account);
                
                if (tradesToDelete.length === 0) {
                    showAlert(`No trades found for Account #${account}`, 'info');
                    return;
                }
                
                debugMsg(`Found ${tradesToDelete.length} trades to delete`, 'info');
                
                let deleteCount = 0;
                for (const trade of tradesToDelete) {
                    try {
                        const response = await fetch(`${SHEET_API}/timestamp/${trade.timestamp}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            deleteCount++;
                        } else {
                            debugMsg(`Failed to delete trade: ${trade.timestamp}`, 'error');
                        }
                    } catch (error) {
                        debugMsg(`Error deleting trade: ${error.message}`, 'error');
                    }
                }
                
                debugMsg(`‚úì Deleted ${deleteCount} trades from Account ${account}`, 'success');
                showAlert(`‚úì Deleted ${deleteCount} trades from Account #${account}`, 'success');
                
                accountSelect.value = '';
                setTimeout(() => loadDashboardData(), 1000);
                
            } catch (error) {
                debugMsg(`‚úó Delete error: ${error.message}`, 'error');
                showAlert(`‚úó Delete failed: ${error.message}`, 'error');
            }
        }

        async function confirmDeleteAll() {
            if (!confirm('‚ö†Ô∏è Are you ABSOLUTELY SURE you want to delete ALL data? This cannot be undone!')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: This will permanently delete ALL ' + allData.length + ' trades. Type YES to continue.')) {
                return;
            }
            
            const confirmation = prompt('Type "DELETE ALL" to confirm (case sensitive):');
            if (confirmation !== 'DELETE ALL') {
                showAlert('Deletion cancelled - confirmation text did not match', 'info');
                return;
            }
            
            debugMsg('Deleting ALL data...', 'info');
            showAlert('Deleting all trades... This may take a moment.', 'info');
            
            try {
                const totalTrades = allData.length;
                let deleteCount = 0;
                
                for (const trade of allData) {
                    try {
                        const response = await fetch(`${SHEET_API}/timestamp/${trade.timestamp}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            deleteCount++;
                            
                            if (deleteCount % 10 === 0) {
                                debugMsg(`Progress: ${deleteCount}/${totalTrades} deleted`, 'info');
                            }
                        } else {
                            debugMsg(`Failed to delete trade: ${trade.timestamp}`, 'error');
                        }
                    } catch (error) {
                        debugMsg(`Error deleting trade: ${error.message}`, 'error');
                    }
                }
                
                debugMsg(`‚úì Deleted ${deleteCount} of ${totalTrades} trades`, 'success');
                
                try {
                    const storageKey = `prop_farm_payouts_${CURRENT_USER.name}`;
                    localStorage.removeItem(storageKey);
                    payoutData = [];
                    allData = [];
                    
                    debugMsg(`‚úì Deleted all payout records and trade log`, 'success');
                    showAlert(`‚úì Successfully deleted ${deleteCount} trades, all payouts, and trade log`, 'success');
                } catch (error) {
                    debugMsg(`‚úó Error deleting payouts: ${error.message}`, 'error');
                    showAlert(`‚úì Deleted ${deleteCount} trades (payout deletion failed)`, 'info');
                }
                
                setTimeout(() => loadDashboardData(), 1500);
                
            } catch (error) {
                debugMsg(`‚úó Delete all error: ${error.message}`, 'error');
                showAlert(`‚úó Delete failed: ${error.message}`, 'error');
            }
        }

        // EXPORT CSV
        function exportCSV() {
            if (allData.length === 0) {
                showAlert('No data to export', 'error');
                return;
            }

            const headers = ['Date', 'Account', 'Market Condition', 'Risk Template', 'P&L', 'Contracts', 'Notes'];
            const rows = allData.map(t => [
                t.trade_date,
                t.account,
                t.market_condition,
                t.risk_template,
                t.pnl,
                t.contracts,
                t.notes || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prop_farm_trades_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            debugMsg('CSV exported successfully', 'success');
            showAlert('‚úì CSV exported successfully!', 'success');
        }

        // UTILITIES
        function calculateStreak(data) {
            if (data.length === 0) return { current: 0, longest: 0 };
            
            const sorted = [...data].sort((a, b) => new Date(b.trade_date) - new Date(a.trade_date));
            
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            
            for (let i = 0; i < sorted.length; i++) {
                const isWin = parseFloat(sorted[i].pnl || 0) > 0;
                
                if (i === 0) {
                    if (isWin) tempStreak = 1;
                    else break;
                } else {
                    if (isWin) tempStreak++;
                    else break;
                }
            }
            currentStreak = tempStreak;
            
            let currentRun = 0;
            let isWinStreak = false;
            
            for (let i = sorted.length - 1; i >= 0; i--) {
                const isWin = parseFloat(sorted[i].pnl || 0) > 0;
                
                if (isWin) {
                    if (!isWinStreak) {
                        currentRun = 1;
                        isWinStreak = true;
                    } else {
                        currentRun++;
                    }
                    longestStreak = Math.max(longestStreak, currentRun);
                } else {
                    currentRun = 0;
                    isWinStreak = false;
                }
            }
            
            return { current: currentStreak, longest: longestStreak };
        }

        function getAccountsAtGoal() {
            let count = 0;
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                const trades = allData.filter(t => t.account == i);
                const pnl = trades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
                if (pnl >= GOAL_PER_ACCOUNT) count++;
            }
            return count;
        }

        function getActiveAccountCount() {
            const activeSet = new Set();
            allData.forEach(t => {
                if (t.account && t.account !== 'N/A') {
                    activeSet.add(parseInt(t.account));
                }
            });
            return activeSet.size;
        }

        function groupByAccount(data) {
            const grouped = {};
            for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
                const trades = data.filter(t => t.account == i);
                const pnl = trades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
                const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0).length;
                
                let runningBalance = STARTING_BALANCE;
                let highestBalance = STARTING_BALANCE;
                
                trades.sort((a, b) => new Date(a.trade_date) - new Date(b.trade_date)).forEach(t => {
                    runningBalance += parseFloat(t.pnl || 0);
                    highestBalance = Math.max(highestBalance, runningBalance);
                });
                
                grouped[i] = {
                    pnl,
                    trades: trades.length,
                    winRate: trades.length > 0 ? (wins / trades.length) * 100 : 0,
                    progress: Math.min((pnl / GOAL_PER_ACCOUNT) * 100, 100),
                    highestBalance
                };
            }
            return grouped;
        }

        function groupByTemplate(data) {
            const templates = {
                'High Impact News': {},
                'No Impact': {},
                '100': {}, '200': {}, '300': {}, '400': {}, '500': {}, '600': {}
            };

            Object.keys(templates).forEach(key => {
                const isCondition = ['High Impact News', 'No Impact'].includes(key);
                const trades = isCondition 
                    ? data.filter(t => t.market_condition === key)
                    : data.filter(t => t.risk_template == key);
                
                const pnl = trades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
                const wins = trades.filter(t => parseFloat(t.pnl || 0) > 0);
                const losses = trades.filter(t => parseFloat(t.pnl || 0) < 0);
                
                templates[key] = {
                    totalPnL: pnl,
                    trades: trades.length,
                    winRate: trades.length > 0 ? (wins.length / trades.length) * 100 : 0,
                    avgWin: wins.length > 0 ? wins.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / wins.length : 0,
                    avgLoss: losses.length > 0 ? losses.reduce((sum, t) => sum + parseFloat(t.pnl), 0) / losses.length : 0,
                    bestTrade: trades.length > 0 ? Math.max(...trades.map(t => parseFloat(t.pnl || 0))) : 0
                };
            });

            return templates;
        }

        function getTemplateIcon(name) {
            if (name === 'High Impact News') return 'üì∞';
            if (name === 'No Impact') return 'üìâ';
            return 'üéØ';
        }

        function getTemplateDesc(name) {
            if (name === 'High Impact News') return 'High volatility news events';
            if (name === 'No Impact') return 'Low volatility sessions';
            const risk = parseInt(name.replace('$', '').replace(' Risk', ''));
            return `$${risk} risk, 1:1 reward, ${risk/100} contract(s)`;
        }

        function formatCurrency(amount) {
            const formatted = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.abs(amount));
            return amount < 0 ? '(' + formatted + ')' : formatted;
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        function refreshData() {
            debugMsg('Manual refresh triggered', 'info');
            showAlert('Refreshing data...', 'info');
            loadDashboardData();
        }
    </script>
</body>
</html>
