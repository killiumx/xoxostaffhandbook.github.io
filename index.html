<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Farm Pro - Enhanced Features Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            padding: 2rem;
            color: #0f172a;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .section {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e2e8f0;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
        }
        
        /* Trade Copier Mode Toggle */
        .mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .mode-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Account Selector Grid */
        .account-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .account-checkbox {
            display: none;
        }
        .account-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        .account-checkbox:checked + .account-label {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .account-label:hover {
            border-color: #3b82f6;
        }
        
        /* Risk Status */
        .risk-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .risk-safe { background: #d1fae5; color: #065f46; }
        .risk-caution { background: #fef3c7; color: #92400e; }
        .risk-danger { background: #fee2e2; color: #991b1b; }
        .risk-failed { background: #e5e7eb; color: #1f2937; }
        
        /* Account Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .risk-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.25rem;
        }
        .risk-card.safe { border-color: #10b981; }
        .risk-card.caution { border-color: #f59e0b; }
        .risk-card.danger { border-color: #ef4444; }
        .risk-card.failed { border-color: #6b7280; }
        
        .risk-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .risk-card-title {
            font-weight: 800;
            font-size: 1.125rem;
        }
        .risk-detail {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .risk-label {
            color: #64748b;
        }
        .risk-value {
            font-weight: 700;
            font-family: monospace;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Button Styles */
        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* Delete Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
        }
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        /* Cycle Selector */
        .cycle-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
        }
        .cycle-tab {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .cycle-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .alert-info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 2rem;">üåæ Prop Farm Pro - Enhanced Features</h1>
        
        <div id="alertContainer"></div>
        
        <!-- FEATURE 1: TRADE COPIER MODE -->
        <div class="section">
            <h2 class="section-title">üìã Add Trade (with Trade Copier)</h2>
            
            <!-- Mode Toggle -->
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('single')">Single Account</button>
                <button class="mode-btn" onclick="setMode('copier')">Trade Copier (Multi-Account)</button>
            </div>
            
            <!-- Single Account Mode -->
            <div id="singleMode">
                <div class="form-group">
                    <label class="form-label">Select Account</label>
                    <select class="form-select" id="singleAccount">
                        <option value="">Choose account...</option>
                    </select>
                </div>
            </div>
            
            <!-- Trade Copier Mode -->
            <div id="copierMode" style="display: none;">
                <p style="color: #64748b; margin-bottom: 1rem; font-size: 0.875rem;">
                    ‚úÖ Select all accounts you traded (using your trade copier). One trade will be logged for each account selected.
                </p>
                <div class="account-selector" id="accountSelector"></div>
                <div style="margin-top: 1rem;">
                    <button class="btn" onclick="selectAllAccounts()" style="background: #e5e7eb; color: #1f2937; margin-right: 0.5rem;">Select All</button>
                    <button class="btn" onclick="clearAllAccounts()" style="background: #e5e7eb; color: #1f2937;">Clear All</button>
                    <span id="selectedCount" style="margin-left: 1rem; font-weight: 600;"></span>
                </div>
            </div>
            
            <!-- Trade Details Form -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 2rem;">
                <div class="form-group">
                    <label class="form-label">Cycle (Month)</label>
                    <select class="form-select" id="cycle">
                        <option value="">Select cycle...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Market Condition</label>
                    <select class="form-select" id="marketCondition">
                        <option value="">Select...</option>
                        <option value="High Impact News">High Impact News</option>
                        <option value="No Impact">No Impact</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Risk Template</label>
                    <select class="form-select" id="riskTemplate">
                        <option value="">Select...</option>
                        <option value="100">$100 (1 contract)</option>
                        <option value="200">$200 (2 contracts)</option>
                        <option value="300">$300 (3 contracts)</option>
                        <option value="400">$400 (4 contracts)</option>
                        <option value="500">$500 (5 contracts)</option>
                        <option value="600">$600 (6 contracts)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Trade Date</label>
                    <input type="date" class="form-input" id="tradeDate">
                </div>
                <div class="form-group">
                    <label class="form-label">P&L ($)</label>
                    <input type="number" step="0.01" class="form-input" id="pnl" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Contracts (auto)</label>
                    <input type="number" class="form-input" id="contracts" readonly style="background: #f8fafc;">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-input" id="notes" rows="3" placeholder="Trade notes..."></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="submitTrade()">
                <span id="submitText">Submit Trade</span>
            </button>
        </div>
        
        <!-- FEATURE 2: ACCOUNT RISK MONITOR -->
        <div class="section">
            <h2 class="section-title">‚ö†Ô∏è Account Risk Monitor</h2>
            
            <div style="background: #dbeafe; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid #3b82f6;">
                <h3 style="font-weight: 700; margin-bottom: 0.5rem;">üìä Risk Rules</h3>
                <ul style="margin-left: 1.5rem; font-size: 0.875rem; line-height: 1.8;">
                    <li><strong>Starting Balance:</strong> $50,000</li>
                    <li><strong>Drawdown Limit:</strong> $2,500</li>
                    <li><strong>Initial Fail Line:</strong> $47,500</li>
                    <li><strong>Trailing Stop:</strong> Moves up as balance increases above $50k</li>
                    <li><strong>Safety Net:</strong> $52,600 (locks fail line at $50,100 forever)</li>
                </ul>
            </div>
            
            <div class="risk-grid" id="riskGrid"></div>
        </div>
        
        <!-- FEATURE 3: CYCLE MANAGEMENT -->
        <div class="section">
            <h2 class="section-title">üìÖ Cycle Management (12 Monthly Cycles)</h2>
            
            <div class="cycle-tabs">
                <div class="cycle-tab active" onclick="filterByCycle('all')">All Cycles</div>
            </div>
            
            <div style="background: #fef3c7; padding: 1rem; border-radius: 12px; border-left: 4px solid #f59e0b;">
                <p style="font-size: 0.875rem;"><strong>üìå Current Cycle:</strong> <span id="currentCycle">Cycle 1</span></p>
                <p style="font-size: 0.875rem; margin-top: 0.5rem;"><strong>Total Trades This Cycle:</strong> <span id="cycleTradeCount">0</span></p>
            </div>
        </div>
        
        <!-- FEATURE 4: DELETE DATA -->
        <div class="section">
            <h2 class="section-title">üóëÔ∏è Delete Data</h2>
            
            <div style="display: grid; gap: 1rem;">
                <button class="btn btn-danger" onclick="showDeleteModal('all')">
                    Delete All Data (‚ö†Ô∏è Caution)
                </button>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn" onclick="showDeleteModal('cycle')" style="background: #f59e0b; color: white;">
                        Delete by Cycle
                    </button>
                    <button class="btn" onclick="showDeleteModal('account')" style="background: #f59e0b; color: white;">
                        Delete by Account
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h3 class="modal-title">‚ö†Ô∏è Confirm Deletion</h3>
            <p id="deleteMessage"></p>
            
            <div class="form-group" style="margin-top: 1.5rem;" id="deletePasswordSection">
                <label class="form-label">Enter password to confirm:</label>
                <input type="password" class="form-input" id="deletePassword" placeholder="trader2025">
            </div>
            
            <div class="form-group" id="deleteCycleSection" style="display: none;">
                <label class="form-label">Select Cycle to Delete:</label>
                <select class="form-select" id="deleteCycleSelect"></select>
            </div>
            
            <div class="form-group" id="deleteAccountSection" style="display: none;">
                <label class="form-label">Select Account to Delete:</label>
                <select class="form-select" id="deleteAccountSelect"></select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                <button class="btn" onclick="closeDeleteModal()" style="background: #e5e7eb; color: #1f2937;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const SHEET_API = 'https://sheetdb.io/api/v1/eltwz49i4x169';
        const PASSWORD = 'trader2025';
        const STARTING_BALANCE = 50000;
        const DRAWDOWN_LIMIT = 2500;
        const SAFETY_NET = 52600;
        
        let currentMode = 'single';
        let currentDeleteType = '';
        let allData = [];
        let accountBalances = {}; // Track current balance per account
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeAccountSelector();
            initializeCycleSelector();
            initializeDropdowns();
            setTodayDate();
            loadData();
            updateSelectedCount();
            
            // Auto-fill contracts when risk changes
            document.getElementById('riskTemplate').addEventListener('change', (e) => {
                const risk = parseInt(e.target.value);
                document.getElementById('contracts').value = risk ? risk / 100 : '';
            });
        });
        
        function initializeAccountSelector() {
            const selector = document.getElementById('accountSelector');
            const singleSelect = document.getElementById('singleAccount');
            
            for (let i = 1; i <= 20; i++) {
                // Multi-select checkboxes
                selector.innerHTML += `
                    <div>
                        <input type="checkbox" class="account-checkbox" id="account${i}" value="${i}">
                        <label for="account${i}" class="account-label" onclick="updateSelectedCount()">PA #${i}</label>
                    </div>
                `;
                
                // Single select dropdown
                singleSelect.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
            }
        }
        
        function initializeCycleSelector() {
            const select = document.getElementById('cycle');
            const tabs = document.querySelector('.cycle-tabs');
            
            for (let i = 1; i <= 12; i++) {
                select.innerHTML += `<option value="${i}">Cycle ${i} (Month ${i})</option>`;
                tabs.innerHTML += `<div class="cycle-tab" onclick="filterByCycle(${i})">Cycle ${i}</div>`;
            }
        }
        
        function initializeDropdowns() {
            const deleteC = document.getElementById('deleteCycleSelect');
            const deleteA = document.getElementById('deleteAccountSelect');
            
            for (let i = 1; i <= 12; i++) {
                deleteC.innerHTML += `<option value="${i}">Cycle ${i}</option>`;
            }
            for (let i = 1; i <= 20; i++) {
                deleteA.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
            }
        }
        
        function setTodayDate() {
            document.getElementById('tradeDate').valueAsDate = new Date();
        }
        
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'single') {
                document.getElementById('singleMode').style.display = 'block';
                document.getElementById('copierMode').style.display = 'none';
            } else {
                document.getElementById('singleMode').style.display = 'none';
                document.getElementById('copierMode').style.display = 'block';
            }
        }
        
        function selectAllAccounts() {
            document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function clearAllAccounts() {
            document.querySelectorAll('.account-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = document.querySelectorAll('.account-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = 
                count > 0 ? `${count} account${count > 1 ? 's' : ''} selected` : '';
        }
        
        async function submitTrade() {
            const cycle = document.getElementById('cycle').value;
            const marketCondition = document.getElementById('marketCondition').value;
            const riskTemplate = document.getElementById('riskTemplate').value;
            const tradeDate = document.getElementById('tradeDate').value;
            const pnl = document.getElementById('pnl').value;
            const contracts = document.getElementById('contracts').value;
            const notes = document.getElementById('notes').value;
            
            if (!cycle || !marketCondition || !riskTemplate || !tradeDate || !pnl) {
                showAlert('Please fill all required fields', 'error');
                return;
            }
            
            let accounts = [];
            if (currentMode === 'single') {
                const acc = document.getElementById('singleAccount').value;
                if (!acc) {
                    showAlert('Please select an account', 'error');
                    return;
                }
                accounts.push(acc);
            } else {
                accounts = Array.from(document.querySelectorAll('.account-checkbox:checked'))
                    .map(cb => cb.value);
                
                if (accounts.length === 0) {
                    showAlert('Please select at least one account', 'error');
                    return;
                }
            }
            
            document.getElementById('submitText').textContent = 'Submitting...';
            
            try {
                const trades = accounts.map(account => ({
                    account,
                    cycle,
                    market_condition: marketCondition,
                    risk_template: riskTemplate,
                    trade_date: tradeDate,
                    pnl,
                    contracts,
                    notes,
                    timestamp: new Date().toISOString()
                }));
                
                const response = await fetch(SHEET_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: trades })
                });
                
                if (response.ok) {
                    showAlert(`‚úì Trade logged for ${accounts.length} account${accounts.length > 1 ? 's' : ''}!`, 'success');
                    clearForm();
                    setTimeout(() => loadData(), 1000);
                } else {
                    throw new Error('Submission failed');
                }
            } catch (error) {
                showAlert('‚úó Error submitting trade', 'error');
            } finally {
                document.getElementById('submitText').textContent = 'Submit Trade';
            }
        }
        
        function clearForm() {
            document.getElementById('pnl').value = '';
            document.getElementById('notes').value = '';
            clearAllAccounts();
            document.getElementById('singleAccount').value = '';
        }
        
        async function loadData() {
            try {
                const response = await fetch(SHEET_API);
                allData = await response.json();
                calculateAccountBalances();
                updateRiskMonitor();
                updateCycleInfo();
            } catch (error) {
                console.error('Load error:', error);
            }
        }
        
        function calculateAccountBalances() {
            accountBalances = {};
            for (let i = 1; i <= 20; i++) {
                const trades = allData.filter(t => t.account == i);
                const totalPnL = trades.reduce((sum, t) => sum + parseFloat(t.pnl || 0), 0);
                accountBalances[i] = STARTING_BALANCE + totalPnL;
            }
        }
        
        function calculateRiskStatus(balance) {
            const failLine = Math.max(
                STARTING_BALANCE - DRAWDOWN_LIMIT, // Initial: $47,500
                balance >= SAFETY_NET ? STARTING_BALANCE + 100 : balance - DRAWDOWN_LIMIT // Trailing or locked
            );
            
            const locked = balance >= SAFETY_NET;
            
            let status = 'safe';
            if (balance < failLine) status = 'failed';
            else if (balance < failLine + 500) status = 'danger';
            else if (balance < 51000) status = 'caution';
            
            return { balance, failLine, locked, status };
        }
        
        function updateRiskMonitor() {
            const grid = document.getElementById('riskGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 20; i++) {
                const risk = calculateRiskStatus(accountBalances[i] || STARTING_BALANCE);
                
                const statusLabels = {
                    safe: 'üü¢ Safe',
                    caution: 'üü° Caution',
                    danger: 'üî¥ At Risk',
                    failed: '‚ö´ Failed'
                };
                
                grid.innerHTML += `
                    <div class="risk-card ${risk.status}">
                        <div class="risk-card-header">
                            <span class="risk-card-title">PA #${i}</span>
                            <span class="risk-status risk-${risk.status}">${statusLabels[risk.status]}</span>
                        </div>
                        <div class="risk-detail">
                            <span class="risk-label">Current Balance</span>
                            <span class="risk-value">$${risk.balance.toLocaleString()}</span>
                        </div>
                        <div class="risk-detail">
                            <span class="risk-label">Fail Line</span>
                            <span class="risk-value">$${risk.failLine.toLocaleString()}</span>
                        </div>
                        <div class="risk-detail">
                            <span class="risk-label">Room to Fail</span>
                            <span class="risk-value" style="color: ${risk.balance - risk.failLine < 1000 ? '#ef4444' : '#10b981'}">
                                $${(risk.balance - risk.failLine).toLocaleString()}
                            </span>
                        </div>
                        <div class="risk-detail">
                            <span class="risk-label">Status</span>
                            <span class="risk-value">${risk.locked ? 'üîí Locked at Safety Net' : 'üìà Trailing'}</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function updateCycleInfo() {
            const currentCycle = 1; // This would be dynamic in real app
            document.getElementById('currentCycle').textContent = `Cycle ${currentCycle}`;
            
            const cycl eTrades = allData.filter(t => t.cycle == currentCycle);
            document.getElementById('cycleTradeCount').textContent = cycleTrades.length;
        }
        
        function filterByCycle(cycle) {
            document.querySelectorAll('.cycle-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // This would filter your main dashboard
            console.log('Filtering by cycle:', cycle);
        }
        
        function showDeleteModal(type) {
            currentDeleteType = type;
            const modal = document.getElementById('deleteModal');
            const msg = document.getElementById('deleteMessage');
            
            document.getElementById('deleteCycleSection').style.display = 'none';
            document.getElementById('deleteAccountSection').style.display = 'none';
            document.getElementById('deletePasswordSection').style.display = 'block';
            
            if (type === 'all') {
                msg.textContent = `‚ö†Ô∏è This will permanently delete ALL ${allData.length} trades from all accounts and cycles. This cannot be undone!`;
            } else if (type === 'cycle') {
                msg.textContent = 'Select a cycle to delete all its trades:';
                document.getElementById('deleteCycleSection').style.display = 'block';
            } else if (type === 'account') {
                msg.textContent = 'Select an account to delete all its trades:';
                document.getElementById('deleteAccountSection').style.display = 'block';
            }
            
            modal.classList.add('show');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            document.getElementById('deletePassword').value = '';
        }
        
        async function confirmDelete() {
            const password = document.getElementById('deletePassword').value;
            
            if (password !== PASSWORD) {
                showAlert('Incorrect password', 'error');
                return;
            }
            
            // In real implementation, you'd call SheetDB delete endpoint
            let filter = '';
            if (currentDeleteType === 'cycle') {
                filter = `cycle ${document.getElementById('deleteCycleSelect').value}`;
            } else if (currentDeleteType === 'account') {
                filter = `account ${document.getElementById('deleteAccountSelect').value}`;
            }
            
            showAlert(`‚úì Would delete ${currentDeleteType === 'all' ? 'all data' : filter} (demo mode)`, 'info');
            closeDeleteModal();
            
            // Real implementation:
            // await fetch(`${SHEET_API}/account/${accountId}`, { method: 'DELETE' });
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }
    </script>
</body>
</html>
