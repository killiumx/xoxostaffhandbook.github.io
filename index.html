<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Farm Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;1,9..40,400&family=DM+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0d1117;
            --bg2: #161b22;
            --bg3: #1c2128;
            --border: #30363d;
            --border2: #444c56;
            --text: #e6edf3;
            --text2: #8b949e;
            --text3: #6e7681;
            --accent: #58a6ff;
            --accent2: #1f6feb;
            --green: #3fb950;
            --green-bg: rgba(63,185,80,0.1);
            --red: #f85149;
            --red-bg: rgba(248,81,73,0.1);
            --yellow: #d29922;
            --yellow-bg: rgba(210,153,34,0.1);
            --purple: #bc8cff;
            --purple-bg: rgba(188,140,255,0.1);
            --orange: #ffa657;
            --orange-bg: rgba(255,166,87,0.1);
            --radius: 10px;
            --radius-lg: 16px;
            --shadow: 0 0 0 1px var(--border), 0 4px 12px rgba(0,0,0,0.4);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
        .auth-screen {
            position: fixed; inset: 0;
            background: var(--bg);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            transition: opacity 0.4s ease;
        }
        .auth-screen.hidden { opacity: 0; pointer-events: none; }

        .auth-box {
            width: 420px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            box-shadow: 0 16px 48px rgba(0,0,0,0.6);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }
        .auth-logo-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 0.5rem;
        }
        .auth-logo-title {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .auth-logo-sub {
            font-size: 0.875rem;
            color: var(--text2);
            margin-top: 0.25rem;
        }

        .auth-tabs {
            display: flex;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 1.75rem;
        }
        .auth-tab {
            flex: 1;
            padding: 0.625rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            background: transparent;
            border: none;
            color: var(--text2);
            transition: all 0.2s;
        }
        .auth-tab.active {
            background: var(--bg3);
            color: var(--text);
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }

        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--text2);
            margin-bottom: 0.5rem;
            letter-spacing: 0.01em;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 0.9375rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent2);
            box-shadow: 0 0 0 3px rgba(31,111,235,0.25);
        }
        .form-select {
            width: 100%; padding: 0.75rem 1rem;
            background: var(--bg3); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text);
            font-size: 0.9375rem; font-family: inherit; cursor: pointer;
            transition: all 0.2s;
        }
        .form-select:focus { outline: none; border-color: var(--accent2); box-shadow: 0 0 0 3px rgba(31,111,235,0.25); }
        .form-textarea { min-height: 100px; resize: vertical; font-family: inherit; }

        .btn {
            padding: 0.75rem 1.25rem;
            border: none; border-radius: var(--radius);
            font-weight: 600; font-size: 0.9375rem;
            cursor: pointer; transition: all 0.2s;
            font-family: inherit; display: inline-flex;
            align-items: center; gap: 0.5rem;
        }
        .btn-primary {
            background: var(--accent2);
            color: white; width: 100%; justify-content: center;
        }
        .btn-primary:hover { background: var(--accent); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background: var(--bg3); color: var(--text);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { border-color: var(--border2); }

        .btn-danger { background: var(--red-bg); color: var(--red); border: 1px solid rgba(248,81,73,0.3); }
        .btn-danger:hover { background: rgba(248,81,73,0.2); }
        .btn-success { background: var(--green-bg); color: var(--green); border: 1px solid rgba(63,185,80,0.3); }
        .btn-success:hover { background: rgba(63,185,80,0.2); }
        .btn-sm { padding: 0.5rem 0.875rem; font-size: 0.8125rem; }
        .btn-icon { width: 36px; height: 36px; padding: 0; justify-content: center; font-size: 1rem; }

        .btn-google {
            background: var(--bg3); color: var(--text);
            border: 1px solid var(--border); width: 100%;
            justify-content: center; margin-top: 0.75rem;
        }
        .btn-google:hover { border-color: var(--border2); }

        .auth-divider {
            display: flex; align-items: center; gap: 1rem;
            margin: 1.25rem 0; color: var(--text3); font-size: 0.8125rem;
        }
        .auth-divider::before, .auth-divider::after {
            content: ''; flex: 1; height: 1px; background: var(--border);
        }

        .auth-error {
            background: var(--red-bg); color: var(--red);
            border: 1px solid rgba(248,81,73,0.3);
            padding: 0.75rem 1rem; border-radius: var(--radius);
            font-size: 0.875rem; margin-bottom: 1rem; display: none;
        }
        .auth-error.show { display: block; }
        .auth-success {
            background: var(--green-bg); color: var(--green);
            border: 1px solid rgba(63,185,80,0.3);
            padding: 0.75rem 1rem; border-radius: var(--radius);
            font-size: 0.875rem; margin-bottom: 1rem; display: none;
        }
        .auth-success.show { display: block; }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .dashboard { display: none; min-height: 100vh; }
        .dashboard.show { display: flex; }

        .sidebar {
            position: fixed; left: 0; top: 0; bottom: 0;
            width: 260px; background: var(--bg2);
            border-right: 1px solid var(--border);
            padding: 1.5rem 1rem;
            overflow-y: auto; z-index: 100;
            transition: transform 0.3s ease;
            display: flex; flex-direction: column;
        }
        .sidebar.hidden { transform: translateX(-100%); }

        .sidebar-logo {
            font-size: 1.25rem; font-weight: 800;
            letter-spacing: -0.02em; padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-user {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg3); border-radius: var(--radius);
            margin-bottom: 1.5rem; border: 1px solid var(--border);
        }
        .sidebar-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, var(--accent2), var(--purple));
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem; font-weight: 700; flex-shrink: 0;
        }
        .sidebar-user-info { flex: 1; min-width: 0; }
        .sidebar-user-name { font-size: 0.875rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar-user-role { font-size: 0.75rem; color: var(--text2); }

        .admin-badge {
            background: linear-gradient(135deg, var(--purple-bg), rgba(188,140,255,0.15));
            color: var(--purple); border: 1px solid rgba(188,140,255,0.3);
            padding: 0.25rem 0.5rem; border-radius: 6px;
            font-size: 0.6875rem; font-weight: 700;
            letter-spacing: 0.04em; text-transform: uppercase;
        }

        .nav-section { margin-bottom: 1.5rem; }
        .nav-label {
            font-size: 0.6875rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.08em;
            color: var(--text3); padding: 0 0.75rem; margin-bottom: 0.5rem;
        }
        .nav-item {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.625rem 0.75rem; border-radius: var(--radius);
            cursor: pointer; font-size: 0.9rem; font-weight: 500;
            color: var(--text2); transition: all 0.15s; margin-bottom: 2px;
            border: 1px solid transparent;
        }
        .nav-item:hover { background: var(--bg3); color: var(--text); }
        .nav-item.active {
            background: rgba(31,111,235,0.15);
            color: var(--accent);
            border-color: rgba(31,111,235,0.2);
        }
        .nav-icon { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }

        .sidebar-spacer { flex: 1; }
        .sidebar-bottom { padding-top: 1rem; border-top: 1px solid var(--border); }

        .main-content {
            margin-left: 260px;
            flex: 1; min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        .main-content.expanded { margin-left: 0; }

        .topbar {
            background: var(--bg2); border-bottom: 1px solid var(--border);
            padding: 1rem 1.75rem; display: flex;
            justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 90;
        }
        .topbar-left { display: flex; align-items: center; gap: 1rem; }
        .topbar-title { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
        .topbar-actions { display: flex; align-items: center; gap: 0.75rem; }

        .menu-toggle { display: none; background: none; border: none; font-size: 1.25rem; cursor: pointer; color: var(--text); }

        .container { padding: 1.75rem; max-width: 1600px; }

        /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
        .page { display: none; }
        .page.active { display: block; }

        /* ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ */
        .alert {
            padding: 0.875rem 1.25rem; border-radius: var(--radius);
            margin-bottom: 1.5rem; font-size: 0.9rem; font-weight: 500;
            display: none; border: 1px solid;
        }
        .alert.show { display: block; animation: fadeIn 0.3s ease; }
        .alert-success { background: var(--green-bg); color: var(--green); border-color: rgba(63,185,80,0.3); }
        .alert-error { background: var(--red-bg); color: var(--red); border-color: rgba(248,81,73,0.3); }
        .alert-info { background: rgba(88,166,255,0.1); color: var(--accent); border-color: rgba(88,166,255,0.3); }
        .alert-warning { background: var(--yellow-bg); color: var(--yellow); border-color: rgba(210,153,34,0.3); }

        @keyframes fadeIn { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .metric-card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 1.5rem;
            transition: border-color 0.2s, transform 0.2s;
        }
        .metric-card:hover { border-color: var(--border2); transform: translateY(-1px); }
        .metric-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
        .metric-label { font-size: 0.8125rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.04em; }
        .metric-icon {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 1rem;
        }
        .mi-blue { background: rgba(88,166,255,0.1); }
        .mi-green { background: var(--green-bg); }
        .mi-purple { background: var(--purple-bg); }
        .mi-orange { background: var(--orange-bg); }
        .mi-red { background: var(--red-bg); }
        .metric-value {
            font-size: 2rem; font-weight: 800;
            font-family: 'DM Mono', monospace; letter-spacing: -0.02em;
            margin-bottom: 0.375rem;
        }
        .metric-change { font-size: 0.8125rem; font-weight: 600; }
        .positive { color: var(--green); }
        .negative { color: var(--red); }
        .neutral { color: var(--text2); }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius-lg); overflow: hidden;
        }
        .card-header {
            padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 1rem; font-weight: 700; }
        .card-subtitle { font-size: 0.8125rem; color: var(--text2); margin-top: 0.2rem; }
        .card-body { padding: 1.5rem; }

        /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
        .hero {
            background: linear-gradient(135deg, #1a1f35 0%, #0d1117 50%, #1a0d2e 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 2.5rem;
            margin-bottom: 1.5rem; position: relative; overflow: hidden;
        }
        .hero::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(ellipse at 70% 50%, rgba(88,166,255,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse at 20% 80%, rgba(188,140,255,0.06) 0%, transparent 50%);
            pointer-events: none;
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-greeting { font-size: 0.875rem; color: var(--text2); margin-bottom: 0.375rem; }
        .hero-title { font-size: 2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .hero-subtitle { font-size: 0.9375rem; color: var(--text2); margin-bottom: 2rem; }
        .hero-stats { display: flex; gap: 2.5rem; flex-wrap: wrap; }
        .hero-stat-val { font-size: 1.75rem; font-weight: 800; font-family: 'DM Mono', monospace; letter-spacing: -0.02em; }
        .hero-stat-label { font-size: 0.8125rem; color: var(--text2); margin-top: 0.2rem; }

        /* ‚îÄ‚îÄ CHART GRID ‚îÄ‚îÄ */
        .chart-grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .chart-grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .chart-container { position: relative; height: 260px; }
        .chart-container-sm { position: relative; height: 200px; }

        /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead tr { background: var(--bg3); }
        th {
            text-align: left; padding: 0.875rem 1.25rem;
            font-size: 0.75rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.05em;
            color: var(--text3); white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }
        td { padding: 0.875rem 1.25rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: rgba(255,255,255,0.02); }

        /* ‚îÄ‚îÄ ACCOUNTS GRID ‚îÄ‚îÄ */
        .accounts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .account-card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 1.25rem; transition: all 0.2s;
        }
        .account-card:hover { border-color: var(--border2); transform: translateY(-1px); }
        .account-card.at-risk { border-color: rgba(248,81,73,0.4); background: rgba(248,81,73,0.03); }
        .account-card.warning-card { border-color: rgba(210,153,34,0.4); background: rgba(210,153,34,0.03); }
        .acc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .acc-number { font-size: 1rem; font-weight: 800; font-family: 'DM Mono', monospace; }
        .badge {
            padding: 0.25rem 0.625rem; border-radius: 20px;
            font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .badge-green { background: var(--green-bg); color: var(--green); }
        .badge-blue { background: rgba(88,166,255,0.1); color: var(--accent); }
        .badge-red { background: var(--red-bg); color: var(--red); }
        .badge-yellow { background: var(--yellow-bg); color: var(--yellow); }
        .badge-gray { background: var(--bg3); color: var(--text2); }
        .badge-purple { background: var(--purple-bg); color: var(--purple); }

        .progress-bar { height: 6px; background: var(--bg3); border-radius: 10px; overflow: hidden; margin: 0.5rem 0; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--accent2), var(--accent)); }
        .progress-fill.danger { background: linear-gradient(90deg, #b22222, var(--red)); }
        .progress-fill.warn { background: linear-gradient(90deg, #9a6f00, var(--yellow)); }

        .acc-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.875rem; }
        .acc-stat-label { font-size: 0.6875rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.2rem; }
        .acc-stat-val { font-size: 1rem; font-weight: 700; font-family: 'DM Mono', monospace; }

        /* ‚îÄ‚îÄ FILTER PILLS ‚îÄ‚îÄ */
        .filter-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
        .pill {
            padding: 0.4375rem 0.875rem; border-radius: 20px;
            border: 1px solid var(--border); background: var(--bg2);
            font-size: 0.8125rem; font-weight: 600; cursor: pointer; transition: all 0.15s;
            color: var(--text2);
        }
        .pill:hover { border-color: var(--border2); color: var(--text); }
        .pill.active { background: rgba(31,111,235,0.15); color: var(--accent); border-color: rgba(31,111,235,0.3); }

        /* ‚îÄ‚îÄ STATS MINI ‚îÄ‚îÄ */
        .mini-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .mini-card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 1.125rem; text-align: center;
        }
        .mini-val { font-size: 1.5rem; font-weight: 800; font-family: 'DM Mono', monospace; margin-bottom: 0.25rem; }
        .mini-label { font-size: 0.75rem; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }

        /* ‚îÄ‚îÄ TEMPLATE CARDS ‚îÄ‚îÄ */
        .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .tmpl-card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 1.5rem; transition: all 0.2s;
        }
        .tmpl-card:hover { border-color: var(--border2); transform: translateY(-2px); }
        .tmpl-header { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.25rem; }
        .tmpl-icon {
            width: 48px; height: 48px; border-radius: 12px;
            background: linear-gradient(135deg, var(--accent2), var(--purple));
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; flex-shrink: 0;
        }
        .tmpl-name { font-size: 1rem; font-weight: 700; }
        .tmpl-desc { font-size: 0.8125rem; color: var(--text2); margin-top: 0.25rem; }
        .tmpl-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; text-align: center; }
        .tmpl-stat-val { font-size: 1.375rem; font-weight: 800; font-family: 'DM Mono', monospace; }
        .tmpl-stat-lbl { font-size: 0.6875rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.04em; }
        .tmpl-details { padding-top: 1rem; border-top: 1px solid var(--border); display: grid; gap: 0.625rem; }
        .tmpl-row { display: flex; justify-content: space-between; font-size: 0.875rem; }
        .tmpl-row-lbl { color: var(--text2); }
        .tmpl-row-val { font-weight: 700; font-family: 'DM Mono', monospace; }

        /* ‚îÄ‚îÄ FORM CARD ‚îÄ‚îÄ */
        .form-card {
            background: var(--bg2); border: 1px solid var(--border);
            border-radius: var(--radius-lg); padding: 2rem; max-width: 900px;
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; margin-bottom: 1.25rem; }
        .form-footer { display: flex; gap: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }

        /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
        .spin {
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
            border-radius: 50%; animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
        .admin-header {
            background: linear-gradient(135deg, rgba(188,140,255,0.1), rgba(88,166,255,0.05));
            border: 1px solid rgba(188,140,255,0.3);
            border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem;
            display: flex; align-items: center; gap: 1rem;
        }
        .admin-icon { font-size: 2rem; }
        .admin-title { font-size: 1.25rem; font-weight: 800; color: var(--purple); }
        .admin-sub { font-size: 0.875rem; color: var(--text2); }

        .user-row-actions { display: flex; gap: 0.5rem; }

        /* ‚îÄ‚îÄ SECTION HEADER ‚îÄ‚îÄ */
        .section-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
        .section-title { font-size: 1.375rem; font-weight: 800; letter-spacing: -0.02em; }

        /* ‚îÄ‚îÄ RISK INFO ‚îÄ‚îÄ */
        .risk-note { margin-top: 0.875rem; padding: 0.75rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 500; }
        .risk-note.safe { background: var(--green-bg); color: var(--green); }
        .risk-note.warn { background: var(--yellow-bg); color: var(--yellow); }
        .risk-note.danger { background: var(--red-bg); color: var(--red); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
            .main-content { margin-left: 0; }
            .menu-toggle { display: block; }
            .chart-grid-2, .chart-grid-3 { grid-template-columns: 1fr; }
        }
        @media (max-width: 640px) {
            .container { padding: 1rem; }
            .hero { padding: 1.5rem; }
            .hero-stats { flex-direction: column; gap: 1rem; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ -->
<div class="auth-screen" id="authScreen">
    <div class="auth-box">
        <div class="auth-logo">
            <span class="auth-logo-icon">üåæ</span>
            <div class="auth-logo-title">Prop Farm Pro</div>
            <div class="auth-logo-sub">Professional Trading Portfolio Management</div>
        </div>

        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">Create Account</button>
        </div>

        <!-- LOGIN FORM -->
        <div class="auth-form active" id="loginForm">
            <div class="auth-error" id="loginError"></div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="loginEmail" placeholder="you@example.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">
                <span id="loginBtnText">Sign In</span>
                <span id="loginSpinner" class="spin" style="display:none;"></span>
            </button>
            <div class="auth-divider">or</div>
            <button class="btn btn-google" onclick="handleGoogleAuth()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 01-7.18-2.54H1.83v2.07A8 8 0 008.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 010-3.04V5.41H1.83a8 8 0 000 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 001.83 5.4L4.5 7.49a4.77 4.77 0 014.48-3.3z"/></svg>
                Continue with Google
            </button>
        </div>

        <!-- SIGNUP FORM -->
        <div class="auth-form" id="signupForm">
            <div class="auth-error" id="signupError"></div>
            <div class="auth-success" id="signupSuccess"></div>
            <div class="form-group">
                <label class="form-label">Display Name</label>
                <input type="text" class="form-input" id="signupName" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="signupEmail" placeholder="you@example.com" autocomplete="email">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="signupPassword" placeholder="Min 6 characters" autocomplete="new-password">
            </div>
            <button class="btn btn-primary" id="signupBtn" onclick="handleSignup()">
                <span id="signupBtnText">Create Account</span>
                <span id="signupSpinner" class="spin" style="display:none;"></span>
            </button>
            <div class="auth-divider">or</div>
            <button class="btn btn-google" onclick="handleGoogleAuth()">
                <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 002.38-5.88c0-.57-.05-.66-.15-1.18z"/><path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 01-7.18-2.54H1.83v2.07A8 8 0 008.98 17z"/><path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 010-3.04V5.41H1.83a8 8 0 000 7.18l2.67-2.07z"/><path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 001.83 5.4L4.5 7.49a4.77 4.77 0 014.48-3.3z"/></svg>
                Continue with Google
            </button>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
<div class="dashboard" id="dashboard">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">üåæ Prop Farm</div>

        <div class="sidebar-user" id="sidebarUser">
            <div class="sidebar-avatar" id="sidebarAvatar">?</div>
            <div class="sidebar-user-info">
                <div class="sidebar-user-name" id="sidebarName">Loading...</div>
                <div class="sidebar-user-role" id="sidebarRole">Trader</div>
            </div>
            <span class="admin-badge" id="adminBadge" style="display:none;">Admin</span>
        </div>

        <nav>
            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-page="overview"><span class="nav-icon">üìä</span>Overview</div>
                <div class="nav-item" data-page="cyclePerformance"><span class="nav-icon">üîÑ</span>Cycle Performance</div>
                <div class="nav-item" data-page="templates"><span class="nav-icon">üìã</span>Templates</div>
                <div class="nav-item" data-page="accounts"><span class="nav-icon">üíº</span>Accounts</div>
                <div class="nav-item" data-page="analytics"><span class="nav-icon">üìà</span>Analytics</div>
                <div class="nav-item" data-page="riskMonitor"><span class="nav-icon">‚ö†Ô∏è</span>Risk Monitor</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Actions</div>
                <div class="nav-item" data-page="addTrade"><span class="nav-icon">‚ûï</span>Add Trade</div>
                <div class="nav-item" data-page="logPayout"><span class="nav-icon">üí∞</span>Log Payout</div>
                <div class="nav-item" data-page="tradeLog"><span class="nav-icon">üìù</span>Trade Log</div>
                <div class="nav-item" data-page="deleteData"><span class="nav-icon">üóëÔ∏è</span>Delete Data</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Settings</div>
                <div class="nav-item" data-page="settings"><span class="nav-icon">‚öôÔ∏è</span>Settings</div>
                <!-- Admin only -->
                <div class="nav-item admin-only" data-page="adminPanel" style="display:none;"><span class="nav-icon">üõ°Ô∏è</span>Admin Panel</div>
            </div>
        </nav>

        <div class="sidebar-spacer"></div>
        <div class="sidebar-bottom">
            <div class="nav-item" onclick="handleLogout()"><span class="nav-icon">üö™</span>Sign Out</div>
        </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content" id="mainContent">
        <div class="topbar">
            <div class="topbar-left">
                <button class="menu-toggle" id="menuToggle">‚ò∞</button>
                <span class="topbar-title" id="pageTitle">Overview</span>
            </div>
            <div class="topbar-actions">
                <button class="btn btn-secondary btn-icon btn-sm" onclick="refreshData()" title="Refresh">‚Üª</button>
                <span id="topbarAdminMode" style="display:none;">
                    <span class="badge badge-purple" style="margin-right:0.5rem;">üõ°Ô∏è Admin Mode</span>
                </span>
            </div>
        </div>

        <div class="container">
            <div class="alert" id="mainAlert"></div>

            <!-- PAGE: OVERVIEW -->
            <div class="page active" id="overviewPage">
                <div class="hero">
                    <div class="hero-content">
                        <div class="hero-greeting" id="heroGreeting">Welcome back</div>
                        <div class="hero-title" id="heroTitle">Building Your Trading Empire</div>
                        <div class="hero-subtitle" id="heroSubtitle">Track, grow, and harvest your prop firm accounts.</div>
                        <div class="hero-stats">
                            <div>
                                <div class="hero-stat-val" id="heroTotalPnL">$0</div>
                                <div class="hero-stat-label">Total P&L</div>
                            </div>
                            <div>
                                <div class="hero-stat-val" id="heroProgress">0%</div>
                                <div class="hero-stat-label">Portfolio Progress</div>
                            </div>
                            <div>
                                <div class="hero-stat-val" id="heroAccounts">0/20</div>
                                <div class="hero-stat-label">Accounts at Goal</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Total P&L</span><div class="metric-icon mi-blue">üí∞</div></div>
                        <div class="metric-value" id="totalPnL">$0</div>
                        <div class="metric-change neutral" id="pnlChange">$0 total</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Win Rate</span><div class="metric-icon mi-green">üéØ</div></div>
                        <div class="metric-value" id="winRate">0%</div>
                        <div class="metric-change neutral" id="winStats">0 wins / 0 trades</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Profit Factor</span><div class="metric-icon mi-purple">üìä</div></div>
                        <div class="metric-value" id="profitFactor">0.00</div>
                        <div class="metric-change neutral" id="profitFactorInfo">No data</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Win Streak</span><div class="metric-icon mi-orange">üî•</div></div>
                        <div class="metric-value" id="winStreak">0</div>
                        <div class="metric-change neutral" id="streakInfo">No active streak</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Total Trades</span><div class="metric-icon mi-blue">üìà</div></div>
                        <div class="metric-value" id="totalTrades">0</div>
                        <div class="metric-change neutral" id="totalTradesLabel">All accounts</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Avg Trade</span><div class="metric-icon mi-green">üíµ</div></div>
                        <div class="metric-value" id="avgTrade">$0</div>
                        <div class="metric-change neutral">Per trade</div>
                    </div>
                </div>

                <div class="mini-grid">
                    <div class="mini-card"><div class="mini-val" id="bestDay">$0</div><div class="mini-label">Best Day</div></div>
                    <div class="mini-card"><div class="mini-val" id="worstDay">$0</div><div class="mini-label">Worst Day</div></div>
                    <div class="mini-card"><div class="mini-val" id="avgWin">$0</div><div class="mini-label">Avg Win</div></div>
                    <div class="mini-card"><div class="mini-val" id="avgLoss">$0</div><div class="mini-label">Avg Loss</div></div>
                    <div class="mini-card"><div class="mini-val" id="longestStreak">0</div><div class="mini-label">Longest Streak</div></div>
                    <div class="mini-card"><div class="mini-val" id="monthlyProgress">0%</div><div class="mini-label">Payout Progress</div></div>
                </div>

                <div class="chart-grid-2">
                    <div class="card">
                        <div class="card-header"><div><div class="card-title">Portfolio Growth</div><div class="card-subtitle">Cumulative P&L over time</div></div></div>
                        <div class="card-body"><div class="chart-container"><canvas id="growthChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div><div class="card-title">Win Rate by Condition</div></div></div>
                        <div class="card-body"><div class="chart-container"><canvas id="winRateChart"></canvas></div></div>
                    </div>
                </div>

                <div class="chart-grid-3">
                    <div class="card">
                        <div class="card-header"><div class="card-title">Daily Performance</div></div>
                        <div class="card-body"><div class="chart-container-sm"><canvas id="dailyChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div class="card-title">Risk Distribution</div></div>
                        <div class="card-body"><div class="chart-container-sm"><canvas id="riskChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div class="card-title">Account Status</div></div>
                        <div class="card-body"><div class="chart-container-sm"><canvas id="accountStatusChart"></canvas></div></div>
                    </div>
                </div>

                <div class="section-hdr">
                    <h2 class="section-title">Top Performing Templates</h2>
                    <button class="btn btn-secondary btn-sm" onclick="navigateTo('templates')">View All</button>
                </div>
                <div class="template-grid" id="topTemplatesGrid"></div>
            </div>

            <!-- PAGE: CYCLE PERFORMANCE -->
            <div class="page" id="cyclePerformancePage">
                <div class="alert alert-info show" style="margin-bottom:1.5rem;">
                    <strong>üåæ Farmer Mentality:</strong> Plant $250‚Äì$300/day per account. Protect accounts (avoid red-folder news). First cycle: 45 days to $4,600. After first payout: $2,000 in 8‚Äì20 days monthly.
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">First Payout Progress</span><div class="metric-icon mi-blue">üéØ</div></div>
                        <div class="metric-value" id="firstPayoutProgress">0%</div>
                        <div class="metric-change neutral" id="firstPayoutStatus">Not qualified</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Total Payouts</span><div class="metric-icon mi-green">üí∞</div></div>
                        <div class="metric-value" id="totalPayouts">$0</div>
                        <div class="metric-change neutral" id="payoutCount">0 payouts</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Cycle Status</span><div class="metric-icon mi-purple">üìÖ</div></div>
                        <div class="metric-value" id="currentCycleStatus">Cycle 1</div>
                        <div class="metric-change neutral" id="currentCycleInfo">Building</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-header"><span class="metric-label">Daily Average</span><div class="metric-icon mi-orange">üìä</div></div>
                        <div class="metric-value" id="dailyAverage">$0</div>
                        <div class="metric-change neutral" id="dailyTarget">Target: $250‚Äì$300</div>
                    </div>
                </div>
                <div class="mini-grid">
                    <div class="mini-card"><div class="mini-val" id="cycleActiveAccounts">0</div><div class="mini-label">Active Accounts</div></div>
                    <div class="mini-card"><div class="mini-val" id="cycleAvgPerAccount">$0</div><div class="mini-label">Avg Per Account</div></div>
                    <div class="mini-card"><div class="mini-val" id="cycleTotalGoal">$0</div><div class="mini-label">Total Goal (Active)</div></div>
                    <div class="mini-card"><div class="mini-val" id="cycleRemainingGoal">$0</div><div class="mini-label">Remaining</div></div>
                </div>
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="card-header"><div class="card-title">Cycle-by-Cycle Comparison</div></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Cycle</th><th>Total P&L</th><th>Trades</th><th>Trading Days</th><th>Avg/Day</th><th>Win Rate</th><th>Best Day</th><th>Worst Day</th><th>Status</th></tr></thead>
                        <tbody id="cycleComparisonBody"></tbody></table>
                    </div>
                </div>
                <div class="chart-grid-2">
                    <div class="card"><div class="card-header"><div class="card-title">Cycle P&L Comparison</div></div><div class="card-body"><div class="chart-container"><canvas id="cyclePnLChart"></canvas></div></div></div>
                    <div class="card"><div class="card-header"><div class="card-title">Daily Average by Cycle</div></div><div class="card-body"><div class="chart-container"><canvas id="cycleDailyAvgChart"></canvas></div></div></div>
                </div>
                <div class="section-hdr"><h2 class="section-title">Cycle Details</h2></div>
                <div class="template-grid" id="cycleDetailsGrid"></div>
            </div>

            <!-- PAGE: TEMPLATES -->
            <div class="page" id="templatesPage">
                <div class="section-hdr"><h2 class="section-title">Market Conditions</h2></div>
                <div class="template-grid" id="marketConditionsGrid"></div>
                <div class="section-hdr"><h2 class="section-title">Risk Templates</h2></div>
                <div class="template-grid" id="riskTemplatesGrid"></div>
            </div>

            <!-- PAGE: ACCOUNTS -->
            <div class="page" id="accountsPage">
                <div class="section-hdr">
                    <h2 class="section-title" id="accountsPageTitle">Portfolio Accounts</h2>
                    <button class="btn btn-secondary btn-sm" onclick="exportCSV()">Export CSV</button>
                </div>
                <div class="filter-pills">
                    <div class="pill active" onclick="filterAccounts('all', event)">All</div>
                    <div class="pill" onclick="filterAccounts('active', event)">Active</div>
                    <div class="pill" onclick="filterAccounts('goal', event)">Goal Reached</div>
                    <div class="pill" onclick="filterAccounts('profitable', event)">Profitable</div>
                </div>
                <div class="accounts-grid" id="accountsGrid"></div>
            </div>

            <!-- PAGE: ANALYTICS -->
            <div class="page" id="analyticsPage">
                <div class="section-hdr"><h2 class="section-title">Performance Analytics</h2></div>
                <div class="card">
                    <div class="card-header"><div class="card-title">Template Comparison</div></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Template</th><th>Total P&L</th><th>Trades</th><th>Win Rate</th><th>Avg Win</th><th>Avg Loss</th><th>Best Trade</th><th>Profit Factor</th></tr></thead>
                        <tbody id="comparisonTableBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: RISK MONITOR -->
            <div class="page" id="riskMonitorPage">
                <div class="section-hdr"><h2 class="section-title">‚ö†Ô∏è Account Risk Monitor</h2></div>
                <div class="alert alert-info show" style="margin-bottom:1.5rem;">
                    <strong>Trailing Drawdown Rules:</strong> Starting $50,000 | Max Drawdown $2,500 | Fail Line $47,500 (trails highest balance). Safety Net: $52,600 (fail line locks at $50,100 forever).
                </div>
                <div class="accounts-grid" id="riskMonitorGrid"></div>
            </div>

            <!-- PAGE: ADD TRADE -->
            <div class="page" id="addTradePage">
                <div class="section-hdr"><h2 class="section-title">Add New Trade</h2></div>
                <div class="form-card">
                    <form id="tradeForm">
                        <div class="form-grid">
                            <div class="form-group" style="grid-column:1/-1;">
                                <label class="form-label" style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                                    <input type="checkbox" id="noTradeDay" style="width:auto;">
                                    üìÖ No-Trade Day (rest/holiday)
                                </label>
                            </div>
                            <div class="form-group" style="grid-column:1/-1;">
                                <label class="form-label" style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                                    <input type="checkbox" id="copierMode" style="width:auto;">
                                    üîÑ Trade Copier (copy to multiple accounts)
                                </label>
                            </div>
                            <div id="singleAccountGroup" class="form-group">
                                <label class="form-label">PA Account *</label>
                                <select class="form-select" id="accountSelect" required></select>
                            </div>
                            <div id="multiAccountGroup" style="display:none;grid-column:1/-1;">
                                <div class="form-group">
                                    <label class="form-label">Lead Account *</label>
                                    <select class="form-select" id="leadAccountSelect"></select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Follower Accounts *</label>
                                    <div style="border:1px solid var(--border);border-radius:var(--radius);padding:1rem;background:var(--bg3);max-height:160px;overflow-y:auto;">
                                        <div id="followerCheckboxes" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.5rem;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cycle *</label>
                                <select class="form-select" id="cycleSelect" required>
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option>
                                    <option value="3">Cycle 3</option><option value="4">Cycle 4</option>
                                    <option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                    <option value="7">Cycle 7</option><option value="8">Cycle 8</option>
                                    <option value="9">Cycle 9</option><option value="10">Cycle 10</option>
                                    <option value="11">Cycle 11</option><option value="12">Cycle 12</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Market Condition *</label>
                                <select class="form-select" id="marketConditionSelect" required>
                                    <option value="">Select</option>
                                    <option value="High Impact News">High Impact News</option>
                                    <option value="No Impact">No Impact</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Risk Template *</label>
                                <select class="form-select" id="riskTemplateSelect" required>
                                    <option value="">Select risk</option>
                                    <option value="100">$100 (1 contract)</option>
                                    <option value="200">$200 (2 contracts)</option>
                                    <option value="300">$300 (3 contracts)</option>
                                    <option value="400">$400 (4 contracts)</option>
                                    <option value="500">$500 (5 contracts)</option>
                                    <option value="600">$600 (6 contracts)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Trade Date *</label>
                                <input type="date" class="form-input" id="tradeDateInput" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">P&L ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="pnlInput" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contracts (auto)</label>
                                <input type="number" class="form-input" id="contractsInput" readonly style="background:var(--bg3);opacity:0.7;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input form-textarea" id="notesInput" placeholder="Trade notes..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="submitTradeBtn" style="width:auto;">
                                <span id="submitTradeText">Submit Trade</span>
                                <span id="submitTradeSpinner" class="spin" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetTradeForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- PAGE: LOG PAYOUT -->
            <div class="page" id="logPayoutPage">
                <div class="section-hdr"><h2 class="section-title">üí∞ Log Payout</h2></div>
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Available</span><div class="metric-icon mi-green">üíµ</div></div><div class="metric-value" id="availableWithdrawal">$0</div><div class="metric-change neutral" id="withdrawalStatus">Not qualified</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Withdrawn</span><div class="metric-icon mi-blue">üí∞</div></div><div class="metric-value" id="totalWithdrawn">$0</div><div class="metric-change neutral" id="withdrawalCount">0 payouts</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Cycle Phase</span><div class="metric-icon mi-purple">üîÑ</div></div><div class="metric-value" id="cyclePhase">Cycle 1</div><div class="metric-change neutral" id="phaseInfo">Building</div></div>
                </div>
                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1.25rem;font-size:1rem;font-weight:700;">Record New Payout</h3>
                    <form id="payoutForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Payout Type *</label>
                                <select class="form-select" id="payoutType" required>
                                    <option value="">Select type</option>
                                    <option value="first_min">First Payout ‚Äì Min ($2,600)</option>
                                    <option value="first_full">First Payout ‚Äì Full ($4,600)</option>
                                    <option value="monthly">Monthly ($2,000)</option>
                                    <option value="custom">Custom Amount</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Amount ($) *</label>
                                <input type="number" step="0.01" class="form-input" id="withdrawalAmount" placeholder="0.00" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Date *</label>
                                <input type="date" class="form-input" id="payoutDateInput" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account</label>
                                <select class="form-select" id="payoutAccountSelect">
                                    <option value="all">All Accounts</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cycle Completed *</label>
                                <select class="form-select" id="cycleCompletedSelect" required>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option>
                                    <option value="3">Cycle 3</option><option value="4">Cycle 4</option>
                                    <option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">New Cycle Starting *</label>
                                <select class="form-select" id="newCycleSelect" required>
                                    <option value="2">Cycle 2</option><option value="3">Cycle 3</option>
                                    <option value="4">Cycle 4</option><option value="5">Cycle 5</option>
                                    <option value="6">Cycle 6</option><option value="7">Cycle 7</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethodSelect">
                                    <option value="">Select (optional)</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="paypal">PayPal</option>
                                    <option value="wise">Wise</option>
                                    <option value="crypto">Crypto</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-input form-textarea" id="payoutNotes" placeholder="Payout notes..."></textarea>
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" id="payoutSubmitBtn" style="width:auto;">
                                <span id="payoutSubmitText">üí∞ Log Payout</span>
                                <span id="payoutSubmitSpinner" class="spin" style="display:none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetPayoutForm()">Clear</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">Payout History</div></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Account</th><th>Cycle</th><th>New Cycle</th><th>Method</th><th>Notes</th></tr></thead>
                        <tbody id="payoutHistoryBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: TRADE LOG -->
            <div class="page" id="tradeLogPage">
                <div class="section-hdr"><h2 class="section-title">Trade Log</h2><button class="btn btn-secondary btn-sm" onclick="exportCSV()">Export CSV</button></div>
                <div class="card">
                    <div class="card-header"><div class="card-title">All Trades (Latest 100)</div></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Date</th><th>Account</th><th>Condition</th><th>Risk</th><th>P&L</th><th>Contracts</th><th>Cycle</th><th>Notes</th></tr></thead>
                        <tbody id="tradeLogBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: DELETE DATA -->
            <div class="page" id="deleteDataPage">
                <div class="section-hdr"><h2 class="section-title">üóëÔ∏è Delete Data</h2></div>
                <div class="alert alert-error show">‚ö†Ô∏è Deleted data cannot be recovered. Please be careful!</div>
                <div class="form-card">
                    <div style="display:grid;gap:1.5rem;">
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">üîÑ Delete by Cycle</h4>
                            <p style="color:var(--text2);font-size:0.875rem;margin-bottom:1rem;">Remove all trades from a specific cycle</p>
                            <div style="display:flex;gap:1rem;">
                                <select class="form-select" id="deleteCycleSelect" style="flex:1;">
                                    <option value="">Select cycle</option>
                                    <option value="1">Cycle 1</option><option value="2">Cycle 2</option>
                                    <option value="3">Cycle 3</option><option value="4">Cycle 4</option>
                                    <option value="5">Cycle 5</option><option value="6">Cycle 6</option>
                                </select>
                                <button class="btn btn-danger" onclick="deleteByCycle()">Delete Cycle</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid var(--border);border-radius:var(--radius);">
                            <h4 style="margin-bottom:0.5rem;">üíº Delete by Account</h4>
                            <p style="color:var(--text2);font-size:0.875rem;margin-bottom:1rem;">Remove all trades from a specific account</p>
                            <div style="display:flex;gap:1rem;">
                                <select class="form-select" id="deleteAccountSelect" style="flex:1;"><option value="">Select account</option></select>
                                <button class="btn btn-danger" onclick="deleteByAccount()">Delete Account</button>
                            </div>
                        </div>
                        <div style="padding:1.25rem;border:1px solid rgba(248,81,73,0.3);border-radius:var(--radius);background:var(--red-bg);">
                            <h4 style="margin-bottom:0.5rem;color:var(--red);">üí£ Delete ALL Data</h4>
                            <p style="color:var(--text2);font-size:0.875rem;margin-bottom:1rem;">Permanently delete ALL trades and payouts</p>
                            <button class="btn btn-danger" onclick="confirmDeleteAll()">Delete Everything</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: SETTINGS -->
            <div class="page" id="settingsPage">
                <div class="section-hdr"><h2 class="section-title">‚öôÔ∏è Settings</h2></div>
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Account Goal</span><div class="metric-icon mi-blue">üéØ</div></div><div class="metric-value" id="settingsCurrentGoal">20</div><div class="metric-change neutral">Accounts in portfolio</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Active Accounts</span><div class="metric-icon mi-green">üíº</div></div><div class="metric-value" id="settingsActiveAccounts">0</div><div class="metric-change neutral">With trades</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Portfolio Goal</span><div class="metric-icon mi-purple">üí∞</div></div><div class="metric-value" id="settingsPortfolioGoal">$92,000</div><div class="metric-change neutral" id="settingsGoalCalc">$4,600 √ó 20</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Potential Payout</span><div class="metric-icon mi-orange">üåæ</div></div><div class="metric-value" id="settingsPotentialPayout">$40,000</div><div class="metric-change neutral" id="settingsPayoutCalc">$2,000 √ó 20</div></div>
                </div>
                <div class="form-card" style="margin-bottom:1.5rem;">
                    <h3 style="margin-bottom:1.25rem;font-size:1rem;font-weight:700;">Portfolio Configuration</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label class="form-label">Account Goal</label>
                            <select class="form-select" id="accountGoalSelect">
                                <option value="1">1 Account</option>
                                <option value="5">5 Accounts</option>
                                <option value="10">10 Accounts</option>
                                <option value="20" selected>20 Accounts</option>
                                <option value="50">50 Accounts</option>
                                <option value="100">100 Accounts</option>
                                <option value="custom">Custom...</option>
                            </select>
                        </div>
                        <div class="form-group" id="customGoalGroup" style="display:none;">
                            <label class="form-label">Custom Account Count</label>
                            <input type="number" class="form-input" id="customAccountGoal" min="1" max="200" placeholder="1‚Äì200">
                        </div>
                        <div class="form-footer">
                            <button type="submit" class="btn btn-primary" style="width:auto;">üíæ Save Settings</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSettingsForm()">Reset</button>
                        </div>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-title">All Configured Accounts</div></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Account</th><th>Status</th><th>P&L</th><th>Progress</th><th>Trades</th><th>Win Rate</th><th>To Goal</th></tr></thead>
                        <tbody id="settingsAccountsBody"></tbody></table>
                    </div>
                </div>
            </div>

            <!-- PAGE: ADMIN PANEL -->
            <div class="page" id="adminPanelPage">
                <div class="admin-header">
                    <span class="admin-icon">üõ°Ô∏è</span>
                    <div>
                        <div class="admin-title">Admin Panel</div>
                        <div class="admin-sub">Manage users, view all accounts, reset passwords</div>
                    </div>
                </div>

                <!-- Admin Stats -->
                <div class="metrics-grid" style="margin-bottom:1.5rem;">
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Users</span><div class="metric-icon mi-blue">üë•</div></div><div class="metric-value" id="adminTotalUsers">0</div><div class="metric-change neutral">Registered</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total Trades</span><div class="metric-icon mi-green">üìä</div></div><div class="metric-value" id="adminTotalTrades">0</div><div class="metric-change neutral">All users</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Total P&L (All)</span><div class="metric-icon mi-purple">üí∞</div></div><div class="metric-value" id="adminTotalPnL">$0</div><div class="metric-change neutral">Platform-wide</div></div>
                    <div class="metric-card"><div class="metric-header"><span class="metric-label">Admin Users</span><div class="metric-icon mi-orange">üõ°Ô∏è</div></div><div class="metric-value" id="adminAdminCount">0</div><div class="metric-change neutral">With admin role</div></div>
                </div>

                <!-- Viewing As Banner -->
                <div id="viewingAsBanner" style="display:none;" class="alert alert-warning show">
                    <strong>üëÅÔ∏è Viewing as:</strong> <span id="viewingAsName"></span>
                    <button class="btn btn-secondary btn-sm" style="margin-left:1rem;" onclick="exitImpersonate()">Exit View</button>
                </div>

                <!-- Users Table -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="card-header">
                        <div class="card-title">All Users</div>
                        <button class="btn btn-secondary btn-sm" onclick="loadAdminData()">‚Üª Refresh</button>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead><tr><th>User</th><th>Email</th><th>Account Goal</th><th>Trades</th><th>P&L</th><th>Admin</th><th>Joined</th><th>Actions</th></tr></thead>
                            <tbody id="adminUsersBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Add User -->
                <div class="form-card">
                    <h3 style="margin-bottom:1.25rem;font-size:1rem;font-weight:700;">‚ûï Invite / Create User</h3>
                    <div class="alert alert-info show" style="margin-bottom:1rem;">
                        Users are created via the sign-up form. To grant admin access, use the toggle in the table above. You can also send a password reset from the table.
                    </div>
                </div>
            </div>

        </div><!-- /container -->
    </main>
</div><!-- /dashboard -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚öôÔ∏è  CONFIGURATION ‚Äî REPLACE WITH YOUR VALUES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://YOUR_PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY_HERE';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STARTING_BALANCE = 50000;
const MAX_DRAWDOWN = 2500;
const SAFETY_NET = 52600;
const GOAL_PER_ACCOUNT = 4600;
const FIRST_PAYOUT_MIN = 2600;
const MONTHLY_PAYOUT_GOAL = 2000;
const PAYOUT_PER_ACCOUNT = 2000;
const DAILY_TARGET_MIN = 250;
const DAILY_TARGET_MAX = 300;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentUser = null;
let currentProfile = null;
let isAdmin = false;
let allData = [];
let payoutData = [];
let charts = {};
let accountFilter = 'all';
let USER_ACCOUNT_GOAL = 20;
let impersonatingUserId = null;
let impersonatingName = '';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t, i) => {
        t.classList.toggle('active', (i === 0 && tab === 'login') || (i === 1 && tab === 'signup'));
    });
    document.getElementById('loginForm').classList.toggle('active', tab === 'login');
    document.getElementById('signupForm').classList.toggle('active', tab === 'signup');
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const btn = document.getElementById('loginBtn');
    const errEl = document.getElementById('loginError');

    if (!email || !password) { showAuthError('loginError', 'Please fill in all fields'); return; }

    setAuthLoading('loginBtn', 'loginBtnText', 'loginSpinner', true);
    errEl.classList.remove('show');

    const { data, error } = await sb.auth.signInWithPassword({ email, password });

    if (error) {
        showAuthError('loginError', error.message);
        setAuthLoading('loginBtn', 'loginBtnText', 'loginSpinner', false);
    }
    // Auth state listener handles the rest
}

async function handleSignup() {
    const name = document.getElementById('signupName').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;

    if (!name || !email || !password) { showAuthError('signupError', 'Please fill in all fields'); return; }
    if (password.length < 6) { showAuthError('signupError', 'Password must be at least 6 characters'); return; }

    setAuthLoading('signupBtn', 'signupBtnText', 'signupSpinner', true);
    document.getElementById('signupError').classList.remove('show');

    const { data, error } = await sb.auth.signUp({
        email, password,
        options: { data: { full_name: name } }
    });

    setAuthLoading('signupBtn', 'signupBtnText', 'signupSpinner', false);

    if (error) {
        showAuthError('signupError', error.message);
    } else {
        document.getElementById('signupSuccess').textContent = '‚úì Account created! Check your email to confirm, then sign in.';
        document.getElementById('signupSuccess').classList.add('show');
        document.getElementById('signupForm').querySelectorAll('input').forEach(i => i.value = '');
    }
}

async function handleGoogleAuth() {
    const { error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.href }
    });
    if (error) showAuthError('loginError', error.message);
}

async function handleLogout() {
    await sb.auth.signOut();
    currentUser = null; currentProfile = null; isAdmin = false;
    allData = []; payoutData = []; charts = {};
    impersonatingUserId = null;
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('dashboard').classList.remove('show');
}

function showAuthError(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

function setAuthLoading(btnId, textId, spinnerId, loading) {
    document.getElementById(btnId).disabled = loading;
    document.getElementById(textId).style.display = loading ? 'none' : 'inline';
    document.getElementById(spinnerId).style.display = loading ? 'inline-block' : 'none';
}

// Auth state listener
sb.auth.onAuthStateChange(async (event, session) => {
    if (session?.user) {
        currentUser = session.user;
        await loadProfile();
        await initDashboard();
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('dashboard').classList.add('show');
    }
});

// Check existing session on load
sb.auth.getSession().then(({ data: { session } }) => {
    if (!session) {
        document.getElementById('authScreen').classList.remove('hidden');
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadProfile() {
    const { data, error } = await sb.from('user_profiles').select('*').eq('id', currentUser.id).single();
    if (data) {
        currentProfile = data;
        isAdmin = data.is_admin || false;
        USER_ACCOUNT_GOAL = data.account_goal || 20;
    }
}

function updateSidebarUser() {
    if (!currentProfile) return;
    const name = currentProfile.display_name || currentUser.email;
    document.getElementById('sidebarName').textContent = name;
    document.getElementById('sidebarRole').textContent = isAdmin ? 'Admin' : 'Trader';
    document.getElementById('sidebarAvatar').textContent = name.charAt(0).toUpperCase();
    document.getElementById('adminBadge').style.display = isAdmin ? 'inline' : 'none';
    document.getElementById('topbarAdminMode').style.display = isAdmin ? 'inline-flex' : 'none';
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? 'flex' : 'none';
    });
    document.getElementById('heroGreeting').textContent = `Welcome back, ${name.split(' ')[0]}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initDashboard() {
    updateSidebarUser();
    populateAccountDropdowns();
    setupFormListeners();
    setTodayDates();
    await loadDashboardData();
    await loadPayoutData();
}

function populateAccountDropdowns() {
    const selectors = ['accountSelect', 'leadAccountSelect', 'deleteAccountSelect', 'payoutAccountSelect'];
    selectors.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = id === 'payoutAccountSelect' 
            ? '<option value="all">All Accounts</option>'
            : '<option value="">Select account</option>';
        for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
            el.innerHTML += `<option value="${i}">PA Account #${i}</option>`;
        }
    });

    const followerDiv = document.getElementById('followerCheckboxes');
    if (followerDiv) {
        followerDiv.innerHTML = '';
        for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
            followerDiv.innerHTML += `
                <label style="display:flex;align-items:center;gap:0.4rem;cursor:pointer;padding:0.375rem;border-radius:6px;background:var(--bg2);">
                    <input type="checkbox" class="follower-checkbox" value="${i}" style="cursor:pointer;">
                    <span style="font-size:0.8125rem;">PA #${i}</span>
                </label>`;
        }
    }
}

function setTodayDates() {
    const today = new Date().toISOString().split('T')[0];
    ['tradeDateInput', 'payoutDateInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOADING (SUPABASE)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDashboardData() {
    try {
        const uid = impersonatingUserId || currentUser.id;
        const { data, error } = await sb.from('trades').select('*').eq('user_id', uid).order('trade_date', { ascending: true });
        if (error) throw error;
        allData = data || [];
        updateAllViews();
    } catch (err) {
        showAlert('Failed to load trades: ' + err.message, 'error');
        allData = [];
        updateAllViews();
    }
}

async function loadPayoutData() {
    try {
        const uid = impersonatingUserId || currentUser.id;
        const { data, error } = await sb.from('payouts').select('*').eq('user_id', uid).order('payout_date', { ascending: false });
        if (error) throw error;
        payoutData = data || [];
        updatePayoutPage();
    } catch (err) {
        payoutData = [];
    }
}

async function saveSettings(goal) {
    USER_ACCOUNT_GOAL = goal;
    const uid = currentUser.id;
    await sb.from('user_profiles').update({ account_goal: goal }).eq('id', uid);
    await sb.from('user_settings').upsert({ user_id: uid, account_goal: goal });
    populateAccountDropdowns();
    updateAllViews();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navigateTo(page) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page + 'Page').classList.add('active');
    const titles = { overview: 'Overview', cyclePerformance: 'Cycle Performance', templates: 'Templates', accounts: 'Accounts', analytics: 'Analytics', riskMonitor: 'Risk Monitor', addTrade: 'Add Trade', logPayout: 'Log Payout', tradeLog: 'Trade Log', deleteData: 'Delete Data', settings: 'Settings', adminPanel: 'Admin Panel' };
    document.getElementById('pageTitle').textContent = titles[page] || page;
    if (page === 'settings') updateSettingsPage();
    if (page === 'adminPanel' && isAdmin) loadAdminData();
    if (window.innerWidth <= 1024) document.getElementById('sidebar').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UPDATE ALL VIEWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAllViews() {
    updateHeroStats();
    updateMetrics();
    updateStatsComparison();
    updateCharts();
    updateTemplates();
    updateAccounts();
    updateAnalytics();
    updateTradeLog();
    updateRiskMonitor();
    updateCyclePerformance();
}

function updateHeroStats() {
    const totalPnL = allData.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
    const portfolioGoal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
    const progress = Math.min((totalPnL / portfolioGoal) * 100, 100);
    const atGoal = getAccountsAtGoal();
    document.getElementById('heroTotalPnL').textContent = fmt(totalPnL);
    document.getElementById('heroProgress').textContent = Math.round(progress) + '%';
    document.getElementById('heroAccounts').textContent = `${atGoal}/${USER_ACCOUNT_GOAL}`;
}

function updateMetrics() {
    const totalPnL = allData.reduce((s, t) => s + parseFloat(t.pnl || 0), 0);
    const total = allData.length;
    const wins = allData.filter(t => parseFloat(t.pnl || 0) > 0).length;
    const wr = total > 0 ? (wins / total) * 100 : 0;
    const totalWinAmt = allData.filter(t => parseFloat(t.pnl||0) > 0).reduce((s,t) => s + parseFloat(t.pnl), 0);
    const totalLossAmt = Math.abs(allData.filter(t => parseFloat(t.pnl||0) < 0).reduce((s,t) => s + parseFloat(t.pnl), 0));
    const pf = totalLossAmt > 0 ? totalWinAmt / totalLossAmt : 0;
    const avg = total > 0 ? totalPnL / total : 0;
    const streak = calcStreak(allData);
    const portfolioGoal = USER_ACCOUNT_GOAL * GOAL_PER_ACCOUNT;
    const progress = Math.min((totalPnL / portfolioGoal) * 100, 100);

    document.getElementById('totalPnL').textContent = fmt(totalPnL);
    document.getElementById('pnlChange').textContent = fmt(totalPnL) + ' total';
    document.getElementById('pnlChange').className = `metric-change ${totalPnL >= 0 ? 'positive' : 'negative'}`;
    document.getElementById('winRate').textContent = Math.round(wr) + '%';
    document.getElementById('winStats').textContent = `${wins} wins / ${total} trades`;
    document.getElementById('profitFactor').textContent = pf.toFixed(2);
    document.getElementById('profitFactorInfo').textContent = pf > 1 ? 'Good' : 'Needs work';
    document.getElementById('profitFactorInfo').className = `metric-change ${pf > 1 ? 'positive' : 'negative'}`;
    document.getElementById('winStreak').textContent = streak.current;
    document.getElementById('streakInfo').textContent = streak.current > 0 ? `üî• ${streak.current} in a row!` : 'No active streak';
    document.getElementById('streakInfo').className = `metric-change ${streak.current > 0 ? 'positive' : 'neutral'}`;
    document.getElementById('totalTrades').textContent = total;
    document.getElementById('totalTradesLabel').textContent = `Across ${USER_ACCOUNT_GOAL} accounts`;
    document.getElementById('avgTrade').textContent = fmt(avg);
    document.getElementById('monthlyProgress').textContent = Math.round(progress) + '%';
}

function updateStatsComparison() {
    if (!allData.length) return;
    const dailyPnL = {};
    allData.forEach(t => { const d = t.trade_date; dailyPnL[d] = (dailyPnL[d] || 0) + parseFloat(t.pnl || 0); });
    const days = Object.values(dailyPnL);
    document.getElementById('bestDay').textContent = fmt(days.length ? Math.max(...days) : 0);
    document.getElementById('worstDay').textContent = fmt(days.length ? Math.min(...days) : 0);
    const winsArr = allData.filter(t => parseFloat(t.pnl||0) > 0);
    const lossArr = allData.filter(t => parseFloat(t.pnl||0) < 0);
    document.getElementById('avgWin').textContent = fmt(winsArr.length ? winsArr.reduce((s,t)=>s+parseFloat(t.pnl),0)/winsArr.length : 0);
    document.getElementById('avgLoss').textContent = fmt(lossArr.length ? lossArr.reduce((s,t)=>s+parseFloat(t.pnl),0)/lossArr.length : 0);
    document.getElementById('longestStreak').textContent = calcStreak(allData).longest;
}

function updateCharts() {
    Object.values(charts).forEach(c => c?.destroy());
    charts = {};
    if (!allData.length) return;

    const chartDefaults = {
        responsive: true, maintainAspectRatio: false,
        animation: { duration: 400 },
        plugins: { legend: { display: false } },
        scales: {
            x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } },
            y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e' } }
        }
    };

    // Growth chart
    const dates = [...new Set(allData.map(t => t.trade_date))].sort();
    let sum = 0;
    const cumulative = dates.map(d => {
        sum += allData.filter(t => t.trade_date === d).reduce((s,t) => s + parseFloat(t.pnl||0), 0);
        return sum;
    });
    charts.growth = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: { labels: dates, datasets: [{ data: cumulative, borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4 }] },
        options: { ...chartDefaults, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', maxTicksLimit: 8 } }, y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', callback: v => '$' + v.toLocaleString() } } } }
    });

    // Win rate doughnut
    const condStats = {};
    allData.forEach(t => {
        const k = t.market_condition || 'Other';
        if (!condStats[k]) condStats[k] = { wins: 0, total: 0 };
        condStats[k].total++;
        if (parseFloat(t.pnl||0) > 0) condStats[k].wins++;
    });
    const condLabels = Object.keys(condStats);
    charts.winRate = new Chart(document.getElementById('winRateChart'), {
        type: 'doughnut',
        data: { labels: condLabels, datasets: [{ data: condLabels.map(l => condStats[l].total > 0 ? (condStats[l].wins/condStats[l].total)*100 : 0), backgroundColor: ['#58a6ff','#3fb950','#bc8cff','#ffa657'], borderWidth: 2, borderColor: '#161b22' }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { position: 'bottom', labels: { color: '#8b949e', padding: 10, font: { size: 11 } } } } }
    });

    // Daily bar chart
    const dailyPnL = {};
    allData.forEach(t => { dailyPnL[t.trade_date] = (dailyPnL[t.trade_date]||0) + parseFloat(t.pnl||0); });
    const dDates = Object.keys(dailyPnL).sort().slice(-14);
    const dVals = dDates.map(d => dailyPnL[d]);
    charts.daily = new Chart(document.getElementById('dailyChart'), {
        type: 'bar',
        data: { labels: dDates.map(d=>d.substring(5)), datasets: [{ data: dVals, backgroundColor: dVals.map(v=>v>=0?'rgba(63,185,80,0.7)':'rgba(248,81,73,0.7)'), borderRadius: 4 }] },
        options: { ...chartDefaults, scales: { x: { grid: { display: false }, ticks: { color: '#8b949e' } }, y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', callback: v => '$'+v.toLocaleString() } } } }
    });

    // Risk pie
    const riskCounts = {};
    allData.forEach(t => { const r = t.risk_template || 'Other'; riskCounts[r] = (riskCounts[r]||0)+1; });
    charts.risk = new Chart(document.getElementById('riskChart'), {
        type: 'pie',
        data: { labels: Object.keys(riskCounts).map(r=>'$'+r), datasets: [{ data: Object.values(riskCounts), backgroundColor: ['#58a6ff','#3fb950','#bc8cff','#ffa657','#f85149','#39d0d8'], borderWidth: 2, borderColor: '#161b22' }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { position: 'bottom', labels: { color: '#8b949e', padding: 8, font: { size: 10 } } } } }
    });

    // Account status doughnut
    const atGoal = getAccountsAtGoal();
    const active = getActiveAccountCount() - atGoal;
    const inactive = USER_ACCOUNT_GOAL - getActiveAccountCount();
    charts.accStatus = new Chart(document.getElementById('accountStatusChart'), {
        type: 'doughnut',
        data: { labels: ['At Goal','In Progress','Not Started'], datasets: [{ data: [atGoal, active, inactive], backgroundColor: ['#3fb950','#58a6ff','#444c56'], borderWidth: 2, borderColor: '#161b22' }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { position: 'bottom', labels: { color: '#8b949e', padding: 8, font: { size: 10 } } } } }
    });
}

function updateTemplates() {
    const templates = groupByTemplate(allData);
    const mGrid = document.getElementById('marketConditionsGrid');
    mGrid.innerHTML = '';
    ['High Impact News', 'No Impact'].forEach(n => mGrid.appendChild(createTemplateCard(n, templates[n])));

    const rGrid = document.getElementById('riskTemplatesGrid');
    rGrid.innerHTML = '';
    ['100','200','300','400','500','600'].forEach(r => rGrid.appendChild(createTemplateCard('$'+r+' Risk', templates[r])));

    const topGrid = document.getElementById('topTemplatesGrid');
    topGrid.innerHTML = '';
    const sorted = Object.entries(templates).filter(([,d])=>d.trades>0).sort((a,b)=>b[1].totalPnL-a[1].totalPnL).slice(0,3);
    if (!sorted.length) { topGrid.innerHTML = '<p style="color:var(--text2);">No trades yet.</p>'; return; }
    sorted.forEach(([n,d]) => topGrid.appendChild(createTemplateCard(n, d)));
}

function createTemplateCard(name, data) {
    const card = document.createElement('div');
    card.className = 'tmpl-card';
    const icon = name.includes('News') ? 'üì∞' : name.includes('Impact') ? 'üìâ' : 'üéØ';
    const desc = name.includes('News') ? 'High volatility events' : name.includes('Impact') ? 'Low volatility sessions' : `${parseInt(name.replace(/\D/g,''))/100} contracts`;
    card.innerHTML = `
        <div class="tmpl-header">
            <div class="tmpl-icon">${icon}</div>
            <div><div class="tmpl-name">${name}</div><div class="tmpl-desc">${desc}</div></div>
        </div>
        <div class="tmpl-stats">
            <div><div class="tmpl-stat-val">${fmt(data.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div>
            <div><div class="tmpl-stat-val">${data.trades}</div><div class="tmpl-stat-lbl">Trades</div></div>
            <div><div class="tmpl-stat-val">${Math.round(data.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div>
        </div>
        <div class="tmpl-details">
            <div class="tmpl-row"><span class="tmpl-row-lbl">Avg Win</span><span class="tmpl-row-val">${fmt(data.avgWin)}</span></div>
            <div class="tmpl-row"><span class="tmpl-row-lbl">Avg Loss</span><span class="tmpl-row-val">${fmt(data.avgLoss)}</span></div>
            <div class="tmpl-row"><span class="tmpl-row-lbl">Best Trade</span><span class="tmpl-row-val">${fmt(data.bestTrade)}</span></div>
        </div>`;
    return card;
}

function updateAccounts() {
    const grid = document.getElementById('accountsGrid');
    grid.innerHTML = '';
    document.getElementById('accountsPageTitle').textContent = `${USER_ACCOUNT_GOAL} Portfolio Accounts`;
    const accData = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = accData[i];
        if (accountFilter === 'active' && acc.trades === 0) continue;
        if (accountFilter === 'goal' && acc.pnl < GOAL_PER_ACCOUNT) continue;
        if (accountFilter === 'profitable' && acc.pnl <= 0) continue;
        const card = document.createElement('div');
        card.className = 'account-card';
        card.innerHTML = `
            <div class="acc-header">
                <div class="acc-number">PA #${i}</div>
                <span class="badge ${acc.pnl >= GOAL_PER_ACCOUNT ? 'badge-green' : acc.trades > 0 ? 'badge-blue' : 'badge-gray'}">${acc.pnl >= GOAL_PER_ACCOUNT ? 'GOAL ‚úì' : acc.trades > 0 ? 'ACTIVE' : 'INACTIVE'}</span>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.8125rem;color:var(--text2);margin-bottom:0.25rem;">
                <span>${fmt(acc.pnl)}</span><span>${Math.round(acc.progress)}%</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:${acc.progress}%"></div></div>
            <div class="acc-stats">
                <div><div class="acc-stat-label">Trades</div><div class="acc-stat-val">${acc.trades}</div></div>
                <div><div class="acc-stat-label">Win Rate</div><div class="acc-stat-val">${acc.trades > 0 ? Math.round(acc.winRate) : 0}%</div></div>
                <div><div class="acc-stat-label">To Goal</div><div class="acc-stat-val">${fmt(Math.max(GOAL_PER_ACCOUNT - acc.pnl, 0))}</div></div>
                <div><div class="acc-stat-label">Balance</div><div class="acc-stat-val">${fmt(STARTING_BALANCE + acc.pnl)}</div></div>
            </div>`;
        grid.appendChild(card);
    }
}

function filterAccounts(filter, e) {
    accountFilter = filter;
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    if (e) e.target.classList.add('active');
    updateAccounts();
}

function updateAnalytics() {
    const tbody = document.getElementById('comparisonTableBody');
    tbody.innerHTML = '';
    const templates = groupByTemplate(allData);
    const sorted = Object.entries(templates).filter(([,d])=>d.trades>0).sort((a,b)=>b[1].totalPnL-a[1].totalPnL);
    if (!sorted.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:2rem;">No trades yet</td></tr>'; return; }
    sorted.forEach(([name, d]) => {
        const tw = d.avgWin * (d.trades * d.winRate / 100);
        const tl = Math.abs(d.avgLoss * (d.trades * (100-d.winRate) / 100));
        const pf = tl > 0 ? (tw/tl).toFixed(2) : '0.00';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>${name}</strong></td><td style="color:${d.totalPnL>=0?'var(--green)':'var(--red)'}">${fmt(d.totalPnL)}</td><td>${d.trades}</td><td>${Math.round(d.winRate)}%</td><td>${fmt(d.avgWin)}</td><td>${fmt(d.avgLoss)}</td><td>${fmt(d.bestTrade)}</td><td>${pf}</td>`;
    });
}

function updateTradeLog() {
    const tbody = document.getElementById('tradeLogBody');
    tbody.innerHTML = '';
    if (!allData.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:2rem;">No trades yet</td></tr>'; return; }
    [...allData].sort((a,b) => new Date(b.trade_date)-new Date(a.trade_date)).slice(0,100).forEach(t => {
        const pnl = parseFloat(t.pnl||0);
        const row = tbody.insertRow();
        if (t.no_trade_day) {
            row.style.opacity = '0.6';
            row.innerHTML = `<td>${t.trade_date}</td><td colspan="7" style="text-align:center;color:var(--text2);font-style:italic;">üìÖ No-Trade Day</td>`;
        } else {
            row.innerHTML = `<td>${t.trade_date}</td><td>PA #${t.account}</td><td>${t.market_condition||'-'}</td><td>$${t.risk_template||0}</td><td style="color:${pnl>=0?'var(--green)':'var(--red)'}"><strong>${fmt(pnl)}</strong></td><td>${t.contracts||0}</td><td>${t.cycle||1}</td><td>${t.notes||'-'}</td>`;
        }
    });
}

function updateRiskMonitor() {
    const grid = document.getElementById('riskMonitorGrid');
    grid.innerHTML = '';
    const accData = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = accData[i];
        const bal = STARTING_BALANCE + acc.pnl;
        const highest = acc.highestBalance;
        const failLine = highest >= SAFETY_NET ? (STARTING_BALANCE + (SAFETY_NET-STARTING_BALANCE) - MAX_DRAWDOWN) : (highest - MAX_DRAWDOWN);
        const cushion = bal - failLine;
        const pct = (cushion / MAX_DRAWDOWN) * 100;
        let risk = 'safe', cls = '', bCls = 'badge-blue', bTxt = 'SAFE';
        if (cushion <= 0) { risk = 'danger'; cls = 'at-risk'; bCls = 'badge-red'; bTxt = 'AT RISK'; }
        else if (cushion <= 500) { risk = 'warning'; cls = 'warning-card'; bCls = 'badge-yellow'; bTxt = 'WARNING'; }
        const card = document.createElement('div');
        card.className = `account-card ${cls}`;
        card.innerHTML = `
            <div class="acc-header"><div class="acc-number">PA #${i}</div><span class="badge ${bCls}">${bTxt}</span></div>
            <div style="display:flex;justify-content:space-between;font-size:0.8125rem;color:var(--text2);margin-bottom:0.25rem;"><span>Balance: ${fmt(bal)}</span><span>${Math.round(Math.max(0,pct))}% cushion</span></div>
            <div class="progress-bar"><div class="progress-fill ${risk==='danger'?'danger':risk==='warning'?'warn':''}" style="width:${Math.max(0,Math.min(100,pct))}%"></div></div>
            <div class="acc-stats">
                <div><div class="acc-stat-label">P&L</div><div class="acc-stat-val" style="color:${acc.pnl>=0?'var(--green)':'var(--red)'}">${fmt(acc.pnl)}</div></div>
                <div><div class="acc-stat-label">Fail Line</div><div class="acc-stat-val">${fmt(failLine)}</div></div>
                <div><div class="acc-stat-label">Cushion</div><div class="acc-stat-val" style="color:${risk==='danger'?'var(--red)':risk==='warning'?'var(--yellow)':'var(--green)'}">${fmt(cushion)}</div></div>
                <div><div class="acc-stat-label">Highest</div><div class="acc-stat-val">${fmt(highest)}</div></div>
            </div>
            <div class="risk-note ${risk}">${risk==='danger'?'‚ö†Ô∏è CRITICAL: At or below fail line!':risk==='warning'?'‚ö†Ô∏è WARNING: < $500 from fail line':highest>=SAFETY_NET?'‚úì Safety net locked. Fail line: $50,100':'‚úì Safe ‚Äì '+fmt(SAFETY_NET-highest)+' to safety net'}</div>`;
        grid.appendChild(card);
    }
}

// ‚îÄ‚îÄ CYCLE PERFORMANCE
function updateCyclePerformance() {
    const totalPnL = allData.reduce((s,t) => s+parseFloat(t.pnl||0), 0);
    const activeAccounts = getActiveAccountCount();
    const cycleData = groupByCycle(allData);
    const activeGoal = activeAccounts * GOAL_PER_ACCOUNT;
    const firstProg = activeAccounts > 0 ? Math.min((totalPnL/activeGoal)*100, 100) : 0;
    document.getElementById('firstPayoutProgress').textContent = Math.round(firstProg) + '%';
    document.getElementById('firstPayoutStatus').textContent = totalPnL >= activeGoal ? '‚úì Qualified!' : `${fmt(activeGoal-totalPnL)} remaining`;
    const tradingDays = [...new Set(allData.map(t=>t.trade_date))].length;
    const dailyAvg = tradingDays > 0 ? totalPnL/tradingDays : 0;
    document.getElementById('dailyAverage').textContent = fmt(dailyAvg);
    document.getElementById('cycleActiveAccounts').textContent = activeAccounts;
    document.getElementById('cycleAvgPerAccount').textContent = activeAccounts > 0 ? fmt(totalPnL/activeAccounts) : '$0';
    document.getElementById('cycleTotalGoal').textContent = fmt(activeGoal);
    document.getElementById('cycleRemainingGoal').textContent = fmt(Math.max(0, activeGoal - totalPnL));
    document.getElementById('totalPayouts').textContent = fmt(payoutData.reduce((s,p)=>s+parseFloat(p.amount||0),0));
    document.getElementById('payoutCount').textContent = `${payoutData.length} payout${payoutData.length!==1?'s':''}`;
    const cycles = Object.keys(cycleData);
    const currCycle = cycles.length > 0 ? Math.max(...cycles.map(Number)) : 1;
    document.getElementById('currentCycleStatus').textContent = `Cycle ${currCycle}`;
    document.getElementById('currentCycleInfo').textContent = totalPnL >= activeGoal ? 'Payout qualified!' : 'Building...';
    updateCycleTable(cycleData, activeAccounts);
    updateCycleCharts(cycleData);
    updateCycleDetailCards(cycleData, activeAccounts);
}

function groupByCycle(data) {
    const grouped = {};
    for (let c = 1; c <= 12; c++) {
        const trades = data.filter(t => parseInt(t.cycle) === c);
        if (!trades.length) continue;
        const pnl = trades.reduce((s,t) => s+parseFloat(t.pnl||0), 0);
        const wins = trades.filter(t => parseFloat(t.pnl||0) > 0);
        const tradingDays = [...new Set(trades.map(t=>t.trade_date))].length;
        const dailyPnL = {};
        trades.forEach(t => { dailyPnL[t.trade_date] = (dailyPnL[t.trade_date]||0)+parseFloat(t.pnl||0); });
        const days = Object.values(dailyPnL);
        grouped[c] = { cycle: c, totalPnL: pnl, trades: trades.length, tradingDays, dailyAvg: tradingDays > 0 ? pnl/tradingDays : 0, winRate: (wins.length/trades.length)*100, bestDay: Math.max(...days, 0), worstDay: Math.min(...days, 0), avgWin: wins.length ? wins.reduce((s,t)=>s+parseFloat(t.pnl),0)/wins.length : 0 };
    }
    return grouped;
}

function updateCycleTable(cycleData, activeAccounts) {
    const tbody = document.getElementById('cycleComparisonBody');
    tbody.innerHTML = '';
    const cycles = Object.keys(cycleData).sort((a,b)=>a-b);
    if (!cycles.length) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:2rem;">No data yet</td></tr>'; return; }
    cycles.forEach(c => {
        const d = cycleData[c];
        const goal = activeAccounts * GOAL_PER_ACCOUNT;
        const status = d.totalPnL >= goal ? '‚úÖ Ready' : d.totalPnL >= goal*0.75 ? 'üü° Near' : 'üîµ In Progress';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>Cycle ${c}</strong></td><td style="color:${d.totalPnL>=0?'var(--green)':'var(--red)'}">${fmt(d.totalPnL)}</td><td>${d.trades}</td><td>${d.tradingDays}</td><td>${fmt(d.dailyAvg)}</td><td>${Math.round(d.winRate)}%</td><td>${fmt(d.bestDay)}</td><td>${fmt(d.worstDay)}</td><td>${status}</td>`;
    });
}

function updateCycleCharts(cycleData) {
    if (charts.cyclePnL) charts.cyclePnL.destroy();
    if (charts.cycleDailyAvg) charts.cycleDailyAvg.destroy();
    const cycles = Object.keys(cycleData).sort((a,b)=>a-b);
    if (!cycles.length) return;
    const pnlData = cycles.map(c=>cycleData[c].totalPnL);
    charts.cyclePnL = new Chart(document.getElementById('cyclePnLChart'), {
        type: 'bar',
        data: { labels: cycles.map(c=>'Cycle '+c), datasets: [{ data: pnlData, backgroundColor: pnlData.map(v=>v>=0?'rgba(63,185,80,0.7)':'rgba(248,81,73,0.7)'), borderRadius: 6 }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#8b949e' } }, y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', callback: v=>'$'+v.toLocaleString() } } } }
    });
    const avgData = cycles.map(c=>cycleData[c].dailyAvg);
    charts.cycleDailyAvg = new Chart(document.getElementById('cycleDailyAvgChart'), {
        type: 'line',
        data: { labels: cycles.map(c=>'Cycle '+c), datasets: [{ data: avgData, borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,0.08)', tension: 0.4, fill: true, borderWidth: 2, pointRadius: 4 }] },
        options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#8b949e' } }, y: { grid: { color: '#30363d' }, ticks: { color: '#8b949e', callback: v=>'$'+v.toLocaleString() } } } }
    });
}

function updateCycleDetailCards(cycleData, activeAccounts) {
    const grid = document.getElementById('cycleDetailsGrid');
    grid.innerHTML = '';
    const cycles = Object.keys(cycleData).sort((a,b)=>b-a);
    if (!cycles.length) { grid.innerHTML = '<p style="color:var(--text2);">No cycle data yet</p>'; return; }
    const goal = activeAccounts * GOAL_PER_ACCOUNT;
    cycles.forEach(c => {
        const d = cycleData[c];
        const card = document.createElement('div');
        card.className = 'tmpl-card';
        const pct = Math.min((d.totalPnL/goal)*100, 100);
        card.innerHTML = `
            <div class="tmpl-header"><div class="tmpl-icon" style="background:${d.totalPnL>=goal?'#238636':'rgba(88,166,255,0.2)'}">${d.totalPnL>=goal?'üåæ':'üå±'}</div>
            <div><div class="tmpl-name">Cycle ${c}</div><div class="tmpl-desc">${d.tradingDays} trading days</div></div></div>
            <div class="tmpl-stats"><div><div class="tmpl-stat-val">${fmt(d.totalPnL)}</div><div class="tmpl-stat-lbl">P&L</div></div><div><div class="tmpl-stat-val">${d.trades}</div><div class="tmpl-stat-lbl">Trades</div></div><div><div class="tmpl-stat-val">${Math.round(d.winRate)}%</div><div class="tmpl-stat-lbl">Win Rate</div></div></div>
            <div class="tmpl-details">
                <div class="tmpl-row"><span class="tmpl-row-lbl">Daily Avg</span><span class="tmpl-row-val">${fmt(d.dailyAvg)}</span></div>
                <div class="tmpl-row"><span class="tmpl-row-lbl">Best Day</span><span class="tmpl-row-val">${fmt(d.bestDay)}</span></div>
                <div class="tmpl-row"><span class="tmpl-row-lbl">Worst Day</span><span class="tmpl-row-val">${fmt(d.worstDay)}</span></div>
            </div>`;
        grid.appendChild(card);
    });
}

// ‚îÄ‚îÄ PAYOUT PAGE
function updatePayoutPage() {
    const totalPnL = allData.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
    const totalWithdrawn = payoutData.reduce((s,p)=>s+parseFloat(p.amount||0),0);
    const activeAccounts = getActiveAccountCount();
    const activeGoal = activeAccounts * GOAL_PER_ACCOUNT;
    document.getElementById('totalWithdrawn').textContent = fmt(totalWithdrawn);
    document.getElementById('withdrawalCount').textContent = `${payoutData.length} payout${payoutData.length!==1?'s':''}`;
    let avail = 0;
    if (totalPnL >= (activeAccounts*FIRST_PAYOUT_MIN)) {
        avail = activeAccounts * PAYOUT_PER_ACCOUNT;
    }
    document.getElementById('availableWithdrawal').textContent = fmt(avail);
    document.getElementById('withdrawalStatus').textContent = avail > 0 ? '‚úÖ Qualified' : `${fmt(Math.max(0,(activeAccounts*FIRST_PAYOUT_MIN)-totalPnL))} to qualify`;
    document.getElementById('cyclePhase').textContent = payoutData.length === 0 ? 'Cycle 1' : `Cycle ${payoutData[0].new_cycle || 2}`;
    document.getElementById('phaseInfo').textContent = payoutData.length === 0 ? 'First cycle' : 'Monthly farming';
    const tbody = document.getElementById('payoutHistoryBody');
    tbody.innerHTML = '';
    if (!payoutData.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:2rem;">No payouts yet</td></tr>'; return; }
    payoutData.forEach(p => {
        const row = tbody.insertRow();
        row.innerHTML = `<td>${p.payout_date}</td><td>${p.payout_type}</td><td style="color:var(--green)">${fmt(parseFloat(p.amount))}</td><td>${p.account||'All'}</td><td>${p.cycle_completed||1}</td><td>${p.new_cycle||2}</td><td>${p.payment_method||'-'}</td><td>${p.notes||'-'}</td>`;
    });
}

// ‚îÄ‚îÄ SETTINGS PAGE
function updateSettingsPage() {
    const active = getActiveAccountCount();
    document.getElementById('settingsCurrentGoal').textContent = USER_ACCOUNT_GOAL;
    document.getElementById('settingsActiveAccounts').textContent = active;
    document.getElementById('settingsPortfolioGoal').textContent = fmt(USER_ACCOUNT_GOAL*GOAL_PER_ACCOUNT);
    document.getElementById('settingsGoalCalc').textContent = `$${GOAL_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL}`;
    document.getElementById('settingsPotentialPayout').textContent = fmt(USER_ACCOUNT_GOAL*PAYOUT_PER_ACCOUNT);
    document.getElementById('settingsPayoutCalc').textContent = `$${PAYOUT_PER_ACCOUNT.toLocaleString()} √ó ${USER_ACCOUNT_GOAL}`;
    const tbody = document.getElementById('settingsAccountsBody');
    tbody.innerHTML = '';
    const accData = groupByAccount(allData);
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const acc = accData[i];
        const status = acc.trades === 0 ? 'Not Started' : acc.pnl >= GOAL_PER_ACCOUNT ? 'Goal Reached' : 'In Progress';
        const row = tbody.insertRow();
        row.innerHTML = `<td><strong>PA #${i}</strong></td><td>${status}</td><td style="color:${acc.pnl>=0?'var(--green)':'var(--red)'}">${fmt(acc.pnl)}</td><td>${Math.round(acc.progress)}%</td><td>${acc.trades}</td><td>${acc.trades>0?Math.round(acc.winRate):0}%</td><td>${fmt(Math.max(0,GOAL_PER_ACCOUNT-acc.pnl))}</td>`;
    }
}

function resetSettingsForm() {
    document.getElementById('accountGoalSelect').value = '20';
    document.getElementById('customGoalGroup').style.display = 'none';
}

// ‚îÄ‚îÄ ADMIN PANEL
async function loadAdminData() {
    if (!isAdmin) return;
    try {
        const { data: profiles } = await sb.from('user_profiles').select('*');
        const { data: allTrades } = await sb.from('trades').select('user_id, pnl');

        document.getElementById('adminTotalUsers').textContent = profiles?.length || 0;
        document.getElementById('adminAdminCount').textContent = profiles?.filter(p=>p.is_admin).length || 0;
        document.getElementById('adminTotalTrades').textContent = allTrades?.length || 0;
        const totalPnL = allTrades?.reduce((s,t)=>s+parseFloat(t.pnl||0),0) || 0;
        document.getElementById('adminTotalPnL').textContent = fmt(totalPnL);

        const tbody = document.getElementById('adminUsersBody');
        tbody.innerHTML = '';
        if (!profiles?.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text2);padding:2rem;">No users</td></tr>'; return; }

        for (const profile of profiles) {
            const userTrades = allTrades?.filter(t => t.user_id === profile.id) || [];
            const userPnL = userTrades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><strong>${profile.display_name || 'Unknown'}</strong></td>
                <td style="color:var(--text2);font-size:0.8125rem;">${profile.email}</td>
                <td>${profile.account_goal || 20}</td>
                <td>${userTrades.length}</td>
                <td style="color:${userPnL>=0?'var(--green)':'var(--red)'}">${fmt(userPnL)}</td>
                <td><span class="badge ${profile.is_admin?'badge-purple':'badge-gray'}">${profile.is_admin?'Admin':'User'}</span></td>
                <td style="color:var(--text2);font-size:0.8125rem;">${new Date(profile.created_at).toLocaleDateString()}</td>
                <td>
                    <div class="user-row-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewAsUser('${profile.id}','${profile.display_name||profile.email}')">üëÅ View</button>
                        <button class="btn btn-${profile.is_admin?'danger':'success'} btn-sm" onclick="toggleAdminRole('${profile.id}',${profile.is_admin})">${profile.is_admin?'Revoke':'Grant'} Admin</button>
                        <button class="btn btn-secondary btn-sm" onclick="sendPasswordReset('${profile.email}')">üîë Reset PW</button>
                    </div>
                </td>`;
        }
    } catch (err) {
        showAlert('Admin data load error: ' + err.message, 'error');
    }
}

async function toggleAdminRole(userId, currentAdmin) {
    if (!confirm(`${currentAdmin ? 'Revoke' : 'Grant'} admin access?`)) return;
    const { error } = await sb.from('user_profiles').update({ is_admin: !currentAdmin }).eq('id', userId);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì Admin role ${currentAdmin ? 'revoked' : 'granted'}`, 'success');
    loadAdminData();
}

async function sendPasswordReset(email) {
    const { error } = await sb.auth.resetPasswordForEmail(email);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì Password reset email sent to ${email}`, 'success');
}

async function viewAsUser(userId, name) {
    impersonatingUserId = userId;
    impersonatingName = name;
    document.getElementById('viewingAsBanner').style.display = 'block';
    document.getElementById('viewingAsName').textContent = name;
    await loadDashboardData();
    await loadPayoutData();
    navigateTo('overview');
    showAlert(`üëÅ Now viewing dashboard as ${name}`, 'info');
}

async function exitImpersonate() {
    impersonatingUserId = null;
    impersonatingName = '';
    document.getElementById('viewingAsBanner').style.display = 'none';
    await loadDashboardData();
    await loadPayoutData();
    showAlert('‚úì Returned to your own view', 'success');
}

// ‚îÄ‚îÄ FORM HANDLERS
function setupFormListeners() {
    // Nav items
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
        item.addEventListener('click', () => navigateTo(item.dataset.page));
    });

    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('show');
    });

    // Risk template auto-fill contracts
    document.getElementById('riskTemplateSelect').addEventListener('change', e => {
        document.getElementById('contractsInput').value = e.target.value ? parseInt(e.target.value)/100 : '';
    });

    // Trade copier toggle
    document.getElementById('copierMode').addEventListener('change', e => {
        document.getElementById('singleAccountGroup').style.display = e.target.checked ? 'none' : 'block';
        document.getElementById('multiAccountGroup').style.display = e.target.checked ? 'block' : 'none';
        document.getElementById('accountSelect').required = !e.target.checked;
    });

    // No-trade day toggle
    document.getElementById('noTradeDay').addEventListener('change', e => {
        ['marketConditionSelect','riskTemplateSelect','pnlInput','accountSelect'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.disabled = e.target.checked; if (e.target.checked) el.required = false; }
        });
        if (e.target.checked) document.getElementById('notesInput').value = 'No trading today - rest day';
    });

    // Trade form submit
    document.getElementById('tradeForm').addEventListener('submit', handleTradeSubmit);

    // Payout form submit
    document.getElementById('payoutForm').addEventListener('submit', handlePayoutSubmit);

    // Settings form
    document.getElementById('settingsForm').addEventListener('submit', async e => {
        e.preventDefault();
        let goal;
        if (document.getElementById('accountGoalSelect').value === 'custom') {
            goal = parseInt(document.getElementById('customAccountGoal').value);
            if (isNaN(goal) || goal < 1 || goal > 200) { showAlert('Enter a number between 1‚Äì200', 'error'); return; }
        } else {
            goal = parseInt(document.getElementById('accountGoalSelect').value);
        }
        await saveSettings(goal);
        showAlert(`‚úì Settings saved! Portfolio: ${goal} accounts`, 'success');
        setTimeout(() => navigateTo('overview'), 1200);
    });

    document.getElementById('accountGoalSelect').addEventListener('change', e => {
        document.getElementById('customGoalGroup').style.display = e.target.value === 'custom' ? 'block' : 'none';
    });

    // Payout type auto-fill
    document.getElementById('payoutType').addEventListener('change', e => {
        const amounts = { first_min: 2000, first_full: 2000, monthly: 2000 };
        if (amounts[e.target.value]) document.getElementById('withdrawalAmount').value = amounts[e.target.value];
    });
}

async function handleTradeSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('submitTradeBtn');
    btn.disabled = true;
    document.getElementById('submitTradeText').style.display = 'none';
    document.getElementById('submitTradeSpinner').style.display = 'inline-block';

    const uid = currentUser.id;
    const isNoTrade = document.getElementById('noTradeDay').checked;
    const isCopier = document.getElementById('copierMode').checked;
    const trades = [];

    const base = {
        user_id: uid,
        trade_date: document.getElementById('tradeDateInput').value,
        cycle: parseInt(document.getElementById('cycleSelect').value),
        notes: document.getElementById('notesInput').value || '',
        no_trade_day: isNoTrade
    };

    if (isNoTrade) {
        trades.push({ ...base, account: null, market_condition: 'No Trade', risk_template: 0, pnl: 0, contracts: 0 });
    } else if (isCopier) {
        const lead = document.getElementById('leadAccountSelect').value;
        const followers = Array.from(document.querySelectorAll('.follower-checkbox:checked')).map(c=>c.value);
        const pnl = parseFloat(document.getElementById('pnlInput').value);
        const mc = document.getElementById('marketConditionSelect').value;
        const rt = document.getElementById('riskTemplateSelect').value;
        const contracts = parseInt(document.getElementById('contractsInput').value || 0);
        if (!lead || !followers.length) { showAlert('Select lead and followers', 'error'); btn.disabled = false; document.getElementById('submitTradeText').style.display='inline'; document.getElementById('submitTradeSpinner').style.display='none'; return; }
        [lead, ...followers].forEach(acc => trades.push({ ...base, account: acc, market_condition: mc, risk_template: rt, pnl, contracts }));
    } else {
        trades.push({ ...base, account: document.getElementById('accountSelect').value, market_condition: document.getElementById('marketConditionSelect').value, risk_template: document.getElementById('riskTemplateSelect').value, pnl: parseFloat(document.getElementById('pnlInput').value), contracts: parseInt(document.getElementById('contractsInput').value||0) });
    }

    try {
        const { error } = await sb.from('trades').insert(trades);
        if (error) throw error;
        showAlert(`‚úì ${trades.length} trade(s) added successfully!`, 'success');
        resetTradeForm();
        await loadDashboardData();
        setTimeout(() => navigateTo('overview'), 800);
    } catch (err) {
        showAlert('Failed to submit: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        document.getElementById('submitTradeText').style.display = 'inline';
        document.getElementById('submitTradeSpinner').style.display = 'none';
    }
}

async function handlePayoutSubmit(e) {
    e.preventDefault();
    const btn = document.getElementById('payoutSubmitBtn');
    btn.disabled = true;
    document.getElementById('payoutSubmitText').style.display = 'none';
    document.getElementById('payoutSubmitSpinner').style.display = 'inline-block';

    const payout = {
        user_id: currentUser.id,
        payout_date: document.getElementById('payoutDateInput').value,
        payout_type: document.getElementById('payoutType').value,
        amount: parseFloat(document.getElementById('withdrawalAmount').value),
        account: document.getElementById('payoutAccountSelect').value,
        cycle_completed: parseInt(document.getElementById('cycleCompletedSelect').value),
        new_cycle: parseInt(document.getElementById('newCycleSelect').value),
        payment_method: document.getElementById('paymentMethodSelect').value,
        notes: document.getElementById('payoutNotes').value
    };

    try {
        const { error } = await sb.from('payouts').insert([payout]);
        if (error) throw error;
        showAlert('‚úì Payout logged!', 'success');
        resetPayoutForm();
        await loadPayoutData();
    } catch (err) {
        showAlert('Failed: ' + err.message, 'error');
    } finally {
        btn.disabled = false;
        document.getElementById('payoutSubmitText').style.display = 'inline';
        document.getElementById('payoutSubmitSpinner').style.display = 'none';
    }
}

function resetTradeForm() {
    document.getElementById('tradeForm').reset();
    setTodayDates();
    document.getElementById('singleAccountGroup').style.display = 'block';
    document.getElementById('multiAccountGroup').style.display = 'none';
}
function resetPayoutForm() {
    document.getElementById('payoutForm').reset();
    setTodayDates();
}

// ‚îÄ‚îÄ DELETE FUNCTIONS
async function deleteByCycle() {
    const cycle = document.getElementById('deleteCycleSelect').value;
    if (!cycle) { showAlert('Select a cycle', 'error'); return; }
    if (!confirm(`Delete ALL trades from Cycle ${cycle}?`)) return;
    const uid = impersonatingUserId || currentUser.id;
    const { error } = await sb.from('trades').delete().eq('user_id', uid).eq('cycle', parseInt(cycle));
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì Deleted Cycle ${cycle} trades`, 'success');
    await loadDashboardData();
}

async function deleteByAccount() {
    const account = document.getElementById('deleteAccountSelect').value;
    if (!account) { showAlert('Select an account', 'error'); return; }
    if (!confirm(`Delete ALL trades from PA #${account}?`)) return;
    const uid = impersonatingUserId || currentUser.id;
    const { error } = await sb.from('trades').delete().eq('user_id', uid).eq('account', account);
    if (error) { showAlert('Error: ' + error.message, 'error'); return; }
    showAlert(`‚úì Deleted Account #${account} trades`, 'success');
    await loadDashboardData();
}

async function confirmDeleteAll() {
    if (!confirm('Delete ALL data? This cannot be undone!')) return;
    const confirmation = prompt('Type "DELETE ALL" to confirm:');
    if (confirmation !== 'DELETE ALL') { showAlert('Cancelled', 'info'); return; }
    const uid = impersonatingUserId || currentUser.id;
    const { error: te } = await sb.from('trades').delete().eq('user_id', uid);
    const { error: pe } = await sb.from('payouts').delete().eq('user_id', uid);
    if (te || pe) { showAlert('Error during deletion', 'error'); return; }
    showAlert('‚úì All data deleted', 'success');
    await loadDashboardData();
    await loadPayoutData();
}

// ‚îÄ‚îÄ EXPORT CSV
function exportCSV() {
    if (!allData.length) { showAlert('No data to export', 'error'); return; }
    const headers = ['Date','Account','Condition','Risk','P&L','Contracts','Cycle','Notes'];
    let csv = headers.join(',') + '\n';
    allData.forEach(t => { csv += [t.trade_date,t.account,t.market_condition,t.risk_template,t.pnl,t.contracts,t.cycle,`"${t.notes||''}"`].join(',') + '\n'; });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `prop_farm_${new Date().toISOString().split('T')[0]}.csv`;
    a.click(); URL.revokeObjectURL(url);
    showAlert('‚úì CSV exported!', 'success');
}

async function refreshData() {
    showAlert('Refreshing...', 'info');
    await loadDashboardData();
    await loadPayoutData();
}

// ‚îÄ‚îÄ UTILITIES
function fmt(amount) {
    const abs = new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(amount));
    return amount < 0 ? '(' + abs + ')' : abs;
}

function calcStreak(data) {
    if (!data.length) return { current: 0, longest: 0 };
    const sorted = [...data].sort((a,b) => new Date(b.trade_date)-new Date(a.trade_date));
    let current = 0;
    for (const t of sorted) {
        if (parseFloat(t.pnl||0) > 0) current++;
        else break;
    }
    let longest = 0, run = 0;
    for (const t of [...data].sort((a,b)=>new Date(a.trade_date)-new Date(b.trade_date))) {
        if (parseFloat(t.pnl||0) > 0) { run++; longest = Math.max(longest,run); } else run = 0;
    }
    return { current, longest };
}

function getAccountsAtGoal() {
    let count = 0;
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const pnl = allData.filter(t=>t.account==i).reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        if (pnl >= GOAL_PER_ACCOUNT) count++;
    }
    return count;
}

function getActiveAccountCount() {
    return new Set(allData.filter(t=>t.account&&t.account!='N/A').map(t=>parseInt(t.account))).size;
}

function groupByAccount(data) {
    const grouped = {};
    for (let i = 1; i <= USER_ACCOUNT_GOAL; i++) {
        const trades = data.filter(t=>t.account==i);
        const pnl = trades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        const wins = trades.filter(t=>parseFloat(t.pnl||0)>0).length;
        let running = STARTING_BALANCE, highest = STARTING_BALANCE;
        [...trades].sort((a,b)=>new Date(a.trade_date)-new Date(b.trade_date)).forEach(t => {
            running += parseFloat(t.pnl||0);
            highest = Math.max(highest, running);
        });
        grouped[i] = { pnl, trades: trades.length, winRate: trades.length>0?(wins/trades.length)*100:0, progress: Math.min((pnl/GOAL_PER_ACCOUNT)*100,100), highestBalance: highest };
    }
    return grouped;
}

function groupByTemplate(data) {
    const keys = { 'High Impact News': 'mc', 'No Impact': 'mc', '100': 'rt', '200': 'rt', '300': 'rt', '400': 'rt', '500': 'rt', '600': 'rt' };
    const result = {};
    Object.entries(keys).forEach(([key, type]) => {
        const trades = type === 'mc' ? data.filter(t=>t.market_condition===key) : data.filter(t=>t.risk_template==key);
        const pnl = trades.reduce((s,t)=>s+parseFloat(t.pnl||0),0);
        const wins = trades.filter(t=>parseFloat(t.pnl||0)>0);
        const losses = trades.filter(t=>parseFloat(t.pnl||0)<0);
        result[key] = { totalPnL: pnl, trades: trades.length, winRate: trades.length?(wins.length/trades.length)*100:0, avgWin: wins.length?wins.reduce((s,t)=>s+parseFloat(t.pnl),0)/wins.length:0, avgLoss: losses.length?losses.reduce((s,t)=>s+parseFloat(t.pnl),0)/losses.length:0, bestTrade: trades.length?Math.max(...trades.map(t=>parseFloat(t.pnl||0))):0 };
    });
    // Also add named versions for risk templates
    ['100','200','300','400','500','600'].forEach(r => {
        result['$'+r+' Risk'] = result[r];
    });
    return result;
}

function showAlert(msg, type) {
    const el = document.getElementById('mainAlert');
    el.textContent = msg;
    el.className = `alert alert-${type} show`;
    setTimeout(() => el.classList.remove('show'), 5000);
}
</script>
</body>
</html>
